<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="renderer" content="webkit|ie-comp|ie-stand">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta http-equiv="Content-Type" content="charset=UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
		<meta http-equiv="Cache-Control" content="no-siteapp" />
		<link rel="stylesheet" href="/iles/pages/layui/css/layui.css" type="text/css" />

		<title>工厂结构</title>
	</head>

	<body id="bodyDiv">

		<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
		<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
		<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
		<script type="text/html" id="bodyTpl">
			<div id="plmPlantStructureTree" class="tree tree-box" style="width: 340px; height: 671px; overflow: scroll;float:left"></div>
			<div style="width: 1300px; float:right">
				<div class="layui-fluid">
					<div class="layui-row layui-form">
						<div class="layui-col-md3">
							<label class="layui-form-label">结构编码</label>
							<div class="layui-input-block">
								<input type="text" id="modelCode" placeholder="请输入编码" class="layui-input">
							</div>
						</div>
						<div class="layui-col-md3">
							<label class="layui-form-label">结构名称</label>
							<div class="layui-input-block">
								<input type="text" id="modelName" placeholder="请输入名称" class="layui-input">
							</div>
						</div>

						<div class="layui-col-md3">&nbsp;</div>
						<div class="layui-col-md3">
							<div class="layui-btn-container" style="text-align:left;">
								{{# if(d.search==null || d.search=="true"){ }}
								<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
								<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="reset" type="button"><i class="layui-icon layui-icon-reset"></i>重置</button> {{# } }}
							</div>
						</div>
					</div>
				</div>

				<div class="layui-fluid-table">
					<div class="layui-row layui-form" style="margin-bottom: 0">
						<div class="layui-btn-container" style="text-align: left;">



						</div>
					</div>
					<table id="plmPlantStructureTab" lay-filter="plmPlantStructureTabF"></table>
				</div>
			</div>

		</script>

		<script type="text/javascript">
			var element = layui.element;
			var layer = layui.layer;
			var table = layui.table;
			var tree = layui.tree;
			var util = layui.util;
			var form = layui.form;
			var contextPath = config.basicInfoConfig.contextPath;

			var oldData;
			var treeData = new Array();
			var parentId = 0;
			var level = "";
			var warehouseCode = 0;
			var warehouseName = 0;
			var parentMaterialClassificationName = "";
			var parentMaterialClassificationCode = "";

			function loadding() {

				//树
				layui.use(['tree', 'util'], function() {
					var tree = layui.tree,
						util = layui.util;
					tree.render({
						elem: '#plmPlantStructureTree',
						data: treeData,
						showCheckbox: false //是否显示复选框
							,
						id: 'plmPlantStructureTreeId',
						isJump: true //是否允许点击节点时弹出新窗口跳转
							,
						click: function(obj) {

							$(".layui-tree-txt").css("background", "");

							var data = obj.data; //获取当前点击的节点数据

							//查询条件
							modelName = $('#modelName').val();
							modelCode = $('#modelCode').val();
							parentMaterialClassificationName = data.title;
							parentMaterialClassificationCode = data.field;
							var params = {};
							params.modelName = modelName;
							params.modelCode = modelCode;
							params.plantItemId = data.id;
							parentId = data.id;
							level = data.level;

							//执行重载列表
							table.reload('plmPlantStructureTabId', {
								where: params,
								page: {
									"curr": 1
								}
							});
						}
					});
				})
				$(document).on("click", ".layui-tree-txt", function(event) {
					$(this).css("background", "blue");
				})

				table.render({
					elem: '#plmPlantStructureTab',
					id: 'plmPlantStructureTabId',
					url: contextPath + 'plmPlantStructure/listBypage',
					where: {
						plantItemId: parentId
					},
					cols: [
						[
							{
								type: 'numbers',
								title: '序号'
							},
							{
								field: 'modelCode',
								title: '工厂结构编码'
							},
							{
								field: 'modelName',
								title: '工厂结构名称'
							},
							{
								field: 'modelTypeName',
								title: '类型名称'
							},
							{
								field: 'createTime',
								title: '创建时间'
							},

						]
					],
					page: {
						theme: '#008155'
					},

					even: true,
					done: function(res, page, count) { //列表数据回调函数

						/* form.render(null, 'select-form-element'); */
					}
				});

				$('.layui-btn-container button').on('click', function() {
					var othis = $(this),
						method = othis.data('method');
					active[method] ? active[method].call(this, othis) : '';
				});

				var active = {

					search: function(othis) {
						var modelName = $('#modelName').val();
						var modelCode = $('#modelCode').val();

						var params = {};
						params.modelName = modelName;
						params.modelCode = modelCode;
						params.plantItemId = parentId;

						//执行重载
						table.reload('plmPlantStructureTabId', {
							where: params,
							page: {
								"curr": 1
							}
						});
					},
					reset: function(othis) {
						$('#modelName').val("");
						$('#modelCode').val("");

						form.render("select");
					},
					tree: function() {

						listTree();
					}

				};

				listTree();
			}

			function listTree() {
				var option = {
					url: contextPath + 'plmPlantStructure/listTree',
					type: "post",
					data: JSON.stringify({
						"plantItemId": parentId
					}),
					contentType: 'application/json',
					success: function(result) {
						if(result.code == 0) {
							treeData = result.data;
							tree.reload('plmPlantStructureTreeId', {
								data: treeData

							});
							//标记颜色
							$("span").each(function() {
								var v = $(this).html();
								if(v == parentMaterialClassificationName) {
									$(this).css("background", "");

								}
							});
						}
					}
				}
				$.ajax(option);
			}
		</script>
	</body>

</html>
