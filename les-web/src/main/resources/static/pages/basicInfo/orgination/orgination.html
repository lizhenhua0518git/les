<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>组织结构</title>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
</head>
<body>

 <div id="bodyDiv">

</div>
	
	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
 	<script src="/iles/pages/layui/lay/modules/treeGrid.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/loginInspect.js"></script>
	<script type="text/html" id="bodyTpl">
    <div class="layui-fluid">    
    <div class="layui-row layui-form">
			 <div class="layui-col-md2">
			 	<label class="layui-form-label">组织编号:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="orgCode_search" class="layui-input">
			    </div>
			 </div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label">组织名称:</label>
			 	 <div class="layui-input-block">
			      	<input type="text" id="orgName_search" class="layui-input">
			    </div>
			 </div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label">组织类型:</label>
			 	 <div class="layui-input-block">
				      <select id="orgType_search">
				        <option value=""></option>
				      </select>
			    </div>
			 </div>
			 <div class="layui-col-md2">
				<label class="layui-form-label">状态:</label>
			 	 <div class="layui-input-block layui-form" lay-filter="statusFilter">
			       <select  id="status_search">
			        <option value="">请选择</option>
			      </select>
			    </div>
			</div>
			<div class="layui-btn-container nav-" style="text-align: right;">
						{{# if(d.search==null || d.search=="true"){ }}
						<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
						<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="reset" id="reset" type="button"><i class="layui-icon  layui-icon-reset"></i>重置</button> {{# } }}
					</div>
		</div>
		<div class="layui-row layui-form" style="margin-top: 10px">
			 
			<div class="layui-col-md6">
				<div class="layui-btn-container" style="text-align: left;">

          {{# if(d.add==null || d.add=="true"){ }}
	      <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="add" data-type="auto" type="button"><i class="layui-icon  layui-icon-add-circle"></i>增加</button>
	     
          {{# } }}	

        {{# if(d.edit==null || d.edit=="true"){ }}
 
	    <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="edit" type="button"><i class="layui-icon layui-icon-edit"></i>编辑</button>
                     
        {{# } }}	

        {{# if(d.del==null || d.del=="true"){ }}
	     <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="del" type="button"><i class="layui-icon layui-icon-delete"></i>删除</button>				
        {{# } }}	
	    
          {{# if(d.enable==null || d.export=="true"){ }}
				  	<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="enable"><i class="layui-icon layui-icon-stock-check"></i>启用</button>
				  {{# } }}	
				  {{# if(d.disable==null || d.disable=="true"){ }}
				  	<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="disable"><i class="layui-icon layui-icon-cancel"></i>禁用</button>
				  {{# } }}	
				</div>
			</div>
		</div>
</div>
<table class="layui-hide" id="orgTab" lay-filter="orgTabF"></table>
</script>
<script type="text/javascript">
        
        var contextPath = config.basicInfoConfig.contextPath;
 
		var $ = layui.$;
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var treeGrid = layui.treeGrid;
		var form = layui.form;
		var parentId;
		var oldData;//用于编辑时传递参数
		var dictItems;//用于存储字典
		function loadding(){
		layui.use(['element', 'tree', 'layer', 'form', 'upload', 'treeGrid'], function () {
			var tree = layui.tree;
		    var treeTable = treeGrid.render({
		            elem: '#orgTab'
		            ,id:'orgTabId'
		           // , data: datatable
		            ,url:contextPath+'orgnization/orgnizationList'
		            , cellMinWidth: 100
		            , treeId: 'id'//树形id字段名称
		            , treeUpId: 'parentId'//树形父id字段名称
		            , treeShowName: 'orgName'//以树形式显示的字段
		            , cols: [[
		                {type: 'checkbox'}
		                ,{field:'orgName', title: '组织名称'}
		                ,{field:'orgCode', width:'30%', title: '组织编号'}
		    		    ,{field:'orgType', width:'29%', title: '组织类型'}
		    		    ,{field:'status', title: '状态', minWidth: 100}
		            ]]
			        ,page: false
		    		,height: 'full-95'
		    		,even:true
		    		,done:function(res,page,count){//列表数据回调函数
		    			var dictType = new Array();
		    			dictType.push("org_type");
		    			dictType.push("enable");
		    			//查询字典
		    			var option={
		    					url:contextPath+'dictItems/listDictItemByTypes',
		    					type:'POST',
		    					dataType:'json',
		    					contentType: "application/json",
		    					data:JSON.stringify(dictType),
		    					success:function(res){
		    						if(res.code==0){
		    							dictItems = res.data
		    							changeItemName(res.data);
		    							defulatSelect(dictItems);
		    						}
		    					}
			    			};
		    			$.ajax(option);
		    			
		    		}
		        });
		  });
		  function changeItemName(data){
			//组织类型数据处理
	    		$("[data-field='orgType']").children().each(function(){
	    			for(var i=0;i<data.length;i++){
	    				if(data[i].dictTypeId=="org_type" && data[i].itemValue==$(this).text().trim()){
	    					$(this).text(data[i].itemName);
	    				}
	    			}
	    		});
	    		//状态数据处理
	    		$("[data-field='status']").children().each(function(){
	    			for(var i=0;i<data.length;i++){
	    				if(data[i].dictTypeId=="enable" && data[i].itemValue==$(this).text().trim()){
	    					$(this).text(data[i].itemName);
	    				}
	    			}
	    		});
		  }
		  function defulatSelect(dictItems){
				if(dictItems && dictItems.length>0){
					if($("#orgType_search").find("option").length==1){
					  for(var i=0;i<dictItems.length;i++){
						   if(dictItems[i].dictTypeId=="org_type"){
							  $("#orgType_search").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
						  }else if(dictItems[i].dictTypeId=="enable"){
							  $("#status_search").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
						  }
					  }
					  form.render('select');
				  }
				}
			}
		  var active = {
		  		add:function(othis){
		  			var checkStatus = treeGrid.checkStatus('orgTabId');
      				oldData = checkStatus.data;
		  			var type = othis.data('type');
		  			layer.open({
				        type: 2
				        ,title:'组织结构新增'
				        ,maxmin:true
				        ,area: ['800px', '400px']
				        ,offset: type 
				        ,id: 'addOrg'+type //防止重复弹出
				        ,content: 'addOrgination.html'
				        ,shade: 0 //不显示遮罩
				        ,yes: function(){
				          layer.closeAll();
				        }
/* 			  			,end:function(){
			  				location.reload();
			  			} */
			      	}); 
		  		}
		  		,edit:function(othis){
		  			var checkStatus = treeGrid.checkStatus('orgTabId');
      				oldData = checkStatus.data;
					if(oldData.length<=0){
						layer.alert('请选择要编辑的行！',{icon: 2});
      					return ;
					}else if(oldData.length >1){
      					layer.alert('编辑不能超过多行！',{icon: 2});
      					return ;
      				}
					var type = othis.data('type');
      				layer.open({
				        type: 2
				        ,title:'编辑组织信息'
				        ,maxmin:true
				        ,area: ['800px', '400px']
				        ,offset: type 
				        ,id: 'editOrg'+type //防止重复弹出
				        ,content: 'editOrgination.html'
				        ,shade: 0 //不显示遮罩
				        ,yes: function(){
				          layer.closeAll();
				        }
			      	}); 
		  		}
		  		,del:function(){
		  			var checkStatus = treeGrid.checkStatus('orgTabId');
      				oldData = checkStatus.data;
					if(oldData.length<=0){
						layer.alert('请选择要删除的行！',{icon: 2});
      					return ;
					}
					var idarrys = new Array();
					for(var i=0;i<oldData.length;i++){
						idarrys.push(oldData[i].id);
					}
		  			layer.confirm('确定删除此节点?', {icon: 3, title:'提示'}, function(index){
		  			  //do something
		  			  var option ={
							url:contextPath+'orgnization/deleteOrgination',
							type:'POST',
							contentType: "application/json",
							dataType:'json',
							data:JSON.stringify(idarrys),
							success:function(data){
								if(data.code==0){
									layer.msg("删除成功");
									treeGrid.reload('orgTabId');
								}
							},error:function(data){
								layer.alert(data.msg);
							}
						}
						$.ajax(option);
		  			  layer.close(index);
		  			});
		  		},check:function(othis){
		  			var checkStatus = treeGrid.checkStatus('orgTabId');
      				oldData = checkStatus.data;
					if(oldData.length<=0){
						layer.alert('请选择要查看的行！',{icon: 2});
      					return ;
					}else if(oldData.length >1){
      					layer.alert('查看不能超过多行！',{icon: 2});
      					return ;
      				}
					var type = othis.data('type');
      				layer.open({
				        type: 2
				        ,title:'查看组织信息'
				        ,maxmin:true
				        ,area: ['800px', '400px']
				        ,offset: type 
				        ,id: 'checkOrg'+type //防止重复弹出
				        ,content: 'orgInfo.html'
				        ,shade: 0 //不显示遮罩
				        ,yes: function(){
				          layer.closeAll();
				        }
			      	}); 
		  		},search:function(othis){
		  			var orgCode = $('#orgCode_search');
					var orgName = $('#orgName_search');
					var orgType = $('#orgType_search');
					var status = $('#status_search');
				      //执行重载
				      treeGrid.reload('orgTabId', {
				        where:{
				        	"orgCode":orgCode.val().trim()
				           ,"orgName":orgName.val().trim()
				           ,"orgType":orgType.val().trim()
				           ,"status":status.val().trim()
				        }
				      });
		  		},reset:function(othis){
		  			$('#orgCode_search').val("");
					$('#orgName_search').val("");
					$('#orgType_search').val("");
					$('#status_search').val("");
					form.render("select");
		  		},enable:function(othis){
		  			var checkStatus = treeGrid.checkStatus('orgTabId');
      				oldData = checkStatus.data;
					if(oldData.length<=0){
						layer.alert('请选择要启用的数据！',{icon: 2});
      					return ;
					}
					var idarrys = new Array();
					for(var i=0;i<oldData.length;i++){
						idarrys.push(oldData[i].id);
					}
					var option ={
							url:contextPath+'orgnization/updateStateById?status=1',
							type:'POST',
							contentType: "application/json",
							dataType:'json',
							data:JSON.stringify(idarrys),
							success:function(data){
								if(data.code==0){
									treeGrid.reload('orgTabId');
								}
							},error:function(data){
								layer.alert(data.msg);
							}
						}
					$.ajax(option);
		  		},disable:function(othis){
		  			var checkStatus = treeGrid.checkStatus('orgTabId');
      				oldData = checkStatus.data;
					if(oldData.length<=0){
						layer.alert('请选择要禁用的数据！',{icon: 2});
      					return ;
					}
					var idarrys = new Array();
					for(var i=0;i<oldData.length;i++){
						idarrys.push(oldData[i].id);
					}
					var option ={
							url:contextPath+'orgnization/updateStateById?status=0',
							type:'POST',
							contentType: "application/json",
							dataType:'json',
							data:JSON.stringify(idarrys),
							success:function(data){
								if(data.code==0){
									treeGrid.reload('orgTabId');
								}
							},error:function(data){
								layer.alert(data.msg);
							}
						}
					$.ajax(option);
		  		}
		  	}
		  	
			$('.layui-btn-container button').on('click', function(){
			    var othis = $(this), method = othis.data('method');
			    active[method] ? active[method].call(this, othis) : '';
		  	}); 
		} 
	</script>
</body>
</html>