<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>编辑货架信息</title>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="${ctx}/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="${ctx}/pages/css/layui_extend.css"  media="all">
</head>
<body>
<div class="layui-container" style="padding-top: 20px;">
		<form class="layui-form" action="" lay-filter="shelfForm">
			<div class="layui-form-item">
				<div class="layui-inline">
				    <label class="layui-form-label">货架编号</label>
				    <div class="layui-input-block">
				      <input type="text" name="shelfCode" id="shelfCode" lay-verify="shelfCode" autocomplete="off" placeholder="请输入货架编号" class="layui-input">
				    </div>
			 	</div>
			 </div>
			<div class="layui-form-item">
				<div class="layui-inline">
				    <label class="layui-form-label">货架名称</label>
				    <div class="layui-input-block">
				      <input type="text" name="shelfName" id="shelfName" autocomplete="off" placeholder="请输入货架名称" class="layui-input">
				    </div>
			 	</div>
			 </div>
			 <div class="layui-form-item">
			 	<div class="layui-inline">
				    <label class="layui-form-label">所在区域</label>
				    <div class="layui-input-block">
				      <input type="text" name="areaName" id="areaName"  autocomplete="off" placeholder="请点击选择所在区域" lay-verify="required" class="layui-input" readonly="readonly" onclick="chooseArea()">
				    </div>
			 	</div>
			 </div>
			 <div class="layui-form-item">
			 	<div class="layui-inline">
				    <label class="layui-form-label">状态</label>
				    <div class="layui-input-block">
				      <select name="status" id="status" lay-verify="required" class="layui-select">
						  <option value=""></option>
						</select>
				    </div>
			 	</div>
			 </div>
			 <div class="layui-form-item">
			    <div class="layui-input-block">
			      <button class="layui-btn" lay-submit="" lay-filter="shelfSubit">立即提交</button>
			      <button type="reset" class="layui-btn layui-btn-primary">重置</button>
			    </div>
			  </div>
			  <input type="text" hidden="true"  name="areaId" id="areaId">
			  <input type="text" hidden="true" name ="id"/>
		</form>
	</div>
	<script src="${ctx}/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script type="text/javascript">
		var $ = layui.$;
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form
		var dictItems = parent.dictItems;
		var oldData = parent.oldData;
		var feildName = "areaName";
		var feildValue = "areaId";
		layui.use(['form', 'layedit'], function(){
			form.verify({
				shelfCode: function(value){
				      if(value.length < 1){
				        return '货架编号不能为空';
				      }
				      if(value.length>32)
				    	  return '货架编号超长，不能超过32个字符';
				}
			  });
			  //监听提交
			  form.on('submit(shelfSubit)', function(data){
				  data.field.id = oldData[0].id;//防止重置后id丢失
				  var option = {
						  url:'${ctx}/shelf/queryShelfRepeat',
						  data:JSON.stringify(data.field),
					      type:'POST',
					      contentType:'application/json',
					      success:function(res){
					    	  if(res.code==0 && res.data==null){
					    		  saveShelf(data);
					    	  }else{
					    		  layer.alert("区域内已经存在货架信息！");
					    	  }
					      }
				  };
				  $.ajax(option);
				return false;
			 });
		});
		function saveShelf(data){
			var option = {
		    	url:'${ctx}/shelf/updateShelf',
		    	data:JSON.stringify(data.field),
		    	type:'POST',
		    	contentType:'application/json',
		    	success:function(data){
		    		if(data.code==0){
		    			var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
		    			parent.layer.close(index);  // 关闭layer
		    			parent.parentId = "";
		    			parent.table.reload('shelfTabId');
		    		}else{
		    			layer.alert(data.msg);
		    		}
		    	},error:function(data){
		    		layer.alert(data.msg)
		    	}
		    }
		    $.ajax(option); 
		}
	 //状态设置下拉选项开始
	 if(dictItems && dictItems.length>0){
		 defulatSelect(dictItems);
	 }else{
		 queryDictItem(); 
	 }
	 if(oldData && oldData.length>0){
		 var formData =  eval('('+JSON.stringify(oldData[0])+')');
		 form.val('shelfForm',formData);
		 if(formData.id!=null && formData.id.length>0){
			 var option = {
					 url:'${ctx}/shelf/queryShelfById?id='+formData.id,
					 type:'GET',
					 success:function(res){
						 if(res.code==0 && res.data!=null){
							 $("#areaName").val(formData.areaId);
							 $("#areaId").val(res.data.areaId);
						 }
					 }
			 };
			 $.ajax(option);
		 }
	 }
	 function queryDictItem(){
		  var dictType = new Array();
			dictType.push("enable");
			//查询字典
			var option={
					url:'${ctx}/dictItems/queryDictItemByTypes',
					type:'POST',
					dataType:'json',
					contentType: "application/json",
					data:JSON.stringify(dictType),
					success:function(res){
						if(res.code==0){
							dictItems = res.data
							defulatSelect(res.data);
						}
					}
  			};
			$.ajax(option);
	  }
	  function defulatSelect(dictItems){
		  if(dictItems && dictItems.length>0){
			  for(var i=0;i<dictItems.length;i++){
				  if(dictItems[i].dictTypeId=="enable"){
					  $("#status").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
				  }
			  }
			  form.render('select');
		  }
	  }
	  //状态设置下拉选项结束
	  function chooseArea(){
		  layer.open({
		        type: 2
		        ,title:'选择所在区域'
		        ,maxmin:true
		        ,area: ['400px', '300px']
		        ,id: 'areachose' //防止重复弹出
		        ,content: '${ctx}/pages/basicInfo/area/chooseArea.html'
		        ,shade: 0 //不显示遮罩
		   });
	  }
	  
	</script>
</body>
</html>