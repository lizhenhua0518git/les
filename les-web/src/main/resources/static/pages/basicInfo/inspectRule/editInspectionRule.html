<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>编辑载具信息</title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="/iles/pages/css/layui_extend.css"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css"/>
</head>
<body>
<div id="bodyDiv">

</div>
<div class="layui-container" style="padding-top: 20px;">
    <form class="layui-form" action="" lay-filter="inspectRuleForm">
        <div class="layui-row layui-form">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">仓库</label>
                    <div class="layui-input-inline">
                        <select id="warehouse_code"  lay-filter="wareHoseType" name="wareHoseName">
                            <option value="">请选择</option>
                        </select></div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label layui-required">单据类型</label>
                    <div class="layui-input-inline">
                        <select id="billType_search"  name="billName" lay-filter="billType">
                            <option value="">请选择</option>
                        </select></div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">发货方</label>
                    <div class="layui-input-inline">
                        <input type="text" id="supplierCode" class="layui-input" name="supplierCode">
                    </div>
                </div>
            </div>

            <div class="layui-col-md2">
                <div class="layui-btn-container" style="text-align: center;margin-top:20px">
                    <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="save" id="search"
                            type="button" lay-submit="" lay-filter="carrierSubit">保存
                    </button>
                    <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="reset" id="reset"
                            type="button"  data-method="reset"><i class="layui-icon layui-icon-reset"></i>重置
                    </button>
                </div>
            </div>
        </div>
        <input type="text" name="id" id="id" hidden="true">

    </form>
</div>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
<script type="text/html" id="bodyTpl">
</script>
<script type="text/javascript">
    var $ = layui.$;
    var element = layui.element;
    var layer = layui.layer;
    var table = layui.table;
    var form = layui.form;
    var oldData = parent.oldData;
    var contextPath = config.basicInfoConfig.contextPath;
    var active = {
        reset: function (type) {
            $("#warehouse_code").val("");
            $("#billType_search").val("");
            $("#supplierCode").val("");
            form.render('select');
        }
    }
    function loadding() {
        $('.layui-btn-container button').on('click', function () {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });
    };

    initWarehouseSignSelect("warehouse_code", 1, oldData[0].wareHoseCode);
     inintBillType("billType_search",oldData[0].billCode);

    initData();
    layui.use(['form', 'layedit'], function () {
        form.verify({
            billType: function (value) {
                if (value == '') {
                    return '请选择单据类型';
                }
            }
        });
        //监听提交
        form.on('submit(carrierSubit)', function (data) {
            var wareHose = $("#warehouse_code").find("option:selected");
            var bill = $("#billType_search").find("option:selected");
            var supplierCode = $("#supplierCode").val();
            var params = {};
            params.id = data.field.id;
            params.supplierCode = supplierCode;
            params.billCode = bill.val();
            params.billName = bill.text();
            params.wareHoseCode = wareHose.val();
            params.wareHoseName = wareHose.text();
            saveDict(params);
            return false;
        });
    });

    function saveDict(data) {
        var option = {
            url: contextPath + 'inspect/update',
            data: JSON.stringify(data),
            contentType: 'application/json',
            type: 'POST',
            success: function (data) {
               var resultData = JSON.parse(data);
                if (resultData.code == 0) {
                    var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                    parent.layer.close(index);  // 关闭layer
                    parent.table.reload('inspectionRuleTabId');
                } else if (resultData.code == -1233){
                    layer.alert("质检规则重复");
                }else {
                    layer.alert("修改失败");
                }
            }, error: function (data) {
                layer.alert(data.msg)
            }
        }
        $.ajax(option);
    }


    function defulatSelect(dictItems) {
        if (dictItems && dictItems.length > 0) {
            if ($("#carrierType").find("option").length == 1) {
                for (var i = 0; i < dictItems.length; i++) {
                    $("#carrierType").append("<option value=" + dictItems[i].itemValue + ">" + dictItems[i].itemName + "</option>");
                }
                $("#carrierType").val(parent.oldData[0].carrierType);
                form.render('select');
            }
        }
    }

    //初始化表单数据
    function initData(){
        var oldData = parent.oldData;
        if(oldData && oldData.length>0){
            var formData =  eval('('+JSON.stringify(oldData[0])+')');
            form.val('carrierForm',formData);
        }
    }
    /**
     * 功能描述：单选下拉仓库
     * @param warehouseSelectId 下拉框ID
     * @param permission 1-权限控制 0-不控制
     * @param selectValue  选中的值
     * @returns
     */
    function initWarehouseSignSelect(warehouseSelectId, permission, selectValue) {
        var params = {limit: 0, sortColums: "org_code asc", permission: permission};
        var contextPath = config.basicInfoConfig.contextPath
        var option = {
            url: contextPath + 'orgnization/listWarehouse',
            type: "post",
            contentType: "application/json",
            dataType: 'json',
            data: JSON.stringify(params),
            success: function (result) {
                if (result.code == 0) {
                    var WarehouseCodes = result.data;
                    warehouseSignSelect(WarehouseCodes, warehouseSelectId, selectValue);
                }
            }
        }
        $.ajax(option);
    }

    /**
     * 功能描述：渲染单选下拉框
     * @param WarehouseCodes 数据
     * @param warehouseSelectId 下拉框ID
     * @param selectValue  选中的值
     * @returns
     */
    function warehouseSignSelect(WarehouseCodes, warehouseSelectId, selectValue) {
        if (WarehouseCodes.wareHoseList.length > 0) {
            var currwareCode;
            var wareHoseList = WarehouseCodes.wareHoseList;
            if ($("#" + warehouseSelectId).find("option").length == 1) {
                for (var i = 0; i < wareHoseList.length; i++) {
                    if (WarehouseCodes.currWareHose == wareHoseList[i].storageLocation) {
                        currwareCode = wareHoseList[i].orgCode;
                    }
                    $("#" + warehouseSelectId).append("<option value=" + wareHoseList[i].orgCode + " orgType=" + wareHoseList[i].orgType + " factory=" + wareHoseList[i].factory + " sapStoragelocation=" + wareHoseList[i].sapStorageLocation + "  storagelocation=" + wareHoseList[i].storageLocation + "  orgcode=" + wareHoseList[i].orgCode + " >" + wareHoseList[i].orgName + "</option>");
                }
                $("#" + warehouseSelectId).val(selectValue);
                layui.form.render("select");
            }
        }
    }

    /**
     * 加载单据类型
     */
    function inintBillType(warehouseSelectId, selectValue) {
        var contextPath = config.basicInfoConfig.contextPath
        var option = {
            url: contextPath + 'documentType/listByBusinessType?status=1&businessTypeStr=' + '1,2',
            type: "GET",
            success: function (result) {
                if (result.code == 0) {
                    var documentType = result.data;
                    for (var i = 0; i < documentType.length; i++) {
                        $("#billType_search").append("<option value=" + documentType[i].documentCode + "  >" + documentType[i].documentName + "</option>");
                    }
                    $("#" + warehouseSelectId).val(selectValue);
                    form.render("select");
                }
            }
        }
        $.ajax(option);
    }

    //初始化表单数据
    function initData() {
        var oldData = parent.oldData;
        if (oldData && oldData.length > 0) {
            var formData = eval('(' + JSON.stringify(oldData[0]) + ')');
            form.val('inspectRuleForm', formData);
        }
    }
</script>
</body>
</html>