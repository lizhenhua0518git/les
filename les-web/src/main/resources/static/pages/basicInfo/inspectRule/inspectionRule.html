<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="charset=UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <title>质检规则管理</title>
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="/iles/pages/css/layui_extend.css"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css"/>
</head>
<script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-xs" lay-event="showDetail">查看</a>
</script>
<script type="text/html" id="bodyTpl">
    <div class="layui-fluid">
        <div class="layui-row layui-form">
            <div class="layui-col-md2">
                <label class="layui-form-label">仓库</label>
                <div class="layui-input-inline">
                    <select id="warehouse_search" xm-select="inWarehouseCodeSelect" xm-select-show-count="1">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">单据类型</label>
                <div class="layui-input-inline">
                    <select id="billType_search" xm-select="billTypeSelect" xm-select-show-count="1">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">发货方</label>
                <div class="layui-input-inline">
                    <input type="text" id="supplierCode" class="layui-input">
                </div>
            </div>

                <div class="layui-btn-container" style="text-align: right;">
                    {{# if(d.search==null || d.search=="true"){ }}
                    <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="search" id="search"
                            type="button"><i class="layui-icon layui-icon-search"></i>查询
                    </button>
                    <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="reset" id="reset"
                            type="button"><i class="layui-icon layui-icon-reset"></i>重置
                    </button>
                    {{# } }}
                </div>

        </div>
    </div>
    <div class="layui-fluid-table">
        <div class="layui-row layui-form" style="margin-bottom: 0">
            <div class="layui-btn-container" style="text-align: left;">
                {{# if(d.add==null || d.add=="true"){ }}
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="add" data-type="auto"
                        type="button"><i class="layui-icon  layui-icon-add-circle"></i>新增
                </button>
                {{# } }}
                {{# if(d.edit==null || d.edit=="true"){ }}
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="edit" type="button"><i
                        class="layui-icon layui-icon-edit"></i>修改
                </button>
                {{# } }}
                {{# if(d.delete==null || d.delete=="true"){ }}
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="del" type="button"><i
                        class="layui-icon layui-icon-edit"></i>删除
                </button>
                {{# } }}
            </div>
        </div>
        <table class="layui-hide" id="inspectionRuleTab" lay-filter="singleAllocateTabF"></table>
    </div>
</script>

<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>

<script type="text/javascript">
    var table = layui.table;
    var element = layui.element;
    var contextPath = config.basicInfoConfig.contextPath;
    var form = layui.form;
    var storage = window.localStorage;
    var token = storage.token;
    var layer = layui.layer;
    var laydate = layui.laydate;
    var oldData;
    var factoryCodes;
    var active = {
        add: function (othis) {
            var type = othis.data('type');
            layer.open({
                type: 2
                , title: '新增质检规则'
                , maxmin: false
                , area: ['45%', '55%']
                , offset: type
                , id: 'documentTypeadd' + type //防止重复弹出
                , content: 'addInspectionRule.html'
                , shade: 0 //不显示遮罩
                , yes: function () {
                    layer.closeAll();
                }
            });
        },
        edit: function (othis) {
            var checkStatus = table.checkStatus('inspectionRuleTabId');
            oldData = checkStatus.data;
            if(oldData.length<=0){
                layer.alert('请选择要编辑的行！',{icon: 2});
                return ;
            }else if(oldData.length >1){
                layer.alert('编辑不能超过多行！',{icon: 2});
                return ;
            }
            var type = othis.data('type');
            layer.open({
                type: 2
                ,title:'编辑质检信息'
                ,maxmin: false
                ,area: ['45%', '55%']
                ,offset: type
                ,id: 'warehouseEdit'+type //防止重复弹出
                ,content: 'editInspectionRule.html'
                ,shade: [0.8, '#393D49']
                ,yes: function(){
                    layer.closeAll();
                }
            });
        },
        del: function (othis) {
            var checkStatus = table.checkStatus('inspectionRuleTabId');
            oldData = checkStatus.data;
            if (oldData.length <= 0) {
                layer.alert('请选择要删除的行！', {icon: 2});
                return;
            }
            var idarrys = new Array();
            for (var i = 0; i < oldData.length; i++) {
                idarrys.push(oldData[i].id);
            }
            layer.confirm('确定删除' + idarrys.length + '条质检规则?', {icon: 3, title: '提示'}, function (index) {
                //do something
                var option = {
                    url: contextPath + 'inspect/delete',
                    type: 'POST',
                    contentType: "application/json",
                    dataType: 'json',
                    data: JSON.stringify(idarrys),
                    success: function (data) {
                        if (data.code == 0) {
                            table.reload('inspectionRuleTabId');//刷新列表
                        } else {
                            layer.alert(data.data);
                        }
                    }, error: function (data) {
                        layer.alert(data.msg);
                    }
                }
                $.ajax(option);
                layer.close(index);
            });
        },
        search: function (othis) {
            var supplierCode = $('#supplierCode').val();
            //多选值 仓库名称 + 仓库编码 [{"name":"","val":""}]
            var warehouseCodes = layui.formSelects.value('inWarehouseCodeSelect','valueStr');
            //单据类型 [{"name":"","val":""}]
            var billCodes = layui.formSelects.value('billTypeSelect','valueStr');
            var startTimeStr = null;
            var endTimeStr = null;
            //执行重载
            table.reload('inspectionRuleTabId', {
                where: {
                    supplierCode: supplierCode
                    , warehouseCodes: warehouseCodes
                    , billCodes: billCodes
                }
                , page: {"curr": 1}
            });
        },
        reset: function (othis) {
            $('#supplierCode').val("");
            layui.formSelects.value('inWarehouseCodeSelect', []);
            layui.formSelects.value('billTypeSelect', []);
            form.render("select");
        }
    }

    function loadding() {
        table.render({
            elem: '#inspectionRuleTab',
            id: 'inspectionRuleTabId',
            url: contextPath + 'inspect/findLists',
            cols: [[
                {type: 'checkbox'},
                {type: 'numbers', title: '序号', width: 60},
                {field: 'wareHoseCode', title: '仓库编码', width: 105},
                {field: 'wareHoseName', title: '仓库名称', width: 100},
                {field: 'billCode', title: '单据类型编码', width: 100},
                {field: 'billName', title: '单据类型名称', width: 100},
                {field: 'supplierCode', title: '发货方编码', width: 100},
                {field: 'supplierName', title: '发货方名称', width: 100},
                {field: 'isInspectStr', title: '是否质检', width: 100},
                {field: 'createrName', title: '创建人', width: 100},
                {field: 'createTime', title: '创建时间', width: 100},
                {field: 'modifierName', title: '修改人', width: 100},
                {field: 'modifiedTime', title: '修改时间', width: 100}
            ]],
            page: {theme: '#008155'},

            even:true
            ,done:function(res,page,count){//列表数据回调函数

            }
        });
        $('.layui-btn-container button').on('click', function () {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });

        //创建时间区间
        laydate.render({
            elem: '#createTime_search',
            range: true
        });
        initWarehouseMultiSelect("warehouse_search","inWarehouseCodeSelect",1,null);
        //加载单据类型
        inintBillTypeMultiSelects("billTypeSelect",[]);
    }
    /**
     * 功能描述：单选下拉仓库
     * @param warehouseSelectId 下拉框ID
     * @param permission 1-权限控制 0-不控制
     * @param selectValue  选中的值
     * @returns
     */
    function initWarehouseSignSelect(warehouseSelectId, permission, selectValue) {
        var params = {limit: 0, sortColums: "org_code asc", permission: permission};
        var contextPath = config.basicInfoConfig.contextPath
        var option = {
            url: contextPath + 'orgnization/listWarehouse',
            type: "post",
            contentType: "application/json",
            dataType: 'json',
            data: JSON.stringify(params),
            success: function (result) {
                if (result.code == 0) {
                    var WarehouseCodes = result.data;
                    warehouseSignSelect(WarehouseCodes, warehouseSelectId, selectValue);
                }
            }
        }
        $.ajax(option);
    }

    /**
     * 功能描述：渲染单选下拉框
     * @param WarehouseCodes 数据
     * @param warehouseSelectId 下拉框ID
     * @param selectValue  选中的值
     * @returns
     */
    function warehouseSignSelect(WarehouseCodes, warehouseSelectId, selectValue) {
        if (WarehouseCodes.wareHoseList.length > 0) {
            var currwareCode;
            var wareHoseList = WarehouseCodes.wareHoseList;
            if ($("#" + warehouseSelectId).find("option").length == 1) {
                for (var i = 0; i < wareHoseList.length; i++) {
                    if (WarehouseCodes.currWareHose == wareHoseList[i].storageLocation) {
                        currwareCode = wareHoseList[i].orgCode;
                    }
                    $("#" + warehouseSelectId).append("<option value=" + wareHoseList[i].orgCode + " orgType=" + wareHoseList[i].orgType + " factory=" + wareHoseList[i].factory + " sapStoragelocation=" + wareHoseList[i].sapStorageLocation + "  storagelocation=" + wareHoseList[i].storageLocation + "  orgcode=" + wareHoseList[i].orgCode + " >" + wareHoseList[i].orgName + "</option>");
                }
                $("#" + warehouseSelectId).val(selectValue);
                layui.form.render("select");
            }
        }
    }

    /**
     * 加载单据类型
     */
    function inintBillType() {
        var contextPath = config.basicInfoConfig.contextPath
        var option = {
            url: contextPath + 'documentType/listByBusinessType?status=1&businessTypeStr=' + '1,2',
            type: "GET",
            success: function (result) {
                if (result.code == 0) {
                    var documentType = result.data;
                    for (var i = 0; i < documentType.length; i++) {
                        $("#billType_search").append("<option value=" + documentType[i].documentCode + "  >" + documentType[i].documentName + "</option>");
                    }
                    form.render();
                }
            }
        }
        $.ajax(option);
    }

    /**
     *  功能描述：多选下拉仓库
     *  permission  1-权限控制 0-不控制
     * @param warehouseSelectId 下拉框ID
     * @param xmselectId  多选的xmselect参数ID
     * @param selectValues 多选中的值
     * @param permission  1-权限控制 0-不控制
     * @returns
     */
    function initWarehouseMultiSelect(warehouseSelectId,xmselectId,permission,selectValues){
        var params={limit:0,sortColums:"org_code asc",permission:permission};
        var contextPath = config.basicInfoConfig.contextPath
        var option = {
            url:contextPath + 'orgnization/listWarehouse',
            type:"post",
            contentType: "application/json",
            dataType:'json',
            data:JSON.stringify(params),
            success:function(result){
                if(result.code==0){
                    var WarehouseCodes=result.data;
                    warehouseMultiSelect(WarehouseCodes,warehouseSelectId,xmselectId,selectValues);
                }
            }
        }
        $.ajax(option);
    }

    /**
     * 功能描述：渲染多选下拉框
     * @param WarehouseCodes  数据
     * @param warehouseSelectId   下拉框ID
     * @param xmselectId  多选的xmselect参数ID
     * @param selectValues 多选中的值 数据结构如["00500100","00500200"]
     * @returns
     */
    function warehouseMultiSelect(WarehouseCodes, warehouseSelectId,xmselectId,selectValues){
        if(WarehouseCodes.wareHoseList.length>0){
            //warehouseMultiLisenter(xmselectId);
            var optoinArray = new Array();
            var curWarehouse = WarehouseCodes.currWareHose;
            var wareHoseList = WarehouseCodes.wareHoseList;
            if(!selectValues){
                selectValues = new Array();
            }
            for(var i=0;i<wareHoseList.length;i++){
                var optionItem = {"name":""+wareHoseList[i].orgName, "value":""+wareHoseList[i].orgCode,"storagelocation":""+wareHoseList[i].storageLocation,"sapStoragelocation":wareHoseList[i].sapStorageLocation,"factory":wareHoseList[i].factory};
                optoinArray.push(optionItem);
                /*if(wareHoseList[i].storageLocation==curWarehouse){
                    selectValues.push(wareHoseList[i].orgCode);
                }*/
            }
            if($("#"+warehouseSelectId).find("option").length==1){
                layui.formSelects.data(xmselectId,'local',{
                    arr:optoinArray
                });
                layui.formSelects.value(xmselectId, selectValues,true);


            }
            layui.form.render("select");

        }
    }

    /**
     * 加载单据类型
     */
    function inintBillTypeMultiSelects(xmselectId,defualtValue){
        var contextPath = config.basicInfoConfig.contextPath
        var option = {
            url: contextPath + 'documentType/listByBusinessType?status=1&businessTypeStr=' + '1,2',
            type:"GET",
            success:function(result){
                if(result.code==0){
                    var documentType=result.data;
                    if (documentType.length>0){
                        var optoinArray = new Array();
                        for(var i=0;i<documentType.length;i++){
                            itemOption = {"name":""+documentType[i].documentName, "value":""+documentType[i].documentCode};
                            optoinArray.push(itemOption);
                        }
                        layui.formSelects.data(xmselectId,'local',{
                            arr:optoinArray
                        });
                        layui.formSelects.value(xmselectId, defualtValue,true);
                        layui.form.render("select");
                    }
                }
            }
        }
        $.ajax(option);
    }
</script>
<body id="bodyDiv">

</body>
</html>
