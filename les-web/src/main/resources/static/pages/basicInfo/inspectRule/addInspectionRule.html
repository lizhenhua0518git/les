<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="charset=UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <title>增加质检规则</title>
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css" type="text/css"/>
    <style type="text/css">
        .layui-table-cell {
            overflow: visible !important;
        }

        .layui-table-body {
            overflow: visible !important;
        }

        .layui-table-box, layui-table-view {
            overflow: visible !important;
        }
    </style>
</head>
<body id="bodyDiv">
<script type="text/html" id="bodyTpl">

    <div class="layui-fluid">
        <form class="layui-form" action="">
            <div class="layui-row layui-form">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">仓库</label>
                        <div class="layui-input-inline">
                            <select id="warehouse_search" xm-select="inWarehouseCodeSelect"
                                    xm-select-show-count="1">
                                <option value="">请选择</option>
                            </select></div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label layui-required">单据类型</label>
                        <div class="layui-input-inline">
                            <select id="billType_search" xm-select="inWarehouseCodeSelect"
                                    xm-select-show-count="1">
                                <option value="">请选择</option>
                            </select></div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">发货方</label>
                        <div class="layui-input-inline">
                            <input type="text" id="supplierCode" class="layui-input" placeholder="发货方编码">
                        </div>
                    </div>
                </div>

                <div class="layui-col-md2">
                    <div class="layui-btn-container" style="text-align: center;margin-top:20px">
                        <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="save" id="search"
                                type="button">保存
                        </button>
                        <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="reset" id="reset"
                                type="button"><i class="layui-icon layui-icon-reset"></i>重置
                        </button>
                    </div>
                </div>
            </div>
            <input type="text" name="inWarehouseName" id="inWarehouseName" hidden="true">
            <input type="text" name="outWarehouseName" id="outWarehouseName" hidden="true">
            <input type="text" name="billName" id="billName" hidden="true">
        </form>
    </div>
</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script type="text/javascript">
    var table = layui.table;
    var element = layui.element;
    var contextPath = config.basicInfoConfig.contextPath;
    var form = layui.form;
    var storage = window.localStorage;
    var token = storage.token;
    var layer = layui.layer;
    var chooseMaterialObj;
    var materialItem = 0;
    var dictItemValue;
    var factoryCodes = parent.factoryCodes;
    var active = {
        save: function (type) {
            var wareHose = $("#warehouse_search").find("option:selected");
            var bill = $("#billType_search").find("option:selected");
            var supplierCode = $("#supplierCode").val();
            if (bill.val() == '' || bill.text() ==null) {
                layer.msg("单据类型不能为空!");
                return;
            }
            var params = {};
            params.supplierCode = supplierCode;
            params.billCode = bill.val();
            params.billName = bill.text();
            params.wareHoseCode = wareHose.val();
            params.wareHoseName = wareHose.text();
            saveInspectionRule(params);

        },
        reset: function (type) {
            $("#warehouse_search").val("");
            $("#billType_search").val("");
            $("#supplierCode").val("");
            form.render('select');
        }
    };

    function saveInspectionRule(data) {
        var option = {
            url: contextPath + 'inspect/save',
            data: JSON.stringify(data),
            type: 'POST',
            contentType: 'application/json',
            dataType: 'json',
            success: function (res) {
                if (res.code == 0) {
                    var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                    parent.layer.close(index);  // 关闭layer,返回数据刷新
                    parent.table.reload('inspectionRuleTabId');
                } else if (res.code == -1233) {
                    layer.msg("质检规则重复");
                } else if (res.code == -1234) {
                    layer.msg("发货编码填写错误");
                } else {
                    layer.msg("保存失败");
                }
            }, error: function (res) {
                layer.msg("保存失败");
            }
        };
        $.ajax(option);
    }

    function loadding() {
        $('.layui-btn-container button').on('click', function () {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });
        //加载库存状态和库存类型
        var dictTypes = ["stock_type", "stock_status"]
        var selectItems = ["stockType", "stockStatus"]
        var defaultValues = ["", ""]
        dictItemValue = queryDictItems(dictTypes, selectItems, defaultValues);

        initWarehouseSignSelect("warehouse_search", 1, '');

        //加载单据类型
        inintBillType();
    }


    /**
     * 功能描述：单选下拉仓库
     * @param warehouseSelectId 下拉框ID
     * @param permission 1-权限控制 0-不控制
     * @param selectValue  选中的值
     * @returns
     */
    function initWarehouseSignSelect(warehouseSelectId, permission, selectValue) {
        var params = {limit: 0, sortColums: "org_code asc", permission: permission};
        var contextPath = config.basicInfoConfig.contextPath
        var option = {
            url: contextPath + 'orgnization/listWarehouse',
            type: "post",
            contentType: "application/json",
            dataType: 'json',
            data: JSON.stringify(params),
            success: function (result) {
                if (result.code == 0) {
                    var WarehouseCodes = result.data;
                    warehouseSignSelect(WarehouseCodes, warehouseSelectId, selectValue);
                }
            }
        }
        $.ajax(option);
    }

    /**
     * 功能描述：渲染单选下拉框
     * @param WarehouseCodes 数据
     * @param warehouseSelectId 下拉框ID
     * @param selectValue  选中的值
     * @returns
     */
    function warehouseSignSelect(WarehouseCodes, warehouseSelectId, selectValue) {
        if (WarehouseCodes.wareHoseList.length > 0) {
            var currwareCode;
            var wareHoseList = WarehouseCodes.wareHoseList;
            if ($("#" + warehouseSelectId).find("option").length == 1) {
                for (var i = 0; i < wareHoseList.length; i++) {
                    if (WarehouseCodes.currWareHose == wareHoseList[i].storageLocation) {
                        currwareCode = wareHoseList[i].orgCode;
                    }
                    $("#" + warehouseSelectId).append("<option value=" + wareHoseList[i].orgCode + " orgType=" + wareHoseList[i].orgType + " factory=" + wareHoseList[i].factory + " sapStoragelocation=" + wareHoseList[i].sapStorageLocation + "  storagelocation=" + wareHoseList[i].storageLocation + "  orgcode=" + wareHoseList[i].orgCode + " >" + wareHoseList[i].orgName + "</option>");
                }
                $("#" + warehouseSelectId).val(selectValue);
                layui.form.render("select");
            }
        }
    }

    /**
     * 加载单据类型
     */
    function inintBillType() {
        var contextPath = config.basicInfoConfig.contextPath
        var option = {
            url: contextPath + 'documentType/listByBusinessType?status=1&businessTypeStr=' + '1,2',
            type: "GET",
            success: function (result) {
                if (result.code == 0) {
                    var documentType = result.data;
                    for (var i = 0; i < documentType.length; i++) {
                        $("#billType_search").append("<option value=" + documentType[i].documentCode + "  >" + documentType[i].documentName + "</option>");
                    }
                    form.render();
                }
            }
        }
        $.ajax(option);
    }

    /**
     * 验证数据必填
     */
    function checkNeedWrite(data, checkNames) {
        var materialNum = null;
        for (var i = 0; i < data.length; i++) {
            materialNum = data[i].materialNum;
            var regu = /^(\+)?\d+(\.\d+)?$/;
            if (materialNum == "" || !regu.test(materialNum)) {
                return 1;
            }
            for (var j = 0; j < checkNames.length; j++) {
                if (data[i][checkNames[j]] == "") {
                    return 2;
                }
            }
        }
        if (data.length == 0) {
            return 0;
        }
    }

    function getFactoryName(factoryCodes, facotry) {
        var resultStr = "";
        for (var i = 0; i < factoryCodes.length; i++) {
            if (facotry == factoryCodes[i].modelCode) {
                resultStr = factoryCodes[i].modelName;
                break;
            }
        }
        return resultStr;
    }

    /* function loadStockStatus(d){

        return '<select  id="outStorageLocation" name="outStorageLocation"><option value="">请选择</option><option value="">2</option><option value="">1</option></select>';
    }
    function loadStockType(d){

        return '<select  id="outStorageLocation" name="outStorageLocation"><option value="">请选择</option><option value="">2</option><option value="">1</option></select>';
    } */
</script>
</body>

</html>