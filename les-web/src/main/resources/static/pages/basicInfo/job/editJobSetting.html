<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>编辑任务调度</title>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
</head>
<body>
<div id="bodyDiv">

</div>
<div class="layui-container" style="padding-top: 20px;">
		<form class="layui-form" action="" lay-filter="jobForm">
			<div class="layui-form-item">
				<div class="layui-inline">
				    <label class="layui-form-label">任务名称</label>
				    <div class="layui-input-block">
				      <input type="text" name="jobName" id="jobName" lay-verify="required" autocomplete="off" placeholder="请输入任务名称" class="layui-input">
				    </div>
			 	</div>
			 	<div class="layui-inline">
				    <label class="layui-form-label">任务编号</label>
				    <div class="layui-input-block">
				      <input type="text" name="jobCode" id="jobCode"  autocomplete="off" placeholder="请输入任务编号" lay-verify="jobCode" class="layui-input" >
				    </div>
			 	</div>
			 </div>
			 <div class="layui-form-item">
			 	<div class="layui-inline">
				    <label class="layui-form-label">任务接口类</label>
				    <div class="layui-input-block">
				      <input type="text" name="jobClassName" id="jobClassName" lay-verify="required" autocomplete="off" placeholder="请输入任务接口类" class="layui-input">
				    </div>
			 	</div>
			 	<div class="layui-inline">
				    <label class="layui-form-label">调用方式</label>
				    <div class="layui-input-block">
				    	<select name="jobGroup" id="jobGroup" lay-verify="required"  lay-filter ="jobGroupf" class="layui-select">
						  <option value=""></option>
						</select>
				    </div>
			 	</div>
			 </div>
			  <div class="layui-form-item">
			 	<div class="layui-inline" style="display:none" id="intervalDiv">
				    <label class="layui-form-label">间隔时间</label>
				    <div class="layui-input-block">
				      <input type="text" name="intervalTime" id="intervalTime"  autocomplete="off" placeholder="请输入任务间隔时间" class="layui-input">
				    </div>
			 	</div>
			 	<div class="layui-inline" style="display:none" id="cronDiv">
				    <label class="layui-form-label">定时时间</label>
				    <div class="layui-input-block">
				      <input type="text" name="cron" id="cron"  autocomplete="off" placeholder="请输入任务定时时间" class="layui-input">
				    </div>
			 	</div>
			 </div>
			 <div class="layui-form-item">
			 	<div class="layui-inline">
				    <label class="layui-form-label">任务处理类型</label>
				    <div class="layui-input-block">
				    	<select name="type" id="type" lay-verify="required"  lay-filter ="type" class="layui-select">
						   <option value="0">类处理</option>
						   <option value="1">接口处理</option>
						</select>
				    </div>
			 	</div>
				
			 	<div class="layui-inline">
				    <label class="layui-form-label">接口处理地址</label>
				    <div class="layui-input-block">
				    	<input type="text" name="url" id="url"  autocomplete="off" placeholder="请输入接口处理地址" class="layui-input">
				    </div>
			 	</div>
			 </div>
			 <div class="layui-form-item">
				<div class="layui-inline">
				    <label class="layui-form-label">任务描述</label>
				    <div class="layui-input-block">
				     	 <textarea placeholder="请输入任务描述信息" class="layui-textarea" name="jobDesc" id="jobDesc"></textarea>
				    </div>
			 	</div>
			 	<div class="layui-inline" style="display:none">
				    <label class="layui-form-label">状态</label>
				    <div class="layui-input-block">
				      <select name="status" id="status" lay-verify="required" class="layui-select">
						  <option value=""></option>
						</select>
				    </div>
			 	</div>
			 </div>
			 <div class="layui-form-item">
			    <div class="layui-input-block">
			      <button class="layui-btn" lay-submit="" lay-filter="jobSetSubit">立即提交</button>
			      <button type="reset" class="layui-btn layui-btn-primary">重置</button>
			    </div>
			  </div>
			  <input type="text" hidden="true" name="id"/>
		</form>
	</div>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
 
	<script src="/iles/pages/js/loginInspect.js"></script>
 
	<script type="text/html" id="bodyTpl"></script>
	<script type="text/javascript">
	 var contextPath = config.quartzConfig.contextPath;
		var $ = layui.$;
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form
		var dictItems = parent.dictItems;
		var oldData = parent.oldData;
		function loadding(){}
		layui.use(['form', 'layedit'], function(){
			form.verify({
				jobName: function(value){
				      if(value.length < 1){
				        return '任务名称不能为空';
				      }
				      if(value.length>32)
				    	  return '任务名称超长，不能超过32个字符';
				},jobCode:function(value){
				   if(value.length < 1){
				        return '任务编号不能为空';
				      }
			       if(value.length>32)
			    	  return '任务编号超长，不能超过32个字符';
				},intervalTime:function(value){
					 if(value.length < 1)
					     return '间隔时间不能为空';
					 if(value.length>32)
					     return '间隔时间超长，不能超过32个字符';
				}
			  });
			  //监听提交
			  form.on('submit(jobSetSubit)', function(data){
				  data.field.id = oldData[0].id;//防止重置后id丢失
				  saveJobSetting(data);
				  return false;
			 });
		});
		 form.on('select(type)',function(res){
			 var flg = false;
			 if(res.value=="0"){
				 $("#jobName").attr("lay-verify","required");
				 $("#jobClassName").attr("lay-verify","required");
				 $("#url").attr("lay-verify","");
			 }else if(res.value=="1"){
				 $("#jobName").attr("lay-verify","");
				 $("#jobClassName").attr("lay-verify","");
				 $("#url").attr("lay-verify","required");
				
			 }
		 });
		function saveJobSetting(data){
			var option = {
		    	url:contextPath+'jobSetting/updateJobSetting',
		    	data:JSON.stringify(data.field),
		    	type:'POST',
		    	contentType:'application/json',
		    	success:function(data){
		    		if(data.code==0){
		    			var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
		    			parent.layer.close(index);  // 关闭layer
		    			parent.parentId = "";
		    			parent.table.reload('jobSetTabId');
		    		}else{
		    			layer.alert(data.msg);
		    		}
		    	},error:function(data){
		    		layer.alert(data.msg)
		    	}
		    }
		    $.ajax(option); 
		}
	 //状态设置下拉选项开始
	 if(dictItems && dictItems.length>0){
		 defulatSelect(dictItems);
	 }else{
		 queryDictItem(); 
	 }
	 function queryDictItem(){
		  var dictType = new Array();
			dictType.push("enable");
			dictType.push("job_group");
			//查询字典
			var option={
					url:config.basicInfoConfig.contextPath+'dictItems/listDictItemByTypes',
					type:'POST',
					dataType:'json',
					contentType: "application/json",
					data:JSON.stringify(dictType),
					success:function(res){
						if(res.code==0){
							dictItems = res.data
							defulatSelect(res.data);
						}
					}
  			};
			$.ajax(option);
	  }
	  function defulatSelect(dictItems){
		  if(dictItems && dictItems.length>0){
			  for(var i=0;i<dictItems.length;i++){
				  if(dictItems[i].dictTypeId=="enable"){
					  $("#status").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
				  }else if(dictItems[i].dictTypeId=="job_group"){
					  $("#jobGroup").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
				  }
			  }
			  $("#status").val("0");
			  form.render('select');
		  }
	  }
	  form.on("select(jobGroupf)",function(res){
		  if(res.value=="0"){
			  $("#intervalDiv").show();
			  $("intervalTime").attr("lay-verify","intervalTime");
			  $("#cron").removeAttr("lay-verify");
			  $("#cronDiv").hide();
			  $("#cron").val("");
		  }else if(res.value=="1"){
			  $("#intervalDiv").hide();
			  $("#intervalTime").val("");
			  $("#cronDiv").show();
			  $("#cron").attr("lay-verify","required");
			  $("#intervalTime").removeAttr("lay-verify");
		  }
	  });
	  if(oldData && oldData.length>0){
		  var formData =  eval('('+JSON.stringify(oldData[0])+')');
		  form.val('jobForm',formData);
		  if(formData.jobGroup==0){
			  $("#intervalDiv").show();
		  }else if(formData.jobGroup==1){
			  $("#cronDiv").show();
		  }
	  }
	</script>
</body>
</html>