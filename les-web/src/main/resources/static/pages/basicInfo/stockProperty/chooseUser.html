<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<title>设置人员</title>
</head>
<body>
<div id="bodyDiv">

</div>

<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script type="text/html" id="toolBar">
     <button type="button" class="layui-btn layui-btn-normal" id="del" lay-event="del">删除</button>
 </script>
<script type="text/html" id="bodyTpl">
<div style="padding: 20px; background-color: #F2F2F2;">
	<div class="layui-row layui-col-space15" style="position:relative;float:left;width:42%;height:100%;margin-top:24px">


    <div>
      <div class="layui-card">
        <div class="layui-card-header">当前对应用户</div>
        <div class="layui-card-body">
        	<div class="layui-collapse">
			  	<div class="layui-colla-item">

				    <div class="layui-colla-content">

				    </div>
			  	</div>
			  </div>
		     <table class="layui-hide" id="currUserTab" lay-filter="currUserTabF"></table>
        </div>
      </div>
    </div>
 </div>
 <div class="layui-row layui-form" style="margin-bottom: 0;position:relative;margin-top:111px;float:left;width:10%;">
		<div class="layui-col-md5">&nbsp;</div>
		<div class="layui-col-md5">
			<div class="layui-btn-container" style="text-align: center;margin-top:15px;">
			  <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="up" data-type="auto"><!-- <i class="layui-icon">&#xe61f;</i> -->左移</button>

			</div>
		</div>
	</div>
 <div class="layui-row layui-col-space15" style="position:relative;float:right;width:42%;height:100%;margin-top:24px;margin-left:-10px">
    <div>
      <div class="layui-card">
        <div class="layui-card-header"></div>
        <div class="layui-card-body">
        	<div class="layui-collapse">
			  	<div class="layui-colla-item">
				    <h2 class="layui-colla-title">检索信息</h2>
				    <div class="layui-colla-content">
				      	<div class="layui-fluid">
							<div class="layui-row layui-form">
								 <div class="layui-col-md6">
								 	<label class="layui-form-label">用户姓名:</label>
								 	 <div class="layui-input-block">
								      <input type="text" id="userName_search_n" class="layui-input">
								    </div>
								 </div>
								 <div class="layui-col-md6">
								 	<label class="layui-form-label">用户组织:</label>
								 	 <div class="layui-input-block">
								      <input type="text" id="orgId_search_n" class="layui-input">
								    </div>
								 </div>
							</div>
							<div class="layui-row layui-form" style="margin-bottom: 0">
								<div class="layui-col-md6">&nbsp;</div>
								<div class="layui-col-md6">
									<div class="layui-btn-container" style="text-align: right;">
									  <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="searchN"><i class="layui-icon">&#xe615;</i>查询</button>
									  <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="resetN"><i class="mine-icon">&#xe640;</i>重置</button>
									</div>
								</div>
							</div>
						</div>
				    </div>
			  	</div>
			  </div>
		    <table class="layui-hide" id="userTab" lay-filter="userTabF"></table>
        </div>
      </div>
    </div>
 </div>

</div>

</script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js"></script>
<script type="text/javascript">
	var contextPath = config.basicInfoConfig.contextPath;
	var element = layui.element;
	var layer = layui.layer;
	var table = layui.table;
	var teamLeader = parent.$("#teamLeader").val();
	var businessLeader = parent.$("#businessLeader").val();
	var sapManager = parent.$("#sapManager").val();
	var minister = parent.$("#minister").val();
	var businessManager = parent.$("#businessManager").val();
	var materialControl = parent.$("#materialControl").val();

	var businessLeaderId = parent.$("#businessLeaderId").val();
	var teamLeaderId = parent.$("#teamLeaderId").val();
	var sapManagerId = parent.$("#sapManagerId").val();
	var ministerId = parent.$("#ministerId").val();

	var businessManagerId = parent.$("#businessManagerId").val();
	var materialControlId = parent.$("#materialControlId").val();
	var orgId = parent.$("#orgId").val();


	var currUserData= new Array();
	var  userType= getQueryVariable("userType");


	if(userType==1  ){
		if(teamLeader!=null && teamLeader !=''){
			currUserData.push($.parseJSON('{"userName":'+'"'+teamLeader+'"'+'  ,"orgId":'+'"'+orgId+'"'+',"userId":'+'"'+teamLeaderId+'"'+'}'));
		}
	}else if(userType==2){
		if(businessLeader!=null && businessLeader !=''){
			var businessLeaderArray= businessLeader.split(";");
			var businessLeaderIdArray= businessLeaderId.split(";");
			var orgIdArray= orgId.split(";");
			for(i=0;i<businessLeaderArray.length;i++){
				currUserData.push($.parseJSON('{"userName":'+'"'+businessLeaderArray[i]+'"'+'  ,"orgId":'+'"'+orgIdArray[i]+'"'+',"userId":'+'"'+businessLeaderIdArray[i]+'"'+'}'));
			}

		}
	}
	else if(userType==3){
		if(sapManager!=null && sapManager !=''){
			var sapManagerArray= sapManager.split(";");
			var sapManagerIdArray= sapManagerId.split(";");
			var orgIdArray= orgId.split(";");
			for(i=0;i<sapManagerArray.length;i++){
			currUserData.push($.parseJSON('{"userName":'+'"'+sapManagerArray[i]+'"'+'  ,"orgId":'+'"'+orgIdArray[i]+'"'+',"userId":'+'"'+sapManagerIdArray[i]+'"'+'}'));
			}
	}
	}else if(userType==4){
		if(minister!=null && minister !=''){
			currUserData.push($.parseJSON('{"userName":'+'"'+minister+'"'+'  ,"orgId":'+'"'+orgId+'"'+',"userId":'+'"'+ministerId+'"'+'}'));
		}
	}

	else if(userType==6){
		if(materialControl!=null && materialControl !=''){
			var materialControlArray= materialControl.split(";");
			var materialControlIdArray= materialControlId.split(";");
			var orgIdArray= orgId.split(";");
			for(i=0;i<materialControlArray.length;i++){
			currUserData.push($.parseJSON('{"userName":'+'"'+materialControlArray[i]+'"'+'  ,"orgId":'+'"'+orgIdArray[i]+'"'+',"userId":'+'"'+materialControlIdArray[i]+'"'+'}'));
			}
	}
	}else if(userType==5){
		if(businessManager!=null && businessManager !=''){
			currUserData.push($.parseJSON('{"userName":'+'"'+businessManager+'"'+'  ,"orgId":'+'"'+orgId+'"'+',"userId":'+'"'+businessManager+'"'+'}'));
		}
	}
	var active = {
			up:function(othis){
				var checkStatus = table.checkStatus('userTabId');
  				var userData = checkStatus.data;
  				var allData =  table.cache["currUserTabId"];
  				while (allData.length >0) {
  					if(allData[i]==null){
 						 allData.splice(i,1);
 					}
  				}


				if(userData.length<=0){
					layer.alert('请选择要左移的行！',{icon: 2});
  					return ;
				}
				if(userType==1){
					if(userData.length>1){
						layer.alert('班组长只能选择一位！',{icon: 2});
	  					return ;
					}


					if(allData.length>0 && allData[0].length !=0){
						layer.alert('已经选择过班组长了！',{icon: 2});
	  					return ;
					}
				}else if(userType==4){
					if(userData.length>1){
						layer.alert('分管副部长只能选择一位！',{icon: 2});
	  					return ;
					}

					if(allData.length>0 && allData[0].length !=0){
						layer.alert('已经选择过分管副部长了！',{icon: 2});
	  					return ;
					}
				}else if(userType==5){
					if(userData.length>1){
						layer.alert('业务经理只能选择一位！',{icon: 2});
	  					return ;
					}

					if(allData.length>0 && allData[0].length !=0){
						layer.alert('已经选择过业务经理了！',{icon: 2});
	  					return ;
					}
				}

				var tempData = allData;
				var userName ="";
				var userId ="";
				var orgId ="";

				for(var i=0;i<userData.length;i++){

					tempData.push($.parseJSON('{"userName":'+'"'+userData[i].userName+'"'+'  ,"orgId":'+'"'+userData[i].orgId+'"'+',"userId":'+'"'+userData[i].id+'"'+'}'));

				}

			      table.reload("currUserTabId", {
						data:tempData,
						page: false,
						done:function(e){
							console.log(e);
						}
					});
			      userData =  table.cache["currUserTabId"];
			      for(var i=0;i<userData.length;i++){
			    	  if(userData[i].length<1){
			    		  continue;
			    	  }


						 userName=userName+userData[i].userName+";";
						 userId=userId+userData[i].userId+";";
						orgId =orgId +userData[i].orgId+";";

					}
					 parent.$("#orgId").val(orgId.substring(0,userId.length-1));
					if(userType==1){
						 parent.$("#teamLeader").val(userName.substring(0,userName.length-1)) ;
						 parent.$("#teamLeaderId").val(userId.substring(0,userId.length-1));

						}
					else if(userType==2){
							parent.$("#businessLeader").val(userName.substring(0,userName.length-1)) ;
							parent.$("#businessLeaderId").val(userId.substring(0,userId.length-1));

						}
					else if(userType==3){

						  parent.$("#sapManager").val( userName.substring(0,userName.length-1)) ;
						  parent.$("#sapManagerId").val(userId.substring(0,userId.length-1));

						}
					else if(userType==4){
						 parent.$("#minister").val(userName.substring(0,userName.length-1)) ;
						 parent.$("#ministerId").val(userId.substring(0,userId.length-1));

						}

					else if(userType==5){
						 parent.$("#businessManager").val(userName.substring(0,userName.length-1)) ;
						 parent.$("#businessManagerId").val(userId.substring(0,userId.length-1));

						}

					else if(userType==6){
						 parent.$("#materialControl").val(userName.substring(0,userName.length-1)) ;
						 parent.$("#materialControlId").val(userId.substring(0,userId.length-1));

						}
				 table.reload('userTabId');



			}
			 ,search:function(othis){
				var userName = $('#userName_search');
				var orgId = $('#orgId_search');
			      //执行重载
			      table.reload('currUserTabId', {
			        where:{
			           userName: userName.val()
			           ,orgId:orgId.val()
			        }
			        ,page:{"curr":1}
			      });
			},reset:function(othis){
				$('#userName_search').val("");
				$('#orgId_search').val("");
			},searchN:function(othis){
				var userName = $('#userName_search_n');
				var orgId = $('#orgId_search_n');
			      //执行重载
			      table.reload('userTabId', {
			        where:{
			           userName: userName.val()
			           ,orgId:orgId.val()
			        }
			        ,page:{"curr":1}
			      });
			},resetN:function(othis){
				$('#userName_search_n').val("");
				$('#orgId_search_n').val("");

			}
	};
	function getQueryVariable(variable)
	 {
	        var query = window.location.search.substring(1);
	        var vars = query.split("&");
	        for (var i=0;i<vars.length;i++) {
	                var pair = vars[i].split("=");
	                if(pair[0] == variable){
	                	return pair[1];
	                }
	        }
	        return(false);
	 }
	function loadding(){
		//未设置用户
		table.render({
			elem:'#userTab',
			id:'userTabId',
			url:config.basicInfoConfig.contextPath+'user/queryNoRoleUser',
			cols:[[
			{type:'checkbox'},

			{field:'userName',width:'40%',title:'用户姓名'},

			{field:'orgId', width:'40%', title: '用户组织'},


			]],
			page: {theme: '#008155'},
			where:{"roleId":''},
			//height: 'full-95',
			even:true,
			request: {
				  pageName: 'pageNumber' //页码的参数名称，默认：page
				  ,limitName: 'pageSize' //每页数据量的参数名，默认：limit
				},
			done:function(res,page,count){//列表数据回调函数

			}
		});
		//当前对应用户
		table.render({
			elem:'#currUserTab',
			id:'currUserTabId',
			data:currUserData,
			cols:[[
			//{type:'checkbox'},

			{field:'userName',width:'30%',title:'用户姓名'},

		/* 	{field:'orgId', width:'30%', title: '用户组织'}, */

			{fixed:'right',align:'center',title:'操作', toolbar:'#toolBar'}

			]],
			page: false,

			//height: 'full-95',
			even:true,

			done:function(res,page,count){//列表数据回调函数

			}
		});

		$('.layui-btn-container button').on('click', function(){
		    var othis = $(this), method = othis.data('method');
		    active[method] ? active[method].call(this, othis) : '';
	  	});
		//监听工具条
		  table.on('tool(currUserTabF)', function(obj){
		    var data = obj.data;
			var allData =  table.cache["currUserTabId"];
		      if(obj.event === 'del'){
		      layer.confirm('真的删除记录吗', function(index){
		    	  for(i =0;i<allData.length;i++){
			    		var tempData = allData[i];
			    	 if(tempData.userId==data.userId){
			    		 allData.splice(i,1);
			    		 break;
			    	 }

			    	}
		    	  var userName ="";
					var userId ="";
					var orgId ="";
		    	  for(var i=0;i<allData.length;i++){

						 userName=userName+allData[i].userName+";";
						 userId=userId+allData[i].userId+";";
						orgId =orgId +allData[i].orgId+";";

					}
					 parent.$("#orgId").val(orgId.substring(0,userId.length-1));
					if(userType==1){
						 parent.$("#teamLeader").val(userName.substring(0,userName.length-1)) ;
						 parent.$("#teamLeaderId").val(userId.substring(0,userId.length-1));

						}
					else if(userType==2){
							parent.$("#businessLeader").val(userName.substring(0,userName.length-1)) ;
							parent.$("#businessLeaderId").val(userId.substring(0,userId.length-1));

						}
					else if(userType==3){

						  parent.$("#sapManager").val( userName.substring(0,userName.length-1)) ;
						  parent.$("#sapManagerId").val(userId.substring(0,userId.length-1));

						}
					else if(userType==4){
						 parent.$("#minister").val(userName.substring(0,userName.length-1)) ;
						 parent.$("#ministerId").val(userId.substring(0,userId.length-1));

						}

					else if(userType==5){
						 parent.$("#businessManager").val(userName.substring(0,userName.length-1)) ;
						 parent.$("#businessManagerId").val(userId.substring(0,userId.length-1));

						}

					else if(userType==6){
						 parent.$("#materialControl").val(userName.substring(0,userName.length-1)) ;
						 parent.$("#materialControlId").val(userId.substring(0,userId.length-1));

						}
		        obj.del();
		        layer.close(index);



		      });
		    }
		  });
	}








	</script>


</body>
</html>
