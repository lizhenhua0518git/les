<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<!--<meta name="viewport"-->
<!--	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />-->
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<title>设置组织</title>
</head>
<body>
 <div id="bodyDiv">

</div>
<script type="text/html" id="bodyTpl">
	<div style="padding: 20px; background-color: #F2F2F2;">
  		<div class="layui-row layui-col-space15" style="position:relative;float:left;width:42%;height:100%;margin-top:24px">
		    <div>
		      <div class="layui-card">
		        <div class="layui-card-header">已维护仓库</div>
		        <div class="layui-card-body">
		        	<div class="layui-collapse">
					  	<div class="layui-colla-item">
						    <h2 class="layui-colla-title">检索信息</h2>
						    <div class="layui-colla-content">
						      	<div class="layui-fluid">
									<div class="layui-row layui-form">
										 <div class="layui-col-md6">
										 	<label class="layui-form-label">仓库名称:</label>
										 	 <div class="layui-input-block">
										      <input type="text" id="warehouseName_search" class="layui-input">
										    </div>
										 </div>
										 <div class="layui-col-md6">
										 	<label class="layui-form-label">仓库编码:</label>
										 	 <div class="layui-input-block">
										      <input type="text" id="warehouseCode_search" class="layui-input">
										    </div>
										 </div>
									</div>
									<div class="layui-row layui-form" style="margin-bottom: 0">
										<div class="layui-col-md6">&nbsp;</div>
										<div class="layui-col-md6">
											<div class="layui-btn-container" style="text-align: right;">
											  <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search"><i class="layui-icon">&#xe615;</i>查询</button>
											  <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset"><i class="mine-icon">&#xe640;</i>重置</button>
											</div>
										</div>
									</div>
								</div>
						    </div>
					  	</div>
					  </div>
				     <table class="layui-hide" id="currOrgTab" lay-filter="currUserOrgF"></table>
		        </div>
		      </div>
		    </div>
		 </div>
		 <div class="layui-row layui-form" style="margin-bottom: 0;position:relative;margin-top:111px;float:left;width:10%;">
				<div class="layui-col-md5">&nbsp;</div>
				<div class="layui-col-md5">
					<div class="layui-btn-container" style="text-align: left;margin-top:15px;">
					  <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="up" data-type="auto"><!-- <i class="layui-icon">&#xe61f;</i> -->左移</button>
					  <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="down" style="margin-top:30px;"><!-- <i class="layui-icon">&#xe642;</i> -->右移</button>
					</div>
				</div>
			</div>
		 <div class="layui-row layui-col-space15" style="position:relative;float:right;width:42%;height:100%;margin-top:24px">
		    <div id="treeTabeDiv">
		      <div class="layui-card">
		        <div class="layui-card-header">未维护仓库</div>
		        <div class="layui-card-body">
		        	<div class="layui-collapse">
					  	<div class="layui-colla-item">
						    <h2 class="layui-colla-title">检索信息</h2>
						    <div class="layui-colla-content">
						      	<div class="layui-fluid">
									<div class="layui-row layui-form">
										 <div class="layui-col-md6">
										 	<label class="layui-form-label">仓库名称:</label>
										 	 <div class="layui-input-block">
										      <input type="text" id="warehouseName_search_n" class="layui-input">
										    </div>
										 </div>
										 <div class="layui-col-md6">
										 	<label class="layui-form-label">仓库编码:</label>
										 	 <div class="layui-input-block">
										      <input type="text" id="warehouseCode_search_n" class="layui-input">
										    </div>
										 </div>
									</div>
									<div class="layui-row layui-form" style="margin-bottom: 0">
										<div class="layui-col-md6">&nbsp;</div>
										<div class="layui-col-md6">
											<div class="layui-btn-container" style="text-align: right;">
											  <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="searchN"><i class="layui-icon">&#xe615;</i>查询</button>
											  <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="resetN"><i class="mine-icon">&#xe640;</i>重置</button>
											</div>
										</div>
									</div>
								</div>
						    </div>
					  	</div>
					  </div>
				    <table class="layui-hide" id="orgTab" lay-filter="orgTabF"></table>
		        </div>
		      </div>
		    </div>
		 </div>
	</div>
</script>
	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
	<script src="/iles/pages/layui/lay/modules/treeGrid.js" charset="UTF-8"></script>
	<script src="/iles/pages/assets/js/jquery-1.10.2.js"></script>
	<script src="/iles/pages/js/loginInspect.js"></script>
	<script type="text/javascript">
	var contextPath = config.basicInfoConfig.contextPath;
	var element = layui.element;
	var treeGrid = layui.treeGrid;
	var layer = layui.layer;
	var table = layui.table;
	var userId = parent.userId;
	var active = {
			up:function(othis){
				var checkStatus = table.checkStatus('orgTabId');
  				var userData = checkStatus.data;
  				console.log(userData);
				if(userData.length<=0){
					layer.alert('请选择要左移的行！',{icon: 2});
  					return ;
				}
				var tempData = "";
				for(var i=0;i<userData.length;i++){
					tempData = tempData + "{'userId':'"+userId+"','orgId':"+"'"+userData[i].wareHouseId+"'"+",'wareHouseName':'"+userData[i].wareHouseName+"','wareHouseCode':'"+userData[i].wareHouseCode+"'},";
				}
				tempData = "["+tempData.substring(0,tempData.length-1)+"]";
				console.log(tempData);
				var option = {
						url:contextPath+'user/saveUserWareHouse',
					   // url:contextPath+'user/saveUserOrganization',
						type:'POST',
						data: JSON.stringify(eval('('+tempData+')')),
			        	contentType:'application/json',
						success:function(res){
							if(res.code==0){//成功后刷新列表
								table.reload('currUserOrgId');
								table.reload('orgTabId');
								//treeGrid.reload('orgTabId');
							}
						}
				};
				$.ajax(option);
			}
			,down:function(othis){
				var checkStatus = table.checkStatus('currUserOrgId');
  				var userData = checkStatus.data;
				if(userData.length<=0){
					layer.alert('请选择要右移的行！',{icon: 2});
  					return ;
				}
				var tempData = new Array();
				for(var i=0;i<userData.length;i++){
					tempData.push(userData[i].id);
				}
				var option = {
						url:contextPath+'user/removeUserOrganization',
						type:'POST',
						data: JSON.stringify(tempData),
			        	contentType:'application/json',
						success:function(res){
							if(res.code==0){//成功后刷新列表
								table.reload('currUserOrgId');
								table.reload('orgTabId');
								//treeGrid.reload('orgTabId');
							}
						}
				};
				$.ajax(option);
			},search:function(othis){
				var warehouseName = $('#warehouseName_search');
				var warehouseCode = $('#warehouseCode_search');
			      //执行重载
			      table.reload('currUserOrgId', {
			        where:{
			        	warehouseName: warehouseName.val()
			           ,warehouseCode:warehouseCode.val()
			           ,userId:userId
			        }
			        ,page:{"curr":1}
			      });
			},reset:function(othis){
				$('#warehouseName_search').val("");
				$('#warehouseCode_search').val("");
			},searchN:function(othis){
				var orgName = $('#warehouseName_search_n');
				var orgCode = $('#warehouseCode_search_n');
			      //执行重载
			      treeGrid.reload('orgTabId', {
			        where:{
			        	orgName: orgName.val()
			           ,orgCode:orgCode.val()
			           ,userId:userId
			        }
			      });
			},resetN:function(othis){
				$('#warehouseName_search_n').val("");
				$('#warehouseCode_search_n').val("");

			}
	};
	function loadding(){

		table.render({
			            elem: '#orgTab'
			            ,id:'orgTabId'
			           // , data: datatable
			           //  ,url:contextPath+'orgnization/orgnizationList'

			          ,url:contextPath+'user/listUserWareHouse'
			            , cellMinWidth: 100
			            // , treeId: 'id'//树形id字段名称
			            // , treeUpId: 'parentId'//树形父id字段名称
			            // , treeShowName: 'orgName'//以树形式显示的字段
			            , cols: [[
			                {type: 'checkbox'}
			                ,{field:'wareHouseName', title: '仓库名称'}
			                ,{field:'wareHouseCode', title: '仓库编号'}
			            ]]
				        ,page: true
				        ,where:{"userId":userId}
			    		,even:true
			    		,done:function(res,page,count){//列表数据回调函数

			    		}
			        });
		//当前对应用户
		table.render({
			elem:'#currOrgTab',
			id:'currUserOrgId',
			url:contextPath+'user/listHasOrgUser',
			cols:[[
			{type:'checkbox'},
			{field:'warehouseName',title:'仓库名称'},
			{field:'warehouseCode', title: '仓库编号'},

			]],
			page: {theme: '#008155'},
			where:{"userId":userId},
			//height: 'full-95',
			even:true,
			done:function(res,page,count){//列表数据回调函数

			}
		});
		$('.layui-btn-container button').on('click', function(){
		    var othis = $(this), method = othis.data('method');
		    active[method] ? active[method].call(this, othis) : '';
	  	});

		//给表格的复选框增加 监听事件
		// treeGrid.on('checkbox(orgTabF)',function(obj){
		// 	 if(obj.type=="one"){
		// 		 var checkObj = $("#treeTabeDiv").find("input[name=layTableCheckbox]");
		// 		 checekBoxCtl(obj.data,checkObj,obj.checked);
		// 	 }
		//
		// });

	}
	//递归选中节点下面的所有子节点
	function checekBoxCtl(obj,checkObj,flg){
		var tempIndex;
		if(obj.children.length>0){
			for(var i=0;i<obj.children.length;i++){
				obj.children[i].LAY_CHECKED = flg;
				tempIndex = obj.children[i].LAY_TABLE_INDEX;
				if(flg)
					checkObj[tempIndex+1].nextSibling.className +=" layui-form-checked";
				else
					checkObj[tempIndex+1].nextSibling.className = checkObj[tempIndex+1].nextSibling.className.replace("layui-form-checked","");
				checekBoxCtl(obj.children[i],checkObj,flg);
			}
		}
	}


	</script>
</body>
</html>
