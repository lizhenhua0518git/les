<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="${ctx}/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="${ctx}/pages/css/layui_extend.css"  media="all">
<title>查看异常提醒</title>
<style type="text/css">
.layui-form-label{
	float: left;
    display: block;
    padding: 9px 15px;
    width: 100px;
    font-weight: 400;
    line-height: 20px;
    text-align: right;
}
.layui-input-block{
	margin-left: 130px;
    min-height: 36px;
}
</style>
</head>
<body>
	<div class="layui-container" style="padding-top: 20px;">
	 <form class="layui-form" action="" lay-filter="abnormalDetialForm">
 		<div class="layui-form-item">
			<div class="layui-inline">
				<label class="layui-form-label">异常类型</label>
				<div class="layui-input-block">
		      		<input type="text" name="abnormalType" style="border:none" readonly="readonly"  id="abnormalType" class="layui-input" >
			   </div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">异常节点</label>
				<div class="layui-input-block">
				    <input type="text" name="abnormalNode" style="border:none" readonly="readonly"  id="abnormalNode" class="layui-input" >
			   </div>
			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-inline">
			    <label class="layui-form-label">发起人</label>
			    <div class="layui-input-block">
			      <input name="defualtUid" id="defualtUid" value="" hidden="true" />
			      <input type="text" name="recordUid" id="recordUid" style="border:none" readonly="readonly" class="layui-input">
			    </div>
		 	</div>
		 	<div class="layui-inline">
				    <label class="layui-form-label">发起时间</label>
				    <div class="layui-input-block">
				      <input type="text" name="recordTime" id="recordTime" style="border:none" readonly="readonly" class="layui-input">
				    </div>
			 </div>
		</div>
		<div class="layui-form-item">
			<div class="layui-inline">
			    <label class="layui-form-label">初始归口人</label>
			    <div class="layui-input-block">
			      <input name="defualtUid" id="defualtUid" value="" hidden="true" />
			      <input type="text" name="defualtName" id="defualtName" style="border:none" readonly="readonly" class="layui-input">
			    </div>
		 	</div>
		 	<div class="layui-inline">
				    <label class="layui-form-label">归口负责人</label>
				    <div class="layui-input-block">
				      <input name="chargeUid" id="chargeUid" value="" hidden="true" />
				      <input type="text" name="chargeName" id="chargeName" style="border:none" readonly="readonly" class="layui-input">
				    </div>
			 </div>
		 </div>
		 <div class="layui-form-item">
			<div class="layui-inline">
			    <label class="layui-form-label">归口经理人</label>
			    <div class="layui-input-block">
			      <input name="manageUid" id="manageUid" value="" hidden="true" />
			      <input type="text" name="manageName" id="manageName" style="border:none" readonly="readonly" class="layui-input">
			    </div>
		 	</div>
			<div class="layui-inline">
			    <label class="layui-form-label">归口总负责人</label>
			    <div class="layui-input-block">
			      <input name="mchargeUid" id="mchargeUid" value="" hidden="true" />
			      <input type="text" name="mchargeName" id="mchargeName" style="border:none" readonly="readonly" class="layui-input">
			    </div>
		 	</div>
		 </div>
		 
		<div class="layui-form-item">
			 <div class="layui-inline">
			    <label class="layui-form-label">上报时间(H)</label>
			    <div class="layui-input-block">
		      		<input type="text" name="reportTime" id="reportTime" style="border:none" readonly="readonly" class="layui-input">
		    	</div>
			 </div>
			 <div class="layui-inline">
			    <label class="layui-form-label">到货通知单号</label>
			    <div class="layui-input-block">
		      		<input type="text" name="arrivalCode" id="arrivalCode" style="border:none" readonly="readonly" class="layui-input">
		    	</div>
			 </div>
		 </div>
		 <div class="layui-form-item">
			 <div class="layui-inline">
			    <label class="layui-form-label">行项目号</label>
			    <div class="layui-input-block">
		      		<input type="text" name="arrivalItemNo" id="arrivalItemNo" style="border:none" readonly="readonly" class="layui-input">
		    	</div>
			 </div>
			 <div class="layui-inline">
			    <label class="layui-form-label">仓库</label>
			    <div class="layui-input-block">
				   <input type="text" name="storageLocation" style="border:none" readonly="readonly"  id="storageLocation" class="layui-input" >
		    	</div>
			 </div>
		 </div>
		 <div class="layui-form-item">
			 <div class="layui-inline">
			    <label class="layui-form-label">问题描述</label>
			    <div class="layui-input-block">
		      		<textarea  class="layui-textarea" name="abnormalDesc" id="abnormalDesc" style="border:none" readonly="readonly"></textarea>
		    	</div>
			 </div>
			 <div class="layui-inline">
			    <label class="layui-form-label">附件</label>
			    <div class="layui-input-block">
			    	<!-- <button type="button" class="layui-btn" id="upattach">选择文件</button> -->
		      		<!-- <input type="text" name="userName" lay-verify="userName" autocomplete="off" placeholder="请输入用户姓名" class="layui-input"> -->
		    		<blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
					    <div class="layui-upload-list" id="attachmentDiv"></div>
					 </blockquote>
		    	</div>
			 </div>
		 </div>
		 <div class="layui-form-item">
			 <div class="layui-inline">
			    <label class="layui-form-label">已用时（H）</label>
			    <div class="layui-input-block">
		      		<input type="text" name="lastTime" style="border:none" readonly="readonly"  id="lastTime" class="layui-input" >
		    	</div>
			 </div>
			 <div class="layui-inline">
			    <label class="layui-form-label">处理反馈</label>
			    <div class="layui-input-block">
			    	<textarea placeholder="请输入处理反馈信息" class="layui-textarea" name="feedbackInfo" id="feedbackInfo" lay-verify="required"></textarea>
		    	</div>
			 </div>
		 </div>
		  <div class="layui-form-item" id="subDiv">
		    <div class="layui-input-block">
		      <button class="layui-btn" id="cancelButton">取消</button>
		      <button  class="layui-btn layui-btn-primary" id="confirmButton">确认</button>
		    </div>
		  </div>
		  <input name="status" id="status" value="0" hidden="true" />
		  <input name="handleUid" id="handleUid" value="" hidden="true" />
		</form>
		<ul class="layui-timeline" id="timeLineUL">
		 
		</ul>
	</div>
	<script src="${ctx}/pages/layui/layui.all.js" charset="UTF-8"></script>
	<!-- 异常处理时间轴线 -->
	<script type="text/javascript" id="moduleHtml">
		{{# layui.each(d,function(index,item){	}}
		<li class="layui-timeline-item">
		    <i class="layui-icon layui-timeline-axis"></i>
		    <div class="layui-timeline-content layui-text">
		      <h3 class="layui-timeline-title">{{ item.time }}</h3>
		      <p>
		        {{ item.node }}
		        <br>{{ item.orgName }}
		        <br>{{ item.name }}
		        <br>{{ item.active }}
		      </p>
		    </div>
		  </li>
		{{#  }); }}
	</script>
	<script type="text/javascript">
		var $ = layui.$;
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var laytpl = layui.laytpl;
		var form = layui.form
		var abnormalData = parent.abnormalData;//异常信息数据
		var abnormalDictItems = parent.abnormalDictItems;//异常信息中字典
		var warehouseData = parent.warehouseData;//仓库字典
		var handleUid;//处理人
		if(abnormalData!=null){
			 var formData =  eval('('+JSON.stringify(abnormalData)+')');
			 form.val('abnormalDetialForm',formData);
			 var tempAttachment = abnormalData.attachmentUrl;
			 if(abnormalData.status==1){//如果已经处理了  就隐藏确定按钮
				 $("#subDiv").hide();
				 $("#feedbackInfo").attr("readonly","readonly");
				 $("#feedbackInfo").attr("style","border:none");
			 }
			 //附件赋值
			 defaultAttachment(tempAttachment);
			 //给归口人赋值
			 defaultHandle(abnormalData.id);
			 //加载时间轴线
			 timeLine(abnormalData.id);
		}
		
		if(abnormalDictItems && abnormalDictItems.length>0){
			 defulatSelect(abnormalDictItems);
		 }else{
			 queryDictItem(); 
		 }
		 function queryDictItem(){
			  var dictType = new Array();
			  dictType.push("abnormal_type");
  			  dictType.push("abnormal_node");
  			  dictType.push("abnormal_status");
				//查询字典
				var option={
						url:'${ctx}/dictItems/queryDictItemByTypes',
						type:'POST',
						dataType:'json',
						contentType: "application/json",
						data:JSON.stringify(dictType),
						success:function(res){
							if(res.code==0){
								dictItems = res.data
								defulatSelect(res.data);
							}
						}
	  			};
				$.ajax(option);
		  }
		  function defulatSelect(dictItems){
			  if(dictItems && dictItems.length>0){
				  for(var i=0;i<dictItems.length;i++){
					  if(dictItems[i].dictTypeId=="abnormal_type" && abnormalData.abnormalType==dictItems[i].itemValue){
						  $("#abnormalType").val(dictItems[i].itemName);
					  }else if(dictItems[i].dictTypeId=="abnormal_node" && abnormalData.abnormalNode==dictItems[i].itemValue){
						  $("#abnormalNode").val(dictItems[i].itemName);
					  }else if(dictItems[i].dictTypeId=="abnormal_status" && abnormalData.status==dictItems[i].itemValue){
						  $("#status").val(dictItems[i].itemName);
					  }
				  }
			  }
			  if(warehouseData!=null && warehouseData.length>0){
				  for(var i=0;i<warehouseData.length;i++){
					  if(warehouseData[i].orgCode==abnormalData.storageLocation){
						  $("#storageLocation").val(warehouseData[i].orgName);
					  }
				  }
			  }
		  }
		  function defaultHandle(id){
			  var option ={
					url:"${ctx}/abnormal/queryHandleName?id="+id,
					type:"GET",
					success:function(res){
						if(res.code==0){
							if(res.data.uName[4]=="false"){//如果当前登录人不是处理人则不能处理异常
								$("#subDiv").hide();
							} 
							$("#defualtName").val(res.data.uName[0]);
							$("#chargeName").val(res.data.uName[1]);
							$("#manageName").val(res.data.uName[2]);
							$("#mchargeName").val(res.data.uName[3]);
						}
					}
			  };
			  $.ajax(option);
		  }
		  function timeLine(id){
			  var option ={
						url:"${ctx}/abnormal/queryTimeLine?id="+id,
						type:"GET",
						success:function(res){
							if(res.code==0){
								var getTpl = moduleHtml.innerHTML
								,view = document.getElementById('timeLineUL');
								var data = res.data;
								laytpl(getTpl).render(data, function(html){
								  view.innerHTML = html;
								});
							}
						}
				  };
				  $.ajax(option);
		  }
		  function defaultAttachment(tempAttachment){
			  if(tempAttachment!=null && tempAttachment.length>0){
				  var attachments = tempAttachment.split(";");
				  var temp="";
				  for(var i=0;i<attachments.length-1;i++){
					  temp = attachments[i];
					  temp = temp.substring(temp.lastIndexOf("\\")+1);
					  $("#attachmentDiv").append('<a style="cursor:pointer" href="/'+attachments[i]+'">'+temp+'</a><br/>');
				  }
			  }
		  }
		  $("#cancelButton").click(function(){
			  parent.layer.closeAll();
		  });
		  $("#confirmButton").click(function(){
			  var feedbackInfo = $("#feedbackInfo").val();
			  if(feedbackInfo=="" || feedbackInfo.length==0){
				  layer.alert("请填写反馈信息");
				  return false;
			  }
			  var dataStr={"id":abnormalData.id,"feedbackInfo":feedbackInfo,"status":1,"handleTime":new Date()};
			  var option = {
					  url:'${ctx}/abnormal/updateAbnormal',
					  data:JSON.stringify(dataStr),
					  type:"POST",
					  contentType: "application/json",
					  dataType:'json',
					  success:function(res){
						  if(res.code==0){
							  parent.layer.closeAll();
							  parent.table.reload('nomralTabId');
						  }else{
							  layer.alert("保存失败");
						  }
					  },error:function(data){
				    	layer.alert(data.msg)
				      }
			  };
			  $.ajax(option);
		  });
	</script>
</body>
</html>