<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>消息日志</title>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
<link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
</head>
<body>
  <div id="bodyDiv">

</div>

	 <script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
	<script src="/iles/pages/assets/js/jquery-1.10.2.js"></script>
	<script src="/iles/pages/js/loginInspect.js"></script>

	<script type="text/html" id="bodyTpl">
<div class="layui-fluid">
		<div class="layui-row layui-form">
			<div class="layui-col-md3">
			 	<label class="layui-form-label">消息类型:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="msgTypeName_search" class="layui-input">
			    </div>
			</div>
			<div class="layui-col-md3">
			 	<label class="layui-form-label">发送时间:</label>
			 	 <div class="layui-input-block">
			      <input type="text" class="layui-input" id="sendTime_search" placeholder="yyyy-MM-dd HH:mm:ss">
			    </div>
			</div>
			<div class="layui-col-md3">
			 	<label class="layui-form-label">接收类型:</label>
			 	<div class="layui-input-block layui-form">
				      <select  id="receiveMode_search">
				        <option value="">请选择</option>
				      </select>
				</div>
			</div>
			<div class="layui-col-md3">
			 	<label class="layui-form-label">状态:</label>
				<div class="layui-input-block layui-form">
				      <select  id="isreaded_search" lay-filter="isreadedF">
				        <option value="">请选择</option>
				      </select>
				</div>
			</div>
		</div>
		<div class="layui-row layui-form" style="margin-top: 10px">

			<div class="layui-col-md6">
				<div class="layui-btn-container" style="text-align: left;">
		{{# if(d.search==null || d.search=="true"){ }}
		 <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
		 <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
	     {{# } }}

         {{# if(d.check==null || d.check=="true"){ }}
	      <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="check" data-type="auto" type="button"><i class="layui-icon  layui-icon-add-check"></i>查看</button>

          {{# } }}
    {{# if(d.export==null || d.export=="true"){ }}
		 <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="export" type="button"><i class="layui-icon layui-icon-export"></i>导出</button>
	     {{# } }}

				</div>
			</div>
		</div>
	</div>
	<table id="msgLogTab" lay-filter="msgLogTabF"></table>
</script>
	<script type="text/javascript">
	 var contextPath = config.basicInfoConfig.contextPath;
		var $ = layui.$;
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form;
		var oldData;
		var dictItems = null;//存储字典信息
		layui.use('laydate', function(){
			var laydate = layui.laydate;
			//时间选择器
			  laydate.render({
			    elem: '#sendTime_search'
			    ,type: 'datetime'
			    ,range: true
			  });
		});

		function loadding(){
		table.render({
			elem:'#msgLogTab',
			id:'msgLogTabId',
			url:contextPath+'msgLog/listMsgLog',
			cols:[[
			{type:'checkbox'}
			,{field:'msgContent',title:'消息内容'}
			,{field:'sendTime',title:'发送时间',sort:true}
			,{field:'msgTypeId',title:'消息类型',sort:true}
			,{field:'receiveMode',title:'接收方式',sort:true}
			,{field:'receiver',title:'接收人'}
			,{field:'isreaded',title:'状态'}
			]],
			page: {theme: '#008155'},
			height: 'full-95',
    		even:true,
    		where:{
    			receiver:'${athemTag.currUser.userName}'
    			,sortColums:'isreaded asc,send_time desc'
    		},
    		done:function(res,page,count){//列表数据回调函数
    			//状态数据处理
    			var dictType = new Array();
    			dictType.push("read_status");
    			dictType.push("send_mode");
    			dictType.push("expired_status");
    			//查询字典
    			var option={
    					url:contextPath+'dictItems/listDictItemByTypes',
    					type:'POST',
    					dataType:'json',
    					contentType: "application/json",
    					data:JSON.stringify(dictType),
    					success:function(res){
    						if(res.code==0){
    							dictItems = res.data
    							//列表中的状态、接收方式赋值
    							changeItemName(res.data);
    							//搜索框的状态、接收方式赋值
    							defulatSelect(dictItems);
    						}
    					}
	    			};
    			$.ajax(option);
    			this.where={};//清楚携带的检索条件
    		}
		});
		var active = {
				search:function(othis){
					var msgTypeName = $('#msgTypeName_search');
					var sendTime =  $('#sendTime_search');
					var isreaded = $('#isreaded_search');
					var receiveMode =  $('#receiveMode_search');

					if(sendTime.val().length>0){
						  var tempTime = sendTime.val();
							//执行重载
					      table.reload('msgLogTabId', {
					        where:{
					        	msgTypeId: msgTypeName.val()
						        ,isreaded:isreaded.val()
						         ,receiveMode:receiveMode.val()
						         ,startTime:new Date(tempTime.substring(0,20))
						         ,endTime:new Date(tempTime.substring(22))
					      		 ,receiver:'${athemTag.currUser.userName}'
					        }
					        ,page:{"curr":1}
					      });
					}else{
						//执行重载
				      table.reload('msgLogTabId', {
				        where:{
				        	msgTypeId: msgTypeName.val()
					        ,isreaded:isreaded.val()
					         ,receiveMode:receiveMode.val()
					         ,receiver:'${athemTag.currUser.userName}'
				        }
				        ,page:{"curr":1}
				      });
					}

				},reset:function(othis){
					$('#msgTypeName_search').val("");
					$('#sendTime_search').val("");
					$('#isreaded_search').val("");
					$('#receiveMode_search').val("");
					form.render("select");
				},check:function(othis){
					var checkStatus = table.checkStatus('msgLogTabId');
      				oldData = checkStatus.data;
					if(oldData.length<=0){
						layer.alert('请选择要查看的行！',{icon: 2});
      					return ;
					}else if(oldData.length >1){
      					layer.alert('查看不能超过多行！',{icon: 2});
      					return ;
      				}
					if(oldData[0].isreaded=="0"){
						var option={
								url:contextPath+'msgLog/updateIsread?id='+oldData[0].id,
								type:'POST',
								success:function(res){
									if(res.code==0)
										table.reload('msgLogTabId');
								}
						};
						$.ajax(option);
					}
					var type = othis.data('type');
		  			layer.open({
			        type: 2
			        ,title:'查看消息日志'
			        ,maxmin:true
			        ,area: ['800px', '450px']
			        ,offset: type
			        ,id: 'msgLogInfo'+type //防止重复弹出
			        ,content: 'msgLogInfo.html'
			        ,shade: 0 //不显示遮罩
			        ,yes: function(){
			          layer.closeAll();
			        }
		  			});
				},export:function(){
					var data = table.cache.msgLogTabId;
					if(data.length>0){
						var msgTypeName = $('#msgTypeName_search');
						var sendTime =  $('#sendTime_search');
						var isreaded = $('#isreaded_search');
						var receiveMode =  $('#receiveMode_search');
						var params="receiver=${athemTag.currUser.userName}";
						params = params + "&receiveMode="+receiveMode.val()+"&msgTypeId="+msgTypeName.val()+"&isreaded="+isreaded.val();
						var token = window.localStorage.token;
						params = params   +"&token="+token;
						if(sendTime.val().length>0){
							var tempTime = sendTime.val();
							params = params + "&startTime="+new Date(tempTime.substring(0,20))+"&endTime="+new Date(tempTime.substring(22))
						}
						window.open(contextPath+"msgLog/export?"+params);
					}else{
						layer.alert('导出失败！无数据',{icon: 2});
					}

				}



		};
		$('.layui-btn-container button').on('click', function(){
		    var othis = $(this), method = othis.data('method');
		    active[method] ? active[method].call(this, othis) : '';
	  	});
		table.on('sort(msgLogTabF)', function (obj) {
			var sortColums;
			if(obj.field=="msgTypeId"){
				sortColums = "msg_type_name "+obj.type;
			}else if(obj.field=="receiveMode"){
				sortColums = "receive_mode "+obj.type;
			}else if(obj.field=="sendTime"){
				sortColums = "send_time "+obj.type;
			}
			var msgTypeName = $('#msgTypeName_search');
			var sendTime =  $('#sendTime_search');
			var isreaded = $('#isreaded_search');
			var receiveMode =  $('#receiveMode_search');
		    if(sendTime.val().length>0){
				  var tempTime = sendTime.val();
					//执行重载
			      table.reload('msgLogTabId', {
			        where:{
			        	msgTypeId: msgTypeName.val()
				        ,isreaded:isreaded.val()
				         ,receiveMode:receiveMode.val()
				         ,startTime:new Date(tempTime.substring(0,20))
				         ,endTime:new Date(tempTime.substring(22))
			      		 ,receiver:'${athemTag.currUser.userName}'
			      		 ,sortColums:sortColums
			        }
			        ,page:{"curr":1}
			      });
			}else{
				//执行重载
		      table.reload('msgLogTabId', {
		        where:{
		        	msgTypeId: msgTypeName.val()
			        ,isreaded:isreaded.val()
			         ,receiveMode:receiveMode.val()
			         ,receiver:'${athemTag.currUser.userName}'
			         ,sortColums:sortColums
		        }
		        ,page:{"curr":1}
		      });
			}
		});

}
		function changeItemName(data){
    		//状态数据处理
    		$("[data-field='isreaded']").children().each(function(){
    			for(var i=0;i<data.length;i++){
    				if(data[i].dictTypeId=="read_status" && data[i].itemValue==$(this).text().trim()){
    					$(this).text(data[i].itemName);
    				}
    			}
    		});
    		//接收方式数据处理
    		$("[data-field='receiveMode']").children().each(function(){
    			for(var i=0;i<data.length;i++){
    				if(data[i].dictTypeId=="send_mode" && data[i].itemValue==$(this).text().trim()){
    					$(this).text(data[i].itemName);
    				}
    			}
    		});

		}
		function defulatSelect(dictItems){
			if(dictItems && dictItems.length>0){
				if($("#isreaded_search").find("option").length==1){
				  for(var i=0;i<dictItems.length;i++){
					   if(dictItems[i].dictTypeId=="read_status"){
						  $("#isreaded_search").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
					   }else if(dictItems[i].dictTypeId=="send_mode"){
						   $("#receiveMode_search").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
					   }
				  }
				  form.render('select');
			  }
			}
		}
	</script>
  </body>
</html>
