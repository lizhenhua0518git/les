<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>编辑用户注册</title>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
</head>
<body>
<div id="bodyDiv"></div>
	<div class="layui-container" style="padding-top: 20px;">
		<form class="layui-form" action="" lay-filter="userRegisterForm">
			<div class="layui-form-item">
				<div class="layui-inline">
				    <label class="layui-form-label">用户姓名</label>
				    <div class="layui-input-block">
				      <input type="text" name="userName" id="userName" lay-verify="required" autocomplete="off" placeholder="请点击输选择用户" class="layui-input" onclick="chooseUser()">
				    </div>
			 	</div>
			 	
			 </div>
			 <div class="layui-form-item">
				<div class="layui-inline">
				    <label class="layui-form-label">消息类型</label>
				    <div class="layui-input-block">
				      <input type="text" name="msgTypeName" id="msgTypeName" lay-verify="required" autocomplete="off" placeholder="请点击输选择消息类型" class="layui-input" onclick="chooseMessageType()">
				    </div>
			 	</div>
			 </div>
			 <div class="layui-form-item">
				 <div class="layui-inline">
					    <label class="layui-form-label">所属仓库</label>
					    <div class="layui-input-block">
					     <select name="groupId" id="groupId">
							  <option value=""></option>
						 </select>
					    </div>
				 </div>
			 </div>
			 <div class="layui-form-item">
			 	<div class="layui-inline">
				    <label class="layui-form-label">接收方式</label>
				    <div class="layui-input-block">
			      		<select name="receiveModel" id="receiveModel">
					        <option value=""></option>
					      </select>
			         </div>
				 </div>
			 </div>
			 <div class="layui-form-item">
				<div class="layui-inline">
				    <label class="layui-form-label">备注</label>
				    <div class="layui-input-block">
				      <textarea placeholder="请输入备注信息" class="layui-textarea" name="remark" id="remark"></textarea>
				    </div>
			 	</div>
			 </div>
			 <div class="layui-form-item">
			    <div class="layui-input-block">
			      <button class="layui-btn" lay-submit="" lay-filter="userRegisterSubit">立即提交</button>
			      <button type="reset" class="layui-btn layui-btn-primary">重置</button>
			    </div>
			  </div>
			  <input hidden="true" name="userId" id="userId" />
			  <input hidden="true" name="msgTypeId" id="msgTypeId" />
		</form>
	</div>
	 <script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/loginInspect.js"></script>
	 <script src="/iles/pages/js/common/warehouseSelect.js"></script>
	
	<script type="text/html" id="bodyTpl"></script>
	<script type="text/javascript">
	 var contextPath = config.basicInfoConfig.contextPath;
	 function loadding(){
		 initWarehouseSignSelect("groupId",0,"");
	    	form.render('select');
	 }
		var $ = layui.$;
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form
		var feildName="msgTypeName";
		var feildId="msgTypeId";
		var oldData = parent.oldData;
		var dictItems = parent.dictItems;
		var warehouseData = parent.warehouseData;
		layui.use(['form', 'layedit'], function(){
			 
			  //监听提交
			  form.on('submit(userRegisterSubit)', function(data){
				  data.field.id = oldData[0].id;//防止重置后id丢失
				  var option = {
			    	url:contextPath+'applicationUser/updateApplicationUser',
			    	data:JSON.stringify(data.field),
			    	type:'POST',
			    	contentType:'application/json',
			    	success:function(data){
			    		if(data.code==0){
			    			var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
			    			parent.layer.close(index);  // 关闭layer
			    			parent.parentId = "";
			    			parent.table.reload('applicationUserTabId');
			    		}else{
			    			layer.alert(data.msg);
			    		}
			    	},error:function(data){
			    		layer.alert(data.msg)
			    	}
			    }
			    $.ajax(option);
				return false;
			 });
		});
		 initWarehouseSignSelect("groupId",0,"");
		if(dictItems && dictItems.length>0){
			 defulatSelect(dictItems);
		 }else{
			 queryDictItem(); 
		 }
		 function queryDictItem(){
			  var dictType = new Array();
				dictType.push("send_mode");
				//查询字典
				var option={
						url:contextPath+'dictItems/listDictItemByName',
						type:'POST',
						dataType:'json',
						contentType: "application/json",
						data:JSON.stringify(dictType),
						success:function(res){
							if(res.code==0){
								dictItems = res.data
								defulatSelect(res.data);
							}
						}
	  			};
				$.ajax(option);
		  }
		  function defulatSelect(dictItems){
			  if(dictItems && dictItems.length>0){
				  for(var i=0;i<dictItems.length;i++){
					  if(dictItems[i].dictTypeId=="send_mode"){
						  $("#receiveModel").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
					  }
				  }
				  form.render('select');
			  }
		  }
		
		function chooseUser(){
			layer.open({
		        type: 2
		        ,title:'选择用户信息'
		        ,maxmin:true
		        ,area: ['500px', '400px']
		        ,id: 'userInfochose' //防止重复弹出
		        ,content:'choseUserInfo.html'
		        ,shade: 0 //不显示遮罩
		        ,yes: function(){
		          layer.closeAll();
		        }
		   });
		}
		function chooseMessageType(){
			layer.open({
		        type: 2
		        ,title:'选择消息类型'
		        ,maxmin:true
		        ,area: ['500px', '400px']
		        ,id: 'msgTypechose' //防止重复弹出
		        ,content:'choseMessageType.html'
		        ,shade: 0 //不显示遮罩
		        ,yes: function(){
		          layer.closeAll();
		        }
		   });
		}
		
		/**
		 * 功能描述：单选下拉仓库
		 * @param warehouseSelectId 下拉框ID
		 * @param permission 1-权限控制 0-不控制
		 * @param selectValue  选中的值
		 * @returns
		 */
		function initWarehouseSignSelect(warehouseSelectId,permission,selectValue){
			 var params={limit:0,sortColums:"org_code asc",permission:permission};
			 var contextPath = config.basicInfoConfig.contextPath
		        var option = {
		                url:contextPath + 'warehouse/',    
		                type:"post",
		                data :params,
		                success:function(result){
		                       if(result.code==0){
		                           var WarehouseCodes=result.data;
		                           warehouseSignSelect(WarehouseCodes,warehouseSelectId,selectValue);
		                       }
		                       
		                       
		                       if(oldData && oldData.length>0){
		             			  var formData =  eval('('+JSON.stringify(oldData[0])+')');
		             			  form.val('userRegisterForm',formData)
		             			  if(formData.userId!=null && formData.userId.length>0){
		             				  var option = {
		             					url:contextPath+'user/getByUserName?userName='+formData.userId,
		             					type:'GET',
		             					contentType:'application/json',
		             					success:function(res){
		             						if(res.code==0 && res.data!=null){
		             							$("#userId").val(res.data.id);//user_id默认赋值
		             							$("#userName").val(res.data.userName);//user_Name默认赋值
		             						}
		             					}
		             				  };
		             				  $.ajax(option);
		             			  }
		             			  if(formData.msgTypeId!=null && formData.msgTypeId.length>0){
		             					 var option = {
		             						url:contextPath+'messageType/getByMsgTypeName?msgTypeName='+formData.msgTypeId,
		             						type:'GET',
		             						contentType:'application/json',
		             						success:function(res){ 
		             							if(res.code==0 && res.data!=null){
		             								$("#msgTypeName").val(res.data.msgTypeName);
		             								$("#msgTypeId").val(res.data.id);
		             							}
		             						}
		             					 };
		             					 $.ajax(option);
		             				 }
		             		}
		                }
		        }
		        $.ajax(option);
		}
		
		 
	</script>
</body>
</html>