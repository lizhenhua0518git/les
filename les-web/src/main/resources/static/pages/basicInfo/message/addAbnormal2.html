<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="${ctx}/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="${ctx}/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="${ctx}/pages/css/style.min.css">
<title>新增异常</title>
<style type="text/css">
.layui-form-label{
	float: left;
    display: block;
    padding: 9px 15px;
    width: 100px;
    font-weight: 400;
    line-height: 20px;
    text-align: right;
}
.layui-input-block{
	margin-left: 130px;
    min-height: 36px;
}
.message-row{
	width: 100%;
	height: 40px;
	line-height: 40px;
	margin-bottom: 10px;
	background-color: rgba(28, 129, 229, 1);
	color: rgba(255, 255, 255, 1);
	font-size: 20px;
	text-align: left;
	font-family: Roboto;
	border: 1px solid rgba(187, 187, 187, 1);
}
.layui-form-item{
	margin-bottom: 30px;
}
</style>
</head>
<body>
<div class="layui-container" style="padding-top: 20px;">
<div class="layui-row message-row">
    <div class="layui-col-xs12">
    新建异常记录
    </div>
</div>
<form class="layui-form" action="">
 		<div class="layui-form-item">
			<div class="layui-inline">
				<label class="layui-form-label">异常类型</label>
				<div class="layui-input-block">
		      		<select name="typeId" id="typeId" lay-verify="required">
				        <option value=""></option>
				    </select>
			   </div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">当前节点：</label>
				<div class="layui-input-block">
		      		<select name="status" id="status" lay-verify="">
				        <option value="1">待确认</option>
				    </select>
			   </div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">状态：</label>
				<div class="layui-input-block">
		      		<input type="text" name="" lay-verify="" id="" autocomplete="off" placeholder="---" class="layui-input">
			   </div>
			</div>
		</div>
		<div class="layui-form-item">
			 <div class="layui-inline">
			    <label class="layui-form-label">到货通知单号</label>
			    <div class="layui-input-block">
		      		<input type="text" name="deliveryCode" lay-verify="deliveryCode" autocomplete="off" placeholder="请输入到货通知单号" class="layui-input">
		    	</div>
			 </div>
		 </div>
		 <div class="layui-form-item">
		 	<div class="layui-inline">
			    <label class="layui-form-label">行项目号</label>
			    <div class="layui-input-block">
		      		<input type="text" name="lineItemSet" lay-verify="lineItemSet" autocomplete="off" placeholder="请输入行项目号" class="layui-input">
		    	</div>
			 </div>
		 </div>
		 <!-- <div class="layui-form-item">
			 <div class="layui-inline">
			    <label class="layui-form-label">问题描述</label>
			    <div class="layui-input-block">
		      		<textarea placeholder="请输入问题描述" class="layui-textarea" name="abnormalDesc" id="abnormalDesc" lay-verify="required"></textarea>
		    	</div>
			 </div>
		 </div> -->
		 <div class="layui-form-item layui-form-text">
		    <label class="layui-form-label">问题描述</label>
		    <div class="layui-input-block">
		      <textarea placeholder="请输入问题描述" class="layui-textarea" lay-verify="describe" name="describe" id="describe" lay-verify="required"></textarea>
		    </div>
		  </div>
		 <div class="layui-form-item">
		 	<div class="layui-inline">
			    <label class="layui-form-label">附件</label>
			    <div class="layui-input-block">
			    	<button type="button" class="layui-btn" id="upattach">选择文件</button>
		      		<!-- <input type="text" name="userName" lay-verify="userName" autocomplete="off" placeholder="请输入用户姓名" class="layui-input"> -->
		    		<blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
					    <div class="layui-upload-list" id="attachmentDiv"></div>
					 </blockquote>
		    	</div>
			 </div>
		 </div>
		 <div class="layui-form-item">
		    <div class="layui-input-block">
		      <button class="layui-btn" lay-submit="" lay-filter="abnormalSubit">立即提交</button>
		      <button type="reset" class="layui-btn layui-btn-primary">重置</button>
		    </div>
		  </div>
		  <input name="photoAlbum" id="photoAlbum" value="" hidden="true" />
	</form>
	</div>
	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script type="text/javascript">
		var $ = layui.$;
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form;
		var upload = layui.upload;
		var abnormalDictItems = parent.abnormalDictItems;//数据字典内容
		var warehouseData = parent.warehouseData;//仓库字典内容
		var filedName;
		var filedId;
		var myDate = new Date();
		var date = myDate.toLocaleDateString();
		date = date.replace("/","-");
		date = date.replace("/","-");
		var time = myDate.getTime();
		var fileName="abnormal<000000>"+date+"<000000>"+time+"_";//文件路径
		var attchmeUrl="";
		var fileRName="";//文件的名称
		//多图片上传
		upload.render({
		    elem: '#upattach'
		    ,url: '${ctx}/fileUploadServlet?folder='+fileName
		    ,multiple: true
		    ,accept: 'file'
		    ,before: function(obj){
		      //预读本地文件示例，不支持ie8
		      obj.preview(function(index, file, result){
		    	fileRName = file.name;
		    	fileName = fileName+file.name;
		       // $('#attachmentUrl').append('<img src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')
		      });
		    }
		    ,done: function(res){
		      //上传完毕
		     attchmeUrl = attchmeUrl+fileName+";";
		     $('#attachmentDiv').append('<a src="#">'+fileRName+'</a>&nbsp;&nbsp;<i class="layui-icon" style="cursor:pointer" onclick="removeAttchme(this)">&#x1007;</i><br/>');
		     fileName="abnormal<000000>"+date+"<000000>"+time+"_";
		    }
		 });
		initSelect();
		//初始赋值下拉框
		function initSelect(){
			var dictType = new Array();
			dictType.push("abnormal_type");
			dictType.push("abnormal_node");
			dictType.push("abnormal_status");
			//查询字典
			var option={
					url:'${ctx}/abnormalMfc/queryAbnormalType',
					type:'POST',
					dataType:'json',
					contentType: "application/json",
					data:{},
					success:function(res){
						if(res.code==0){
							abnormalDictItems = res.data;
							defulatAbnormalSelect(abnormalDictItems);
						}
					}
    			};
			$.ajax(option);
		}
		function defulatAbnormalSelect(abnormalDictItems){
			if(abnormalDictItems && abnormalDictItems.length>0){
				if($("#typeId").find("option").length==1){
				  for(var i=0;i<abnormalDictItems.length;i++){
					 $("#typeId").append("<option value="+abnormalDictItems[i].id+">"+abnormalDictItems[i].name+"</option>");
				  }
				  form.render('select');
			  }
			}
		}
		//自定义验证规则
		  form.verify({
			  arrivalCode: function(value){
		      if(value.length > 32){
		        return '长度超长，不能大于32';
		      }
		    }
		    ,arrivalItemNo: function(value){
			      if(value.length> 38){
				        return '长度超长，不能大于38';
				      }
				    }
		  });
		  
		  //监听提交
		  form.on('submit(abnormalSubit)', function(data){
			  //var tempHandle = $("#defualtUid").val()+";"+$("#chargeUid").val()+";"+$("#manageUid").val()+";"+$("#mchargeUid").val()+";"
			  //data.field.handleUid=tempHandle;
			  data.field.photoAlbum=attchmeUrl;
			  var option = {
		    	url:'${ctx}/abnormalMfc/insert',
		    	data:data.field,
		    	//type:'POST',
		    	//contentType:'application/json',
		    	success:function(data){
		    		if(data.code==0){
		    			//window.history.go(-1);
		    			layer.alert("保存成功！");
		    		}else{
		    			layer.alert(data.msg);
		    		}
		    	},error:function(data){
		    		layer.alert(data.msg)
		    	}
		    }
		    $.ajax(option);  
			return false;
		  });
		  //移除附件名称
		  function removeAttchme(obj){
			  var parentObj = $(obj).prev();
			  var fileRName = parentObj.text();
			  attchmeUrl = attchmeUrl.replace(fileName+fileRName+";","");
			  parentObj.remove();
			  $(obj).remove();
		  }
	</script>
</body>
</html>