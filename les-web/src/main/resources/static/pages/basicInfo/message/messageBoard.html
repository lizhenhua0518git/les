<#assign  title="消息看板" />
<#include '/header.html' /> 
<meta charset="UTF-8">
<style type="text/css">
.message-row{
	width: 100%;
	height: 40px;
	line-height: 40px;
	background-color: rgba(28, 129, 229, 1);
	color: rgba(255, 255, 255, 1);
	font-size: 20px;
	text-align: left;
	font-family: Roboto;
	border: 1px solid rgba(187, 187, 187, 1);
}
.message-row div{
	float:left;
}
.message-total{
	width: 118px;
	height: 18px;
	color: rgba(255, 255, 255, 1);
	font-size: 16px;
	text-align: left;
	font-family: SourceHanSansSC-regular;
	position:absolute;
}
.message-total span{
	margin-left:5px;
}

</style>
<#if athemTag.loginFlag=="true" && athemTag.menuFlag=="true">
<div class="layui-row message-row">
    <div class="layui-col-xs12">
      <div class="grid-demo grid-demo-bg1">
      	<div style="margin-left:19px">消息提醒</div>
      	<div class="message-total" style="margin-left:34%">未读消息:<span id="unreadCount">0</span></div>
      	<div class="message-total" style="margin-left:43%">一般:<span id="generalCount">0</span></div>
      	<div class="message-total" style="margin-left:50%">重要:<span id="importCount">0</span></div>
      	<div class="message-total" style="margin-left:86%"><button class="layui-btn layui-btn-primary layui-btn-sm" id="readAll">全部已读</button></div>
      	<div class="message-total" style="margin-left:94%;cursor:pointer" id="expand">展开</div>
      </div>
    </div>
</div>
<div class="layui-fluid" style="margin-top:8px">
	<div class="layui-row layui-form">
		<div class="layui-col-md3">
		 	<label class="layui-form-label">接收人:</label>
		 	 <div class="layui-input-block">
		      <input type="text" id="userId_search" class="layui-input">
		    </div>
		</div>
		<div class="layui-col-md3">
		 	<label class="layui-form-label">消息位置:</label>
		 	<div class="layui-input-block layui-form">
			      <select  id="storageLocation_search">
			        <option value="">请选择</option>
			      </select>
			</div>
		</div>
		<div class="layui-col-md3">
		 	<label class="layui-form-label">状态:</label>
			<div class="layui-input-block layui-form">
			      <select  id="status_search">
			        <option value="">请选择</option>
			      </select>
			</div>
		</div>
		<div class="layui-col-md3">
		 	<label class="layui-form-label">类别:</label>
			<div class="layui-input-block layui-form">
			      <select  id="type_search">
			        <option value="">请选择</option>
			      </select>
			</div>
		</div>
	</div>
	<div class="layui-row layui-form" style="margin-bottom: 0">
		<div class="layui-col-md4">
		 	 <label class="layui-form-label">推送时间</label>
		      <div class="layui-input-inline" style="width:52.5%">
		        <input type="text" class="layui-input" id="sendTime_search" placeholder=" - - ">
		      </div>
		</div>
		<div class="layui-col-md2">&nbsp;</div>
		<div class="layui-col-md6">
			<div class="layui-btn-container" style="text-align: right;" id="messageButton">
				<#include '/bottonContainer.html' /> 
			</div>
		</div>
	</div>
</div>
<table id="messageTab" lay-filter="messageTabF" ></table>
<div class="layui-row message-row">
    <div class="layui-col-xs12">
      <div class="grid-demo grid-demo-bg1">
      	<div style="margin-left:19px">异常提醒</div>
      	<div class="message-total" style="margin-left:86%"><button class="layui-btn layui-btn-primary layui-btn-sm" id="addAbnormal">新建异常</button></div>
      	<div class="message-total" style="margin-left:94%;cursor:pointer" id="abnormalExpand">展开</div>
      </div>
    </div>
</div>
<div class="layui-fluid" style="margin-top:8px">
	<div class="layui-row layui-form">
		<div class="layui-col-md3">
		 	<label class="layui-form-label">仓库:</label>
		 	<div class="layui-input-block layui-form">
			      <select  id="abnormal_storageLocation_search">
			        <option value="">请选择</option>
			      </select>
			</div>
		</div>
		<div class="layui-col-md3">
		 	<label class="layui-form-label">异常类型:</label>
		 	<div class="layui-input-block layui-form">
			      <select  id="abnormalType_search">
			        <option value="">请选择</option>
			      </select>
			</div>
		</div>
		<div class="layui-col-md3">
		 	<label class="layui-form-label">异常节点:</label>
			<div class="layui-input-block layui-form">
			      <select  id="abnormalNode_search">
			        <option value="">请选择</option>
			      </select>
			</div>
		</div>
		<div class="layui-col-md3">
		 	<label class="layui-form-label">状态:</label>
			<div class="layui-input-block layui-form">
			      <select  id="abnormalStatus_search">
			        <option value="">请选择</option>
			      </select>
			</div>
		</div>
	</div>
	<div class="layui-row layui-form" style="margin-bottom: 0">
		<div class="layui-col-md4">
		 	 <label class="layui-form-label">发起时间</label>
		      <div class="layui-input-inline" style="width:52.5%">
		        <input type="text" class="layui-input" id="recordTime_search" placeholder=" -- ">
		      </div>
		</div>
		<div class="layui-col-md2">&nbsp;</div>
		<div class="layui-col-md6">
			<div class="layui-btn-container" style="text-align: right;" id="normalButton">
				<#include '/bottonContainer.html' /> 
			</div>
		</div>
	</div>
</div>
<table id="nomralTab" lay-filter="nomralTabF" ></table>
<script src="${ctx}/pages/layui/layui.all.js" charset="UTF-8"></script>
<script type="text/javascript">
	var $ = layui.$;
	var element = layui.element;
	var layer = layui.layer;
	var table = layui.table;
	var form = layui.form;
	var laydate = layui.laydate;
	var dictItems=null;//存放数据字典
	var warehouseData=null;//仓库字典
	var abnormalDictItems=null;//异常提醒数据字典
	var abnormalData;//异常提醒的数据
	laydate.render({
	    elem: '#sendTime_search'
	    ,type: 'datetime'
	    ,range: true
	  });
	table.render({
		elem:"#messageTab",
		id:"messageTabId",
		url:"${ctx}/msgLog/",
		cols:[[
			{type:'checkbox'}
			,{field:'sendTime',title:'推送时间',width:200}
			,{field:'msgContent',title:'内容'}
			,{field:'receiver',title:'接收人',width:120}
			,{field:'storageLocation',title:'消息位置',width:120}
			,{field:'isreaded',title:'状态',width:120}
			,{field:'type',title:'类别',width:120}
		]],
		where:{
			page:1,
			limit:4,
			sortColums:"type desc,send_time desc,isreaded asc"
		},
		done:function(res,page,count){//列表数据回调函数
			//状态数据处理
			var dictType = new Array();
			dictType.push("read_status");
			dictType.push("message_type");
			//查询字典
			var option={
					url:'${ctx}/dictItems/queryDictItemByTypes',
					type:'POST',
					dataType:'json',
					contentType: "application/json",
					data:JSON.stringify(dictType),
					success:function(res){
						if(res.code==0){
							dictItems = res.data
							//列表中的状态、接收方式赋值
							changeItemName(res.data);
							//搜索框的状态、接收方式赋值
							defulatSelect(dictItems);
							
						}
					}
    			};
			if(dictItems==null){
				$.ajax(option);
			}else{
				//列表中的状态、接收方式赋值
				changeItemName(dictItems);
				//搜索框的状态、接收方式赋值
				defulatSelect(dictItems);
			}
			initWarehouse();
			this.where={};//清楚携带的检索条件
		}
	});
	//初始 未读消息数量
	initUnreadCount();
	table.render({
		elem:"#nomralTab",
		id:"nomralTabId",
		url:'${ctx}/abnormal/',
		cols:[[
			{type:'checkbox'}
			,{field:'recordTime',title:'发起时间',width:200}
			,{field:'storageLocation',title:'仓库'}
			,{field:'abnormalType',title:'异常类型'}
			,{field:'abnormalNode',title:'异常节点'}
			,{field:'status',title:'状态'}
			,{field:'handleUid',title:'问题归口人'}
			,{field:'recordUid',title:'发起人'}
			,{field:'reportTime',title:'上报时间'}
			,{field:'lastTime',title:'已用时间'}
		]],
		where:{
			page:1,
			limit:4
		},done:function(res,page,count){//列表数据回调函数
			//状态数据处理
			var dictType = new Array();
			dictType.push("abnormal_type");
			dictType.push("abnormal_node");
			dictType.push("abnormal_status");
			//查询字典
			var option={
					url:'${ctx}/dictItems/queryDictItemByTypes',
					type:'POST',
					dataType:'json',
					contentType: "application/json",
					data:JSON.stringify(dictType),
					success:function(res){
						if(res.code==0){
							abnormalDictItems = res.data
							//列表中的状态、接收方式赋值
							changeAbnormalItemName(abnormalDictItems);
							//搜索框的状态、接收方式赋值
							defulatAbnormalSelect(abnormalDictItems);
							
						}
					}
    			};
			if(abnormalDictItems==null){
				$.ajax(option);
			}else{
				//列表中的状态、接收方式赋值
				changeAbnormalItemName(abnormalDictItems);
				//搜索框的状态、接收方式赋值
				defulatAbnormalSelect(abnormalDictItems);
			}
			initWarehouse();
			this.where={};//清楚携带的检索条件
		}
	});
	function changeAbnormalItemName(data){
		//异常类型数据处理
		$("[data-field='abnormalType']").children().each(function(){
			for(var i=0;i<data.length;i++){
				if(data[i].dictTypeId=="abnormal_type" && data[i].itemValue==$(this).text().trim()){
					$(this).text(data[i].itemName);
				}
			}
		});
		//异常节点数据处理
		$("[data-field='abnormalNode']").children().each(function(){
			for(var i=0;i<data.length;i++){
				if(data[i].dictTypeId=="abnormal_node" && data[i].itemValue==$(this).text().trim()){
					$(this).text(data[i].itemName);
				}
			}
		});
		//异常状态数据处理
		$("[data-field='status']").children().each(function(){
			for(var i=0;i<data.length;i++){
				if(data[i].dictTypeId=="abnormal_status" && data[i].itemValue==$(this).text().trim()){
					$(this).text(data[i].itemName);
				}
			}
		});
	}
	function changeItemName(data){
    		//状态数据处理
    		$("[data-field='isreaded']").children().each(function(){
    			for(var i=0;i<data.length;i++){
    				if(data[i].dictTypeId=="read_status" && data[i].itemValue==$(this).text().trim()){
    					$(this).text(data[i].itemName);
    				}
    			}
    		});
    		//接收方式数据处理
    		$("[data-field='type']").children().each(function(){
    			for(var i=0;i<data.length;i++){
    				if(data[i].dictTypeId=="message_type" && data[i].itemValue==$(this).text().trim()){
    					$(this).text(data[i].itemName);
    				}
    			}
    		});
    		
		}
	function defulatAbnormalSelect(abnormalDictItems){
		if(abnormalDictItems && abnormalDictItems.length>0){
			if($("#abnormalNode_search").find("option").length==1){
			  for(var i=0;i<abnormalDictItems.length;i++){
				   if(abnormalDictItems[i].dictTypeId=="abnormal_node"){
					  $("#abnormalNode_search").append("<option value="+abnormalDictItems[i].itemValue+">"+abnormalDictItems[i].itemName+"</option>");
				   }else if(abnormalDictItems[i].dictTypeId=="abnormal_type"){
					   $("#abnormalType_search").append("<option value="+abnormalDictItems[i].itemValue+">"+abnormalDictItems[i].itemName+"</option>");
				   }else if(abnormalDictItems[i].dictTypeId=="abnormal_status"){
					   $("#abnormalStatus_search").append("<option value="+abnormalDictItems[i].itemValue+">"+abnormalDictItems[i].itemName+"</option>");
				   }
			  }
			  form.render('select');
		  }
		}
	}
	function defulatSelect(dictItems){
		if(dictItems && dictItems.length>0){
			if($("#status_search").find("option").length==1){
			  for(var i=0;i<dictItems.length;i++){
				   if(dictItems[i].dictTypeId=="read_status"){
					  $("#status_search").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
				   }else if(dictItems[i].dictTypeId=="message_type"){
					   $("#type_search").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
				   }
			  }
			  form.render('select');
		  }
		}
	}
	//所属仓库值操作
    function  initWarehouse(){
		 if(warehouseData!=null && warehouseData.length>0){
			 $("[data-field='storageLocation']").children().each(function(){
	    			for(var i=0;i<warehouseData.length;i++){
	    				if(warehouseData[i].orgCode==$(this).text().trim()){
	    					$(this).text(warehouseData[i].orgName);
	    				}
	    				if($("#storageLocation_search").find("option").length<=warehouseData.length){
	    	  				$("#storageLocation_search").append("<option value="+warehouseData[i].orgCode+">"+warehouseData[i].orgName+"</option>");
	    				}
	    				if($("#abnormal_storageLocation_search").find("option").length<=warehouseData.length){
	    	  				$("#abnormal_storageLocation_search").append("<option value="+warehouseData[i].orgCode+">"+warehouseData[i].orgName+"</option>");
	    				}
	    			}
	  
	    		});
			 form.render('select');
			 return;
		 }
		 var option={
					url:'${ctx}/dictItems/queryDictItemByName?itemName=仓库&dictName=组织类型',
					type:'GET',
					contentType: "application/json",
					success:function(res){
						if(res.code==0){
							var orgType = res.data.itemValue;
							var options={
									url:'${ctx}/orgination/queryOrgnizaByType?orgType='+orgType,
									type:'GET',
									contentType: "application/json",
									success:function(res){
										if(res.code==0 && res.data!=null && res.data.length>0){
											warehouseData = res.data;
											$("[data-field='storageLocation']").children().each(function(){
								    			for(var i=0;i<warehouseData.length;i++){
								    				if(warehouseData[i].orgCode==$(this).text().trim()){
								    					$(this).text(warehouseData[i].orgName);
								    				}
								    				if($("#storageLocation_search").find("option").length<=warehouseData.length){
								    	  				$("#storageLocation_search").append("<option value="+warehouseData[i].orgCode+">"+warehouseData[i].orgName+"</option>");
								    				}
								    				if($("#abnormal_storageLocation_search").find("option").length<=warehouseData.length){
								    	  				$("#abnormal_storageLocation_search").append("<option value="+warehouseData[i].orgCode+">"+warehouseData[i].orgName+"</option>");
								    				}
								    			}
								    			form.render('select');
								    		});
										}else{
											layer.msg("获取仓库资源信息失败！");
										}
										
									}
							};
							$.ajax(options);
						}else{
							layer.msg("获取仓库资源信息失败！");
						}
					}
			};
			$.ajax(option);
	  }
		var active = {
				search:function(res){
					var buttonType = res.parent().attr("id");
					if("messageButton"==buttonType){//消息列表的查询
						console.log(table);
						var receiverSearch = $("#userId_search").val();
						var storageLocationSearch = $("#storageLocation_search").val();
						var statusSearch = $("#status_search").val();
						var typeSearch = $("#type_search").val();
						var sendTimeSearch = $("#sendTime_search").val();
						var startTime="null";
						var endTime="null";
						var param = {
								page:1,
								limit:4,
								receiver:receiverSearch,
								storageLocation:storageLocationSearch,
								isreaded:statusSearch,
								type:typeSearch,
								sortColums:"type desc,send_time desc,isreaded asc"
						};
						if(sendTimeSearch.length>0){
							startTime = new Date(sendTimeSearch.substring(0,20));
							endTime = new Date(sendTimeSearch.substring(22));
							param = {
									page:1,
									limit:4,
									receiver:receiverSearch,
									storageLocation:storageLocationSearch,
									isreaded:statusSearch,
									type:typeSearch,
									startTime:startTime,
							        endTime:endTime,
									sortColums:"type desc,send_time desc,isreaded asc"
							}
						}
						table.reload('messageTabId',{
							where:param
						});
					}else if("normalButton"==buttonType){//异常列表的查询
						var storageLocation = $("#abnormal_storageLocation_search").val();
						var abnormalType = $("#abnormalType_search").val();
						var abnormalNode = $("#abnormalNode_search").val();
						var status = $("#abnormalStatus_search").val();
						var recordTime = $("#recordTime_search").val();
						var param = {
								page:1,
								limit:4,
								abnormalType:abnormalType,
								storageLocation:storageLocation,
								abnormalNode:abnormalNode,
								status:status,
						};
						if(recordTime.length>0){
							startTime = new Date(recordTime.substring(0,20));
							endTime = new Date(recordTime.substring(22));
							param = {
									page:1,
									limit:4,
									abnormalType:abnormalType,
									storageLocation:storageLocation,
									abnormalNode:abnormalNode,
									status:status,
									startTime:startTime,
							        endTime:endTime,
							}
						}
						table.reload('nomralTabId',{
							where:param
						});
					}
				},reset:function(res){
					var buttonType = res.parent().attr("id");
					if("messageButton"==buttonType){//消息列表的重置
						 $("#userId_search").val("");
						 $("#storageLocation_search").val("");
						 $("#status_search").val("");
						 $("#type_search").val("");
						 $("#sendTime_search").val("");
						 form.render('select');
					}else if("normalButton"==buttonType){//异常列表的重置
						$("#abnormal_storageLocation_search").val();
						$("#abnormalType_search").val("");
						$("#abnormalNode_search").val("");
						$("#abnormalStatus_search").val("");
						$("#recordTime_search").val("");
						form.render('select');
					}
				}
				
		};
		$('.layui-btn-container button').on('click', function(){
		    var othis = $(this), method = othis.data('method');
		    active[method] ? active[method].call(this, othis) : '';
	  	});
		$("#expand").click(function(){
			layer.open({
				type: 2
		        ,title:'消息列表'
		        ,maxmin:false
		        ,area: ['100%', '100%']
		        ,id: 'msgBoardDetail' //防止重复弹出
		        ,content: 'msgBoardDetail.html'
		        ,shade: 0 //不显示遮罩
		        ,yes: function(){
		          layer.closeAll();
		        }
			});
		});
		$("#readAll").click(function(){
			var tableData = table.cache.messageTabId;
			if(tableData!=null && tableData.length>0){
				var ids = new Array();
				for(var i=0;i<tableData.length;i++){
					ids.push(tableData[i].id);
				}
				var option={
						url:'${ctx}/msgLog/readAll',
						data:{"ids":ids},
						dataType:"json",
						type:"POST",
						success:function(res){
							if(res.code==0){
								layer.msg("修改成功");
								table.reload("messageTabId",{
									where:{
										page:1,
										limit:4,
									}
								});
							}else{
								layer.msg("修改失败");
							}
						}
				};
				$.ajax(option);
			}else{
				layer.msg("无数据");
			}
		});
		function initUnreadCount(){
			var option ={
					url:'${ctx}/msgLog/queryUnreadCount',
					type:"GET",
					success:function(res){
						if(res.code==0){
							$("#importCount").text(res.data.importCount);
							$("#generalCount").text(res.data.generalCount);
							$("#unreadCount").text(res.data.unreadCount);
						}else{
							layer.msg("初始数据失败");
						}
					}
			};
			$.ajax(option);
		}
		$("#addAbnormal").click(function(){
			layer.open({
				type: 2
		        ,title:'新增异常'
		        ,maxmin:false
		        ,area: ['100%', '100%']
		        ,id: 'addAbnormalId' //防止重复弹出
		        ,content: 'addAbnormal.html'
		        ,shade: 0 //不显示遮罩
		        ,yes: function(){
		          layer.closeAll();
		        }
			});
		});
		$("#abnormalExpand").click(function(){
			layer.open({
				type: 2
		        ,title:'异常提醒列表'
		        ,maxmin:false
		        ,area: ['100%', '100%']
		        ,id: 'abnormalList' //防止重复弹出
		        ,content: 'abnormalList.html'
		        ,shade: 0 //不显示遮罩
		        ,yes: function(){
		          layer.closeAll();
		        }
			});
		});
		table.on('rowDouble(nomralTabF)', function(obj){
		  abnormalData = obj.data; //得到当前行数据
		  layer.open({
				type: 2
		        ,title:'异常提醒详细'
		        ,maxmin:false
		        ,area: ['100%', '100%']
		        ,id: 'abnormalDetail' //防止重复弹出
		        ,content: 'abnormalDetail.html'
		        ,shade: 0 //不显示遮罩
		        ,yes: function(){
		          layer.closeAll();
		        }
			});
		});
</script>
<#else>
	<#include '/noAuthority.html' /> 
</#if> 
<#include '/footer.html' />