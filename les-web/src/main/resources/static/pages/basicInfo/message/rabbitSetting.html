<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>消息配置信息</title>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
<link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
</head>
<body>
  <div id="bodyDiv"></div>

	 <script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
	<script src="/iles/pages/assets/js/jquery-1.10.2.js"></script>
	<script src="/iles/pages/js/loginInspect.js"></script>

	<script type="text/html" id="bodyTpl">

	<div class="layui-fluid">
		<div class="layui-row layui-form">
			<div class="layui-col-md2">
			 	<label class="layui-form-label">路由名称:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="exchangeName_search" class="layui-input">
			    </div>
			</div>
			<div class="layui-col-md2">
				<label class="layui-form-label">队列名称:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="queueName_search" class="layui-input">
			    </div>
			</div>
			<div class="layui-col-md2">
				<label class="layui-form-label">类型:</label>
			 	 <div class="layui-input-block">
			      <select  id="type_search">
				        <option value="">请选择</option>
						<option value="0">消息监听</option>
					    <option value="1">消息接收</option>
				  </select>
			    </div>
			</div>
			<div class="layui-col-md2">
				<label class="layui-form-label">状态:</label>
			 	 <div class="layui-input-block">
			      <select  id="status_search">
				        <option value="">请选择</option>
						<option value="0">禁用</option>
					    <option value="1">启用</option>
				  </select>
			    </div>
			</div>
		</div>
	</div>
	<div class="layui-fluid">
		<div class="layui-row layui-form" style="margin-top: 10px">

			<div class="layui-col-md6">
				<div class="layui-btn-container" style="text-align: left;">
		{{# if(d.search==null || d.search=="true"){ }}
		 <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
		 <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
	     {{# } }}
         {{# if(d.add==null || d.add=="true"){ }}
	      <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="add" data-type="auto" type="button"><i class="layui-icon  layui-icon-add-circle"></i>增加</button>
          {{# } }}

        {{# if(d.edit==null || d.edit=="true"){ }}

	    <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="edit" type="button"><i class="layui-icon layui-icon-edit"></i>编辑</button>

        {{# } }}

        {{# if(d.del==null || d.del=="true"){ }}
	     <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="del" type="button"><i class="layui-icon layui-icon-delete"></i>删除</button>
        {{# } }}

				</div>

			</div>
		</div>
	</div>
	<table id="rabbitTab" lay-filter="rabbitTabF"></table>
	</script>
	<script type="text/javascript">
	 var contextPath = config.messageConfig.contextPath;
	 var $ = layui.$;
	 var element = layui.element;
	 var layer = layui.layer;
	 var table = layui.table;
	 var form = layui.form;
	 var oldData;
	 function loadding(){
		 form.render('select');
		 table.render({
			elem:'#rabbitTab',
			id:'rabbitTabId',
			url:contextPath+'rabbitSetting/listRabbitSettingPage',
			cols:[[
			{type:'checkbox'}
			,{field:'type',title:'类型'}
			,{field:'exchangeName',title:'路由名称'}
			,{field:'queueName',title:'队列名称'}
			,{field:'routingKey',title:'监听key值'}
			,{field:'status',title:'状态'}
			,{field:'callbackUrl',title:'接收地址'}
			]],
			page: {theme: '#008155'},
			height: 'full-95',
    		even:true,
    		done:function(res,page,count){//列表数据回调函数
    			changeItemName();
    		}
		});
		var active = {
				add:function(othis){
					var type = othis.data('type');
		  			layer.open({
			        type: 2
			        ,title:'新增消息配置'
			        ,maxmin:true
			        ,area: ['800px', '450px']
			        ,offset: type
			        ,id: 'rabbit'+type //防止重复弹出
			        ,content: 'addRabbitSetting.html'
			        ,shade: 0 //不显示遮罩
			        ,yes: function(){
			          layer.closeAll();
			        }
			      });
				},
				edit:function(othis){
					var checkStatus = table.checkStatus('rabbitTabId');
      				oldData = checkStatus.data;
					if(oldData.length<=0){
						layer.alert('请选择要编辑的行！',{icon: 2});
      					return ;
					}else if(oldData.length >1){
      					layer.alert('编辑不能超过多行！',{icon: 2});
      					return ;
      				}
					var type = othis.data('type');
		  			layer.open({
				        type: 2
				        ,title:'编辑消息配置'
				        ,maxmin:true
				        ,area: ['800px', '450px']
				        ,offset: type
				        ,id: 'rabbit'+type //防止重复弹出
				        ,content: 'editRabbitSetting.html'
				        ,shade: 0 //不显示遮罩
				        ,yes: function(){
				          layer.closeAll();
				        }
			     	 });
				},del:function(othis){
					var checkStatus = table.checkStatus('rabbitTabId');
      				oldData = checkStatus.data;
					if(oldData.length<=0){
						layer.alert('请选择要删除的行！',{icon: 2});
      					return ;
					}
					var idarrys = new Array();
					for(var i=0;i<oldData.length;i++){
						idarrys.push(oldData[i].id);
					}
					layer.confirm('确定删除选择的消息配置?', {icon: 3, title:'提示'}, function(index){
			  			  //do something
			  			  var option ={
								url:contextPath+'rabbitSetting/deleteRabbitSetting',
								type:'POST',
								contentType: "application/json",
								dataType:'json',
								data:JSON.stringify(idarrys),
								success:function(data){
									if(data.code==0){
										layer.msg("删除成功");
										table.reload('rabbitTabId');//刷新列表
									}
								},error:function(data){
									layer.alert(data.msg);
								}
							}
							$.ajax(option);
			  			  layer.close(index);
			  			});
				},search:function(othis){
					var exchangeName = $('#exchangeName_search');
					var queueName = $('#queueName_search');
					var type = $('#type_search');
					var status = $('#status_search');
				      //执行重载
				      table.reload('rabbitTabId', {
				        where:{
				        	exchangeName:exchangeName.val()
				        	,queueName: queueName.val()
				        	,type: type.val()
				        	,status:status.val()
				        }
				        ,page:{"curr":1}
				      });
				},reset:function(othis){
					$('#exchangeName_search').val("");
					$('#queueName_search').val("");
					$('#type_search').val("");
					$('#status_search').val("");
					form.render("select");
				},check:function(othis){
				var checkStatus = table.checkStatus('rabbitTabId');
     				oldData = checkStatus.data;
				if(oldData.length<=0){
					layer.alert('请选择要查看的行！',{icon: 2});
     					return ;
				}else if(oldData.length >1){
     					layer.alert('查看不能超过多行！',{icon: 2});
     					return ;
     				}
				var type = othis.data('type');
	  			layer.open({
			        type: 2
			        ,title:'消息配置信息'
			        ,maxmin:true
			        ,area: ['800px', '450px']
			        ,offset: type
			        ,id: 'rabbitInfo'+type //防止重复弹出
			        ,content: 'rabbitSettingInfo.html'
			        ,shade: 0 //不显示遮罩
			        ,yes: function(){
			          layer.closeAll();
			        }
		     	 });
			},nowStart:function(othis){
				console.log(othis);
				var classValue = othis.attr("class");
				if(classValue.indexOf("layui-btn-disabled")<0){
					othis.attr("class","layui-btn layui-btn-sm layui-btn-disabled");
					var option = {
							url:contextPath+'rabbitSetting/nowStart',
							type:"POST",
							success:function(res){
								othis.attr("class","layui-btn layui-btn-normal layui-btn-sm");
								if(res.code==0){
									layer.msg("生效成功!")
								}else{
									layer.alert(res.message);
								}
							},error:function(res){
								layui.alert(res.message);
								othis.attr("class","layui-btn layui-btn-normal layui-btn-sm");
							}
					};
					$.ajax(option);
				}
			}



		};
		$('.layui-btn-container button').on('click', function(){
		    var othis = $(this), method = othis.data('method');
		    active[method] ? active[method].call(this, othis) : '';
	  	});

	 }
		function changeItemName(data){
    		//状态数据处理
    		$("[data-field='type']").children().each(function(){

    				if( "0"==$(this).text().trim()){
    					$(this).text("消息监听");
    				}else if("1"==$(this).text().trim()){
    					$(this).text("消息接收");
    				}

    		});
    		$("[data-field='status']").children().each(function(){
    				if( "0"==$(this).text().trim()){
    					$(this).text("禁用");
    				}else if("1"==$(this).text().trim()){
    					$(this).text("启用");
    				}
    		});
		}
		function defulatSelect(dictItems){
			if(dictItems && dictItems.length>0){
				if($("#type_search").find("option").length==1){
				  for(var i=0;i<dictItems.length;i++){
					   if(dictItems[i].dictTypeId=="rabbit_type"){
						  $("#type_search").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
					  }
				  }
				  form.render('select');
			  }
			}
		}
	</script>
</body>
</html>
