<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>消息模板</title>
		<meta name="renderer" content="webkit|ie-comp|ie-stand">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
		<meta http-equiv="Cache-Control" content="no-siteapp" />
		<link rel="stylesheet" href="/iles/pages/layui/css/layui.css" type="text/css" />
		<link rel="stylesheet" href="/iles/pages/css/layui_extend.css" media="all">
		<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css" type="text/css" />
		<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
		<link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css" type="text/css" />
	</head>

	<body>
		<div id="bodyDiv">

		</div>

		<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
		<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
		<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
		<script src="/iles/pages/assets/js/jquery-1.10.2.js"></script>
		<script src="/iles/pages/js/loginInspect.js"></script>

		<script type="text/html" id="bodyTpl">

			<div class="layui-fluid">
				<div class="layui-row layui-form">
					<div class="layui-col-md3">
						<label class="layui-form-label">模板名称:</label>
						<div class="layui-input-block">
							<input type="text" id="templetName_search" class="layui-input">
						</div>
					</div>
					<div class="layui-col-md3">
						<label class="layui-form-label">模板标题:</label>
						<div class="layui-input-block">
							<input type="text" id="templetTitle_search" class="layui-input">
						</div>
					</div>
					<div class="layui-col-md3">
						<label class="layui-form-label">消息类型:</label>
						<div class="layui-input-block">
							<input type="text" id="msgTypeId_search" class="layui-input">
						</div>
					</div>
					<div class="layui-col-md3">
						<label class="layui-form-label">发送方式:</label>
						<div class="layui-input-block layui-form">
							<select id="sendMode_search">
								<option value="">请选择</option>
								<option value="0">短信</option>
								<option value="1">消息</option>
								<option value="2">邮件</option>
							</select>
						</div>
					</div>
					<div class="layui-col-md2">&nbsp;</div>
					<div class="layui-col-md2">
						<div class="layui-btn-container" style="text-align: left;">
							{{# if(d.search==null || d.search=="true"){ }}
							<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
							<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button> {{# } }}
						</div>
						</div>


				</div>
			</div>

			<div class="layui-row layui-form" style="margin-bottom: 0">

							{{# if(d.check==null || d.check=="true"){ }}
							<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="check" data-type="auto" type="button"><i class="layui-icon  layui-icon-add-check"></i>查看</button> {{# } }} {{# if(d.add==null || d.add=="true"){ }}
							<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="add" data-type="auto" type="button"><i class="layui-icon  layui-icon-add-circle"></i>增加</button> {{# } }} {{# if(d.edit==null || d.edit=="true"){ }}

							<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="edit" type="button"><i class="layui-icon layui-icon-edit"></i>编辑</button> {{# } }} {{# if(d.del==null || d.del=="true"){ }}
							<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="del" type="button"><i class="layui-icon layui-icon-delete"></i>删除</button> {{# } }}

						</div>

			<table id="messageTempletTab" lay-filter="messageTempletTabF"></table>

		</script>
		<script type="text/javascript">
			var contextPath = config.basicInfoConfig.contextPath;
			var $ = layui.$;
			var element = layui.element;
			var layer = layui.layer;
			var table = layui.table;
			var form = layui.form;
			var oldData;
			var dictItems = null; //存储字典
			function loadding() {
				table.render({
					elem: '#messageTempletTab',
					id: 'messageTempletTabId',
					url: contextPath + 'messageTemplet/listMessageTemplet',
					cols: [
						[{
							type: 'checkbox'
						}, {
							field: 'templetName',
							title: '模板名称',
							sort: true
						}, {
							field: 'templetTitle',
							title: '模板标题'
						}, {
							field: 'templetContent',
							title: '模板内容'
						}, {
							field: 'msgTypeId',
							title: '消息类型',
							sort: true
						}, {
							field: 'sendMode',
							title: '发送方式'
						}, {
							field: 'status',
							title: '状态'
						}]
					],
					page: {
						theme: '#008155'
					},
					height: 'full-95',
					even: true,
					done: function(res, page, count) { //列表数据回调函数
						var dictType = new Array();
						dictType.push("enable");
						dictType.push("send_mode");
						//查询字典
						var option = {
							url: contextPath + 'dictItems/listDictItemByTypes',
							type: 'POST',
							dataType: 'json',
							contentType: "application/json",
							data: JSON.stringify(dictType),
							success: function(res) {
								if(res.code == 0) {
									dictItems = res.data
									//列表中的状态赋值
									changeItemName(res.data);
									//搜索框的状态赋值
									defulatSelect(dictItems);
								}
							}
						};
						$.ajax(option);
					}
				});
				var active = {
					add: function(othis) {
						var type = othis.data('type');
						layer.open({
							type: 2,
							title: '新增消息模板',
							maxmin: true,
							area: ['800px', '450px'],
							offset: type,
							id: 'msgTempletadd' + type //防止重复弹出
								,
							content: 'addMessageTemplet.html',
							shade: 0 //不显示遮罩
								,
							yes: function() {
								layer.closeAll();
							}
						});
					},
					edit: function(othis) {
						var checkStatus = table.checkStatus('messageTempletTabId');
						oldData = checkStatus.data;
						if(oldData.length <= 0) {
							layer.alert('请选择要编辑的行！', {
								icon: 2
							});
							return;
						} else if(oldData.length > 1) {
							layer.alert('编辑不能超过多行！', {
								icon: 2
							});
							return;
						}
						var type = othis.data('type');
						layer.open({
							type: 2,
							title: '编辑消息模板',
							maxmin: true,
							area: ['800px', '450px'],
							offset: type,
							id: 'msgTempletEdit' + type //防止重复弹出
								,
							content: 'editMessageTemplet.html',
							shade: 0 //不显示遮罩
								,
							yes: function() {
								layer.closeAll();
							}
						});
					},
					del: function(othis) {
						var checkStatus = table.checkStatus('messageTempletTabId');
						oldData = checkStatus.data;
						if(oldData.length <= 0) {
							layer.alert('请选择要删除的行！', {
								icon: 2
							});
							return;
						}
						var idarrys = new Array();
						for(var i = 0; i < oldData.length; i++) {
							idarrys.push(oldData[i].id);
						}
						layer.confirm('确定删除该条消息模板', {
							icon: 3,
							title: '提示'
						}, function(index) {
							//do something
							var option = {
								url: contextPath + 'messageTemplet/deleteMessageTemplet',
								type: 'POST',
								contentType: "application/json",
								dataType: 'json',
								data: JSON.stringify(idarrys),
								success: function(data) {
									if(data.code == 0) {
										layer.msg("删除成功");
										table.reload('messageTempletTabId'); //刷新列表
									}
								},
								error: function(data) {
									layer.alert(data.msg);
								}
							}
							$.ajax(option);
							layer.close(index);
						});
					},
					check: function(othis) {
						var checkStatus = table.checkStatus('messageTempletTabId');
						oldData = checkStatus.data;
						if(oldData.length <= 0) {
							layer.alert('请选择要查看的行！', {
								icon: 2
							});
							return;
						} else if(oldData.length > 1) {
							layer.alert('查看不能超过多行！', {
								icon: 2
							});
							return;
						}
						var type = othis.data('type');
						layer.open({
							type: 2,
							title: '查看消息模板',
							maxmin: true,
							area: ['800px', '450px'],
							offset: type,
							id: 'msgTempletInfo' + type //防止重复弹出
								,
							content: 'messageTempletInfo.html',
							shade: 0 //不显示遮罩
								,
							yes: function() {
								layer.closeAll();
							}
						});
					},
					search: function(othis) {
						var templetName = $('#templetName_search');
						var templetTitle = $('#templetTitle_search');
						var msgTypeId = $('#msgTypeId_search');
						var sendMode = $('#sendMode_search');
						//执行重载
						table.reload('messageTempletTabId', {
							where: {
								templetName: templetName.val(),
								templetTitle: templetTitle.val(),
								msgTypeId: msgTypeId.val(),
								sendMode: sendMode.val()
							},
							page: {
								"curr": 1
							}
						});
					},
					reset: function(othis) {
						$('#templetName_search').val("");
						$('#templetTitle_search').val("");
						$('#msgTypeId_search').val("");
						$('#sendMode_search').val("");
						form.render("select");
					}

				};
				$('.layui-btn-container button').on('click', function() {
					var othis = $(this),
						method = othis.data('method');
					active[method] ? active[method].call(this, othis) : '';
				});
				table.on('sort(messageTempletTabF)', function(obj) {
					var sortColums;
					if(obj.field == "templetName") {
						sortColums = "templet_name " + obj.type;
					} else if(obj.field == "msgTypeId") {
						sortColums = "msg_type_id " + obj.type;
					}
					var templetName = $('#templetName_search');
					var templetTitle = $('#templetTitle_search');
					var msgTypeId = $('#msgTypeId_search');
					var sendMode = $('#sendMode_search');
					//执行重载
					table.reload('messageTempletTabId', {
						where: {
							templetName: templetName.val(),
							templetTitle: templetTitle.val(),
							msgTypeId: msgTypeId.val(),
							sendMode: sendMode.val(),
							sortColums: sortColums
						},
						page: {
							"curr": 1
						}
					});
				});

			}

			function changeItemName(data) {
				//状态数据处理
				$("[data-field='status']").children().each(function() {
					for(var i = 0; i < data.length; i++) {
						if(data[i].dictTypeId == "enable" && data[i].itemValue == $(this).text().trim()) {
							$(this).text(data[i].itemName);
						}
					}
				});
				$("[data-field='sendMode']").children().each(function() {
					for(var i = 0; i < data.length; i++) {
						if(data[i].dictTypeId == "send_mode" && data[i].itemValue == $(this).text().trim()) {
							$(this).text(data[i].itemName);
						}
					}
				});

			}

			function defulatSelect(dictItems) {
				if(dictItems && dictItems.length > 0) {
					if($("#sendMode_search").find("option").length == 1) {
						for(var i = 0; i < dictItems.length; i++) {
							if(dictItems[i].dictTypeId == "send_mode") {
								$("#sendMode_search").append("<option value=" + dictItems[i].itemValue + ">" + dictItems[i].itemName + "</option>");
							}
						}
						form.render('select');
					}
				}
			}
		</script>
	</body>

</html>
