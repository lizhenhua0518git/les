<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="${ctx}/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="${ctx}/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="${ctx}/pages/css/style.min.css">
<title>新增异常</title>
<style type="text/css">
.layui-form-label{
	float: left;
    display: block;
    padding: 9px 15px;
    width: 100px;
    font-weight: 400;
    line-height: 20px;
    text-align: right;
}
.layui-input-block{
	margin-left: 130px;
    min-height: 36px;
}
</style>
</head>
<body>
<div class="layui-container" style="padding-top: 20px;">
<form class="layui-form" action="">
 		<div class="layui-form-item">
			<div class="layui-inline">
				<label class="layui-form-label">异常类型</label>
				<div class="layui-input-block">
		      		<select name="abnormalType" id="abnormalType" lay-verify="required">
				        <option value=""></option>
				    </select>
			   </div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">异常节点</label>
				<div class="layui-input-block">
		      		<select name="abnormalNode" id="abnormalNode" lay-verify="required">
				        <option value=""></option>
				    </select>
			   </div>
			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-inline">
			    <label class="layui-form-label">初始归口人</label>
			    <div class="layui-input-block">
			      <input name="defualtUid" id="defualtUid" value="" hidden="true" />
			      <input type="text" name="defualtName" lay-verify="required" id="defualtName" autocomplete="off" placeholder="请选择初始归口人" class="layui-input" onclick="chooseUser(0)">
			    </div>
		 	</div>
		 	<div class="layui-inline">
				    <label class="layui-form-label">归口负责人</label>
				    <div class="layui-input-block">
				      <input name="chargeUid" id="chargeUid" value="" hidden="true" />
				      <input type="text" name="chargeName" lay-verify="required" id="chargeName" autocomplete="off" placeholder="请选择归口负责人" class="layui-input" onclick="chooseUser(1)">
				    </div>
			 </div>
		 </div>
		 <div class="layui-form-item">
			<div class="layui-inline">
			    <label class="layui-form-label">归口经理人</label>
			    <div class="layui-input-block">
			      <input name="manageUid" id="manageUid" value="" hidden="true" />
			      <input type="text" name="manageName" lay-verify="required" id="manageName" autocomplete="off" placeholder="请选择归口经理人" class="layui-input" onclick="chooseUser(2)">
			    </div>
		 	</div>
			<div class="layui-inline">
			    <label class="layui-form-label">归口总负责人</label>
			    <div class="layui-input-block">
			      <input name="mchargeUid" id="mchargeUid" value="" hidden="true" />
			      <input type="text" name="mchargeName" lay-verify="required" id="mchargeName" autocomplete="off" placeholder="请选择归口总负责人" class="layui-input" onclick="chooseUser(3)">
			    </div>
		 	</div>
		 </div>
		 
		<div class="layui-form-item">
			 <div class="layui-inline">
			    <label class="layui-form-label">上报时间(H)</label>
			    <div class="layui-input-block">
		      		<input type="text" name="reportTime" lay-verify="number" autocomplete="off" placeholder="请输入上报时间" class="layui-input">
		    	</div>
			 </div>
			 <div class="layui-inline">
			    <label class="layui-form-label">到货通知单号</label>
			    <div class="layui-input-block">
		      		<input type="text" name="arrivalCode" lay-verify="arrivalCode" autocomplete="off" placeholder="请输入到货通知单号" class="layui-input">
		    	</div>
			 </div>
		 </div>
		 <div class="layui-form-item">
			 <div class="layui-inline">
			    <label class="layui-form-label">行项目号</label>
			    <div class="layui-input-block">
		      		<input type="text" name="arrivalItemNo" lay-verify="arrivalItemNo" autocomplete="off" placeholder="请输入行项目号" class="layui-input">
		    	</div>
			 </div>
			 <div class="layui-inline">
			    <label class="layui-form-label">仓库</label>
			    <div class="layui-input-block">
		      		<select name="storageLocation" id="storageLocation" lay-verify="required">
				        <option value=""></option>
				    </select>
		    	</div>
			 </div>
		 </div>
		 <div class="layui-form-item">
			 <div class="layui-inline">
			    <label class="layui-form-label">问题描述</label>
			    <div class="layui-input-block">
		      		<textarea placeholder="请输入问题描述" class="layui-textarea" name="abnormalDesc" id="abnormalDesc" lay-verify="required"></textarea>
		    	</div>
			 </div>
			 <div class="layui-inline">
			    <label class="layui-form-label">附件</label>
			    <div class="layui-input-block">
			    	<button type="button" class="layui-btn" id="upattach">选择文件</button>
		      		<!-- <input type="text" name="userName" lay-verify="userName" autocomplete="off" placeholder="请输入用户姓名" class="layui-input"> -->
		    		<blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
					    <div class="layui-upload-list" id="attachmentDiv"></div>
					 </blockquote>
		    	</div>
			 </div>
		 </div>
		 <div class="layui-form-item">
		    <div class="layui-input-block">
		      <button class="layui-btn" lay-submit="" lay-filter="abnormalSubit">立即提交</button>
		      <button type="reset" class="layui-btn layui-btn-primary">重置</button>
		    </div>
		  </div>
		  <input name="attachmentUrl" id="attachmentUrl" value="" hidden="true" />
		  <input name="status" id="status" value="0" hidden="true" />
		  <input name="handleUid" id="handleUid" value="" hidden="true" />
	</form>
	</div>
	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script type="text/javascript">
		var $ = layui.$;
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form;
		var upload = layui.upload;
		var abnormalDictItems = parent.abnormalDictItems;//数据字典内容
		var warehouseData = parent.warehouseData;//仓库字典内容
		var filedName;
		var filedId;
		var myDate = new Date();
		var date = myDate.toLocaleDateString();
		date = date.replace("/","-");
		date = date.replace("/","-");
		var time = myDate.getTime();
		var fileName="abnormal<000000>"+date+"<000000>"+time+"_";//文件路径
		var attchmeUrl="";
		var fileRName="";//文件的名称
		//多图片上传
		upload.render({
		    elem: '#upattach'
		    ,url: '${ctx}/fileUploadServlet?folder='+fileName
		    ,multiple: true
		    ,accept: 'file'
		    ,before: function(obj){
		      //预读本地文件示例，不支持ie8
		      obj.preview(function(index, file, result){
		    	fileRName = file.name;
		    	fileName = fileName+file.name;
		       // $('#attachmentUrl').append('<img src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')
		      });
		    }
		    ,done: function(res){
		      //上传完毕
		     attchmeUrl = attchmeUrl+fileName+";";
		     $('#attachmentDiv').append('<a src="#">'+fileRName+'</a>&nbsp;&nbsp;<i class="layui-icon" style="cursor:pointer" onclick="removeAttchme(this)">&#x1007;</i><br/>');
		     fileName="abnormal<000000>"+date+"<000000>"+time+"_";
		    }
		 });
		initSelect();
		//初始赋值下拉框
		function initSelect(){
			var dictType = new Array();
			dictType.push("abnormal_type");
			dictType.push("abnormal_node");
			dictType.push("abnormal_status");
			//查询字典
			var option={
					url:'${ctx}/dictItems/queryDictItemByTypes',
					type:'POST',
					dataType:'json',
					contentType: "application/json",
					data:JSON.stringify(dictType),
					success:function(res){
						if(res.code==0){
							abnormalDictItems = res.data;
							parent.abnormalDictItems = res.data;
							defulatAbnormalSelect(abnormalDictItems);
						}
					}
    			};
			if(abnormalDictItems==null){
				$.ajax(option);
			}else{
				defulatAbnormalSelect(abnormalDictItems);
			}
			initWarehouse();
		}
		function defulatAbnormalSelect(abnormalDictItems){
			if(abnormalDictItems && abnormalDictItems.length>0){
				if($("#abnormalType").find("option").length==1){
				  for(var i=0;i<abnormalDictItems.length;i++){
					   if(abnormalDictItems[i].dictTypeId=="abnormal_node"){
						  $("#abnormalNode").append("<option value="+abnormalDictItems[i].itemValue+">"+abnormalDictItems[i].itemName+"</option>");
					   }else if(abnormalDictItems[i].dictTypeId=="abnormal_type"){
						   $("#abnormalType").append("<option value="+abnormalDictItems[i].itemValue+">"+abnormalDictItems[i].itemName+"</option>");
					   }
				  }
				  form.render('select');
			  }
			}
		}
		//所属仓库值操作
	    function  initWarehouse(){
			 if(warehouseData!=null && warehouseData.length>0){
    			for(var i=0;i<warehouseData.length;i++){
    				if($("#storageLocation").find("option").length<=warehouseData.length){
    	  				$("#storageLocation").append("<option value="+warehouseData[i].orgCode+">"+warehouseData[i].orgName+"</option>");
    				}
    			}
				form.render('select');
				return;
			 }
			 var option={
						url:'${ctx}/dictItems/queryDictItemByName?itemName=仓库&dictName=组织类型',
						type:'GET',
						contentType: "application/json",
						success:function(res){
							if(res.code==0){
								var orgType = res.data.itemValue;
								var options={
										url:'${ctx}/orgination/queryOrgnizaByType?orgType='+orgType,
										type:'GET',
										contentType: "application/json",
										success:function(res){
											if(res.code==0 && res.data!=null && res.data.length>0){
												warehouseData = res.data;
												parent.warehouseData=res.data;
												for(var i=0;i<warehouseData.length;i++){
								    				if($("#storageLocation").find("option").length<=warehouseData.length){
								    	  				$("#storageLocation").append("<option value="+warehouseData[i].orgCode+">"+warehouseData[i].orgName+"</option>");
								    				}
								    			}
												form.render('select');
											}else{
												layer.msg("获取仓库资源信息失败！");
											}
											
										}
								};
								$.ajax(options);
							}else{
								layer.msg("获取仓库资源信息失败！");
							}
						}
				};
				$.ajax(option);
		  }
		function chooseUser(index){
			if(index==0){
				filedName="defualtName";
				filedId="defualtUid";
			}else if(index==1){
				filedName="chargeName";
				filedId="chargeUid"
			}else if(index==2){
				filedName="manageName";
				filedId="manageUid";
			}else if(index==3){
				filedName="mchargeName";
				filedId="mchargeUid";
			}
			layer.open({
		        type: 2
		        ,title:'选择人员'
		        ,maxmin:true
		        ,area: ['600px', '500px']
		        ,id: 'chooseUserId' //防止重复弹出
		        ,content: 'chooseUser.html'
		        ,shade: 0 //不显示遮罩
		        ,yes: function(){
		          layer.closeAll();
		        }
		   });
		}
		//自定义验证规则
		  form.verify({
			  arrivalCode: function(value){
		      if(value.length > 32){
		        return '长度超长，不能大于32';
		      }
		    }
		    ,arrivalItemNo: function(value){
			      if(value.length> 38){
				        return '长度超长，不能大于38';
				      }
				    }
		  });
		  
		  //监听提交
		  form.on('submit(abnormalSubit)', function(data){
			  var tempHandle = $("#defualtUid").val()+";"+$("#chargeUid").val()+";"+$("#manageUid").val()+";"+$("#mchargeUid").val()+";"
			  data.field.handleUid=tempHandle;
			  data.field.attachmentUrl=attchmeUrl;
			  var option = {
		    	url:'${ctx}/abnormal/insertAbnormal',
		    	data:JSON.stringify(data.field),
		    	type:'POST',
		    	contentType:'application/json',
		    	success:function(data){
		    		if(data.code==0){
		    			var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
		    			parent.layer.close(index);  // 关闭layer
		    			parent.table.reload('nomralTabId',{
		    				where:{
			    					page:1,
									limit:4
								  }
		    			});
		    		}else{
		    			layer.alert(data.msg);
		    		}
		    	},error:function(data){
		    		layer.alert(data.msg)
		    	}
		    }
		    $.ajax(option);  
			return false;
		  });
		  //移除附件名称
		  function removeAttchme(obj){
			  var parentObj = $(obj).prev();
			  var fileRName = parentObj.text();
			  attchmeUrl = attchmeUrl.replace(fileName+fileRName+";","");
			  parentObj.remove();
			  $(obj).remove();
		  }
	</script>
</body>
</html>