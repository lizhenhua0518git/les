<#assign  title="异常提醒列表" />
<#include '/header.html' />
<meta charset="UTF-8">
<style type="text/css">
.message-row{
	width: 100%;
	height: 40px;
	line-height: 40px;
	background-color: rgba(28, 129, 229, 1);
	color: rgba(255, 255, 255, 1);
	font-size: 20px;
	text-align: left;
	font-family: Roboto;
	border: 1px solid rgba(187, 187, 187, 1);
}
.message-row div{
	float:left;
}
.message-total{
	width: 118px;
	height: 18px;
	color: rgba(255, 255, 255, 1);
	font-size: 16px;
	text-align: left;
	font-family: SourceHanSansSC-regular;
	position:absolute;
}
.message-total span{
	margin-left:5px;
}
body{
	overflow:hidden;
}
</style>
<#if athemTag.loginFlag=="true" && athemTag.menuFlag=="true">
<div class="layui-row message-row">
    <div class="layui-col-xs12">
      <div class="grid-demo grid-demo-bg1">
      	<div style="margin-left:19px">异常提醒</div>
      	<div class="message-total" style="margin-left:86%"><button class="layui-btn layui-btn-primary layui-btn-sm" id="addAbnormal">新建异常</button></div>
      </div>
    </div>
</div>
<div class="layui-fluid" style="margin-top:8px">
	<div class="layui-row layui-form">
		<div class="layui-col-md3">
		 	<label class="layui-form-label">仓库:</label>
		 	<div class="layui-input-block layui-form">
			      <select  id="abnormal_storageLocation_search">
			        <option value="">请选择</option>
			      </select>
			</div>
		</div>
		<div class="layui-col-md3">
		 	<label class="layui-form-label">异常类型:</label>
		 	<div class="layui-input-block layui-form">
			      <select  id="abnormalType_search">
			        <option value="">请选择</option>
			      </select>
			</div>
		</div>
		<div class="layui-col-md3">
		 	<label class="layui-form-label">异常节点:</label>
			<div class="layui-input-block layui-form">
			      <select  id="abnormalNode_search">
			        <option value="">请选择</option>
			      </select>
			</div>
		</div>
		<div class="layui-col-md3">
		 	<label class="layui-form-label">状态:</label>
			<div class="layui-input-block layui-form">
			      <select  id="abnormalStatus_search">
			        <option value="">请选择</option>
			      </select>
			</div>
		</div>
	</div>
	<div class="layui-row layui-form" style="margin-bottom: 0">
		<div class="layui-col-md4">
		 	 <label class="layui-form-label">发起时间</label>
		      <div class="layui-input-inline" style="width:52.5%">
		        <input type="text" class="layui-input" id="recordTime_search" placeholder=" -- ">
		      </div>
		</div>
		<div class="layui-col-md2">&nbsp;</div>
		<div class="layui-col-md6">
			<div class="layui-btn-container" style="text-align: right;" id="normalButton">
				<#include '/bottonContainer.html' />
			</div>
		</div>
	</div>
</div>
<div id="abnormalTabDiv">
<table id="nomralListTab" lay-filter="nomralListTabF" ></table>
</div>
<script src="${ctx}/pages/js/jquery-3.3.1.min.js"></script>
<script src="${ctx}/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="${ctx}/pages/layui/lay/modules/layer.js" charset="UTF-8"></script>
<script src="${ctx}/pages/js/printer/jquery.jqprint-0.3.js"></script>
<script src="${ctx}/pages/js/printer/jquery-migrate-1.2.1.min.js"></script>
<script src="${ctx}/pages/js/barcode/jquery-barcode.js"></script>
<script type="text/javascript">
	layui.use(['element','jquery','form','table','layer','laydate'],function(){
		var $ = layui.$;
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form;
		var laydate = layui.laydate;
		var abnormalDictItems = parent.abnormalDictItems;
		var warehouseData = parent.warehouseData;
		table.render({
			elem:"#nomralListTab",
			id:"nomralListTabId",
			url:'${ctx}/abnormal/',
			cols:[[
				{type:'checkbox'}
				,{field:'recordTime',title:'发起时间',width:200}
				,{field:'storageLocation',title:'仓库'}
				,{field:'abnormalType',title:'异常类型'}
				,{field:'abnormalNode',title:'异常节点'}
				,{field:'status',title:'状态'}
				,{field:'handleUid',title:'问题归口人'}
				,{field:'recordUid',title:'发起人'}
				,{field:'reportTime',title:'上报时间'}
				,{field:'lastTime',title:'已用时间'}
			]],
			page: {theme: '#008155'},
			done:function(res,page,count){//列表数据回调函数
				//状态数据处理
				var dictType = new Array();
				dictType.push("abnormal_type");
				dictType.push("abnormal_node");
				dictType.push("abnormal_status");
				//查询字典
				var option={
						url:'${ctx}/dictItems/queryDictItemByTypes',
						type:'POST',
						dataType:'json',
						contentType: "application/json",
						data:JSON.stringify(dictType),
						success:function(res){
							if(res.code==0){
								abnormalDictItems = res.data
								//列表中的状态、接收方式赋值
								changeAbnormalItemName(abnormalDictItems);
								//搜索框的状态、接收方式赋值
								defulatAbnormalSelect(abnormalDictItems);

							}
						}
	    			};
				if(abnormalDictItems==null){
					$.ajax(option);
				}else{
					//列表中的状态、接收方式赋值
					changeAbnormalItemName(abnormalDictItems);
					//搜索框的状态、接收方式赋值
					defulatAbnormalSelect(abnormalDictItems);
				}
				initWarehouse();
				this.where={};//清楚携带的检索条件
			}
		});
		function changeAbnormalItemName(data){
			//异常类型数据处理
			$("[data-field='abnormalType']").children().each(function(){
				for(var i=0;i<data.length;i++){
					if(data[i].dictTypeId=="abnormal_type" && data[i].itemValue==$(this).text().trim()){
						$(this).text(data[i].itemName);
					}
				}
			});
			//异常节点数据处理
			$("[data-field='abnormalNode']").children().each(function(){
				for(var i=0;i<data.length;i++){
					if(data[i].dictTypeId=="abnormal_node" && data[i].itemValue==$(this).text().trim()){
						$(this).text(data[i].itemName);
					}
				}
			});
			//异常状态数据处理
			$("[data-field='status']").children().each(function(){
				for(var i=0;i<data.length;i++){
					if(data[i].dictTypeId=="abnormal_status" && data[i].itemValue==$(this).text().trim()){
						$(this).text(data[i].itemName);
					}
				}
			});
		}
		function defulatAbnormalSelect(abnormalDictItems){
			if(abnormalDictItems && abnormalDictItems.length>0){
				if($("#abnormalNode_search").find("option").length==1){
				  for(var i=0;i<abnormalDictItems.length;i++){
					   if(abnormalDictItems[i].dictTypeId=="abnormal_node"){
						  $("#abnormalNode_search").append("<option value="+abnormalDictItems[i].itemValue+">"+abnormalDictItems[i].itemName+"</option>");
					   }else if(abnormalDictItems[i].dictTypeId=="abnormal_type"){
						   $("#abnormalType_search").append("<option value="+abnormalDictItems[i].itemValue+">"+abnormalDictItems[i].itemName+"</option>");
					   }else if(abnormalDictItems[i].dictTypeId=="abnormal_status"){
						   $("#abnormalStatus_search").append("<option value="+abnormalDictItems[i].itemValue+">"+abnormalDictItems[i].itemName+"</option>");
					   }
				  }
				  form.render('select');
			  }
			}
		}
		//所属仓库值操作
	    function  initWarehouse(){
			 if(warehouseData!=null && warehouseData.length>0){
				 $("[data-field='storageLocation']").children().each(function(){
		    			for(var i=0;i<warehouseData.length;i++){
		    				if(warehouseData[i].orgCode==$(this).text().trim()){
		    					$(this).text(warehouseData[i].orgName);
		    				}
		    				if($("#abnormal_storageLocation_search").find("option").length<=warehouseData.length){
		    	  				$("#abnormal_storageLocation_search").append("<option value="+warehouseData[i].orgCode+">"+warehouseData[i].orgName+"</option>");
		    				}
		    			}

		    		});
				 form.render('select');
				 return;
			 }
			 var option={
						url:'${ctx}/dictItems/queryDictItemByName?itemName=仓库&dictName=组织类型',
						type:'GET',
						contentType: "application/json",
						success:function(res){
							if(res.code==0){
								var orgType = res.data.itemValue;
								var options={
										url:'${ctx}/orgination/queryOrgnizaByType?orgType='+orgType,
										type:'GET',
										contentType: "application/json",
										success:function(res){
											if(res.code==0 && res.data!=null && res.data.length>0){
												warehouseData = res.data;
												$("[data-field='storageLocation']").children().each(function(){
									    			for(var i=0;i<warehouseData.length;i++){
									    				if(warehouseData[i].orgCode==$(this).text().trim()){
									    					$(this).text(warehouseData[i].orgName);
									    				}
									    				if($("#abnormal_storageLocation_search").find("option").length<=warehouseData.length){
									    	  				$("#abnormal_storageLocation_search").append("<option value="+warehouseData[i].orgCode+">"+warehouseData[i].orgName+"</option>");
									    				}
									    			}
									    			form.render('select');
									    		});
											}else{
												layer.msg("获取仓库资源信息失败！");
											}

										}
								};
								$.ajax(options);
							}else{
								layer.msg("获取仓库资源信息失败！");
							}
						}
				};
				$.ajax(option);
		  }
	    var active = {
				search:function(res){
					var storageLocation = $("#abnormal_storageLocation_search").val();
					var abnormalType = $("#abnormalType_search").val();
					var abnormalNode = $("#abnormalNode_search").val();
					var status = $("#abnormalStatus_search").val();
					var recordTime = $("#recordTime_search").val();
					var param = {
							page:1,
							limit:4,
							abnormalType:abnormalType,
							storageLocation:storageLocation,
							abnormalNode:abnormalNode,
							status:status,
					};
					if(recordTime.length>0){
						startTime = new Date(recordTime.substring(0,20));
						endTime = new Date(recordTime.substring(22));
						param = {
								page:1,
								limit:4,
								abnormalType:abnormalType,
								storageLocation:storageLocation,
								abnormalNode:abnormalNode,
								status:status,
								startTime:startTime,
						        endTime:endTime,
						}
					}
					table.reload('nomralListTabId',{
						where:param
					});
				},reset:function(res){
					$("#abnormal_storageLocation_search").val();
					$("#abnormalType_search").val("");
					$("#abnormalNode_search").val("");
					$("#abnormalStatus_search").val("");
					$("#recordTime_search").val("");
					form.render('select');
				},export:function(othis){
					var data = table.cache.nomralListTabId;
					if(data.length>0){
						var storageLocation = $("#abnormal_storageLocation_search").val();
						var abnormalType = $("#abnormalType_search").val();
						var abnormalNode = $("#abnormalNode_search").val();
						var status = $("#abnormalStatus_search").val();
						var recordTime = $("#recordTime_search").val();
						var params="";
						params = params + "&abnormalType="+abnormalType+"&storageLocation="+storageLocation+"&abnormalNode="+abnormalNode+"&status="+status;
						if(recordTime.length>0){
							params = params + "&startTime="+new Date(recordTime.substring(0,20))+"&endTime="+new Date(recordTime.substring(22))
						}
						window.open("${ctx}/abnormal/exportAbnormalList?"+params);
					}else{
						layer.alert('导出失败！无数据',{icon: 2});
					}
				},print:function(res){
					 $("#abnormalTabDiv").jqprint({operaSupport: true});
				}

		};
	    $("#addAbnormal").click(function(){
			 layer.open({
				type: 2
		        ,title:'新增异常'
		        ,maxmin:false
		        ,area: ['100%', '100%']
		        ,id: 'addAbnormalId' //防止重复弹出
		        ,content: 'addAbnormal.html'
		        ,shade: 0 //不显示遮罩
		        ,yes: function(){
		          layer.closeAll();
		        }
			});
		});
		$('.layui-btn-container button').on('click', function(){
		    var othis = $(this), method = othis.data('method');
		    active[method] ? active[method].call(this, othis) : '';
	  	});
		table.on('rowDouble(nomralListTabF)', function(obj){
			  abnormalData = obj.data; //得到当前行数据
			  layer.open({
					type: 2
			        ,title:'异常提醒详细'
			        ,maxmin:false
			        ,area: ['100%', '100%']
			        ,id: 'abnormalDetail' //防止重复弹出
			        ,content: 'abnormalDetail.html'
			        ,shade: 0 //不显示遮罩
			        ,yes: function(){
			          layer.closeAll();
			        }
				});
			});
	});
</script>
<#else>
	<#include '/noAuthority.html' />
</#if>
<#include '/footer.html' />
