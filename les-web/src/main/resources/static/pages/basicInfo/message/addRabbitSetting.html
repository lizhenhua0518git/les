<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>新增消息配置信息</title>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
</head>
<body>
  <div id="bodyDiv"></div>
	<div class="layui-container" style="padding-top: 20px;">
		<form class="layui-form" action="">
			<div class="layui-form-item">
				<div class="layui-inline">
				    <label class="layui-form-label">类型</label>
				    <div class="layui-input-block">
				     	<select name="type" id="type" lay-verify="required" lay-filter="type">
					        <option value="">请选择</option>
					        <option value="0">消息监听</option>
					        <option value="1">消息接收</option>
					    </select>
				    </div>
			 	</div>
			 </div>
			<div class="layui-form-item">
				<div class="layui-inline">
				    <label class="layui-form-label">路由名称</label>
				    <div class="layui-input-block">
				      <input type="text" name="exchangeName" id="exchangeName" lay-verify="required" autocomplete="off" placeholder="请输入路由名称" class="layui-input" >
				    </div>
			 	</div>
				<div class="layui-inline">
				    <label class="layui-form-label">队列名称</label>
				    <div class="layui-input-block">
				      <input type="text" name="queueName" id="queueName" lay-verify="required"  autocomplete="off" placeholder="请输队列名称" class="layui-input" >
				    </div>
			 	</div>
			 </div>
			 <div class="layui-form-item">
			 	<div class="layui-inline">
				    <label class="layui-form-label">监听key值</label>
				    <div class="layui-input-block">
			      		<input type="text" name="routingKey" id="routingKey" lay-verify="required" autocomplete="off" placeholder="请输入监听key值，多个参数用逗号分隔" class="layui-input" >
			         </div>
			 	</div>
				<div class="layui-inline">
				    <label class="layui-form-label">消息接收地址</label>
				    <div class="layui-input-block">
				      <input type="text" name="callbackUrl" id="callbackUrl"   autocomplete="off" placeholder="请输入消息接收地址" class="layui-input" >
				    </div>
			 	</div>
			 </div>
		 	 <div class="layui-form-item">
		 		<div class="layui-inline">
				    <label class="layui-form-label">状态</label>
				    <div class="layui-input-block">
				     	<select name="status" id="status" lay-verify="required" lay-filter="status">
					        <option value="">请选择</option>
					        <option value="0">禁用</option>
					        <option value="1">启用</option>
					    </select>
				    </div>
			 	</div>
		 	</div>
			 <div class="layui-form-item">
			    <div class="layui-input-block">
			      <button class="layui-btn" lay-submit="" lay-filter="rabbitSettingSubit">立即提交</button>
			      <button type="reset" class="layui-btn layui-btn-primary">重置</button>
			    </div>
			  </div>
		</form>
	</div>
 <script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
	<script src="/iles/pages/assets/js/jquery-1.10.2.js"></script>
	<script src="/iles/pages/js/loginInspect.js"></script>
	
	<script type="text/html" id="bodyTpl"></script>
	<script type="text/javascript">
	 var contextPath = config.messageConfig.contextPath;
	 function loadding(){}
		var $ = layui.$;
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form
		var dictItems = parent.dictItems;
		layui.use(['form', 'layedit'], function(){
			 /*  form.verify({
				  beanName: function(value){
				      if(value.length < 1){
				        return '实体名称不能为空';
				      }
				      if(value.length > 32){
				        return '实体名称长度不能超过50';
				      }
				 }
			  }); */
			  //监听提交
			  form.on('submit(rabbitSettingSubit)', function(data){
				  saveRabbit(data);
				/* var option = {
					    	url:contextPath+'rabbitSetting/checkBeanName?beanName='+$("#beanName").val(),
					    	type:'GET',
					    	contentType:'application/json',
					    	success:function(res){
					    		if(res.code==0 ){
					    			if(res.data==0)
					    				saveRabbit(data);
					    			else
					    				layer.alert("重复的实体名称");
					    		}else{
					    			layer.alert(res.msg);
					    		}
					    	},error:function(data){
					    		layer.alert(data.msg)
					    	}
				}
				$.ajax(option);*/
				return false; 
			 });
			 form.on('select(type)',function(res){
				 var flg = false;
				 if(res.value=="0"){
					 $("#callbackUrl").attr("lay-verify","");
				 }else if(res.value=="1"){
					 $("#callbackUrl").attr("lay-verify","required");
					
				 }
			 });
		});
		function saveRabbit(data){
		  var option = {
			    	url:contextPath+'rabbitSetting/saveRabbitSetting',
			    	data:JSON.stringify(data.field),
			    	type:'POST',
			    	contentType:'application/json',
			    	success:function(data){
			    		if(data.code==0){
			    			var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
			    			parent.layer.close(index);  // 关闭layer
			    			parent.parentId = "";
			    			parent.table.reload('rabbitTabId');
			    		}else{
			    			layer.alert(data.msg);
			    		}
			    	},error:function(data){
			    		layer.alert(data.msg)
			    	}
			 }
			 $.ajax(option);
		}
		/* if(dictItems && dictItems.length>0){
			 defulatSelect(dictItems);
		}else{
			 queryDictItem(); 
		} */
		function queryDictItem(){
			  var dictType = new Array();
				dictType.push("rabbit_type");
				//查询字典
				var option={
						url:contextPath+'dictItems/listDictItemByTypes',
						type:'POST',
						dataType:'json',
						contentType: "application/json",
						data:JSON.stringify(dictType),
						success:function(res){
							if(res.code==0){
								dictItems = res.data
								defulatSelect(res.data);
							}
						}
	  			};
				$.ajax(option);
		  }
		  function defulatSelect(dictItems){
			  if(dictItems && dictItems.length>0){
				  for(var i=0;i<dictItems.length;i++){
					  if(dictItems[i].dictTypeId=="rabbit_type"){
						  $("#type").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
					  }
				  }
				  form.render('select');
			  }
		  }
	</script>
</body>
</html>