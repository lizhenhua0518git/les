<#assign  title="异常待确认" />
<#include '/header.html' />
<meta charset="UTF-8">
<#if athemTag.loginFlag=="true" && athemTag.menuFlag=="true">
<style type="text/css">
.layui-table-body{
	overflow-x:scroll;
}
</style>
<div class="layui-fluid">
	<div class="layui-row layui-form">
			<div class="layui-col-md3">
			 	<label class="layui-form-label">到货通知单号编号:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="deliveryCode" placeholder="请输入编码" class="layui-input">
			    </div>
			 </div>
			<div class="layui-col-md3">
			 	<label class="layui-form-label">异常编码:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="code" placeholder="请输入编码" class="layui-input">
			    </div>
			 </div>
		</div>
		<div class="layui-row layui-form" style="margin-bottom: 0">
			<div class="layui-col-md6">&nbsp;</div>
			<div class="layui-col-md6">
				<div class="layui-btn-container" style="text-align: right;">
					<#include '/bottonContainer.html' />
				</div>
			</div>
		</div>
	</div>
	<table class="layui-hide" id="carrierTab" lay-filter="carrierTabF"></table>
	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script type="text/javascript">
	var $ = layui.$;
	var element = layui.element;
	var layer = layui.layer;
	var table = layui.table;
	var treeGrid = layui.treeGrid;
	var form = layui.form;
	var upload = layui.upload;
	var oldData;
	var dictItems = null;//数据字典
	table.render({
		elem:'#carrierTab',
		id:'carrierTabId',
		url:'${ctx}/abnormalMfc/queryAbnormal',
		cols:[[
		{type:'checkbox'},
		//{field:'id', title: 'ID', sort: true},
		{field:'code',width:'202',title:'异常编码'},
		{field:'deliveryCode', width:'200', title: '到货通知单号编号'},
		{field:'lineItemSet', width:'200', title: '行项目号'},
		{field:'describe', width:'200', title: '问题描述'},
		{field:'recordName', width:'200', title: '记录人名称'},
		{field:'recordTime', width:'200', title: '记录时间'},
		{field:'confirmStatus', width:'200', title: '确认状态'},
		{field:'confirmName', width:'200', title: '确认人名称'},
		{field:'confirmTime', width:'200', title: '确认时间'},
		{field:'feedbackName', width:'200', title: '反馈人名称'},
		{field:'feedbackResult', width:'200',title: '反馈信息'},
		{field:'feedbackTime', width:'200', title: '反馈时间'},
		{field:'status', width:'200', title: '数据状态'}
		]],
		page: {theme: '#008155'},
   		height: 'full-95',
   		where:{
   			status:1
   			},
   		even:true,
   		done:function(res,page,count){//列表数据回调函数
   			initTableDate(res.data);
   			//一级载具下拉菜单初始化
   			//initSelect();
   		}
	});
	upload.render({
	  elem: '#import'
	  ,url: '${ctx}/carrier/importExcel' //必填项
	  ,method: 'post'
	  ,accept: 'file'
	  ,exts:'xls'
	  ,before: function(obj){
		layer.load(); //上传loading
	  }
	  ,done: function(res, index, upload){
		  if(res.code==0){
			  layer.alert('载具导入成功！', {icon: 6});
			  layer.closeAll('loading'); //关闭loading
			  table.reload('carrierTabId', {
			        page:{"curr":1}
			      });
		  }else{
			  layer.alert('载具导入失败！', {icon: 5});
			  layer.closeAll('loading'); //关闭loading
		  }

	  }
	  ,error: function(index, upload){
		  layer.alert('载具导入失败！', {icon: 5});
		  layer.closeAll('loading'); //关闭loading
	  }
	});
	  //监听行单击事件（单击事件为：rowDouble）
	  table.on('rowDouble(carrierTabF)', function(obj){
	    var data = obj.data;
	    layui.data('test', {
	    	  key: 'abnormal'
	    	  ,value: data
	    	});
	    window.location.href="${ctx}/pages/message/abnormalUpd1.html";
	    //标注选中样式
	    obj.tr.addClass('layui-table-click').siblings().removeClass('layui-table-click');
	  });
	var active = {
			add:function(othis){
				var type = othis.data('type');
	  			layer.open({
		        type: 2
		        ,title:'新增异常'
		        ,maxmin:true
		        ,area: ['100%', '100%']
		        ,offset: type
		        ,id: 'carrierAdd'+type //防止重复弹出
		        ,content: '${ctx}/pages/message/addAbnormal2.html'
		        ,shade: 0 //不显示遮罩
		        ,yes: function(){
		          layer.closeAll();
		        }
		      });
			},
			search:function(othis){
				var deliveryCode=$('#deliveryCode').val();
				var code=$('#code').val();
				var params={};
				params.deliveryCode=deliveryCode;
				params.code=code;
				params.status=1;
			      //执行重载
			      table.reload('carrierTabId', {
			        where:params,
			        page:{"curr":1}
			      });
			},reset:function(othis){
				$('#deliveryCode').val("");
				$('#code').val("");
				//form.render("select");
			}

	};
	$('.layui-btn-container button').on('click', function(){
	    var othis = $(this), method = othis.data('method');
	    active[method] ? active[method].call(this, othis) : '';
  	});
	//表格数据初始化
	function initTableDate(data){
		$("[data-field='confirmStatus']").children().each(function(){
			if($(this).text()=='0'){
				$(this).text('未处理');
			}else if($(this).text()=='1'){
				$(this).text('无效策效');
			}else if($(this).text()=='2'){
				$(this).text('确认通过');
			}
		});
		$("[data-field='status']").children().each(function(){
			if($(this).text()=='1'){
				$(this).text('待确认');
			}else if($(this).text()=='2'){
				$(this).text('待反馈');
			}else if($(this).text()=='3'){
				$(this).text('已完成');
			}
		});
	}
	//一级载具下拉菜单初始化
	function initSelect(){
		var dictType = new Array();
		dictType.push("carrier_type");
		//查询字典
		var option={
				url:'${ctx}/dictItems/queryDictItemByTypes',
				type:'POST',
				dataType:'json',
				contentType: "application/json",
				data:JSON.stringify(dictType),
				success:function(res){
					if(res.code==0){
						dictItems = res.data;
						//搜索框的区域类型、状态赋值
						defulatSelect(dictItems);
					}
				}
			};
		$.ajax(option);
		initWarehouseCode();
	}
	function defulatSelect(dictItems){
		if(dictItems && dictItems.length>0){
			if($("#carrier_type").find("option").length==1){
			  for(var i=0;i<dictItems.length;i++){
					$("#carrier_type").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
			  }
			  form.render('select');
		  }
		}
	}
	function initWarehouseCode(){
		var params={};
		params.itemName='仓库';
		params.dictName='组织类型';
		$.ajax({
			url:"${ctx}/dictItems/queryDictItemByName",
			type:"post",
			data :params,
			success:function(result){
				if(result.code==0){
					var itemValue = result.data.itemValue;
					params.orgType=itemValue;
					$.ajax({
						url:"${ctx}/orgination/queryOrgnizaByType",
						type:"post",
						data :params,
						success:function(res){
							if(res.code==0){
								var WarehouseCodes=res.data;
								if(WarehouseCodes.length>0){
									if($("#warehouse_code").find("option").length==1){
										for(var i=0;i<WarehouseCodes.length;i++){
											$("#warehouse_code").append("<option value="+WarehouseCodes[i].orgCode+">"+WarehouseCodes[i].orgName+"</option>");
										}
										form.render('select');
									}
								}
							}
						}
					});
				}
			}
		});
	}
</script>
<#else>
	<#include '/noAuthority.html' />
</#if>
<#include '/footer.html' />
