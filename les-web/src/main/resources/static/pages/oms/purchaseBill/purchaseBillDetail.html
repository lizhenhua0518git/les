<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="charset=UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css"
          type="text/css"/>
    <link rel="stylesheet" href="/iles/pages/css/layui_extend.css"
          type="text/css"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css"/>
    <title>采购入库订单明细</title>
</head>
<script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-xs" lay-event="showDetail">查看</a>
</script>
<body id="bodyDiv">
<script type="text/html" id="bodyTpl">
    <div class="layui-fluid">
        <div class="layui-row layui-form">
<!--            <div class="layui-col-md2">-->
<!--                <label class="layui-form-label">订单号</label>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="text" id="orderCode_search" class="layui-input" placeholder="请输入订单号">-->
<!--                </div>-->
<!--            </div>-->
            <div class="layui-col-md2">
                <label class="layui-form-label">供应商</label>
                <div class="layui-input-inline">
                    <input type="text" id="supplierName_search" class="layui-input" placeholder="请输入供应商">
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">单据类型</label>
                <div class="layui-input-inline">
                    <select id="orderType_search" xm-select="orderTypeSelect" xm-select-show-count="1">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">创建日期</label>
                <div class="layui-input-inline layui-form">
                    <input type="text" class="layui-input" id="requiredTime_search" placeholder="请选择创建时间">
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">物料号</label>
                <div class="layui-input-inline">
                    <input type="text" id="materialCode_search" class="layui-input" placeholder="请输入物料号">
                </div>
            </div>

            <div class="layui-col-md2">
                <label class="layui-form-label">行项目状态</label>
                <div class="layui-input-inline">
                    <select id="elikz_search" xm-select="elikzSelect" xm-select-show-count="1">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>

            <div class="layui-btn-container nav-" style="text-align: right;">
                {{# if(d.search==null || d.search=="true"){ }}
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="search" id="search" type="button"><i
                        class="layui-icon layui-icon-search"></i>查询
                </button>
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="reset" id="reset" type="button"><i
                        class="layui-icon  layui-icon-reset"></i>重置
                </button>
                {{# } }}
            </div>

         </div>
        <!--<div class="layui-row layui-form">
            <div class="layui-col-md2">
                <label class="layui-form-label">生产订单号</label>
                <div class="layui-input-inline">
                    <input type="text" id="salesOrderCode_search" class="layui-input" placeholder="请输入生产订单号">
                </div>
            </div>
        </div>-->
    </div>
    <div class="layui-fluid-table">
        <div class="layui-row layui-form">
            <div class="layui-btn-container">
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="dispatch_task" type="button"><i
                        class="layui-icon layui-icon-edit"></i>任务派发
                </button>
            </div>
        </div>
        <table class="layui-hide" id="purchaseBillDetailTab" lay-filter="purchaseBillDetailTabF"></table>
    </div>
</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/commonUtil.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
<script type="text/javascript">
    var element = layui.element;
    var layer = layui.layer;
    var table = layui.table;
    var form = layui.form;
    var laydate = layui.laydate;
    var oldData = parent.oldData;
    var contextPath = config.omsConfig.contextPath;



    var active = {

        search: function (othis) {

            var orderCode = $('#orderCode_search').val();
            var supplierName = $('#supplierName_search').val();
            var orderType = layui.formSelects.value('orderTypeSelect', 'valueStr');
            var requiredTime = $('#requiredTime_search').val();
            var materialCode = $('#materialCode_search').val();
            var elikz = layui.formSelects.value('elikzSelect', 'valueStr');
            var salesOrderCode = $('#salesOrderCode_search').val();

            var params = {};
            params.orderCode = oldData.orderCode;
            params.supplierName = supplierName;
            params.orderType = orderType;
            params.requiredTimeStr = requiredTime;
            params.materialCode = materialCode;
            params.elikz = elikz;
            params.salesOrderCode = salesOrderCode;
            //执行重载
            table.reload('purchaseBillDetailTabId', {
                where: params,
            });
        },
        reset: function (othis) {
            $('#orderCode_search').val("");
            $('#supplierName_search').val("");
            layui.formSelects.value('orderTypeSelect', []);
            $('#requiredTime_search').val("");
            $('#materialCode_search').val("");
            layui.formSelects.value('elikzSelect', []);
            $('#salesOrderCode_search').val("");
            form.render("select");
        },
        dispatch_task: function (othis) {
            if (oldData.orderType != 'NB'){
                layer.alert('请选择标准采购订单进行任务派发！', {
                    icon: 2
                });
                return;
            }
            let checkData = table.checkStatus('purchaseBillDetailTabId').data;
            if(checkData.length <=0) {
                layer.alert('请选择需要派发的物料信息！', {
                    icon: 2
                });
                return;
            }
            console.log("oldData>>>>",oldData);
            let vo = {
                //"主表ID"
                "id": oldData.id,
                //"订单CODE"
                "orderCode": oldData.orderCode,
                //"供应商"
                "supplierName": oldData.supplierName,
                //"供应商"
                "supplierCode": oldData.supplierCode,
                //"仓库CODE"
                "warehouseCode": checkData[0].warehouseCode,
                //"仓库名称"
                "warehouseName": checkData[0].warehouseName,
                //"库存地点"
                "storageLocation": checkData[0].storageLocation,

            }

            let detailList = [];
            for (let one of checkData) {

                if (isBlankStr(one.materialDesc)||isBlankStr(one.materialCode)){
                    layer.alert('请检查所要下发的物料的名称与code编码信息', {
                        icon: 2
                    });
                    return;
                }
                if (isBlankStr(one.currentIssuedAmount)||one.currentIssuedAmount <= 0){
                    layer.alert('请查看物料为:'+one.materialDesc+'的点收下发数量！(填写规则:大于0,不可为空)', {
                        icon: 2
                    });
                    return;
                }
                detailList.push(
                    {
                        //"详情表ID"
                        "id":one.id,
                        //"物料CODE"
                        "materialCode":one.materialCode,
                        //"描述"
                        "materialDesc":one.materialDesc,
                        //"单位"
                        "materialUnit":one.materialUnit,
                        //"当前下发量"
                        "currentIssuedAmount":one.currentIssuedAmount,
                        //"库存地点"
                        "storageLocation": one.storageLocation,
                        //"行项目号"
                        "itemNo":　parseInt(one.itemNo),

                    }
                );
            }
            vo.detailList = detailList;

            console.log("vovovovovovo>>>>>",vo);
            layer.confirm('已选中'+detailList.length+'条数据，确认派发?', {icon: 3, title:'提示'}, function(index){
                var option ={
                    url:contextPath+'purchaseBillDetail/saveTheImportantPurchaseOrder',
                    type:'POST',
                    contentType: "application/json",
                    dataType:'json',
                    data:JSON.stringify(vo),
                    success:function(data){
                        console.log("下发返回参数",data);
                        if(data.code==0){
                            layer.alert('任务已下发,手持端可以点收了!', {
                                icon: 1
                            });
                            layer.close(index);
                            table.reload('purchaseBillDetailTabId');
                        }else{
                            layer.alert('任务下发失败');
                        }
                    },error:function(data){
                        layer.alert('任务下发失败');
                    }
                }
                $.ajax(option);


            })

        }


    };

    function loadding() {
        table.render({
            elem: '#purchaseBillDetailTab',
            id: 'purchaseBillDetailTabId',
            url: contextPath + 'purchaseBillDetail/listPurchaseBillDetail',
            cols: [[
                {type:'checkbox',fixed: "left"},
                {
                    type: 'numbers',
                    title: '序号',
                    fixed: "left"
                }, {
                    field: 'materialCode',
                    width: '150',
                    title: '物料编码'
                }, {
                    field: 'materialDesc',
                    width: '150',
                    title: '物料名称'
                },{
                    field: 'orderCode',
                    width: '100',
                    title: '订单号'
                }, {
                    field: 'supplierName',
                    width: '150',
                    title: '供应商名称'
                }, {
                    field: 'orderTypeName',
                    title: '单据类型名称', templet(d) {
                        if (d.orderType == 'NB') {
                            return '标准采购订单';
                        } else if (d.orderType == 'TETH') {
                            return '退货采购订单';
                        } else {
                            return '-';
                        }
                    },
                    width: '150'
                }, {
                    field: 'itemNo',
                    width: '150',
                    title: '行项目号'
                }, {
                    field: 'itemType',
                    width: '150',
                    title: '项目类别', templet(d) {
                        if (d.itemType == '0') {
                            return '标准';
                        } else if (d.itemType == '2') {
                            return '寄售';
                        } else if (d.itemType == '3') {
                            return '外协';
                        } else {
                            return '-';
                        }
                    }
                }, {
                    field: 'subjectType',
                    width: '150',
                    title: '科目分配类别', templet(d) {
                        if (d.subjectType == 'M') {
                            return '专用料采购';
                        } else if (d.subjectType == 'T') {
                            return '通用料采购';
                        } else {
                            return '-';
                        }
                    }
                },  {
                    field: 'warehouseName',
                    width: '150',
                    title: '仓库名称'
                }, {
                    field: 'storageLocation',
                    width: '150',
                    title: '仓库库存地'
                },  {
                    field: 'materialUnit',
                    width: '150',
                    title: '单位'
                }, {
                    field: 'elikz',
                    width: '150',
                    title: '行项目状态', templet(d) {
                        if (d.elikz == '') {
                            return '未完成';
                        } else if (d.elikz == 'X') {
                            return '收货完成';
                        } else {
                            return '-';
                        }
                    }
                }, {
                    field: 'deliveryDate',
                    width: '150',
                    title: '交货日期'
                }, {
                    field: 'salesOrderCode',
                    width: '150',
                    title: '销售订单号'
                }, {
                    field: 'salesOrderItem',
                    width: '150',
                    title: '销售订单行号'
                }, {
                    field: 'billDate',
                    width: '150',
                    title: '单据日期'
                }, {
                    field: 'createTime',
                    width: '150',
                    title: '创建时间'
                },{
                    field: 'materialNum',
                    width: '150',
                    title: '订单数量',
                    fixed: 'right'
                },{
                    field: 'issuedAmount',
                    width: '150',
                    title: '已下发数量',
                    fixed: 'right'

                }, {
                    field: 'currentIssuedAmount',
                    width: '100',
                    title: '当前点收下发量',
                    type: 'space',
                    edit:'text',
                    fixed: 'right'
                }
                ]],
            page: {
                theme: '#008155'
            },
            even: true,
            where:{
                orderCode:oldData.orderCode
            },
            done: function (res, page, count) {//列表数据回调函数
            }
        });
        $('.layui-btn-container button').on('click', function () {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });
        //时间选择器
        laydate.render({
            elem: '#requiredTime_search',
            type: 'date',
            range: true
        });
        initOrderType();//单据类型
        initElikz();//初始化行项目状态下拉框

    }

    //初始化单据类型下拉框
    function initOrderType() {
        var optoinArray = [{name: '标准采购订单', value: 'NB'}, {name: '退货采购订单', value: 'TETH'}];
        layui.formSelects.data("orderTypeSelect", 'local', {
            arr: optoinArray
        });
    }
    //初始化行项目状态下拉框
    function initElikz() {
        var optoinArray = [{name: '未完成', value: ''}, {name: '收货完成', value: 'X'}];
        layui.formSelects.data("elikzSelect", 'local', {
            arr: optoinArray
        });
    }
</script>
</body>
</html>
