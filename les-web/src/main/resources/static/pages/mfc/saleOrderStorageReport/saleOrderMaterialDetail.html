<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="charset=UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css"
          type="text/css"/>
    <link rel="stylesheet" href="/iles/pages/css/layui_extend.css"
          type="text/css"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css"/>
    <title>销售订单物料明细</title>
</head>
<script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-xs" lay-event="showDetail">查看</a>
</script>
<body id="bodyDiv">
<script type="text/html" id="bodyTpl">
    <div class="layui-fluid">
        <div class="layui-row layui-form">

                <div class="layui-col-md2">
                    <label class="layui-form-label">是否延迟</label>
                    <div class="layui-input-inline">
                        <select id="overDate"  >
                            <option value="">请选择</option>
                            <option value="1">是</option>
                            <option value="0">否</option>
                        </select>
                    </div>
                </div>

            <div class="layui-col-md2">
                <label class="layui-form-label">入库时间</label>
                <div class="layui-input-inline layui-form">
                    <input type="text" class="layui-input" id="receiveStartTime" placeholder="">
                </div>
            </div>
                <div class="layui-col-md2">
                    <label class="layui-form-label">送检时间</label>
                    <div class="layui-input-inline layui-form">
                        <input type="text" class="layui-input" id="receiveEndTime" placeholder="">
                    </div>
                </div>
            <div class="layui-btn-container nav-" style="text-align: right;">
                {{# if(d.search==null || d.search=="true"){ }}
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="search" id="search" type="button"><i
                        class="layui-icon layui-icon-search"></i>查询
                </button>
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="reset" id="reset" type="button"><i
                        class="layui-icon  layui-icon-reset"></i>重置
                </button>
                {{# } }}
                {{# if(d.export==null || d.export=="true"){ }}
                <!--<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="export" type="button"><i class="layui-icon layui-icon-export"></i>导出</button>-->
                {{# } }}
            </div>
         </div>
    </div>
    <div class="layui-fluid-table">
        <div class="layui-row layui-form">
            <div class="layui-btn-container" style="text-align: left;">
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="export" type="button"><i class="layui-icon layui-icon-export"></i>导出</button>
            </div>
        </div>
        <table class="layui-hide" id="saleOrderMaterialDetailTab" lay-filter="saleOrderMaterialDetailTabF"></table>
    </div>
</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>

<script type="text/javascript">
    var element = layui.element;
    var layer = layui.layer;
    var table = layui.table;
    var form = layui.form;
    var laydate = layui.laydate;
    var oldData;
    var contextPath = config.mfcConfig.contextPath;
    var orderCode = parent.oldData.orderCode;
    var materialCode = parent.oldData.materialCode;
    var active = {

        search: function (othis) {


            var receiveStartTime = $('#receiveStartTime').val();

            var overDate = $('#overDate').val();
            var receiveEndTime = $('#receiveEndTime').val();


            var inStartDate = null;
            var inEndDate = null;
            var finishStartDate= null;
            var finishEndDate = null;
            if(receiveStartTime && receiveStartTime.length>0){
                inStartDate = receiveStartTime.substring(0,10);
                inEndDate = receiveStartTime.substring(13,23);
            }
            if(receiveEndTime && receiveEndTime.length>0){
                finishStartDate = receiveEndTime.substring(0,10);
                finishEndDate = receiveEndTime.substring(13,23);
            }

            var params = {};
            params.orderCode = orderCode;
            params.materialCode = materialCode;

            params.overDate = overDate;
            params.finishStartDate = finishStartDate;
            params.finishEndDate = finishEndDate;

            params.inStartDate = inStartDate;
            params.inEndDate = inEndDate;
            //执行重载
            table.reload('saleOrderMaterialDetailTabId', {

                where: params,
            });
        },
        reset: function (othis) {

            $('#receiveEndTime').val("");
            $('#receiveStartTime').val("");
            $('#overDate').val("");

            form.render("select");
        },export: function(othis) {
           var data = table.cache.saleOrderMaterialDetailTabId;
            if(data.length > 0) {
            var receiveStartTime = $('#receiveStartTime').val();

            var overDate = $('#overDate').val();
            var receiveEndTime = $('#receiveEndTime').val();


            var inStartDate = "";
            var inEndDate = "";
            var finishStartDate= "";
            var finishEndDate = "";
            if(receiveStartTime && receiveStartTime.length>0){
                inStartDate = receiveStartTime.substring(0,10);
                inEndDate = receiveStartTime.substring(13,23);
            }
            if(receiveEndTime && receiveEndTime.length>0){
                finishStartDate = receiveEndTime.substring(0,10);
                finishEndDate = receiveEndTime.substring(13,23);
            }
            var token = window.localStorage.token;
            var params = "";
            params = params + "inStartDate=" + inStartDate + "&inEndDate=" + inEndDate + "&finishStartDate=" + finishStartDate +
                "&finishEndDate=" + finishEndDate + "&overDate="+overDate+  "&orderCode="+orderCode+"&materialCode="+materialCode+  "&token=" + token;
            window.open(contextPath + 'saleOrderStorageReport/exportListMaterialDetail?' + params);
        } else {
            layer.alert('导出失败！无数据', {
                icon: 2
            });
        }
    }
    };

    function loadding() {
        form.render("select");
        table.render({
            elem: '#saleOrderMaterialDetailTab',
            id: 'saleOrderMaterialDetailTabId',
            url: contextPath + 'saleOrderStorageReport/listMaterialDetail',
            where:{materialCode:materialCode,orderCode:orderCode},
            cols: [[ {
                type: 'numbers',
                title: '序号'
            },   {
                field: 'materialCode',
                title: '物料编码'
            }, {
                field: 'materialName',
                title: '物料名称'
            }, {
                field: 'materialUnit',
                title: '物料单位'
            }, {
                field: 'receiveNum',
                title: '到货数量'
            }, {
                field: 'receiveStartTime',
                title: '入库日期'
            }, {
                field: 'pointNum',
                title: '点收数量'
            }, {
                field: 'pointerName',
                title: '点收人'
            }, {
                field: 'receiveEndTime',
                title: '送检时间'
            }, {
                field: 'qualifiedNum',
                title: '合格数量'
            }, {
                field: 'inspectionerName',
                title: '送检人'
            }, {
                field: 'inspectionTime',
                title: '质检完成时间'
            }, {
                field: 'overDate',
                title: '质检是否延迟'
            }, {
                field: 'supplierName',
                title: '供货商'
            } ]],
            even: true,
            done: function (res, page, count) {//列表数据回调函数
                initTableDate();
            }
        });


        $('.layui-btn-container button').on('click', function () {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });
        //时间选择器
        laydate.render({
            elem: '#receiveStartTime',
            type: 'date',
            range: true,
            trigger: 'click'
        });

        //时间选择器
        laydate.render({
            elem: '#receiveEndTime',
            type: 'date',
            range: true,
            trigger: 'click'
        });

        
        table.on('tool(saleOrderMaterialDetailTabF)', function(obj){
            var eventName = obj.event;
            oldData =  obj.data;
            if(eventName == "showDetail"){
                layer.open({
                    type : 2,
                    title : '销售订单物料入库详情',
                    maxmin : false,
                    area : [ '100%', '100%' ],
                    id : 'saleOrderMaterialDetailDetail' //防止重复弹出
                    ,
                    content : 'saleOrderMaterialDetailDetail.html',
                    shade : 0 //不显示遮罩
                    ,
                    yes : function() {
                        layer.closeAll();
                    }
                });
            }
        });
    }
    //表格数据初始化
    function initTableDate(data){


        $("[data-field='overDate']").children().each(function(){
            if($(this).text()=='1'){
                $(this).text('否');
            }else if($(this).text()=='0'){
                $(this).text('是');
            }
        });
    }

</script>
</body>
</html>