<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="charset=UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css"
          type="text/css"/>
    <link rel="stylesheet" href="/iles/pages/css/layui_extend.css"
          type="text/css"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css"/>
    <title>关键物料生产订单出库任务统计</title>
</head>

<body id="bodyDiv">
<script type="text/html" id="bodyTpl">
    <div class="layui-fluid">
        <div class="layui-row layui-form">
            <div class="layui-col-md2">
                <label class="layui-form-label">生产订单号</label>
                <div class="layui-input-inline">
                    <input type="text" id="orderCode" class="layui-input" placeholder="请输入生产订单号">
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">条件搜索</label>
                <div class="layui-input-inline">
                    <select  id="workshopCode_search"  xm-select="workshopCode_search" xm-select-show-count="1" >
                        <option value="">请选择车间</option>
                    </select>
                </div>
                <div class="layui-input-inline">
                    <select  id="lineCode_search"  xm-select="lineCode_search" xm-select-show-count="1">
                        <option value="">请选择产线</option>
                    </select>
                </div>
                <div class="layui-input-inline">
                    <select  id="stationCode_search"  xm-select="stationCode_search" xm-select-show-count="1">
                        <option value="">请选择工位</option>
                    </select>
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">仓库</label>
                <div class="layui-input-inline">
                    <select id="warehouseCode_search" xm-select="warehouseCodeSelect" xm-select-show-count="1">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>

        </div>
        <div class="layui-row layui-form">
            <div class="layui-col-md2">
                <label class="layui-form-label">需求时间</label>
                <div class="layui-input-inline layui-form">
                    <input type="text" class="layui-input" id="requiredTime" placeholder="请选择需求时间">
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">物料编码</label>
                <div class="layui-input-inline">
                    <input type="text" id="materialCode" class="layui-input" placeholder="请输入物料编码">
                </div>
            </div>
            <div class="layui-btn-container nav-" style="text-align: right;">
                {{# if(d.search==null || d.search=="true"){ }}
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="search" id="search" type="button"><i
                        class="layui-icon layui-icon-search"></i>查询
                </button>
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="reset" id="reset" type="button"><i
                        class="layui-icon  layui-icon-reset"></i>重置
                </button>
                {{# } }}

                {{# if(d.export==null || d.export=="true"){ }}
                <!--<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="export" type="button"><i class="layui-icon layui-icon-export"></i>导出</button>-->
                {{# } }}
            </div>
        </div>
        <div class="layui-fluid-table">
            <div class="layui-row layui-form">
                <div class="layui-btn-container" style="text-align: left;">
                    <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="export" type="button"><i class="layui-icon layui-icon-export"></i>导出</button>
                </div>
            </div>
            <table class="layui-hide" id="materialOutputTab" lay-filter="materialOutputTabF"></table>
        </div>
    </div>
</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/lay/modules/formSelects-v4.js" charset="UTF-8"></script>

<script type="text/html" id="toolbar">
    {{#  if(d.serialNumber != ''){ }}
    <a class="layui-btn layui-btn-xs" lay-event="showDetail">查看序列号</a>
    {{#  } }}
</script>
<script type="text/javascript">
    var element = layui.element;
    var layer = layui.layer;
    var table = layui.table;
    var form = layui.form;
    var laydate = layui.laydate;
    var formSelects = layui.formSelects;
    var oldData;
    var contextPath = config.mfcConfig.contextPath;
    var active = {
        search: function (othis) {
            //物料编码
            let materialCode = $('#materialCode').val();
            //车间
            let workshopCode = layui.formSelects.value('workshopCode_search', 'valueStr');
            //产线
            let lineCode = layui.formSelects.value('lineCode_search', 'valueStr');
            //工位
            let stationCode = layui.formSelects.value('stationCode_search', 'valueStr');
            //生产订单号
            let orderCode = $('#orderCode').val();
            //仓库
            let warehouseCode = layui.formSelects.value('warehouseCodeSelect', 'valueStr');
            //采购单号
            let requiredTime= $("#requiredTime").val();
            //请求参数封装
            if (!requiredTime || requiredTime =='' ) {
                layer.alert("需求时间必选");
                return;
            }
            let params = {};
            params.requiredTimeStart = requiredTime.split(' - ')[0];
            params.requiredTimeEnd = requiredTime.split(' - ')[1];
            params.workshopCode = workshopCode;
            params.lineCode = lineCode;
            params.stationCode = stationCode;
            params.materialCode = materialCode;
            params.orderCode=orderCode;
            params.wareHouseCode =warehouseCode;
            //执行重载
            table.reload('materialOutputTabId', {
                url: contextPath + 'materialOut/materialOfKeyOutReport',
                where: params,
            });
        },
        reset: function (othis) {
            $('#materialCode').val("");
            $("#requiredTime").val("");
            $('#orderCode').val("");
            layui.formSelects.value('workshopCode_search', []);
            layui.formSelects.value('lineCode_search', []);
            layui.formSelects.value('stationCode_search', []);
            layui.formSelects.value('warehouseCodeSelect', []);

            form.render("select");
        },export: function(othis) {
            let  data = table.cache.materialOutputTabId;
            if(data.length > 0) {
                let requiredTime= $("#requiredTime").val();
                if (!requiredTime || requiredTime =='' ) {
                    layer.alert("需求时间必选");
                    return;
                }
                //物料编码
                let materialCode = $('#materialCode').val();
                //车间
                let workshopCode = layui.formSelects.value('workshopCode_search', 'valueStr');
                //产线
                let lineCode = layui.formSelects.value('lineCode_search', 'valueStr');
                //工位
                let stationCode = layui.formSelects.value('stationCode_search', 'valueStr');
                //仓库
                let warehouseCode = layui.formSelects.value('warehouseCodeSelect', 'valueStr');
                //生产订单号
                let orderCode = $('#orderCode').val();
                let  requiredTimeStart = requiredTime.split(' - ')[0];
                let requiredTimeEnd = requiredTime.split(' - ')[1];
                let token = window.localStorage.token;
                let params = "";
                params = params + "orderCode=" + orderCode + "&materialCode=" + materialCode + "&workshopCode=" + workshopCode +
                    "&lineCode=" + lineCode +"&stationCode="  +stationCode +"&requiredTimeStart="+requiredTimeStart +
                    "&requiredTimeEnd="+requiredTimeEnd+"&token=" + token+"&wareHouseCode="+warehouseCode;
                window.open(contextPath + 'materialOut/materialOfKeyOutReportDownLoad?' + params);
            } else {
                layer.alert('导出失败！无数据', {
                    icon: 2
                });
            }
        }
    };

    function loadding() {
        table.render({
            elem: '#materialOutputTab',
            id: 'materialOutputTabId',
            data:[],
            cols: [[ {
                type: 'numbers',
                title: '序号'
            },   {
                field: 'orderCode',
                title: '生产订单号'
            }, {
                field: 'requiredTime',
                title: '需求时间'
            }, {
                field: 'workshopCode',
                title: '车间'
            }, {
                field: 'lineCode',
                title: '产线'
            }, {
                field: 'stationCode',
                title: '工位'
            }, {
                field: 'materialCode',
                title: '物料编码'
            }, {
                field: 'materialDesc',
                title: '物料名称'
            }, {
                field: 'materialUnit',
                title: '单位'
            }, {
                field: 'requiredNum',
                title: '需求数量'
            }, {
                field: 'matchNum',
                title: '匹配库存数量'
            }, {
                field: 'surplusNum',
                title: '剩余匹配数量'
            }, {
                field: 'quantityOffShelf',
                title: '下架数量'
            },{
                field: 'numberOfTransfers',
                title: '交接数量'
            },{align: 'center', title: '序列号', toolbar: "#toolbar",fixed:'right'}]],
            page: {
                theme: '#008155'
            },
            even: true,
            done: function (res, page, count) {//列表数据回调函数
            }
        });
        inintPlantMultiSelect("workshopCode_search", [], 2);
        initWarehouseMultiSelect("warehouseCode_search", "warehouseCodeSelect", 1, '');
        formSelects.render();
        // initWarehouseMultiSelect("warehouseCode_search", "warehouseCodeSelect", 1, '');
        //initStorageLocationMultiSelect("warehouseCode_search", "warehouseCodeSelect", 1, '');
        $('.layui-btn-container button').on('click', function () {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });
        table.on('tool(materialOutputTabF)', function (obj) {
            let eventName = obj.event;
            let data = obj.data;
            if (eventName == "showDetail") {
                layer.open({
                    title: "物料序列号",
                    content: data.serialNumber;
                })
            }
        });
        //时间选择器
        laydate.render({
            elem: '#requiredTime',
            type: 'date',
            range: true,
            trigger: 'click'
        });
    }
</script>
</body>
</html>
