<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>订单发起退料</title>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
</head>
<body>
<div id="bodyDiv">

</div>
<style type="text/css">
/* 使得下拉框与单元格刚好合适 */
td .layui-form-select{
	margin-top: -10px;
	margin-left: -15px;
	margin-right: -15px;
} 
</style>
<script type="text/html" id="selectType">
	<select name='returnType' >
        <option value=2>生产需求退料</option>
        <option value=1>不合格品退料</option>
        <option value=3>多料</option>
    </select>
</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script type="text/html" id="bodyTpl">
    <table class="layui-hide" id="returnMaterialBeginTab" lay-filter="returnMaterialBeginTabF"></table>
    <button class="layui-btn layui-btn-normal layui-btn-sm" id="returnMaterialBt" type="button" style="float: right;margin-right:20px;" onclick="returnMaterial();">确认退料</button>
</script>
<script type="text/javascript">
	var $ = layui.$;
	var element = layui.element;
	var layer = layui.layer;
	var table = layui.table;
	var form = layui.form;
	var upload = layui.upload;
	var assembleIds = parent.assembleIds;
	console.log(assembleIds);
    var wmsContextPath = config.wmsConfig.contextPath;

    //确认退料
    function returnMaterial(){
        $("#returnMaterialBt").hide();
        var returnTypes=document.getElementsByName("returnType");
        var checkStatus = table.checkStatus('returnMaterialBeginTabId')
            ,data = checkStatus.data;
        var returnMaterials=[];
        for(var i=0;i<data.length;i++){
            var returnMaterial={};
            returnMaterial.returnType=returnTypes[i].value;
            returnMaterial.assembleDetailId=data[i].assembleDetailId;
            returnMaterial.remark=data[i].remark;
            returnMaterial.returnCount=data[i].returnCount;
            returnMaterial.materialReturnCode=data[i].materialReturnCode;
            returnMaterials[i]=returnMaterial;
        }
        $.ajax({
            url:wmsContextPath+"deliveryWork/materialReturn",
            //type:"post",
            data:{returnMaterialInfo:JSON.stringify(returnMaterials)},
            success:function(res){
                if(res.code==0){
                    layer.open({
                        type: 1
                        //,offset: type
                        //,id: 'layerDemo'+type
                        ,content: '<div style="padding: 20px 100px;">'+ res.data +'</div>'
                        ,btn: '确定'
                        ,btnAlign: 'c' //按钮居中
                        ,shade: 0 //不显示遮罩
                        ,yes: function(){
                            var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                            parent.layer.close(index);  // 关闭layer
                        }
                    });
                }else{
                    layer.alert(res.msg, {icon: 5});
                    $("#returnMaterialBt").show();
                }
            }
        });
    }

    function loadding() {
        table.render({
            elem:'#returnMaterialBeginTab',
            id:'returnMaterialBeginTabId',
            url:wmsContextPath+'deliveryWork/materialReturnBegin',
            cols:[[
                {type:'checkbox',LAY_CHECKED:true},
                {field:'assembleOrderCode', width:200, title:'集配订单号'},
                {field:'materialReturnCode', width:150, title:'工序订单号'},
                {field:'materialCode', width:150,title:'物料编号'},
                {field:'materialDesc', width:350, title:'物料描述'},
                {field:'oldCount', width:120, title:'订单数量'},
                {field:'retreatCount', width:120, title:'可退数量'},
                {field:'returnCount', width:150, edit:'text',style:'background-color: #009688; color: #fff;',title:'退料数量（可编辑）'},
                {field:'returnType', width:120,templet:'#selectType', title:'退料类型'},
                {field:'remark', width:200,edit:'text',style:'background-color: #009688; color: #fff;', title: '备注'}
            ]],
            height: 'full-95',
            where:{assembleIds:assembleIds},
            even:true,
            done:function(res,page,count){//列表数据回调函数

            }
        });
        //监听单元格编辑
        table.on('edit(returnMaterialBeginTabF)', function(obj){
            var data = obj.data;//得到所在行所有键值
            var value = data.returnCount;//得到修改后的值
            var maxAcceptCount=data.retreatCount;
            var regu = /^[0-9]+\.?[0-9]*$/;
            if(value!=''){
                if(!regu.test(value)){
                    layer.alert('退料数量编辑有误！', {icon: 5});
                    data.returnCount=0;
                }else{
                    if(value>maxAcceptCount){
                        layer.alert('退料数量大于可退数量！', {icon: 5});
                        data.returnCount=0;
                    }
                }
            }
        });
    }
</script>
</body>
</html>