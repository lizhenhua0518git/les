<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>发起退料</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
</head>
<body>
<div id="bodyDiv">

</div>
<script src="/iles/pages/layui/layui.all.js"></script>
<script src="/iles/pages/layui/lay/modules/layer.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
<script type="text/html" id="bodyTpl">
	<div class="layui-fluid" style="margin-top:10px;">
		<div class="layui-row layui-form">
			<div class="layui-col-md3">
				<label class="layui-form-label">工序订单号:</label>
				<div class="layui-input-block">
					<input type="text" id="orderCode" class="layui-input">
				</div>
			</div>
			<div class="layui-col-md3">
				<label class="layui-form-label">产品线:</label>
				<div class="layui-input-block">
					<input type="text" id="productLine" class="layui-input">
				</div>
			</div>
			<div class="layui-col-md3">
				<label class="layui-form-label">分厂:</label>
				<div class="layui-input-block">
					<input type="text" id="subFactory" class="layui-input">
				</div>
			</div>
			<div class="layui-col-md3">
				<label class="layui-form-label">产线:</label>
				<div class="layui-input-block">
					<input type="text" id="pipeLineCode" class="layui-input">
				</div>
			</div>
		</div>
		<div class="layui-row layui-form" style="margin-bottom: 0;margin-top: 10px;">
			<div class="layui-col-md3">
				<label class="layui-form-label">工位:</label>
				<div class="layui-input-block">
					<input type="text" id="stationCode" class="layui-input">
				</div>
			</div>
			<div class="layui-col-md3">
				<label class="layui-form-label">仓库编号:</label>
				<div class="layui-input-block">
					<select id="warehouseCode" xm-select="select1" xm-select-show-count="1">
						<option value="">请选择</option>
					</select>
				</div>
			</div>
<!--			<div class="layui-col-md3">-->
<!--				<label class="layui-form-label">库存地点:</label>-->
<!--				<div class="layui-input-block">-->
<!--					<input type="text" id="storageLocation" class="layui-input">-->
<!--				</div>-->
<!--			</div>-->
			<div class="layui-col-md3">
				<label class="layui-form-label">工序物料:</label>
				<div class="layui-input-block">
					<input type="text" id="mcode" class="layui-input">
				</div>
			</div>
			<div class="layui-col-md3">
				<label class="layui-form-label">物料号:</label>
				<div class="layui-input-block">
					<input type="text" id="materialCode" class="layui-input">
				</div>
			</div>
		</div>
		<div class="layui-row layui-form" style="margin-bottom: 0;margin-top: 10px;">
			<div class="layui-col-md3">
				<label class="layui-form-label">下架时间:</label>
				<div class="layui-input-block">
					<input type="text" id="lowerFrameTime" class="layui-input" placeholder=" '%Y%m%d -  '%Y%m%d">
				</div>
			</div>
			<div class="layui-col-md3" style="width: 35%;">
				<div class="layui-btn-container" style="text-align: right;">
					{{# if(d.search==null || d.search=="true"){ }}
					<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
					<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
					{{# } }}
					<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="getCheckData" type="button">发起退料</button>
				</div>
			</div>
		</div>
	</div>
	<table class="layui-hide" id="jpWorkTab" lay-filter="jpWorkTabF"></table>
</script>
<script type="text/javascript">
var assembleIds=null;
var $ = layui.$;
var table = layui.table;
var element = layui.element;
var layer = layui.layer;
var active;
var wmsContextPath = config.wmsConfig.contextPath;
var form = layui.form;

	active = {
		search:function(othis){
			var storageLocation = layui.formSelects.value('select1', 'storagelocationStr');
			//执行重载
			table.reload('jpWorkTabId', {
	        	where:{
	        	type:2,
	        	lowerStartTime:$('#lowerFrameTime').val().substring(0,20),
	        	lowerEndTime:$('#lowerFrameTime').val().substring(22),
	        	productLine:$('#productLine').val(),
	        	orderCode:$('#orderCode').val(),
	        	subFactory:$('#subFactory').val(),
	        	pipeLineCode:$('#pipeLineCode').val(),
	        	stationCode:$('#stationCode').val(),
	        	storageLocation:storageLocation,
	        	mcode:$('#mcode').val(),
	        	jpJobNode:2,
	        	materialCode:$('#materialCode').val()
	        	}
	        	,page:{"curr":1}
	      });
		},
		getCheckData:function(othis){
			var checkStatus = table.checkStatus('jpWorkTabId')
			,data = checkStatus.data;
			var ids=[];
			for(var i=0;i<data.length;i++){
				ids[i]=data[i].id;
			}
	    	assembleIds=JSON.stringify(ids);
			console.log("父页面"+assembleIds);
			var type = othis.data('type');
			layer.open({
				type: 2
				,title:'订单发起退料'
				,maxmin:true
				,area: ['1000px', '450px']
				,offset: type
				,id: 'returnMaterial'+type //防止重复弹出
				,content: '/iles/pages/wms/returnTask/returnMaterial.html'
				,shade: 0 //不显示遮罩
				,yes: function(){
					layer.closeAll();
				}
			});
		},reset:function(othis){
			$('#productLine').val("");
			$('#orderCode').val("");
			$('#subFactory').val("");
			$('#pipeLineCode').val("");
			$('#stationCode').val("");
			$('#storageLocation').val("");
			$('#mcode').val("");
			$('#materialCode').val("");
			$('#jpJobNode').val("");
			$('#lowerFrameTime').val("");
		}
	};

function loadding() {
    table.render({
        elem:'#jpWorkTab',
        id:'jpWorkTabId',
        url:wmsContextPath+'deliveryWork/queryJp',
        cols:[[
            //{type:'numbers',title:'序号',fixed: 'left'},
            {type:'checkbox',field:'ASSEMBLE_ID',fixed: 'left'},
            {field:'productLine',width:80,title:'产品线',fixed: 'left'},
            {field:'subFactory',width:80,title:'分厂', fixed: 'left'},
            {field:'pipeLineCode',width:80,title:'产线', fixed: 'left'},
            {field:'stationCode',width:80,title:'工位', fixed: 'left'},
            {field:'ocode',width:120,title:'工序订单号',fixed: 'left'},
            {field:'bwart',width:80,title:'移动类型',fixed: 'left'},
            {field:'lifnr',width:80,title:'供应商编号',fixed: 'left'},
            {field:'mcode',width:140,title:'工序订单物料号',fixed: 'left'},
            {field:'mdesc',width:140,title:'工序订单物料描述'},
            {field:'rtime',width:160,title:'需求时间'},
            {field:'storageLocation',width:120,title:'库存地点'},
            {field:'storageBinId',width:120,title:'仓位号'},
            {field:'materialCode',width:120,title:'物料号'},
            {field:'materialDesc',width:120,title:'物料描述'},
            {field:'accountCount',width:120,title:'数量'},
            {field:'retreatCount',width:120,title:'可退数量'},
            {field:'materialUnit',width:120,title:'单位'},
            {field:'batchNum',width:120,title:'批次号'},
            {field:'assembleUid',width:120,title:'集配操作人'},
            {field:'jobNode',width:120,title:'集配状态'},
            {field:'lowerFrameTime',width:160,title:'下架时间'},
            {field:'assembleTime',width:160,title:'集配时间'},
            {field:'checkTime',width:160,title:'复核时间'},
            {field:'moveDispatchTime',width:160,title:'移库发货区时间'},
            {field:'assembleDate',width:160,title:'集配用时'},
            {field:'orderMaterialCode',width:120,title:'标准时长'},
            {field:'isUrgent',width:120,title:'超时状态'},
            {field:'deliverPlatform',width:120,title:'配送台位'},
            {field:'voucherCode',width:120,title:'凭证号'},
            {field:'voucherLineNum',width:120,title:'凭证行项目'},
            {field:'voucherYear',width:120,title:'凭证年度'},
            {field:'toNum',width:120,title:'TO'},
            {field:'toLineNum',width:120,title:'TO行'},
            {field:'reserveCode',width:120,title:'预留号'},
            {field:'reserveRow',width:120,title:'预留行'},
            {field:'assembleOrderCode',width:120,title:'集配单据号'},
            {field:'activeNum',width:120,title:'集配序号'},
            {field:'atime',width:120,title:'派工日期'}
        ]],
        page:{theme: '#008155'},
        where:{
            type:2,
            storageLocation:'1100',
            jpJobNode:2
        },
        even:true,
        title:'集配作业',
        done:function(res){
            changeItemName(res.data);
            initTableDate(res.data);
        }
    });
    $('.layui-btn-container button').on('click', function(){
        var othis = $(this), method = othis.data('method');
        active[method] ? active[method].call(this, othis) : '';
    });

	var laydate = layui.laydate;
	//时间选择器
	laydate.render({
		elem: '#lowerFrameTime'
		,type: 'datetime'
		,range: true
	});

	initWarehouseMultiSelect("warehouseCode","select1","0",null);
	form.render();

	function initTableDate(data){
		$("[data-field='job_node']").children().each(function(i,e){
			if(i>0){
				if(data[i-1].job_node <='33'){
					$(this).html("待集配");
				}else{
					$(this).html("已集配");
				}
				element.init();
			}
		});
	}

	//手动计算数据
	function changeItemName(data){
		$("[data-field='assemble_date']").children().each(function(i,e){
			if(i>0){
				var time ="";
				var myDate = new Date().getTime();
				if(data[i-1].ATIME!=null){
					myDate = new Date(data[i-1].ASSEMBLE_TIME).getTime();
				}
				if(data[i-1].LOWER_FRAME_TIME!=null){
					var date =  new Date(data[i-1].LOWER_FRAME_TIME).getTime();
					date = myDate-date;
					var days    = date / 1000 / 60 / 60 / 24;
					var daysRound= Math.floor(days);
					var hours    = date/ 1000 / 60 / 60 - (24 * daysRound);
					var hoursRound   = Math.floor(hours);
					var minutes   = date / 1000 /60 - (24 * 60 * daysRound) - (60 * hoursRound);
					var minutesRound  = Math.floor(minutes);
					var seconds   = date/ 1000 - (24 * 60 * 60 * daysRound) - (60 * 60 * hoursRound) - (60 * minutesRound);
					var secondsRound  = Math.floor(seconds);
					if(!isNaN(daysRound)){
						time+= daysRound+"天";
					}
					if(!isNaN(hoursRound)){
						time+= hoursRound +"时";
					}
					if(!isNaN(minutesRound)){
						time+= minutesRound+"分";
					}
				}
				if(time==""){
					time="0分";
				}
				$(this).html(time);
				element.init();
			}
		});
	}
}
</script>
</body>
</html>
