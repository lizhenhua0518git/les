<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Content-Type" content="charset=UTF-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
<link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
<title>直送计划列表</title>
</head>
<body>
<div id="bodyDiv">

</div>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js"></script>
<script type="text/html" id="bodyTpl">
	<div class="layui-fluid">
	<div class="layui-row layui-form">
		<div class="layui-col-md3">
			<label class="layui-form-label">项目号:</label>
		 	<div class="layui-input-block">
				<input type="text" id="projOut" class="layui-input">
			</div>
	    </div>
        <div class="layui-col-md3">
        	<label class="layui-form-label">需求日期:</label>
        	<div class="layui-input-block layui-form">
				<input type="text" class="layui-input" name="requiredDate" id="requiredDate" placeholder=" - ">
        	</div>
        </div>
        <div class="layui-col-md3">
        	<label class="layui-form-label">供货日期:</label>
           	<div class="layui-input-block layui-form">
           		<input type="text" class="layui-input" name="deliveryDate" id="deliveryDate" placeholder=" - ">
          	</div>
      	</div>
        <div class="layui-col-md3">
        	<label class="layui-form-label">作业状态:</label>
        	<div class="layui-input-block">
            	<select name="jobNode" id="jobNode" class="layui-select">
                	<option value="">请选择</option>
               		<option value="-2">供货商无响应</option>
                	<option value="-1">未卸货</option>
                    <option value="10">直送到货 </option>
                    <option value="20">开始卸货</option>
                    <option value="30">卸货完成  </option>
                    <option value="40">开始点收 </option>
                    <option value="50">点收完成 </option>
                    <option value="51">交接完成 </option>
                    <option value="60">开始清点审核</option>
                    <option value="70">清点审核完成 </option>
                    <option value="80">开始交接审核 </option>
                    <option value="90">交接审核完成</option>
             	</select>
           	</div>
       	</div>
	</div>
	</br>
    <div class="layui-row layui-form">
       	<div class="layui-col-md3">
			<label class="layui-form-label">工位:</label>
			<div class="layui-input-block">
				<select  id="zgwdm" xm-select="select5" xm-select-show-count="1" xm-select-search="">
					<option value="">请选择</option>
				</select>
			</div>
       	</div>
        <div class="layui-col-md3">
           	<label class="layui-form-label">生产订单号:</label>
            <div class="layui-input-block">
            	<input type="text" id="orderCode" class="layui-input">
            </div>
       	</div>
        <div class="layui-col-md3">
           	<label class="layui-form-label">到货通知单:</label>
           	<div class="layui-input-block">
               	<input type="text" id="arrivalCode" class="layui-input">
            </div>
       	</div>
 		<div class="layui-col-md3">
       		<label class="layui-form-label" style="padding-left: 7px;width: 88px;">是否有通知单:</label>
           	<div class="layui-input-block">
            	<select name="hadArrivalCode" id="hadArrivalCode" class="layui-select">
                	<option value="">请选择</option>
                	<option value="1">无</option>
               		<option value="2">有</option>
				</select>
           	</div>
       	</div>
	</div>
	</br>
	<div class="layui-row layui-form">
    	<div class="layui-col-md3">
			<label class="layui-form-label">物料号:</label>
			<div class="layui-input-block">
				<input type="text" id="matnr" class="layui-input">
			</div>
		</div>
		<div class="layui-col-md3">
			<label class="layui-form-label">车号:</label>
			<div class="layui-input-block">
				<input type="text" id="zchdm" class="layui-input">
			</div>
		</div>
		<div class="layui-col-md3">
			<label class="layui-form-label">分厂:</label>
			<div class="layui-input-block layui-form">
				<input type="text" class="layui-input" name="zfcdm" id="zfcdm" >
			</div>
		</div>
	</div>
</div>
<div class="layui-row layui-form" style="margin-bottom: 0">
	<div class="layui-btn-container" style="text-align: right;">
				{{# if(d.search==null || d.search=="true"){ }}
		           <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
		           <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
	            {{# } }}
				{{# if(d.export==null || d.export=="true"){ }}
					<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="export" type="button"><i class="layui-icon layui-icon-export"></i>导出</button>
				{{# } }}
	</div>
</div>

<table id="directPlanTab" lay-filter="directPlanTabF"></table>
</script>
<script type="text/javascript">
layui.config({
    base: '/iles/pages/layui/lay/modules/' //此处路径请自行处理, 可以使用绝对路径
}).extend({
    formSelects: 'formSelects-v4'
});
var element = layui.element;
var layer = layui.layer;
var table = layui.table;
var form = layui.form;
var contextPath = config.wmsConfig.contextPath;
var formSelects;
var tableFilter = layui.tableFilter;
var oldData;
layui.use(['formSelects'],function(){
	formSelects = layui.formSelects;
});
var active = {
		search:function(othis){
			var projOut =$("#projOut").val();
			var arrivalCode=$.trim($('#arrivalCode').val());
			var zchdm=$.trim($('#zchdm').val());
			var zfcdm =$.trim($('#zfcdm').val());
			var orderCode =$.trim($('#orderCode').val());
			var matnr =$.trim($('#matnr').val());
			//工位
			var zgwdm = "";
			var sCodeArray = layui.formSelects.value('select5', 'val');
			for(var i=0;i<sCodeArray.length;i++){
				zgwdm += "'"+sCodeArray[i]+"',"
			}
			if(zgwdm != ""){
				zgwdm = zgwdm.substring(0,zgwdm.length-1);
			}
			//var zgwdm =$.trim($('#zgwdm').val());
			var jobNode = $('#jobNode').val() ;
			var hadArrivalCode = $('#hadArrivalCode').val() ;

			var requiredDateStart ='';
			var requiredDateEnd ='';
			var deliveryDateStart ='';
			var deliveryDateEnd ='';
			if($('#requiredDate').val() !='' && $('#requiredDate').val() !=null){
				requiredDateStart = $('#requiredDate').val().split(' - ')[0];
				requiredDateEnd = $('#requiredDate').val().split(' - ')[1];
			}
			if($('#deliveryDate').val() !='' && $('#deliveryDate').val() !=null){
				deliveryDateStart = $('#deliveryDate').val().split(' - ')[0];
				deliveryDateEnd = $('#deliveryDate').val().split(' - ')[1];
			}

			var params={};
			params.projOut=projOut;
			params.zchdm=zchdm;
			params.arrivalCode=arrivalCode;

			params.requiredDateStart=requiredDateStart;
			params.requiredDateEnd=requiredDateEnd;
			params.deliveryDateStart=deliveryDateStart;
			params.deliveryDateEnd=deliveryDateEnd;
			params.zfcdm=zfcdm;
			params.zgwdm=zgwdm;
			params.orderCode=orderCode;
			params.matnr=matnr;
			params.jobNode=jobNode;
			params.hadArrivalCode=hadArrivalCode;
	        //执行重载
	        table.reload('directPlanId', {
				where:params,
				page:{"curr":1}
	        });
		},reset:function(othis){
			$('#arrivalCode').val("");
			$('#jobNode').val("");
			$('#hadArrivalCode').val("");
			$('#projOut').val("");
			$('#zchdm').val("");
			$('#zfcdm').val("");
			$('#orderCode').val("");
			$('#matnr').val("");
			layui.formSelects.value('select5', []);
			//$('#zgwdm').val("");
			$('#requiredDate').val("");
			$('#deliveryDate').val("");
			form.render("select");
		},export:function(othis){
			var projOut =$("#projOut").val();
			var arrivalCode=$.trim($('#arrivalCode').val());
			var zchdm=$.trim($('#zchdm').val());
			var zfcdm =$.trim($('#zfcdm').val());
			var orderCode =$.trim($('#orderCode').val());
			var matnr =$.trim($('#matnr').val());
			//工位
			var zgwdm = "";
			var sCodeArray = layui.formSelects.value('select5', 'val');
			for(var i=0;i<sCodeArray.length;i++){
				zgwdm += "'"+sCodeArray[i]+"',"
			}
			if(zgwdm != ""){
				zgwdm = zgwdm.substring(0,zgwdm.length-1);
			}
			var jobNode = $('#jobNode').val() ;
			var hadArrivalCode = $('#hadArrivalCode').val() ;

			var requiredDateStart ='';
			var requiredDateEnd ='';
			var deliveryDateStart ='';
			var deliveryDateEnd ='';
			if($('#requiredDate').val() !='' && $('#requiredDate').val() !=null){
				requiredDateStart = $('#requiredDate').val().split(' - ')[0];
				requiredDateEnd = $('#requiredDate').val().split(' - ')[1];
			}
			if($('#deliveryDate').val() !='' && $('#deliveryDate').val() !=null){
				deliveryDateStart = $('#deliveryDate').val().split(' - ')[0];
				deliveryDateEnd = $('#deliveryDate').val().split(' - ')[1];
			}

			var params = "";
			if(projOut != ''){
				params += "projOut="+projOut;
			}
			if(zchdm != ''){
				params += "&zchdm="+zchdm;
			}
			if(arrivalCode != ''){
				params += "&arrivalCode="+arrivalCode;
			}
			if(requiredDateStart != ''){
				params += "&requiredDateStart="+requiredDateStart;
			}
			if(requiredDateEnd != ''){
				params += "&requiredDateEnd="+requiredDateEnd;
			}
			if(deliveryDateStart != ''){
				params += "&deliveryDateStart="+deliveryDateStart;
			}
			if(deliveryDateEnd != ''){
				params += "&deliveryDateEnd="+deliveryDateEnd;
			}
			if(zfcdm != ''){
				params += "&zfcdm="+zfcdm;
			}
			if(zgwdm != ''){
				params += "&zgwdm="+zgwdm;
			}
			if(orderCode != ''){
				params += "&orderCode="+orderCode;
			}
			if(matnr != ''){
				params += "&matnr="+matnr;
			}
			if(jobNode != ''){
				params += "&jobNode="+jobNode;
			}
			if(hadArrivalCode != ''){
				params += "&hadArrivalCode="+hadArrivalCode;
			}
			var token = window.localStorage.token;
			params += "&token="+token;
		 	window.open(contextPath+"directDeliveryPc/exportDirectPlanList?"+params);
		}
	};
function loadding(){

	//日期范围
	layui.use('laydate', function(){
	   	var laydate = layui.laydate;
	   	laydate.render({
	   	    elem: '#requiredDate',
	   	    range: true
	   	});

	   	var laydate = layui.laydate;
	   	laydate.render({
	   	    elem: '#deliveryDate',
	   	    range: true
	   	});

	   	initStationCode();//工位
	});
	table.render({
	    elem:'#directPlanTab',
	    id:'directPlanId',
	    url:contextPath+'directDeliveryPc/queryDirectPlanList',

	    cols:[[
	    {type:'numbers',title:'序号',width: 50},
	    {field:'PROJ_OUT', width:120, title: '项目号'},
	    {field:'DELIVERY_DATE', width:120, title: '要求供货日期'},
	    {field:'BDTER', width:120, title: '需求日期'},
	    {field:'REQ_TIME', width:100, title: '需求时间'},
	    {field:'ORDER_CODE', width:120, title: '生产订单号'},
	    {field:'ARRIVAL_CODE', width:120, title: '到货通知单', event: 'arrivalCode'},
	    {field:'ZCHDM', width:100, title: '车号'},
	    {field:'ZFCDM', width:100, title: '分厂代码'},
	    {field:'ZGWDM', width:120, title: '工位代码'},
	    {field:'ZCXDM', width:100, title: '产线'},
	    {field:'ZLSCPX', width:100, title: '隶属产品线'},
	    {field:'MATNR', width:150, title: '物料号'},
	    {field:'MAKTX', width:100, title: '物料描述'},
	    {field:'LACK_QTY', width:120, title: '生产线需求数量'},
	    {field:'MEINS', width:100, title: '单位'},

	    {field:'JOB_NODE', width:120, title: '作业状态'},

	    {field:'EKNAM', width:120, title: '采购组描述'},
	    {field:'CPUTM', width:120, title: '最晚送达时间'},
	    {field:'RSNUM', width:120, title: '预留编号'},
	    {field:'RSPOS', width:100, title: '预留行项目'},
	    {field:'CAR_TYPE', width:100, title: '车型'},
	    {field:'PROJ_DESC', width:120, title: '项目描述'},
	    {field:'LGORT', width:100, title: '库位'},
	    {field:'LIFNR', width:120, title: '供应商'},
	    {field:'LIFNRNAM', width:120, title: '供应商名称'},
	    {field:'ZSFZSGW', width:120, title: '物料是否直送'},
	    {field:'BUFFER_STOCK', width:80, title: '缓冲区库存'},
	    {field:'SUPPLIER_NUMBER', width:100, title: '供应商合格库存'},
	    {field:'SUPPLIER_ONHEAD', width:100, title: '供应商总库存'},
	    {field:'PMENGE', width:80, title: '列用量'},
	    {field:'SUPPLIER_COLUMN_Q', width:100, title: '供应商合格列数'},
	    {field:'SUPPLIER_COLUMN', width:100, title: '供应商库存列数'},
	    {field:'OWNER_SAFETY_NUM', width:100, title: '供应商安全库存列数'},
	    {field:'DIFF_COLUMN', width:100, title: '供应商列差异'}

	    ]],
	    page:{theme: '#008155'},
	    height: 'full-95',
	    done:function(res,page,count){//列表数据回调函数
	    	 initTableDate(res.data);
	    }
	});
	//监听单元格事件
	table.on('tool(directPlanTabF)', function(obj){
		var data = obj.data;
		if(obj.event === 'arrivalCode'){
		 	var arrivalCode =data.ARRIVAL_CODE;
		    if(arrivalCode==null || arrivalCode==''){
		  	  	layer.alert("选中的记录行中到货通知单号为空");
		    }else{
		  	  	showTab(arrivalCode);
		    }
		}
	});
	$('.layui-btn-container button').on('click', function(){
		var othis = $(this), method = othis.data('method');
			active[method] ? active[method].call(this, othis) : '';
		});
	form.render();
}
function initStationCode(){//工位
	$.ajax({
		url:config.basicInfoConfig.contextPath+"stationManager/getAllStationCode",
		type:"GET",
		success:function(result){
			$('#zgwdm').html("");
			$('#zgwdm').append('<option value="">请选择</option>');
      	  	var order = result.data;
			if(order && order.length>0){
			var optionItem;
			var optoinArray = new Array();
				for(var i=0;i<order.length;i++){
				optionItem = {"name":""+order[i].stationCode, "value":""+order[i].stationCode};
				optoinArray.push(optionItem);
				}
				layui.formSelects.data('select5','local',{
					arr:optoinArray
				});
			}
		}
	});
}
function showTab(arrivalCode){
	var url="";
	var title="";
	var dataId="";

	url = 'directDeliveryMain.html?arrivalCode='+arrivalCode;
	title ='直送订单';
	dataId ="directDelivery";

	var isData = false;
	var liObj =$("body", parent.document).find(".layui-tab-title li[lay-id]");
	if(dataId && dataId.length>0){
		$.each(liObj, function () {
			if ($(this).attr("lay-id") == dataId) {
				isData = true;
			}
		})
		if (isData == false) {
			window.parent.active.tabAdd(url,dataId,title);
		}
		window.parent.active.tabChange(dataId);
	}
}
function initTableDate(data){
	$("[data-field='ZSFZSGW']").children().each(function(){
		if($(this).text()=='X'){
			$(this).text('是');
		}
		else if($(this).text()==''){
			$(this).text('否');
		}
	});
	$("[data-field='JOB_NODE']").children().each(function(){
		if($(this).text()=='-2'){
			$(this).text('供货商无响应');
		} else if ($(this).text()=='-1'){
           	$(this).text('待卸货');
       	} else if ($(this).text()=='10'){
           	$(this).text('直送到货');
        } else if ($(this).text()=='20'){
           	$(this).text('开始卸货');
       	} else if ($(this).text()=='30'){
           	$(this).text('卸货完成 ');
        } else if ($(this).text()=='40'){
           	$(this).text('开始点收');
        } else if ($(this).text()=='50'){
            $(this).text('点收完成');
       	} else if ($(this).text()=='51'){
           	$(this).text('交接完成');
        } else if ($(this).text()=='60'){
           	$(this).text('开始清点审核');
        } else if ($(this).text()=='70'){
           	$(this).text('清点审核完成');
        } else if ($(this).text()=='80'){
            $(this).text(' 开始交接审核');
        } else if ($(this).text()=='90'){
            $(this).text('交接审核完成');
        }
	});
}
</script>
</body>
</html>
