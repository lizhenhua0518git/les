<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Content-Type" content="charset=UTF-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
<title>供应商直送订单</title>
</head>
<body>
<div id="bodyDiv">

</div>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/lay/modules/layer.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js"></script>
<script type="text/html" id="bodyTpl">
	<div class="layui-fluid">
		 <div class="layui-row layui-form">

           <input type="hidden" id="id"/>
           <input type="hidden" id="img"/>
         <div class="layui-col-md3">
                <label class="layui-form-label">到货通知单:</label>
                 <div class="layui-input-block">
                  <input type="text" id="arrivalCode" class="layui-input">
                </div>
            </div>
             <div class="layui-col-md3">
                <label class="layui-form-label">到货日期:</label>
                <div class="layui-input-block layui-form">
                    <input type="text" class="layui-input" name="expectedArrivalDate" id="expectedArrivalDate" placeholder=" - ">

                </div>
          </div>

            <div class="layui-col-md3">
                <label class="layui-form-label">需求日期:</label>
                <div class="layui-input-block layui-form">
                    <input type="text" class="layui-input" name="requiredDate" id="requiredDate" placeholder=" - ">

                </div>
          </div>

        </div>

        </br>
         <div class="layui-row layui-form">
          <div class="layui-col-md3">
                <label class="layui-form-label">作业状态:</label>
                 <div class="layui-input-block">
                   <select name="jobNode" id="jobNode" class="layui-select">
                      <option value="">请选择</option>
                      <option value="-1">未卸货</option>
                      <option value="10">直送到货 </option>
                      <option value="20">开始卸货</option>
                      <option value="30">卸货完成  </option>
                      <option value="40">开始点收 </option>
                      <option value="50">点收完成 </option>
                      <option value="51">交接完成 </option>
                      <option value="60">开始清点审核</option>
                      <option value="70">清点审核完成 </option>
                      <option value="80">开始交接审核 </option>
                       <option value="90">交接审核完成</option>

                    </select>
                </div>
            </div>
         <div class="layui-col-md3">
                <label class="layui-form-label">工位:</label>
               	<div class="layui-input-block layui-form">
				<select  id="stationCode" xm-select="select1">
					<option value="">请选择</option>
				</select>
			</div>

            </div>

             <div class="layui-col-md3">
                <label class="layui-form-label">产线:</label>

               <div class="layui-input-block layui-form">
					<select  id="pipeLineCode" xm-select="select2">
						<option value="">请选择</option>
					</select>
			    </div>
            </div>

        </div>
   <div class="layui-row layui-form" style="margin-bottom: 0">

           <div class="layui-btn-container" style="text-align: right;">
				{{# if(d.search==null || d.search=="true"){ }}
		           <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
		           <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
	            {{# } }}
				{{# if(d.export==null || d.export=="true"){ }}
					<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="export" type="button"><i class="layui-icon layui-icon-export"></i>导出</button>
				{{# } }}
				{{# if(d.del==null || d.del=="true"){ }}
					<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="del" type="button"><i class="layui-icon layui-icon-delete"></i>删除</button>
				{{# } }}
			</div>
   </div>
	</div>
	<table   id="directDeliveryMainTab" lay-filter="directDeliveryMainTabF"></table>
</script>
<script type="text/javascript">
	layui.config({
	    base: '/iles/pages/layui/lay/modules/' //此处路径请自行处理, 可以使用绝对路径
	}).extend({
	    formSelects: 'formSelects-v4'
	});
	var element = layui.element;
    var layer = layui.layer;
    var table = layui.table;
    var contextPath = config.wmsConfig.contextPath;
    var form = layui.form;
    var formSelects;
    var tableFilter = layui.tableFilter;
    var oldData;
    var arrivalCodeValue = getQueryVariable("arrivalCode");
    var tableFilterIns;
    layui.use(['formSelects'],function(){
    	formSelects = layui.formSelects;
    });
    var active = {
            search:function(othis){
                var arrivalCode=$.trim($('#arrivalCode').val());
                var carNo=$.trim($('#carNo').val());
                var jobNode =$("#jobNode").val();

                var requiredDateStart ='';
                var requiredDateEnd ='';
                var arrivalDateStart ='';
                var arrivalDateEnd ='';
               if($('#requiredDate').val() !='' && $('#requiredDate').val() !=null){
              	 requiredDateStart = $('#requiredDate').val().split(' - ')[0];
              	 requiredDateEnd = $('#requiredDate').val().split(' - ')[1];
               }

               if($('#expectedArrivalDate').val() !='' && $('#expectedArrivalDate').val() !=null){
              	 arrivalDateStart = $('#expectedArrivalDate').val().split(' - ')[0];
              	 arrivalDateEnd = $('#expectedArrivalDate').val().split(' - ')[1];
               }



            	//工位
        		var sCode = "";
        		var sCodeArray = layui.formSelects.value('select1', 'val');
        		for(var i=0;i<sCodeArray.length;i++){
        			sCode += sCodeArray[i]+","
        		}
        		if(sCode != ""){
        			sCode = sCode.substring(0,sCode.length-1);
        		}

        		 var stationCode =sCode;


        		//产线
        		var pipeLineCode = "";
        		var pipeLineCodeArray = layui.formSelects.value('select2', 'val');
        		for(var i=0;i<pipeLineCodeArray.length;i++){
        			pipeLineCode +=pipeLineCodeArray[i]+","
        		}
        		if(pipeLineCode != ""){
        			pipeLineCode = pipeLineCode.substring(0,pipeLineCode.length-1);
        		}

                var params={};
                params.arrivalCode=arrivalCode;
                params.carNo=carNo;
                params.jobNode=jobNode;
                params.requiredDateStart=requiredDateStart;
                params.requiredDateEnd=requiredDateEnd;
                params.arrivalDateStart=arrivalDateStart;
                params.arrivalDateEnd=arrivalDateEnd;
                params.stationCode=stationCode;
                params.pipeLineCode=pipeLineCode;

                  //执行重载
                table.reload('directDeliveryMainId', {
                    where:params,
                    height: 'full-95',
                    page:{"curr":1}
                  });
            },reset:function(othis){
                $('#arrivalCode').val("");
                $('#carNo').val("");
                $('#jobNode').val("");
                $('#requiredDate').val("");

                $('#expectedArrivalDate').val("");


                layui.formSelects.value('select1', []);
        		layui.formSelects.value('select2', []);

                form.render("select");

            },
            del:function(othis){
                var checkStatus = table.checkStatus('directDeliveryMainId');
                oldData = checkStatus.data;
                if(oldData.length<=0){
                    layer.alert('请选择要删除的行！',{icon: 2});
                    return ;
                }
                var idarrys = new Array();
                for(var i=0;i<oldData.length;i++){
                	if(oldData[i].jobNode !='-1'){
                		 layer.alert('抱歉，只有未卸货的到货通知单才能删除');
                         return ;
                	}
                    idarrys.push(oldData[i].id);
                }
                layer.confirm('确定删除选中的信息吗?', {icon: 3, title:'提示'}, function(index){

                      var option ={
                            url:contextPath+'directDeliveryPc/delDirectArrivalNotice',
                            type:'POST',
                            contentType: "application/json",
                            dataType:'json',
                            data:JSON.stringify(idarrys),
                            success:function(data){
                                if(data.code==0){
                                	table.reload('directDeliveryMainId');//刷新列表
                                }
                            },error:function(data){
                                layer.alert(data.msg);
                            }
                        }
                        $.ajax(option);
                      layer.close(index);
                    });
            },
            export:function(othis){
            	 var arrivalCode=$.trim($('#arrivalCode').val());
                 var carNo=$.trim($('#carNo').val());
                 var jobNode=$.trim($('#jobNode').val());
                  var requiredDateStart ='';
                  var requiredDateEnd ='';
                  var arrivalDateStart ='';
                  var arrivalDateEnd ='';
                 if($('#requiredDate').val() !='' && $('#requiredDate').val() !=null){
                	 requiredDateStart = $('#requiredDate').val().split(' - ')[0];
                	 requiredDateEnd = $('#requiredDate').val().split(' - ')[1];
                 }

                 if($('#expectedArrivalDate').val() !='' && $('#expectedArrivalDate').val() !=null){
                	 arrivalDateStart = $('#expectedArrivalDate').val().split(' - ')[0];
                	 arrivalDateEnd = $('#expectedArrivalDate').val().split(' - ')[1];
                 }


               //工位
         		var sCode = "";
         		var sCodeArray = layui.formSelects.value('select1', 'val');
         		for(var i=0;i<sCodeArray.length;i++){
         			sCode += sCodeArray[i]+","
         		}
         		if(sCode != ""){
         			sCode = sCode.substring(0,sCode.length-1);
         		}

         		 var stationCode =sCode;

         		//产线
         		var pipeLineCode = "";
         		var pipeLineCodeArray = layui.formSelects.value('select2', 'val');
         		for(var i=0;i<pipeLineCodeArray.length;i++){
         			pipeLineCode +=pipeLineCodeArray[i]+","
         		}
         		if(pipeLineCode != ""){
         			pipeLineCode = pipeLineCode.substring(0,pipeLineCode.length-1);
         		}
         	   var token = window.localStorage.token;
               var params = "arrivalCode="+arrivalCode+"&carNo="+carNo
                +"&requiredDateStart="+requiredDateStart+"&requiredDateEnd="+requiredDateEnd

                +"&stationCode="+stationCode+"&pipeLineCode="+pipeLineCode
                +"&arrivalDateStart="+arrivalDateStart+"&arrivalDateEnd="+arrivalDateEnd+"&jobNode="+jobNode+"&token="+token;

                window.open(contextPath+"directDeliveryPc/exportDirectArrivalNotice?"+params);
            }

    };
    function loadding(){
    	if(arrivalCodeValue !=='null' && arrivalCodeValue !==''){
       	 $('#arrivalCode').val(arrivalCodeValue);
       	}
    	//日期范围
        layui.use('laydate', function(){
        	var laydate = layui.laydate;
        	laydate.render({
        	    elem: '#requiredDate',
        	    range: true
        	});
        	var laydate = layui.laydate;
        	laydate.render({
        	    elem: '#expectedArrivalDate',
        	    range: true
        	});
       	 	initPipeLineCode();//产线
        	initStationCode();//工位
        });
    	table.render({
            elem:'#directDeliveryMainTab',
            id:'directDeliveryMainId',
            url:contextPath+'directDeliveryPc/queryDirectArrivalNoticeList',
            //limits:[100, 200, 300, 400, 500],
            //limit:100,
            cols:[[
             {type:'checkbox',fixed:'left'},
            {type:'numbers',title:'序号',width: 50},
            {field:'arrivalCode', width:150, title: '到货通知单'},
            {field:'jobNode', width:120, title: '作业状态'},
            {field:'arrivalAddress', width:120, title: '到货地点'},
            {field:'carNo', width:120, title: '车号代码'},
            {field:'pipeLineCode', width:80, title: '产线'},
            {field:'stationCode', width:100, title: '工位'},
            {field:'requiredDate', width:120, title: '需求日期'},
            {field:'requiredTime', width:100, title: '需求时间'},
            {field:'supplierName', width:100, title: '供货商'},
            {field:'isUrgent', width:90, title: '紧急状态'},
            {field:'totalNum', width:100, title: '到货总数量'},
            {field:'userName', width:100, title: '卸货操作员'},
            {field:'expectedArrivalDate', width:130, title: '到货日期'},
            {field:'unloadBeginTime', width:180, title: '开始卸货时间'},
            {fixed:'right',align:'center',toolbar:'#toolBar',width:150},

            ]],
            page:{theme: '#008155'},
            where:{
            	arrivalCode:arrivalCodeValue
            },
            height: 'full-95',
            done:function(res,page,count){//列表数据回调函数
            	initTableDate(res.data);

            }
        });
    	tableFilterIns = tableFilter.render({
            'elem' : '#directDeliveryMainTab',//table的选择器
            'mode' : 'local',//过滤模式
            'id':'directDeliveryMainId',
            'filters' : [
            	 {field:'pipeLineCode',name:'产线',type:'checkbox'},
    			 {field:'stationCode',name:'工位',type:'checkbox'},
            			],//过滤项配置
            'done': function(filters){

            }
        })
    	$('.layui-btn-container button').on('click', function(){
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });

    	table.on('tool(directDeliveryMainTabF)', function(obj){
    		var eventName = obj.event;			//事件名称
    		var clickObj = $(obj.tr[0]);		//当前对象tr

    		if(eventName=="detail"){	//详情
    			$("#id").val(obj.data.id);			//方便子页面取点收记录的Id

    			layer.open({
    		    	type: 2,
    		        title:'直送详情',
    		        offset:'auto',
    		        maxmin:true,
    		        area: ['100%', '100%'],
    		        id: 'directArrivalNoticeDetail', //防止重复弹出
    		        content: 'directDeliveryDetail.html',
    		        shade: 0, //不显示遮罩
    		        yes: function(){
    		          layer.closeAll();
    		        }
    	     	});
    		}else 	if(eventName=="handleImg"){	//交接图片
    			 if(obj.data.handleImg==null || obj.data.handleImg==''){
    				 layer.alert("抱歉，该记录没有交接图片！");
    				 return;
    			 }

    				$("#img").val(obj.data.handleImg);			//方便子页面取点收记录的Id

    				layer.open({
    			    	type: 2,
    			        title:'交接图片',
    			        offset:'auto',
    			        maxmin:true,
    			        area: ['80%', '80%'],
    			        id: 'handleImg', //防止重复弹出
    			        content: 'directDeliveryHandleImg.html',
    			        shade: 0, //不显示遮罩
    			        yes: function(){
    			          layer.closeAll();
    			        }
    		     	});
    			}
    	});
    	form.render();
    }

    function getQueryVariable(variable)
    {
	    var query = window.location.search.substring(1);
	    var vars = query.split("&");
	    for (var i=0;i<vars.length;i++) {
	            var pair = vars[i].split("=");
	            if(pair[0] == variable){
	            	return pair[1];
	            }
	    }
	    return("");
    }
    function initPipeLineCode(){//产线
    	$.ajax({
    		url:contextPath+"directDeliveryPc/getPipeLineCode",
    		type:"post",
    		success:function(result){
    			$('#pipeLineCode').html("");
    			$('#pipeLineCode').append('<option value="">请选择</option>');
          	  	var order = result.data;
    			if(order && order.length>0){
    			var optionItem;
    			var optoinArray = new Array();
    				for(var i=0;i<order.length;i++){
    				optionItem = {"name":""+order[i], "value":""+order[i]};
    				optoinArray.push(optionItem);
    				}
    				layui.formSelects.data('select2','local',{
    					arr:optoinArray
    				});
    			}
    		}
    	});
    }
    function initStationCode(){//工位
    	$.ajax({
    		url:config.basicInfoConfig.contextPath+"stationManager/getAllStationCode",
    		type:"GET",
    		success:function(result){
    			$('#stationCode').html("");
    			$('#stationCode').append('<option value="">请选择</option>');
          	  	var order = result.data;
    			if(order && order.length>0){
    			var optionItem;
    			var optoinArray = new Array();
    				for(var i=0;i<order.length;i++){
    				optionItem = {"name":""+order[i].stationCode, "value":""+order[i].stationCode};
    				optoinArray.push(optionItem);
    				}
    				layui.formSelects.data('select1','local',{
    					arr:optoinArray
    				});
    			}
    		}
    	});
    }
  //表格数据初始化
    function initTableDate(data){
    	  $("[data-field='isUrgent']").children().each(function(){
          	if($(this).text()=='0'){
                  $(this).text('不紧急');
              }else if($(this).text()=='1'){
                  $(this).text('紧急');
              }
          });
    	  $("[data-field='jobNode']").children().each(function(){
    		  if($(this).text()=='-1'){
                  $(this).text('未卸货');
              }
    		  else if($(this).text()=='10'){
                  $(this).text('直送到货');
              }else if($(this).text()=='20'){
                  $(this).text('开始卸货');
              }else if($(this).text()=='30'){
                  $(this).text('卸货完成 ');
              } else if($(this).text()=='40'){
                  $(this).text('开始点收');
              } else if($(this).text()=='50'){
                  $(this).text('点收完成');
              } else if($(this).text()=='51'){
                  $(this).text('交接完成');
              } else if($(this).text()=='60'){
                  $(this).text('开始清点审核');
              } else if($(this).text()=='70'){
                  $(this).text('清点审核完成');
              } else if($(this).text()=='80'){
                  $(this).text(' 开始交接审核');
              } else if($(this).text()=='90'){
                  $(this).text('交接审核完成');
              }
          });
    }
</script>
<script type="text/html" id="toolBar">
	<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">详情</a>
   	<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="handleImg">交接图片</a>
</script>
</body>
</html>
