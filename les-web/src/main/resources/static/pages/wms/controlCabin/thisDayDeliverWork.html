<#assign  title="当日入库计划" />
<#include '/header.html' />
<meta charset="UTF-8">
<#if athemTag.loginFlag=="true" && athemTag.menuFlag=="true">
<script src="/iles/pages/layui/layui.all.js"></script>
<div class="layui-fluid">
	<div class="layui-row layui-form">
		<div class="layui-col-md2">
			<label class="layui-form-label" style="width: 90px;padding: 9px 5px">到货通知单号:</label>
            <div class="layui-input-block layui-form">
                <input type="text" class="layui-input" name="" id="arrivalCode" placeholder=" - ">
            </div>
		</div>
		<div class="layui-col-md2">
			<label class="layui-form-label" style="width: 90px;padding: 9px 5px">预计到货日期:</label>
			<div class="layui-input-block">
				<input type="text" class="layui-input" name="" id="expectDate" placeholder=" - ">
			</div>
		</div>
		<div class="layui-col-md2">
			<label class="layui-form-label">供应商编号:</label>
			<div class="layui-input-block">
				<input type="text" class="layui-input" name="" id="supplierCode" placeholder=" - ">
			</div>
		</div>
		<div class="layui-col-md2">
			<label class="layui-form-label">物料号:</label>
			<div class="layui-input-block">
				<input type="text" class="layui-input" name="" id="materialCode" placeholder=" - ">
			</div>
		</div>
		<div class="layui-col-md2">
			<label class="layui-form-label">状态:</label>
			<div class="layui-input-block layui-form">
				<select id="status">
						<option value="3" selected="selected">--请选择--</option>
						<option value="1">到货</option>
						<option value="0">未到货</option>
				</select>
			</div>
		</div>
		<div class="layui-col-md2">
			<label class="layui-form-label layui-form">是否紧急:</label>
			<div class="layui-input-block">
				<select id="urgrntStatus">
						<option value="3" selected="selected">--请选择--</option>
						<option value="1">紧急</option>
						<option value="0">正常</option>
				</select>
			</div>
		</div>
	</div>
	<div class="layui-row layui-form">
		<div class="layui-col-md2">
			<label class="layui-form-label" style="width: 90px;padding: 9px 5px">实际到货日期:</label>
			<div class="layui-input-block">
				<input type="text" class="layui-input" name="" id="arrivalData" placeholder=" - ">
			</div>
		</div>
		<div class="layui-col-md2">
			<label class="layui-form-label layui-form">库存地点:</label>
			<div class="layui-input-block">
				<select id="storageLocation">
						<option value="" selected="selected">--请选择--</option>
				</select>
			</div>
		</div>
		<div class="layui-col-md2">
			<label class="layui-form-label layui-form">仓库名称:</label>
			<div class="layui-input-block">
				<select id="warehouseName">
						<option value="" selected="selected">--请选择--</option>
				</select>
			</div>
		</div>
		<div class="layui-col-md3" style="float: right;">
			<div class="layui-btn-container" style="text-align: right;">
			<#if athemTag.search?? && athemTag.search=="true">
				<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
				<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
			</#if>
			</div>
		</div>
	</div>
	<div class="layui-row layui-form">
		<input type="text" class="layui-input" readonly="readonly" style="border:none;font-size: 20px;margin-top: 10px;color: #008155;" id="qitaoDate" value="今日计划到货物料笔数总计:--&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;今日实到物料笔数总计:--">
	</div>
</div>

<table id="processQitaoJd" lay-filter="processQitaoJdTabF"></table>

<script src="/iles/pages/lib/jquery/1.9.1/jquery.js"></script>
<script type="text/javascript">
var $ = layui.$;
var element = layui.element;
var layer = layui.layer;
var table = layui.table;
var form = layui.form;
form.render();
var sysDate=new Date();
var requiredDate=new Date(sysDate.getTime());
var requiredDateStr=getFormatDate(requiredDate);

table.render({
	elem:'#processQitaoJd',
	id:'processQitaoJdId',
	url:'${ctx}/arrival/findExpectArrivalDetail',
	cols:[[
	 		{type:'numbers',title:'序号',width: 100},
	 		{field: 'MATERIAL_CODE', title: '物料号', width: 200},
	 		{field: 'MATERIAL_DESC', title: '物料描述', width: 200},
	 		{field: 'STATUS', title: '状态', width: 150},
	 	    {field: 'TOTAL_COUNT', title: '交货数量', width: 150},
	 	    {field: 'ARRIVAL_CODE', title: '到货通知单号', width: 150},
	 	    {field: 'SUPPLIER_CODE', title: '供应商编号', width: 200},
	 	    {field: 'SUPPLIER_NAME', title: '供应商名称', width: 200},
	 	    {field: 'URGENT_STATUS', title: '是否紧急', width: 150},
	 	    {field: 'PROJECT', title: '项目编号', width: 150},
	 	    {field: 'EXPECTED_ARRIVAL_DATE', title: '预计到货日期', width: 200},
	 	    {field: 'QUEUE_TIME', title: '实际到货日期', width: 200},
	 	    {field: 'STORAGE_LOCATION', title: '库存地点', width: 150},
	 	    {field: 'WAREHOUSE_NAME', title: '库存地点名称'}
	 	  ]],
	page: {theme: '#008155'},
	where: {
		expectDateBegin:requiredDateStr,
		expectDateEnd:requiredDateStr,
		defaultStatus:1
	},
	//limit:100,
	//limits:[100,200,300,400,500,600,700,800,900,1000],
	//page:false,
	title:'当日出库作业进度',
	height: 'full-95'
	/* ,request: {//修改了分页参数，避免自动分页
		  pageName: 'pageNumber' //页码的参数名称，默认：page
		  ,limitName: 'pageSize' //每页数据量的参数名，默认：limit
		} */
	,
	even:true,
	done:function(res,curr,count){
		findStorageLocationAndName();
		initTableDate();
		getNeatRateByDate($('#requiredDate').val());
	}
});
layui.use(['laydate'],function(){
	var laydate = layui.laydate;

	//日期控件
	laydate.render({
		elem:"#expectDate",
		type: 'date',
		range: true
	});
	//日期控件
	laydate.render({
		elem:"#arrivalData",
		type: 'date',
		range: true
	});
})
var active = {
	search:function(othis){
		//执行重载
		form.render();
		var expectDateBegin="";
		var expectDateEnd="";
		if($('#expectDate').val()!=null && $('#expectDate').val().length>10){
			expectDateBegin=$('#expectDate').val().split(' - ')[0];
			expectDateEnd=$('#expectDate').val().split(' - ')[1];
		}
		table.reload('processQitaoJdId', {
		  where:{
			arrivalCode:$('#arrivalCode').val(),
			expectDateBegin:expectDateBegin,
			expectDateEnd:expectDateEnd,
			supplierCode:$('#supplierCode').val(),
			materialCode:$('#materialCode').val(),
			urgentStatus:$('#urgrntStatus').val(),
		  	status:$('#status').val(),
		  	arrivalDateBegin:$('#arrivalData').val().split(' - ')[0],
		  	arrivalDateEnd:$('#arrivalData').val().split(' - ')[1],
		  	defaultStatus:0,
		  	storageLocation:$("#storageLocation").val(),
		  	warehouseName:$("#warehouseName").val()
		  }
		});
	},reset:function(othis){
		$('#arrivalCode').val("");
		$('#expectDate').val("");
		$('#supplierCode').val("");
		$('#materialCode').val("");
	  	$('#urgrntStatus').val("");
	  	$('#status').val("");
	  	$('#arrivalData').val("");
	  	$("#storageLocation").val("");
	  	$("#warehouseName").val("");
		form.render("select");
	}
};

$('.layui-btn-container button').on('click', function(){
    var othis = $(this), method = othis.data('method');
    active[method] ? active[method].call(this, othis) : '';
});


function getNeatRateByDate(date){
	$.ajax({
		url:"${ctx}/arrival/getTodayCount",
		//type:"post",
		success:function(res){
			if(res.code==0){
				if(res.data==null){
					str="今日计划到货单数:--，:笔数--			实到单数:--，笔数:--";
				}else{
					str="今日计划到货单数:"+res.data.expectACount+"，笔数:"+res.data.expectAdCount+"			实到单数:"+res.data.arrivalACount+"，笔数:"+res.data.arrivalAdCount;
				}
				$("#qitaoDate").val(str);
			}
		}
	});
}

function findStorageLocationAndName(){
	$.ajax({
		url:"${ctx}/arrival/findStorageLocationAndName",
		success:function(res){
			if(res.code==0){
				var storages=res.data.storageLocations;
				var warehouseName=res.data.warehouseName;
				if(storages.length>0){
					if($("#storageLocation").find("option").length==1){
						for(var i=0;i<storages.length;i++){
							$("#storageLocation").append("<option value="+storages[i]+">"+storages[i]+"</option>");
						}
						form.render('select');
					}
				}
				if(warehouseName!=null){
					if($("#warehouseName").find("option").length==1){
						$("#warehouseName").append("<option value="+warehouseName+">"+warehouseName+"</option>");
						form.render('select');
					}
				}
			}
		}
	});
}

//格式化日期
function getFormatDate(date){
	var seperator1 = "-";
    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    if (month >= 1 && month <= 9) {
        month = "0" + month;
    }
    if (strDate >= 0 && strDate <= 9) {
        strDate = "0" + strDate;
    }
    var currentdate = year + seperator1 + month + seperator1 + strDate;
    return currentdate;
}

function infoData(){
	var newDate = new Date();
	newDate.setDate(newDate.getDate());
	var dateString = newDate.toLocaleDateString();
	if(newDate.getMonth()+1<10){
		dateString = dateString.replace("/","-0");
	}else{
		dateString = dateString.replace("/","-");
	}
	if(newDate.getDate()<10){
		dateString = dateString.replace("/","-0");
	}else{
		dateString = dateString.replace("/","-");
	}
	startTime=dateString;
	endTime=dateString;
	$("#expectDate").val(startTime+" - "+endTime)
}

function initTableDate(data){
	$("[data-field='URGENT_STATUS']").children().each(function(){
		if($(this).text()=='0'){
			$(this).text('普通');
		}else if($(this).text()=='1'){
			$(this).text('紧急');
		}
	});
	$("[data-field='STATUS']").children().each(function(){
		if($(this).text()=='0'){
			$(this).text('未到货');
		}else if($(this).text()=='1'){
			$(this).text('已到货');
		}
	});
}
</script>
<#else>
	<#include '/noAuthority.html' />
</#if>
<#include '/footer.html' />
