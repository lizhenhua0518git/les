<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">


<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
<title>集配标签打印</title>
<style type="text/css" media="print">
	.labe_css{
		font-size: 13px;
	    height: 17.5px;
	    width: 35mm;
	    text-overflow: clip;
	    white-space: nowrap;
	    overflow: hidden;
	    font-style: inherit;
	    font-weight: bold;
	}
</style>
</head>
<body>
<div id="bodyDiv">

</div>
</body>

<!--打印-->
<script src="/iles/pages/lib/jquery-qrcode-0.14.0/jquery.min.js"></script>
<script src="/iles/pages/lib/jquery-qrcode-0.14.0/jquery-qrcode-0.14.0.min.js"></script>

<script src="/iles/pages/lib/jquery-barcode/jquery-migrate-1.2.1.min.js"></script>
<script src="/iles/pages/lib/jquery-barcode/jquery.jqprint-0.3.js"></script>
<script src="/iles/pages/lib/jquery-barcode/jquery-barcode.js"></script>
<script type="text/javascript">var jquery$ = $;</script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/lay/modules/layer.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js"></script>
<script type="text/html" id="bodyTpl">
<div class="layui-fluid">
<div class="layui-row layui-form">
		 <div class="layui-col-md2">
		 	<label class="layui-form-label">派工日期</label>
		    <div class="layui-input-block">
		        	<input type="text" class="layui-input" id="dateTime" >
		    </div>
		 </div>
		 <div class="layui-col-md2">
		 	  <label class="layui-form-label">派工时间</label>
		      <div class="layui-input-block layui-form">
		        	<select id="activeTime" xm-select="select1">
		        		<option value="">请选择</option>
		        	</select>
		      </div>
		 </div>
		 <div class="layui-col-md2">
		 	<label class="layui-form-label">波次号:</label>
			<div class="layui-input-block">
		        	<input type="text" class="layui-input" id="waveCode" >
		    </div>
		 </div>
		 <div class="layui-col-md2">
			<label class="layui-form-label">集配单号:</label>
			<div class="layui-input-block">
		        	<input type="text" class="layui-input" id="orders" >
		    </div>
		</div>
	</div>
	<div class="layui-row layui-form" style="margin-bottom: 0">
		<div class="layui-col-md2">
			<label class="layui-form-label">物料编码:</label>
			 <div class="layui-input-block">
			    <input type="text" class="layui-input" id="materialCode" name="materialCode" >
			</div>
		</div>
		<div class="layui-col-md2">
			<label class="layui-form-label">工位:</label>
			 <div class="layui-input-block">
			    <input type="text" class="layui-input" id="stationcode" name="stationcode" >
			</div>
		</div>
		<div class="layui-col-md2">
		 <label class="layui-form-label">打印状态</label>
		      <div class="layui-input-block layui-form">
		        	<select id="printStatus" >
		        		<option value="">选择打印状态</option>
		        		<option value="1">已打印</option>
		        		<option value="0">未打印</option>
		        	</select>
		      </div>
		</div>
		<div class="layui-col-md2">
		 <label class="layui-form-label">下架状态</label>
		      <div class="layui-input-block layui-form">
		        	<select id="lowerStatus" >
		        		<option value="">选择下架状态</option>
		        		<option value="1">已下架</option>
		        		<option value="0">未下架</option>
		        	</select>
		      </div>
		</div>
	</div>
	<div class="layui-row layui-form" style="margin-bottom: 0">
	    <div class="layui-col-md2">
			<label class="layui-form-label">订单号:</label>
			 <div class="layui-input-block">
			    <input type="text" class="layui-input" id="orderCode" name="orderCode">
			</div>
		</div>
		
	</div>
	
	<div class="layui-row layui-form" style="margin-bottom: 0">
			<div class="layui-btn-container">
				{{# if(d.search==null || d.search=="true"){ }}
					<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
					<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
				{{# } }}
				{{# if(d.print==null || d.print=="true"){ }}
					<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="print" type="button"><i class="mine-icon icon-print"></i>打印</button> 
				{{# } }}
			</div>
	</div>
	</div>
<table class="layui-hide" id="labelPrintTab" lay-filter="labelPrintTabF" ></table>


<!--打印内容-->
<div>
<div id="div1">
</div>
</div>
</script>
<script type="text/javascript">
	    ;!function(){
	    	layer.config({//加载扩展模块
	    	    extend: 'extend/layer.ext.js'
	    	});
	    	layer.ready(function(){ 
	    	});
	    }();
	    
	   	function ityzl_SHOW_LOAD_LAYER(){
	   		return layer.msg('正在调用打印控件,请稍等...', {icon: 16,shade: [0.5, '#f5f5f5'],scrollbar: false,offset: '0px', time:100000}) ;
	   	}
	   	function ityzl_CLOSE_LOAD_LAYER(index){
	   		layer.close(index);
	   	}
	   	function ityzl_SHOW_TIP_LAYER(){
	   		//layer.msg('打印成功！',{time: 1000,offset: '10px'});
	   	}
	</script>
<script type="text/javascript">
//全局定义一次, 加载formSelects
layui.config({
    base: '/iles/pages/layui/lay/modules/' //此处路径请自行处理, 可以使用绝对路径
}).extend({
    formSelects: 'formSelects-v4'
});
var table = layui.table;
var form = layui.form;
var layer = layui.layer;
var formSelects ;
var contextPath = config.wmsConfig.contextPath;
var myDate = new Date();
var dateString = myDate.toLocaleDateString();
if(myDate.getMonth()+1<10){
	dateString = dateString.replace("/","-0");
}else{
	dateString = dateString.replace("/","-");
}
if(myDate.getDate()<10){
	dateString = dateString.replace("/","-0");
}else{
	dateString = dateString.replace("/","-");
}
var startTime=dateString+" 00:00:00";
var endTime=dateString+" 23:59:59";
var tableFilter = layui.tableFilter;
var tableFilterIns;
var laydate = layui.laydate;
var i;
layui.use(['formSelects'],function(){
	formSelects = layui.formSelects;
});
var active = {
		search:function(othis){
			 
		      var dateTime = $("#dateTime").val();
		      var activeDate = dateTime;
			  var activeTime = $("#activeTime").val();
		      var waveCode = $("#waveCode").val();
		      var orders = $("#orders").val();
		      var materialCode = $("#materialCode").val();
		      var printStatus = $("#printStatus").val();
		      var activeTimeArray = layui.formSelects.value('select1', 'val');
		      var stationcode = $("#stationcode").val();
		      var lowerStatus = $("#lowerStatus").val();
		      var orderCode = $("#orderCode").val();
		      for(var i=0;i<activeTimeArray.length;i++){
		    	  activeTime = activeTime+activeTimeArray[i]+";"
		      }
		      //执行重载
		       table.reload('labelPrintTabId', {
		        where:{
		        	activeDate:activeDate
		        	,activeTime: activeTime
		        	,waveCode:waveCode
		        	,assembleOrderCode: orders
		        	,materialCode:materialCode
		        	,printStatus:printStatus
		        	,storageType:1
		        	,stationcode:stationcode
		        	,lowerStatus:lowerStatus
		        	,orderCode:orderCode
		        }
		      }); 
		       tableFilterIns = tableFilter.render({
		    	    'elem' : '#labelPrintTab',//table的选择器
		    	    'mode' : 'local',//过滤模式
		    	    'id':'labelPrintTabId',
		    	    'filters' : [{field:'assembleordercode',name:'集配订单号',type:'checkbox'}
		    	    			],//过滤项配置
		    	    'done': function(filters){
		    	        //结果回调
		    	    	var tableData = table.cache.activeTotalId;
		    	    	layui.each(tableData, function(e, l){
		    	    		l.LAY_CHECKED = false;
		    	    	});
		    	    }
		    	})
		},reset:function(othis){
			$('#dateTime').val("");
			$('#orders').val("");
			$("#activeTime").val("");
			$("#waveCode").val("");
			$("#materialCode").val("");
			$("#printStatus").val("");
			$("#stationcode").val("");
			$("#lowerStatus").val("");
			$("#orderCode").val("");
			layui.formSelects.value('select1', []); 
			form.render("select");
		},print:function(othis){
			var list = table.checkStatus('labelPrintTabId');
			oldData = list.data;
			$(othis).attr("disabled","true");
			var length = oldData.length;
			if(length==0){
				layer.alert('请选择要打印的数据！',{icon: 2});
				return false;
			}
			if(tableFilter.cacheData.length>0 && tableFilter.cacheData.length<oldData.length){
				oldData = tableFilter.cacheData;
			}
			i = ityzl_SHOW_LOAD_LAYER();
			ityzl_CLOSE_LOAD_LAYER(i);
        	ityzl_SHOW_TIP_LAYER();
			var id_list = new Array();
			for(var i=0;i<oldData.length;i++){
				id_list.push(oldData[i].id);
			}
			$("#div1").show();
			$.ajax({
			        url: contextPath+"outBoundPlanManger/listMaterialLabelData",
			        dataType:'json',
					type:'POST',
			        async: false,
				    contentType:'application/json',
			        data: JSON.stringify(id_list),
			        success: function (result) {
			            if (result.code == 0) {
			                label_list = result.data;
			                for (var i = 0; i < label_list.length; i++) {
			                    var label = label_list[i];
			                    // 条形码内容
								var text =label.materialcode+"\n"+  
								    "订单:"+label.orderCode+"\n"+
								    "描述:"+label.materialdesc+"\n"+
									"数量:"+label.enableCount+label.materialUnit+"\n"+
									"供应商:"+"\n"+
									"制造商:"+"\n"+
									"载具:"+(label.carrierCode==null?'T':label.carrierCode)+" "+(label.putLevel==null?'':label.putLevel)+"\n"+
									"序列:"+"\n"+
									"批次:"+(label.batchNum==null?'':label.batchNum)+"\n"+
									"工位:"+(label.subLineStationCode==null?'':label.subLineStationCode)+"\n"+
									"工序短文本:"+(label.ltxa1==null?'':label.ltxa1)+"\n"+
									label.did;
			                    str = "<div style=\"width: 69mm; height: 39mm;\"><div style=\"float:left;padding-top:2px;position:absolute;padding-left:0px\"><ul style=\"list-style-type:none;padding: 0px;margin: 0px\">"+
			                    "<li><img id=\"image"+i+"\" width=\"120px\" height=\"120px\"></li>"+
			            		"<li><b style=\"width: 35mm;text-overflow: clip;white-space: nowrap;font-size: 10px;\">"+(label.carCode==null?'':label.carCode)+"&nbsp;"+label.activeTime+"</b></li></ui></div>"+
			            		"<div style=\"font-size: 4px;float:left;width: 35mm;float:right;\">"+
			            		"<div style=\"font-size: 13px;height: 17.5px;width: 35mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			label.materialcode+
			            		"</div><div style=\"font-size: 13px;height: 17.5px;width: 35mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			(label.materialdesc==null?'':label.materialdesc)+
			            		"</div><div style=\"font-size: 13px;height: 17.5px;width: 35mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			(label.positionname==null?'':label.positionname)+
			            		"</div><div style=\"font-size: 13px;height: 17.5px;width: 35mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			(label.carrierCode==null?'T':label.carrierCode)+"&nbsp;"+(label.putLevel==null?'':label.putLevel)+
			            		"</div><div style=\"font-size: 13px;height: 17.5px;width: 35mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			(label.assembleArea==null?'':label.assembleArea)+
			            			"["+label.waveOldNum+"]"+
			            		"</div><div style=\"font-size: 13px;height: 17.5px;width: 35mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			/* "<b style=\"margin-left: 2%;font-size: 13px;\">"+(label.POSITIONNAME==null?'':label.POSITIONNAME)+"</b>"+ */
			            			label.enableCount+label.materialUnit+"&nbsp;"+(label.orderCode!='null'?label.orderCode:'')+
			            		"</div><div style=\"font-size: 13px;height: 17.5px;width: 35mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			(label.batchNum==null?'':label.batchNum)+"&nbsp;"+(label.posnr==null?'':label.posnr)+
			            		"</div><div style=\"font-size: 13px;height: 17.5px;width: 35mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
									(label.processMaterialDesc==null?'':label.processMaterialDesc)+
			            		"</div></div>"+
			            		"<canvas id=\"canvas"+i+"\" height=\"120px\" width=\"120px\" style=\"display: none \"></canvas></div>";

			                    if (i == 0) {
			                        // 第一页
			                        // 清空打印内容
			                        $("#div1").empty();

			                    } else {
			                        // 分页
			                        var str = "<DIV STYLE=\"page-break-before:always\">\n" + str + "</DIV>"
			                    }

			                    // 添加打印内容
			                    $("#div1").append(str);

			                    // 条形码生成
			                    jquery$("#canvas"+i).qrcode({
			            			render : 'canvas',    //设置渲染方式，有table和canvas，使用canvas方式渲染性能相对来说比较好
			            			text : text, //扫描二维码后显示的内容,\n换行
			            			size : 120  
			            		});
			                    var img = document.getElementById("image"+i); // get image element
			                    var canvas  = document.getElementById("canvas"+i);  // get canvas element
			                    img.src = canvas.toDataURL();//"image/png"
			                }

			                // 打印
			                jquery$("#div1").jqprint();
			                $("#div1").hide();
			                $(othis).removeAttr("disabled");
			                ityzl_CLOSE_LOAD_LAYER(i);
			            }else {layer.msg(result.msg,{icon: 5,time:1000}); $(othis).removeAttr("disabled");ityzl_CLOSE_LOAD_LAYER(i);}
			        }
			    });
		}
	};
function loadding(){
	table.render({
		elem:"#labelPrintTab",
		id:"labelPrintTabId",
		url:contextPath+"outBoundPlanManger/listMaterialPrintData",
		cols:[[
		     {type:'checkbox'},
		     {type:'numbers',title:'序号',width: 60},
		     {field:'tab',title:'工位',width:200},
		     {field:'ordercode',title:'订单号',width:200},
		     {field:'wavenum',title:'波次序号',width:200},
		     {field:'assembleordercode',title:'集配订单号',width:200},
		     {field:'materialcode',title:'物料号',width:200},
		     {field:'materialdesc',title:'物料描述',width:400}
		     ]],
		 height: 'full-95',
		 width : '100%',
		 even:true,
		 where:{storageType:1,
			 activeDate:dateString
		 }
	});
	 tableFilterIns = tableFilter.render({
		    'elem' : '#labelPrintTab',//table的选择器
		    'mode' : 'local',//过滤模式
		    'id':'labelPrintTabId',
		    'filters' : [{field:'assembleordercode',name:'集配订单号',type:'checkbox'}
		    			],//过滤项配置
		    'done': function(filters){
		        //结果回调
		    	var tableData = table.cache.activeTotalId;
		    	layui.each(tableData, function(e, l){
		    		l.LAY_CHECKED = false;
		    	});
		    }
	});
	//日期范围
	laydate.render({
	 elem: '#dateTime'
	 ,range: false
	 ,type: 'date'
	  ,done: function(value, date, endDate){
	 	  $.ajax({
	         url:contextPath+'outBoundPlanManger/queryActiveTime?queryDate='+value,
	         type:'GET',
	         success:function(res){
	           $('#activeTime').html("");
	     	  $('#activeTime').append('<option value="">请选择</option>');
	       	  var order = res.data;
	       	  if(order && order.length>0){
	     			/*   for(var i=0;i<order.length;i++){
	  					  $("#activeTime").append("<option value="+order[i].activeTime+">"+order[i].activeTime+"</option>");
	     			  } */
	     		 var optionItem;
	     		 var optoinArray = new Array();
	     		 for(var i=0;i<order.length;i++){
	     			 optionItem = {"name": ""+order[i].activeTime, "value": ""+order[i].activeTime };
	     			 optoinArray.push(optionItem);
	     		 }
	     		 layui.formSelects.data('select1', 'local', {
	     			 arr:optoinArray
	     	     });  
	       	  }
	          /* 
	       	  form.render('select'); */
	         }
	         
	     })
	     return false;
	 } 
	 });
	$('.layui-btn-container button').on('click', function(){
	    var othis = $(this), method = othis.data('method');
	    active[method] ? active[method].call(this, othis) : '';
	});
	form.render('select');
}

function initwaveCode(){
	 $.ajax({
       url:contextPath+'outBoundPlanManger/queryActiveWave?storageType=1',
       dataType:'JSON',
       success:function(res){
     	  var order = res.data;
     	/*   $('#orders').html("");
 		  $('#orders').append('<option value="">请选择</option>'); */
 		  if(res.code==0){
 			if(order){
 			  for(var i=0;i<order.waveCode.length;i++){
				  $("#waveCode").append("<option value="+order.waveCode[i]+">"+order.waveCode[i]+"</option>");
 			  }
 			for(var i=0;i<order.assembleOrderCode.length;i++){
				  $("#orders").append("<option value="+order.assembleOrderCode[i]+">"+order.assembleOrderCode[i]+"</option>");
			  }
 			  form.render('select');
   	   }
 		  }
       }
       
   });
}

</script>
</html>