<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>下架作业历史详细列表</title>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<style type="text/css">
.layui-table-body{
	overflow-x:scroll;
}
</style>
</head>
<body>
<div id="bodyDiv">

</div>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js"></script>
<script type="text/html" id="bodyTpl">
	 <div class="layui-fluid">
		<div class="layui-row layui-form">
				 <div class="layui-col-md3">
				 	<label class="layui-form-label">SAP物料号:</label>
				 	 <div class="layui-input-block">
				      <input type="text" id="materialNum_search" class="layui-input">
				    </div>
				 </div>
				 <div class="layui-col-md3">
				 	<label class="layui-form-label">物料描述:</label>
				 	 <div class="layui-input-block">
				      <input type="text" id="materialDesc_search" class="layui-input">
				    </div>
				 </div>
			</div>
			<div class="layui-row layui-form" >
				<div class="layui-col-md3">
					<div class="layui-btn-container">
						{{# if(d.reback==null || d.reback=="true"){ }}
							<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reback" type="button"><i class="layui-icon layui-icon-search"></i>退料</button>
						{{# } }}
						{{# if(d.search==null || d.search=="true"){ }}
							<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
							<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
						{{# } }}
					</div>
				</div>
			</div>
	</div>
<table class="layui-hide" id="orderDetailTab" lay-filter="orderDetailTabF"></table>
</script>
<script type="text/javascript">
	var table = layui.table;
	var assembleId = parent.assembleId;//集配单主键
	var deliveryCode=parent.deliveryCode;//出库单号
	var orderCode=parent.orderCode;//订单号
	var contextPath = config.wmsConfig.contextPath;
	var active = {
			search:function(othis){
				var materialNum_search = $("#materialNum_search").val();
				var materialDesc_search = $("#materialDesc_search").val();
				var reserveNum_search = $("#reserveNum_search").val();
				table.reload('orderDetailTabId',{
						where:{
							materialCode:materialNum_search,
							materialDesc:materialDesc_search
						}
						,page:{"curr":1}
					})
				},
			reset:function(othis){
				$("#materialNum_search").val("");
				$("#materialDesc_search").val("");
				$("#reserveNum_search").val("");
			},
			reback:function(othis){
				var checkStatus = table.checkStatus('orderDetailTabId');
				var oldData = checkStatus.data
				if(oldData.length<=0){
					layer.alert('请选择要退料的行！',{icon: 2});
     				return ;
				}else if(oldData.length >1){
     				layer.alert('退料不能超过多行！',{icon: 2});
     				return ;
     			}
				var i = ityzl_SHOW_LOAD_LAYER();
				var option = {
					url:contextPath+'assembleOrderDetail/rollbackMaterial?id='+oldData[0].id,
					type:'POST',
					success:function(res){
						if(res.code==0){
							ityzl_CLOSE_LOAD_LAYER(i);
				        	ityzl_SHOW_TIP_LAYER();
							table.reload('orderDetailTabId');
							layer.alert("退料成功！");
						}else{
							ityzl_CLOSE_LOAD_LAYER(i);
							layer.alert(res.data);
						}
					},error:function(data){
			    		ityzl_CLOSE_LOAD_LAYER(i);
			    		layer.alert("退料失败");
			    	}
				};
				$.ajax(option);
			}
	};
	function loadding(){
		table.render({
			elem:"#orderDetailTab",
			id:"orderDetailTabId",
			url:contextPath+"outBoundPlanManger/queryAssembleDetail",
			cols:[[
			     {type:'checkbox'},
			     {type:'numbers',title:'序号',width: 60},
			     {field:'reserveCode',title:'预留号',width:100},
			     {field:'reserveRow',title:'预留行',width:100},
			     {field:'materialCode',title:'SAP物料号',width:150},
			     {field:'materialDesc',title:'物料描述',width:100},
			     {field:'materialUnity',title:'单位',width:100},
			     {field:'enableCount',title:'集配数量',width:100},
			     {field:'unsendCount',title:'未发料数量',width:100},
			     {field:'lowerFrameUid',title:'下架人',width:100},
			     {field:'lowerFrameTime',title:'下架时间',width:100},
			     {field:'storageBinId',title:'仓位',width:100},
			     {field:'factory',title:'工厂',width:100},
			     {field:'orderCode',title:'订单号',width:100},
			     {field:'deliverMode',title:'配送方式',width:100},
			     {field:'deliverPlatform',title:'配送台位',width:100},
			     {field:'planFillgoodTime',title:'计划补货完成时间',width:150},
			     {field:'planShippingTime',title:'计划配送完成时间',width:150}
			     ]],
			 page: {theme: '#008155'},
			 height: 'full-200',
			 even:true,
			 where:{
				 assembleId:assembleId
			 },
			 done:function(res,page,count){//列表数据回调函数
				 $("[data-field='deliveryCode']").children().each(function(){
					 	if(deliveryCode!=null && 'null'!=deliveryCode && $(this).text().trim()!='出库单号')
							$(this).text(deliveryCode);
					});
				 $("[data-field='orderCode']").children().each(function(){
					 if(orderCode!=null && 'null'!=orderCode && $(this).text().trim()!='订单号')
						$(this).text(orderCode);
					});
			 }
		});
		$('.layui-btn-container button').on('click', function(){
		    var othis = $(this), method = othis.data('method');
		    active[method] ? active[method].call(this, othis) : '';
	  	});
	}


	;!function(){
    	layer.config({//加载扩展模块
    	    extend: 'extend/layer.ext.js'
    	});
    	layer.ready(function(){
    	});
    }();

   	function ityzl_SHOW_LOAD_LAYER(){
   		return layer.msg('正在同步,请稍等...', {icon: 16,shade: [0.5, '#f5f5f5'],scrollbar: false,offset: '0px', time:100000}) ;
   	}
   	function ityzl_CLOSE_LOAD_LAYER(index){
   		layer.close(index);
   	}
   	function ityzl_SHOW_TIP_LAYER(){
   		layer.msg('恭喜您，加载完成！',{time: 1000,offset: '10px'});
   	}

</script>
</body>
</html>
