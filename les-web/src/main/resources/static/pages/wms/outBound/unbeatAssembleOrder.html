<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>非工位制任务下达</title>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
</head>
<body>
<div id="bodyDiv">

</div>
<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js"></script>
<script src="/iles/pages/js/common/warehouseSelect.js"></script>
<script type="text/html" id="bodyTpl">
<div class="layui-fluid">
	<div class="layui-row layui-form">
			 <div class="layui-col-md3">
                 <label class="layui-form-label">仓库:</label>
                 <div class="layui-input-block">
					<select id="warehouseCode" xm-select="select1" xm-select-show-count="1">
						<option value="">请选择</option>
					</select>
                </div>
     		</div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label">集配订单号:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="orderCode_search" class="layui-input">
			    </div>
			 </div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label">物料凭证号:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="mblnr_search" class="layui-input">
			    </div>
			 </div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label">收货人:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="recive_search" class="layui-input">
			    </div>
			 </div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label">物料编码:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="materialCode_search" class="layui-input">
			    </div>
			 </div>
		</div>
		<div class="layui-row layui-form">
				<div class="layui-btn-container">
					{{# if(d.search==null || d.search=="true"){ }}
						<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
						<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
					{{# } }}
					{{# if(d.match==null || d.match=="true"){ }}
						<button class="layui-btn layui-btn-normal layui-btn-sm"  onclick="splitStroage(1);" type="button" id="matchButton">匹配订单</button>
					{{# } }}
					{{# if(d.active==null || d.active=="true"){ }}
						<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="toActive" type="button">派工</button>
					{{# } }}
				</div>
		</div>
		<div class="layui-row layui-form" style="margin-bottom: 0">
			 <div class="layui-col-md6">
			 	<div style="margin-top: 9px;padding-left: 19px;"><span>集配订单数:</span><span id="orderCount">0</span>
			 	<span style="padding-left: 19px;">物料总数:</span><span id="materialCount">0</span>
			 	<span style="padding-left: 19px;">节拍化空闲区域:</span><span id="areaCount">0</span>
			 	<span style="padding-left: 19px;">非节拍空闲区域:</span><span id="unBeatAreaCount">0</span>
			 	</div>
			 </div>
		</div>
</div>
<table class="layui-hide" id="unactiveTab" lay-filter="unactiveTabF"></table>

</script>
<script type="text/html" id="toolbar">
	<a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
</script>
<script type="text/javascript">
	var element = layui.element;
	var layer = layui.layer;
	var table = layui.table;
	var form = layui.form;
	var tableFilter = layui.tableFilter;
	var dictItems = null;//存储数据字典
	var contextPath = config.wmsConfig.contextPath;
	var assembleId="";
	var deliveryCode="";
	var orderCode="";
	var storageLocation="";
	var chooseData = null;//选择的数据
	var materialData;
	var active={
			search:function(othis){
				var orderNum_search = $("#orderCode_search").val();
				var mblnr_search = $("#mblnr_search").val();
				var recive_search = $("#recive_search").val();
				var materialCode_search = $("#materialCode_search").val();
				var storageLocation = layui.formSelects.value('select1', 'storagelocationStr');
				table.reload('unactiveTabId',{
					where:{
						orderCode:orderNum_search,
						mblnr:mblnr_search,
						recive:recive_search,
						materialCode:materialCode_search,
						storageLocation:storageLocation
					}
					,page:{"curr":1}
				}
				);
				initFilter();
				$("#orderCount").text(0);
				$("#materialCount").text(0);
			},
			reset:function(othis){
				$("#orderCode_search").val("");
				$("#mblnr_search").val("");
				$("#recive_search").val("");
				$("#materialCode_search").val("");
				layui.formSelects.value('select1', []);
				//$("#orderStatus_search").val("");
			},toActive:function(othis){
				var checkStatus = table.checkStatus('unactiveTabId');
				var checkObj = checkStatus.data;
				if(checkObj.length==0){
					layer.alert("请选择派工的行");
					return false;
				}
				if(tableFilter.cacheData.length>0 && tableFilter.cacheData.length<checkObj.length){
					checkObj = tableFilter.cacheData;
				}
				checkMaterialType(checkObj);//验证是否存在没有维护存储类型的物料

			}
	};
	function loadding(){
		layui.use('laydate', function(){
			var laydate = layui.laydate;
			//时间选择器
			  laydate.render({
			    elem: '#requiredTime_search'
			    ,type: 'date'
			    ,range: true
			  });
		});
		table.render({
			elem:"#unactiveTab",
			id:"unactiveTabId",
			url:contextPath+'assembleOrder/unbeatPage',
			cols:[[
				 {type:'checkbox'}
				,{width: 100, align:'center', toolbar: '#toolbar',title:'操作'}
				,{type:'numbers',title:'序号',width: 60}
				,{field:'warehouseCode', title: '仓库编码' , width:100}
				,{field:'warehouseName', title: '仓库名称' , width:100}
				,{field:'waveNum',  width:70, title: '波次', event: 'setSign', style:'cursor: pointer;'}
				,{field:'rowcount',   width:90,title: '需配送行', event: 'setSign', style:'cursor: pointer;'}
				,{field:'bldat',width:160,  title: '凭证日期', event: 'setSign', style:'cursor: pointer;'}
				,{field:'requiredTime',width:160,  title: '需求日期', event: 'setSign', style:'cursor: pointer;'}
				,{field:'usnam',  width:120, title: '发货人', event: 'setSign', style:'cursor: pointer;'}
				,{field:'ablad',  width:160, title: '配送地址', event: 'setSign', style:'cursor: pointer;'}
				,{field:'bwart',  width:120, title: '移动类型', event: 'setSign', style:'cursor: pointer;'}
				,{field:'pname',  width:120, title: '转储用户', event: 'setSign', style:'cursor: pointer;'}
				,{field:'ltxa1',  width:120, title: '工序短文本', event: 'setSign', style:'cursor: pointer;'}
				,{field:'rsnum',  width:120, title: '订单/预留号', event: 'setSign', style:'cursor: pointer;'}
				,{field:'aufnr',  width:120, title: '订单号', event: 'setSign', style:'cursor: pointer;'}
				,{field:'sernr',  width:120, title: '车号', event: 'setSign', style:'cursor: pointer;'}
				,{field:'assembleOrderCode',   width:150,title: '集配订单号', event: 'setSign', style:'cursor: pointer;'}
				,{field:'mblnr',  width:120, title: '物料凭证号', event: 'setSign', style:'cursor: pointer;'}
				//,{field:'MJAHR',  width:120, title: '物料凭证年度', event: 'setSign', style:'cursor: pointer;'}
				//,{field:'VGART',  width:120, title: '交易/事件类型', event: 'setSign', style:'cursor: pointer;'}
				//,{field:'BLART',width:120,  title: '凭证类型', event: 'setSign', style:'cursor: pointer;'}
				//,{field:'BUDAT',   width:120,title: '过账日期', event: 'setSign', style:'cursor: pointer;'}
				,{field:'speBudatUhr',  width:120,title: '发货时间', event: 'setSign', style:'cursor: pointer;'}
				,{field:'bktxt', width:120, title: '凭证抬头文本', event: 'setSign', style:'cursor: pointer;'}
				,{field:'frbnr', width:120, title: '提单号 ', event: 'setSign', style:'cursor: pointer;'}
				,{field:'xabln',   width:120,title: '发货单编号', event: 'setSign', style:'cursor: pointer;'}
			     ]],
			    page: {theme: '#008155'},
			   	height: 'full-100',
			   	limits: [10,20,30,40,50,60,70,80,90,500],
			   	limit: 10,
			   	even:true,
			    done:function(res,page,count){//列表数据回调函数
			    	initArea();
			    	initFilter();
	    		}
		});
		table.on('tool(unactiveTabF)',function(obj){
			var data = obj.data;//当前行数据
			assembleId = data.assembleId;
			if(obj.event=="detail"){
				layer.open({
			        type: 2
			        ,title:'非节拍集配单详细列表'
			        ,maxmin:false
			        ,area: ['100%', '100%']
			        ,id: 'orderDetail' //防止重复弹出
			        ,content: 'unbeatAssembleOrderDetail.html'
			        ,shade: 0 //不显示遮罩
			        ,yes: function(){
			          layer.closeAll();
			        }
		     	 });
			}


		});
		table.on('row(unactiveTabF)', function(obj){
			chooseData=obj.data;
		});
		table.on('checkbox(unactiveTabF)',function(res,index){
			var orderCount = parseInt($("#orderCount").text());;
			var materialCount = parseInt($("#materialCount").text());;
			if(res.type=="all" && res.checked==true){//选中全选
				var tableData = table.cache.unactiveTabId;
				if(tableFilter.cacheData.length>0){
					tableData = tableFilter.cacheData;
				}
				materialCount = 0;
				for(var i=0;i<tableData.length;i++){
					materialCount = materialCount + tableData[i].rowcount;
				}
				$("#orderCount").text(tableData.length);
				$("#materialCount").text(materialCount);
			}else if(res.type=="all" && res.checked==false){//未选中全选
				$("#orderCount").text(0);
				$("#materialCount").text(0);
			}else if(res.type=="one" && res.checked==false){//取消单个选择
				materialCount = materialCount-chooseData.rowcount;
				$("#orderCount").text(orderCount-1);
				$("#materialCount").text(materialCount);
			}else if(res.type=="one" && res.checked==true){//选择单个选择
				materialCount = materialCount+chooseData.rowcount;
				$("#orderCount").text(orderCount+1);
				$("#materialCount").text(materialCount);
			}
		});
		$('.layui-btn-container button').on('click', function(){
		    var othis = $(this), method = othis.data('method');
		    active[method] ? active[method].call(this, othis) : '';
	  	});
		initWarehouseMultiSelect("warehouseCode","select1","0",null);
	}



	function changeItemName(data){
		//状态数据处理

		$("[data-field='order_type']").children().each(function(){
			for(var i=0;i<data.length;i++){
				if(data[i].dictTypeId=="order_type" && data[i].itemValue==$(this).text().trim()){
					$(this).text(data[i].itemName);
				}
			}
		});
	}
	function defulatSelect(dictItems){
		if(dictItems && dictItems.length>0){
			if($("#orderStatus_search").find("option").length==1){
			  for(var i=0;i<dictItems.length;i++){
				   if(dictItems[i].dictTypeId=="order_status"){
					  $("#orderStatus_search").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
				  }
			  }
			  form.render('select');
		  }
		}
	}

	//验证是否存在没有维护存储类型的物料
	function checkMaterialType(checkObj){
		var option = {
				url:contextPath+'assembleOrderDetail/queryNoStorage',
				type:'GET',
				success:function(res){
					if(res.code==0){
						var data = res.data;
						if(data.length>0){
							materialData = data;
							layer.open({
						        type: 2
						        ,title:'派工失败'
						        ,maxmin:false
						        ,area: ['100%', '100%']
						        ,id: 'assembleactive' //防止重复弹出
						        ,content: 'assembleActive.html'
						        ,shade: 0 //不显示遮罩
						        ,yes: function(){
						          layer.closeAll();
						        }
					     	 });
						}else{
							var waveId = new Array();
							for(var i=0;i<checkObj.length;i++){
								waveId.push(checkObj[i].waveId);
							}
							var option = {
				    				  url:contextPath+'assembleOrder/unbeatActive',
				    				  data:{"waveCodes":waveId},
				    				  dataType:'json',
				    				  type:'POST',
				    				  success:function(res){
				    					  if(res.code==0){
				    						  layer.alert("波次派工成功！");
				    						  $("#orderCount").text(0);
				    						  $("#materialCount").text(0);
				    						  initArea();
				    						  table.reload('unactiveTabId');
				    					  }else{
				    						  layer.alert("波次派工失败！");
				    					  }
				    				  },error:function(res){
				    					  layer.alert("波次派工失败！");
				    				  }
				    		  };
				    		  $.ajax(option);
						}
					}else{
						layer.alert("查询失败");
					}
				}
		};
		$.ajax(option);
	}
	function initArea(){
		var option = {
				url:config.basicInfoConfig.contextPath+'area/queryArea',
				type:'GET',
				success:function(res){
					if(res.code==0){
						areaCountAll = res.data;
						$("#areaCount").text(res.data.areaCount);
						$("#unBeatAreaCount").text(res.data.unBeatAreaCount);
					}
				}
		};
		$.ajax(option);
	}
	function initFilter(){
		tableFilter.cacheData = {};
		tableFilter.render({
		    'elem' : '#unactiveTab',//table的选择器
		    'mode' : 'local',//过滤模式
		    'id':'unactiveTabId',
		    'filters' : [{field:'mblnr',name:'物料凭证号',type:'checkbox'},
		                 {field:'rsnum',name:'订单/预留号',type:'checkbox'},
		    			 {field:'bwart',name:'移动类型',type:'checkbox'},
		    			 {field:'pname',name:'转储用户',type:'checkbox'},
		    			 {field:'ltxa1',name:'工序短文本',type:'checkbox'},
		    			 {field:'ablad',name:'配送地址',type:'checkbox'},
		    			 {field:'sernr',name:'车号',type:'checkbox'},
		    			 {field:'bldat',name:'凭证日期',type:'checkbox'},
		    			 {field:'usnam',name:'发货人',type:'checkbox'},
		    			],//过滤项配置
		    'done': function(filters){
		        //结果回调
		    	 var tableData = table.cache.unactiveTabId;
		    	layui.each(tableData, function(e, l){
		    		l.LAY_CHECKED = false;
		    	});
		    	$("#orderCount").text(0);
				$("#materialCount").text(0);
		    }
		});
	}
</script>
<!-- 本页面js -->
<script src="splitOrder.js"></script>
</body>
</html>
