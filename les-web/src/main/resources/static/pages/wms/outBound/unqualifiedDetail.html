<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Content-Type" content="charset=UTF-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
<title>不合格品出库详细</title>
</head>
<style type="text/css">
.layui-table-body{
	overflow-x:hidden;
}
</style>
<style type="text/css" media="print">
	.labe_css{
		font-size: 13px;
	    height: 17.5px;
	    width: 35mm;
	    text-overflow: clip;
	    white-space: nowrap;
	    overflow: hidden;
	    font-style: inherit;
	    font-weight: bold;
	}
</style>
<body>
<div id="bodyDiv">

</div>
	<script src="/iles/pages/lib/jquery-qrcode-0.14.0/jquery.min.js"></script>
	<script src="/iles/pages/lib/jquery-qrcode-0.14.0/jquery-qrcode-0.14.0.min.js"></script>

	<script src="/iles/pages/lib/jquery-barcode/jquery-migrate-1.2.1.min.js"></script>
	<script src="/iles/pages/lib/jquery-barcode/jquery.jqprint-0.3.js"></script>
	<script src="/iles/pages/lib/jquery-barcode/jquery-barcode.js"></script>
	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/loginInspect.js"></script>
<script type="text/html" id="bodyTpl">
		<div class="layui-fluid">
	<div class="layui-row layui-form">
			 <div class="layui-col-md3">
			 	<label class="layui-form-label">物料号:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="materialCode_search" class="layui-input">
			    </div>
			 </div>
			 <div class="layui-col-md3">
			 	<label class="layui-form-label">仓位号:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="positionCode_search" class="layui-input">
			    </div>
			 </div>
			 <div class="layui-col-md3">
			 	<label class="layui-form-label">状态:</label>
			 	 <div class="layui-input-block">
			       <select  id="status_search">
			        <option value="">请选择</option>
			         <option value="1">已下达</option>
			         <option value="2">已完成</option>
			      </select>
			    </div>
			 </div>
		</div>
		<div class="layui-row layui-form" style="margin-bottom: 0">
			<div class="layui-col-md6">&nbsp;</div>
			<div class="layui-col-md6">
				<div class="layui-btn-container" style="text-align: right;">
					{{# if(d.search==null || d.search=="true"){ }}
						<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
						<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
					{{# } }}
					{{# if(d.down==null || d.down=="true"){ }}
  					 <button class="layui-btn layui-btn-normal layui-btn-sm" id="goDown" data-method="goDown" type="button"><i class="layui-icon">&#xe61a;</i>重新下达</button>
					{{# } }}
					{{# if(d.print==null || d.print=="true"){ }}
  						<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="print" type="button"><i class="mine-icon icon-print"></i>打印</button>
					{{# } }}
				</div>
			</div>
		</div>
	</div>

	<table class="layui-hide" id="unqualifiedDetailTab" lay-filter="unqualifiedDetailTabF"></table>
	<!--打印内容-->
	<div>
		<div id="div1">
		</div>
	</div>
	</script>
	<script type="text/html" id="statusTpl">
    	{{# if(d.status==0){ }}
			已创建
		{{# }else if(d.status==1){ }}
			已下达
		{{# }else if(d.status==2){ }}
			已完成
		{{# } }}
	</script>
	<script type="text/javascript">
	var element = layui.element;
	var layer = layui.layer;
	var table = layui.table;
	var form = layui.form;
	var oldData = parent.oldData;
	var unqualifiedDetailId = "";
	var contextPath = config.wmsConfig.contextPath;
	if(oldData && oldData.id){
		unqualifiedDetailId = oldData.id
	}
	var dictItems = null;//数据字典
	var active = {
			goDown:function(othis){
				layer.open({
			        type: 2
			        ,title:'任务下达'
			        ,maxmin:true
			        ,area: ['100%', '100%']
			        ,id: 'unqualifiedGoDown' //防止重复弹出
			        ,content: 'unqualifiedGoDown.html'
			        ,shade: 0 //不显示遮罩
			        ,yes: function(){
			          layer.closeAll();
			        }
		     	 });
			},
			search:function(othis){
				var materialCode = $('#materialCode_search');
				var positionCode = $('#positionCode_search');
				var status = $('#status_search');
			      //执行重载
			      table.reload('unqualifiedDetailTabId', {
			        where:{
			        	materialCode: materialCode.val()
			           ,positionCode:positionCode.val()
			           ,status:status.val()
			           ,unqualifiedDetailId:unqualifiedDetailId
			        }
			        ,page:{"curr":1}
			      });
			},reset:function(othis){
				$('#materialCode_search').val("");
				$('#positionCode_search').val("");
				$('#status_search').val("");
				form.render("select");
			},print:function(othis){
				var checkData = table.checkStatus("unqualifiedDetailTabId").data;
				if(checkData.length<=0){
					layer.alert("请选择要打印的数据");
					return;
				}
				var ids = new Array();
				for(var i=0;i<checkData.length;i++){
					ids.push(checkData[i].id);
				}
				var option = {
					url:contextPath+'unqualifiedRemoved/lablePrint',
					type:'POST',
					data:JSON.stringify(ids),
					contentType:'application/json',
					success:function(res){
						if(res.code==0){
							var labelData = res.data;
							for(var i=0;i<labelData.length;i++){
								var label = labelData[i];
								// 条形码内容
								var text =label.materialCode+"\n"+
								    "描述:"+label.materialDesc+"\n"+
									"数量:"+label.count+label.materialUnit+"\n"+
									"批次:"+(label.batchNo==null?'':label.batchNo)+"\n"+
									"特殊库存标记:"+(label.specialType==null?'':label.specialType)+"\n"+
									"特殊库存编码:"+(label.specialCode==null?'':label.specialCode)+"\n"+
									label.id;
			                    str = "<div style=\"width: 120mm; height: 64mm;padding-left:22px;\"><div style=\"float:left;padding-top:2px;position:absolute;padding-left:0px\"><ul style=\"list-style-type:none;padding: 0px;margin: 0px;\">"+
			                    "<li><img id=\"image"+i+"\" width=\"210px\" height=\"210px\"></li>"+
			            		"<li><b style=\"width: 35mm;text-overflow: clip;white-space: nowrap;font-size: 20px;\"></b></li></ui></div>"+
			            		"<div style=\"font-size: 4px;float:left;width: 63mm;float:right;\">"+
			            		"<div style=\"font-size: 21px;height:30.5px;width: 63mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			label.materialCode+
			            		"</div><div style=\"font-size: 21px;height: 30.5px;width: 63mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			(label.materialDesc==null?'':label.materialDesc)+
			            		"</div><div style=\"font-size: 21px;height: 30.5px;width: 63mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			(label.positionCode==null?'':label.positionCode)+
			            		"</div><div style=\"font-size: 21px;height: 30.5px;width: 63mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			(label.batchNo==null?'T':label.batchNo)+"&nbsp;"+
			            		"</div><div style=\"font-size: 21px;height: 30.5px;width: 63mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			label.count+label.materialUnit+
			            		"</div><div style=\"font-size: 21px;height: 30.5px;width: 63mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			(label.specialType==null?'':label.specialType)+
			            		"</div><div style=\"font-size: 21px;height: 30.5px;width: 63mm;text-overflow: clip;white-space: nowrap;overflow: hidden;font-style: inherit;font-weight: bold;\">"+
			            			(label.specialCode==null?'':label.specialCode)+"&nbsp;"+
			            		"</div></div>"+
			            		"<canvas id=\"canvas"+i+"\" height=\"210px\" width=\"210px\" style=\"display: none \"></canvas></div>";

			                    if (i == 0) {
			                        // 第一页
			                        // 清空打印内容
			                        $("#div1").empty();

			                    } else {
			                        // 分页
			                        var str = "<DIV STYLE=\"page-break-before:always\">\n" + str + "</DIV>"
			                    }

			                    // 添加打印内容
			                    $("#div1").append(str);

			                    // 条形码生成
			                    $("#canvas"+i).qrcode({
			            			render : 'canvas',    //设置渲染方式，有table和canvas，使用canvas方式渲染性能相对来说比较好
			            			text : text, //扫描二维码后显示的内容,\n换行
			            			size : 210
			            		});
			                    var img = document.getElementById("image"+i); // get image element
			                    var canvas  = document.getElementById("canvas"+i);  // get canvas element
			                    img.src = canvas.toDataURL();//"image/png"
							}
							$("#div1").jqprint();
				            $("#div1").hide();
						}else{
							layer.alert("查询失败");
						}
					}
				};
				$.ajax(option);
			}
	};
	function loadding(){
		table.render({
			elem:'#unqualifiedDetailTab',
			id:'unqualifiedDetailTabId',
			url:contextPath+'unqualifiedRemoved/queryUnqualifiedDetail',
			cols:[[
			{type:'checkbox'},
			//{field:'id', width:80, title: 'ID', sort: true},
			{field:'materialCode',title:'物料号'},
			{field:'factory', title: '工厂'},
			{field:'materialUnit', title: '单位'},
			{field:'materialDesc', title: '物料描述'},
			{field:'storageBin', title: '仓位号'},
			{field:'count', title: '出库数量'},
			{field:'specialType',title: '特殊库存标记'},
			{field:'specialCode', title: '特殊库存编码'},
			{field:'batchNo',title: '批次号'},
			{field:'lowerFrameTime',title: '下架时间'},
			{field:'lowerFrameUid', title: '下架人'},
			{field:'outStorageTime', title: '出库时间'},
			{field:'outStorageUid', title: '出库人'},
			{field:'status', title: '状态',templet: '#statusTpl'},
			]],
			page: {theme: '#008155'},
			where:{
				unqualifiedDetailId:unqualifiedDetailId
			},
	   		even:true
		});
		$('.layui-btn-container button').on('click', function(){
		    var othis = $(this), method = othis.data('method');
		    active[method] ? active[method].call(this, othis) : '';
	  	});
	}




</script>
</body>
</html>
