<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Content-Type" content="charset=UTF-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"
	type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"
	type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
<title>成本中心领料</title>
</head>
<body id="bodyDiv">
	<script type="text/html" id="bodyTpl">
    <div class="layui-fluid" >
		<div class="layui-row layui-form">
			<div class="layui-col-md2">
                <label class="layui-form-label">订单号</label>
                <div class="layui-input-inline">
                    <input type="text" id="orderCode_search" class="layui-input" placeholder="请输入订单号">
                </div>
            </div>

<!--            <div class="layui-col-md2">-->
<!--                <label class="layui-form-label">工厂</label>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="text" id="factoryName" class="layui-input" placeholder="请输入工厂">-->
<!--                </div>-->
<!--            </div>-->

            <div class="layui-col-md2">
                <label class="layui-form-label">成本中心</label>
                <div class="layui-input-inline">
                    <select  id="costCenter" lay-filter="storageLocationFilter">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>

<!--            <div class="layui-col-md2">-->
<!--                <label class="layui-form-label">领料人</label>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="text" id="modifierName" class="layui-input" placeholder="请输入领料人">-->
<!--                </div>-->
<!--		    </div>-->
            <div class="layui-col-md2">
                <label class="layui-form-label">物料号</label>
                <div class="layui-input-inline">
                    <input type="text" id="materialCode" class="layui-input" placeholder="请输入物料号">
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">仓库</label>
                <div class="layui-input-inline">
                    <select  id="storageLocation_search" lay-filter="storageLocationFilter" xm-select="storageLocationSelect" xm-select-show-count="1">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
        <div class="layui-row layui-form">


            <div class="layui-col-md2">
                <label class="layui-form-label">内部订单</label>
                <div class="layui-input-inline">
                    <select  id="internalBill" lay-filter="internalBillFilter">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
            <div class="layui-btn-container nav-" style="text-align: right;">
                {{# if(d.search==null || d.search=="true"){ }}
                <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
                <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" id="reset" type="button"><i class="layui-icon  layui-icon-reset"></i>重置</button>
                {{# } }}
            </div>
        </div>
    </div>
    <div class="layui-fluid-table">
        <div class="layui-row layui-form">
            <div class="layui-btn-container">
                <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="distributing" type="button"><i class="layui-icon layui-icon-edit"></i>领料</button>
                {{# if(d.del==null || d.del=="true"){ }}
                <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="del" type="button"><i class="layui-icon layui-icon-delete"></i>删除</button>
                {{# } }}
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="distribute" type="button"><i class="layui-icon layui-icon-edit"></i>任务派发</button>
            </div>
        </div>
        <table class="layui-hide" id="stationOrderTab" lay-filter="stationOrderTabF"></table>
    </div>
</script>
	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
	<script type="text/javascript">
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form;
		var laydate = layui.laydate;
		var oldData;
		var contextPath = config.wmsConfig.contextPath;
		var active = {
             // 领料
			distributing : function(othis) {
                var type = othis.data('type');
                layer.open({
                    type : 2,
                    title : '领料',
                    maxmin : false,
                    area : [ '100%', '100%' ],
                    offset : type,
                    id : 'costCenterOutAdd' + type //防止重复弹出
                    ,
                    content : 'costCenterOutAdd.html',
                    shade : 0 //不显示遮罩
                    ,
                    yes : function() {
                        layer.closeAll();
                    }
                });
			},
            distribute:function(othis){
                var checkStatus = table.checkStatus('stationOrderTabId');
                oldData = checkStatus.data;
                if (oldData.length <= 0) {
                    layer.alert('请选择要下发的任务！', {icon: 2});
                    return;
                }
                let idarrys = new Array();
                for (var i = 0; i < oldData.length; i++) {
                    if (oldData[i].status == 0 ) {
                        idarrys.push(oldData[i].id);
                    }
                }
                if (idarrys.length<=0) {
                    layer.alert("当前任务已派发",{icon:2});
                    return ;
                }
                layer.confirm('下发任务确定', {icon: 3, title: '提示'}, function (index) {
                    //do something
                    var option = {
                        url: contextPath + 'costCenterOut/disStationOrder',
                        type: 'POST',
                        contentType: "application/json",
                        dataType: 'json',
                        data: JSON.stringify(idarrys),
                        success: function (data) {
                            if (data.code == 0) {
                                layer.alert("下发成功");
                                table.reload('stationOrderTabId');
                            }
                        }, error: function (data) {
                            layer.alert(data.msg);
                        }
                    }
                    $.ajax(option);
                    layer.close(index);
                });
            },
			search : function(othis) {
			    //订单号查询
				let orderCode_search = $('#orderCode_search').val();
				//工厂
              //  let factoryName = $('#factoryName').val();
				//成本中心
                let costCenter = $('#costCenter').val();
				 //领料人
                // let modifierName = $('#modifierName').val();
				//物料号
                let materialCode = $('#materialCode').val();
                //仓库
                let storageLocation = layui.formSelects.value('storageLocationSelect', 'valueStr');
                //内部订单
                let internalBill= $('#internalBill').val();
                let params = {};
                //订单号查询
				params.costCenterOrder = orderCode_search;
				//工厂查询
				//params.factory = factoryName;
				//成本中心查询
				params.costCenter = costCenter;
				//领料人查询
				//params.modifierName = modifierName;
				//物料号查询
				params.materialCode = materialCode;
				//仓库查询
				params.warehouseCodes = storageLocation;
                //内部订单查询
                params.internalBill = internalBill;
                params.orderType = "2";
				//执行重载
				table.reload('stationOrderTabId', {
					where : params,
				});
			},
			reset : function(othis) {
				$('#requiredTime_search').val("");
				$('#orderCode_search').val("");
				$('#reserveRow_search').val("");
				$('#materialRow_search').val("");
				$('#materialCode_search').val("");
				$('#reserveCode_search').val("");
				$('#positionCode_search').val("");
				$('#requiredTime_search').val("");
                $('#internalBill').val("");
				//$('#factoryName').val("");
                $('#costCenter').val("");
               // $('#modifierName').val("");
                $('#materialCode').val("");
                layui.formSelects.value('storageLocationSelect', []);
                form.render();
			}
            ,del:function(othis) {
                var checkStatus = table.checkStatus('stationOrderTabId');
                oldData = checkStatus.data;
                if (oldData.length <= 0) {
                    layer.alert('请选择要删除的行！', {icon: 2});
                    return;
                }
                for(let i = 0; i < oldData.length; i++){
                    if (oldData[i].status > 5){
                        layer.alert('无法删除已下架任务！', {icon: 2});
                        return;
                    }
                }

                var idarrys = new Array();
                for (var i = 0; i < oldData.length; i++) {
                    idarrys.push(oldData[i].id);
                }
                layer.confirm('确定删除该条领料记录信息?', {icon: 3, title: '提示'}, function (index) {
                    //do something
                    var option = {
                        url: contextPath + 'costCenterOut/delStationOrderInfo',
                        type: 'POST',
                        contentType: "application/json",
                        dataType: 'json',
                        data: JSON.stringify(idarrys),
                        success: function (data) {
                            if (data.code == 0) {
                                layer.alert("删除成功");
                                table.reload('stationOrderTabId');
                            }
                        }, error: function (data) {
                            layer.alert(data.msg);
                        }
                    }
                    $.ajax(option);
                    layer.close(index);
                });
            }
		};

		function loadding() {
			table.render({
				elem : '#stationOrderTab',
				id : 'stationOrderTabId',
                url : contextPath + 'costCenterOut/findStationOrderInfo',
				cols : [ [ {
					type : 'checkbox',
                    fixed:'left'
				}, {
					type : 'numbers',
					title : '序号',
                    fixed:'left'
				}, {
					field : 'costCenterOrder',
					title : '领料单号',
                    width:'100',
                    fixed:'left'
				}, {
					field : 'materialDocument',
					title : '物料凭证',
                    width:'100'
				}, {
					field : 'sapAccountTime',
					title : '过账日期',
                    width:'100'
				}, {
					field : 'factory',
					title : '工厂',
                    width:'100'
				}, {
					field : 'costCenterName',
					title : '成本中心',
                    width:'100'
				},  {
                    field : 'internalBillCodeDesc',
                    title : '内部订单',
                    width:'100'
                }, {
					field : 'wareHouseName',
					title : '仓库',
                    width:'100'
				}, {
					field : 'createrName',
					title : '创建人',
                    width:'100'
				}, {
					field : 'createTime',
					title : '创建时间',
                    width:'100'
				}, {
					field : 'busiType',
					title : '业务类型',
                    width:'100'
				}, {
					field : 'modifierName',
					title : '领料人',
                    width:'100'
				}, {
					field : 'materialCode',
					title : '物料号',
                    width:'100'
				}, {
					field : 'materialDesc',
					title : '物料描述',
                    width:'100'
				}, {
					field : 'enableCount',
					title : '数量',
                    width:'100'
				},{
                    field : 'materialUnit',
                    title : '单位',
                    width:'100'
                },{
                    field : 'remark',
                    title : '备注',
                    width:'100'
                }, {
					field : 'positionCode',
					title : '库位',
                    width:'100'
				} , {
                    field : 'pickNum',
                    title : '下架数量',
                    width:'100'
                },{
				    field : 'status',
                    title : '下架状态',
                    width:'100',
                    templet:function(d){
                        return d.status == "0" ? "待派发" : d.status == "5" ? "待下架" : d.status == "20" ? "已下架" :  d.status == "25" ? "已交接":"";
                    }
                }

				] ],
				page : {
					theme : '#008155'
				},
                where:{
                    orderType: "2"
                },
				even : true,
				done : function(res, page, count) {//列表数据回调函数
					//initWarehouseSignSelect("warehouse_search", 1);
					form.render(null, "storageLocationSearchForm");
				}
			});
			$('.layui-btn-container button').on('click', function() {
				var othis = $(this), method = othis.data('method');
				active[method] ? active[method].call(this, othis) : '';
			});
			//时间选择器
			laydate.render({
				elem : '#requiredTime_search',
				type : 'date',
				range : true
			});
			initWarehouseMultiSelect("storageLocation_search","storageLocationSelect",1,'');
            //初始化成本中心列表
            initCostCenter("costCenter","");
            //初始化内部订单列表
            initInternalBill("internalBill","");
		}
		//监听启用操作
		form.on('switch(statusValue)', function(obj) {
			var status = '0';
			if (obj.elem.checked) {
				status == '1';
			}
			updateStatus(this.value, status);
		});

        /***
         * @Discription: 成本中心下拉
         * @param null
         * @return null
         * @Author: zhanglei on 2020/9/29 17:13
         */
        function initCostCenter(costCenterSelectId,selectValue) {
            var contextPath = config.basicInfoConfig.contextPath
            var option = {
                url:contextPath + 'costCenter/getCostCenters',
                type:"get",
                contentType:'application/json',
                success:function(result){
                    if(result.code==0){
                        var costCenterCodes=result.data;
                        costCenterSignSelect(costCenterCodes,costCenterSelectId,selectValue);
                    }
                }
            }
            $.ajax(option);
        }

        function costCenterSignSelect(costCenterCodes, costCenterSelectId,selectValue){
            if(costCenterCodes.length>0){
                $("#"+costCenterSelectId).attr("lay-filter","costCenterFilter");
                var currcostCenterCode;
                var costCenterList = costCenterCodes;
                if($("#"+costCenterSelectId).find("option").length==1){
                    for(var i=0;i<costCenterList.length;i++){
                        // if(WarehouseCodes.currWareHose == costCenterList[i].storageLocation){
                        //     currcostCenterCode = costCenterCodes[i].costCenterCode;
                        // }
                        $("#"+costCenterSelectId).append("<option value="+costCenterList[i].costCenterCode+" >"+costCenterList[i].costCenterDesc+"</option>");
                    }
                    /*if(null == selectValue || selectValue==''){
                        selectValue = currwareCode;
                    }*/
                    $("#"+costCenterSelectId).val(selectValue);
                    layui.form.render("select");
                }
            }
        }
        /***
         * @Discription: 内部订单下拉
         * @param null
         * @return null
         * @Author: luozhihong on 2020/10/20
         */
        function initInternalBill(internalBillSelectId,selectValue) {
            var contextPath = config.basicInfoConfig.contextPath
            var option = {
                url:contextPath + 'internalBill/getInternalBillList',
                type:"get",
                contentType:'application/json',
                success:function(result){
                    if(result.code==0){
                        var internalBillCodes=result.data;
                        internalBillSignSelect(internalBillCodes,internalBillSelectId,selectValue);
                    }
                }
            }
            $.ajax(option);
        }
        function internalBillSignSelect(internalBillCodes, internalBillSelectId,selectValue){
            if(internalBillCodes.length>0){
                $("#"+internalBillSelectId).attr("lay-filter","internalBillFilter");
                var internalBillList = internalBillCodes;
                if($("#"+internalBillSelectId).find("option").length==1){
                    for(var i=0;i<internalBillList.length;i++){
                        $("#"+internalBillSelectId).append("<option value="+internalBillList[i].orderCode+" >"+internalBillList[i].describe+"</option>");
                    }
                    $("#"+internalBillSelectId).val(selectValue);
                    layui.form.render("select");
                }
            }
        }
	</script>
</body>
</html>
