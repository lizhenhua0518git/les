<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Content-Type" content="charset=UTF-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
<link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
<title>出库计划(非位制)</title>
<style> .layui-layer-content{background: linear-gradient(#001a47,#022558);}</style>
</head>
<body>
<div id="bodyDiv">

</div>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
<script src="/iles/pages/assets/js/jquery-1.10.2.js"></script>
<script src="/iles/pages/js/ajaxToken.js"></script>
<script src="/iles/pages/js/loginInspect.js"></script>
<script src="/iles/pages/js/common/warehouseSelect.js"></script>
<script type="text/html" id="bodyTpl">
<div class="layui-fluid">
	<!--<div class="layui-row layui-form" style="font-size: 20px;margin-bottom:20px;font-family:Microsoft Yahei;font-weight:600"> 配送计划执行物料明细表(非工位制)<i class="layui-icon layui-icon-help" style="font-size: 24px;color: #bdbd19;" onclick="helpDoc()"></i></div>
    </br> -->
   <div class="layui-row layui-form">
	 <div class="layui-col-md3">
                <label class="layui-form-label">仓库:</label>
                 <div class="layui-input-block">
					<select id="warehouseCode" xm-select="select1" xm-select-show-count="1">
						<option value="">请选择</option>
					</select>
                </div>
     </div>
	 <div class="layui-col-md2">
                <label class="layui-form-label">订单/预留号:</label>
                 <div class="layui-input-block">
                  <input type="text" id="orderCode" class="layui-input">
                </div>
     </div>
     <div class="layui-col-md2">
                <label class="layui-form-label">物料编码:</label>
                 <div class="layui-input-block">
                  <input type="text" id="materialCode" class="layui-input">
                </div>
      </div>
      <div class="layui-col-md2">
                <label class="layui-form-label">凭证号:</label>
                 <div class="layui-input-block">
                  <input type="text" id="voucherCode" class="layui-input">
                </div>
      </div>

	</div>
	<div class="layui-row layui-form" style="margin-bottom: 0">
	 <div class="layui-col-md3">
                <label class="layui-form-label">需求日期:</label>
                <div class="layui-input-block">
                  <input type="text" id="requiredDate" class="layui-input">
                </div>
      </div>
	  <div class="layui-col-md2">
       <label class="layui-form-label">下架任务创建状态:</label>
       <div class="layui-input-block layui-form">
		 <select  id="toStatus">
			<option value="">请选择</option>
            <option value="0">未创建</option>
            <option value="1">部分创建</option>
            <option value="2">已创建</option>
		 </select>
		</div>
      </div>
	</div>
   <div class="layui-row layui-form" style="margin-bottom: 0">
   <!--<div class="layui-col-md6">
       <div style="margin-top: 12px">
			<nobr><span  index="1">计划出库总数：<span id="sunCount">0</span></span></nobr>
			<nobr><span  index="2">工位制总数：<span id="planCount">0</span></span></nobr>
			<nobr><span  index="3">非工位制总数：<span id="noPlanCount">0</span></span></nobr>
		</div>
     </div> -->
		  <div class="layui-btn-container">
				{{# if(d.search==null || d.search=="true"){ }}
					<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
					<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
				{{# } }}
				{{# if(d.export==null || d.export=="true"){ }}
					<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="export" type="button"><i class="layui-icon layui-icon-export"></i>导出</button>
				{{# } }}
				{{# if(d.goDown==null || d.goDown=="true"){ }}
					<button class="layui-btn layui-btn-normal layui-btn-sm" id="goDown" data-method="goDown" type="button"><i class="layui-icon">&#xe61a;</i>创建下架任务</button>
				{{# } }}
		</div>
   </div>
	</div>

<table   id="distributionTaskDetailUnStationTab" lay-filter="distributionTaskDetailUnStationTabF"></table>
<div id="helpDocDiv" style="display:none">
	<div class="layui-col-md12">
      <div class="layui-card" style="background: linear-gradient(#001a47,#022558);">
        <div class="layui-card-header" style="color: #c0dcfe;border-bottom: 1px solid #2a69c7;font-size: 22px;padding-top: 22px;">数据来源</div>
        <div class="layui-card-body"  style="border-bottom: 1px solid #2a69c7;color: #c0dcfe;">
        	<p>默认查询凭证建日期加72个小时是明天的SAP非工位制物料明细表。输入的任何查询条件如果没有选择需求日期则会默认按照需求时间是明天的条件</p>
        	<p>计划出库总数:统计工位制需求日期是明天的所有生产计划+非工位制创建日期加72个小时是明天的所有凭证详情</p>
        	<p>工位制总数:统计工位制需求日期是明天的所有生产计划</p>
        	<p>非工位制总数:非工位制创建日期加72个小时是明天的所有凭证详情</p>

        </div>
      </div>
    </div>
</div>
</script>
 <script type="text/html" id="indexTpl">
     {{d.LAY_TABLE_INDEX+1}}
   </script>
    <script type="text/javascript">
    var element = layui.element;
    var layer = layui.layer;
    var table = layui.table;

    var form = layui.form;
    var formSelects;
    var tableFilter = layui.tableFilter;
    var oldData;
    var curDate = new Date();
	var curDateStr = dateFtt("yyyy-MM-dd",curDate)
	var contextPath = config.wmsConfig.contextPath;
	var tableFilterIns;
    layui.use(['formSelects'],function(){
    	formSelects = layui.formSelects;
    });
	var active = {
            search:function(othis){
                var materialCode=$.trim($('#materialCode').val());
                var orderCode=$.trim($('#orderCode').val());
                var storageLocation = layui.formSelects.value('select1', 'storagelocationStr');
                var startTime = curDateStr;
                var endTime = '';
                if($('#requiredDate').val() !='' && $('#requiredDate').val() !=null){
            	    startTime = $('#requiredDate').val().split(' - ')[0];
                    endTime = $('#requiredDate').val().split(' - ')[1];
             	}
                var voucherCode = $.trim($('#voucherCode').val());
                var toStatus = $("#toStatus").val();
                var params={};
                params.materialCode=materialCode;
                params.orderCode=orderCode;
                params.startTime=startTime;
                params.endTime=endTime;
                params.voucherCode=voucherCode;
                params.storageLocation = storageLocation;
                params.toStatus = toStatus;
                //执行重载
                table.reload('distributionTaskDetailUnStationId', {
                  where:params,
                  page:{"curr":1}
                });

            },reset:function(othis){
                $('#materialCode').val("");
                $('#orderCode').val("");
                $('#requiredDate').val("");
                layui.formSelects.value('select1', []);
                $('#voucherCode').val("");
                $("#toStatus").val("");
                form.render("select");
                form.render("checkbox");
            },
            export:function(othis){
            	 var materialCode=$.trim($('#materialCode').val());
                 var orderCode=$.trim($('#orderCode').val());
                 var  startTime = curDateStr;
                 var  endTime = '';
                 if($('#requiredDate').val() !='' && $('#requiredDate').val() !=null){
                	    startTime = $('#requiredDate').val().split(' - ')[0];
                        endTime = $('#requiredDate').val().split(' - ')[1];
                 }

               var voucherCode = $.trim($('#voucherCode').val());
               var token = window.localStorage.token;
               var storageLocation = layui.formSelects.value('select1', 'storagelocationStr');
               var toStatus = $("#toStatus").val();
               var params = "materialCode="+materialCode+"&orderCode="+orderCode
                +"&startTime="+startTime+"&endTime="+endTime
                +"&storageLocation="+storageLocation
                +"&voucherCode="+voucherCode+"&token="+token+"&toStatus="+toStatus;;
                window.open(contextPath+"outBoundPlanManger/exportCurdateOutUnStation?"+params);
            },
            goDown:function(othis){
            	var checkStatus = table.checkStatus('distributionTaskDetailUnStationId');
 				oldData = checkStatus.data;
				if(oldData.length<=0){
					layer.alert('请选择要创建的行！',{icon: 2});
     				return ;
				}
				var flg = false;
				var idarrys = new Array();
				for(var i=0;i<oldData.length;i++){
					if(oldData[i].toStatus=="2"){
						flg = true;
					}
					idarrys.push(oldData[i].id);
				}
				if(flg){
					layer.alert('已创建任务不能重复创建',{icon: 2});
					return ;
				}
				var option ={
                        url:config.apiConfig.contextPath+'push/createToByIdF',
                        type:'POST',
                        contentType: "application/json",
                        dataType:'json',
                        data:JSON.stringify(idarrys),
                        success:function(data){
                            if(data.code==0){
                            	layer.msg("创建成功");
                            	table.reload('distributionTaskDetailUnStationId');//刷新列表
                            }
                        },error:function(data){
                            layer.alert(data.msg);
                        }
                    }
               $.ajax(option);
	        }

    };
    function loadding(){
    	//日期范围
        layui.use('laydate', function(){
        	var laydate = layui.laydate;
        	laydate.render({
        	    elem: '#requiredDate',
        	    range: true
        	});
        });
        initWarehouseMultiSelect("warehouseCode","select1","0",null);
      //全选
        form.on('checkbox(allSelect)', function (data) {
            var a = data.elem.checked;
            if (a == true) {
                $(".taskState").prop("checked", true);
                form.render('checkbox');
            } else {
                $(".taskState").prop("checked", false);
                form.render('checkbox');
            }

        });
        form.on('checkbox(taskState)', function (data) {
            var t =0;
       	 $("input:checkbox[name='taskState']:checked").each(function(i){
            	t++;
            });
       	 if(t==5){
       		 $("#allSelect").prop("checked", true);

       	 }else{
       		 $("#allSelect").prop("checked", false);
       	 }
       	 form.render('checkbox');

       });

       table.render({
            elem:'#distributionTaskDetailUnStationTab',
            id:'distributionTaskDetailUnStationId',
            url:contextPath+'outBoundPlanManger/curdateOutFWarehouse',
            headers:{"Authorization": 'Bearer '+token},
            limits:[100, 200, 300, 400, 500],
            limit:100,
            cols:[[
				{type:'checkbox'},
    			{type:'numbers',title:'序号',width: 60},
    			{field:'warehouseCode', title: '仓库编码'},
    			{field:'warehouseName', title: '仓库名称'},
    			{field:'orderCode', title: '订单/预留号'},
    			{field:'requiredDate', title: '需求日期'},
    			{field:'requiredTime', title: '需求时间'},
    			{field:'mblnr', title: '凭证号'},
    			{field:'matnr', title: '物料编号'},
    			{field:'maktx', title: '物料描述'},
    			{field:'meins', title: '物料单位'},
    			{field:'menge', title: '实发数量'},
    			{field:'createTime', title: '凭证日期'},
    			{field:'bwart', title: '移动类型'},
    			{field:'toStatus', width:100, title: '下架任务创建状态'},
	            {field:'waitMatchNum', width:100, title: '待分配数量'},
    			{field:'lgort', title: '库存地点'},

            ]],
            page:{theme: '#008155'},
            where:{
            	startTime:curDateStr,
            	endTime:curDateStr
            },
            height: 'full-95',
            done:function(res,page,count){//列表数据回调函数
            	//initTableDate(res.data);
            	//head();
            $("[data-field='toStatus']").children().each(function(){
	            	if($(this).text()=='0'){
	                    $(this).text('未创建');
	                }else if($(this).text()=='1'){
	                    $(this).text('部分创建');
	                } else if($(this).text()=='2'){
	                    $(this).text('已创建');
	                }

	           });
              tableFilterIns = tableFilter.render({

		           'elem' : '#distributionTaskDetailUnStationTab',//table的选择器
		           'mode' : 'local',//过滤模式
		           'id':'distributionTaskDetailUnStationId',
		           'filters' : [
		           			{field:'warehouseName',name:'仓库名称',type:'checkbox'},

		           			 {field:'lgort',name:'库存地点',type:'checkbox'}

		           			],//过滤项配置
		           'done': function(filters){

		           }
		       });
            }
       });

       $('.layui-btn-container button').on('click', function(){
           var othis = $(this), method = othis.data('method');
           active[method] ? active[method].call(this, othis) : '';
       });
    }


    function helpDoc(){
		layer.open({
			  type: 1,
			  area:['50%','50%'],
			  title:'',
			  content: $('#helpDocDiv'), //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
			  cancel: function(index, layero){
  				$("#helpDocDiv").hide();
  			}
		});
	}
  //表格数据初始化
    function initTableDate(data){

        $("[data-field='orderCode']").children().each(function(){
            if($(this).text()=='/'){
                $(this).text('');
            }
        });
    }
    function head(){
    	curDate.setDate(curDate.getDate()+1);
    	var requiredDateStr = dateFtt("yyyy-MM-dd",curDate)
  		$.ajax({
	        url: contextPath+"outBoundPlanManger/curdatePlanTotal?requiredDate="+requiredDateStr+"&createDate="+curDateStr,
	        dataType:'json',
			type:'GET',
	        async: false,
	        success: function (result) {
	            var a = "0";
                if(result.code==0){
                	var data = result.data;
	                	$('#planCount').text(data.stationCount);
	                	$('#noPlanCount').text(data.unStationCount);
	                	$('#sunCount').text(data.total);
                    }else{
                    	$('#planCount').text("0");
                    	$('#noPlanCount').text("0");
                    	$('#sunCount').text("0")
                    }
        	}
	    });
  	}

    function dateFtt(fmt,date)
	{ //author: meizz
	  var o = {
	    "M+" : date.getMonth()+1,                 //月份
	    "d+" : date.getDate(),                    //日
	    "h+" : date.getHours(),                   //小时
	    "m+" : date.getMinutes(),                 //分
	    "s+" : date.getSeconds(),                 //秒
	    "q+" : Math.floor((date.getMonth()+3)/3), //季度
	    "S"  : date.getMilliseconds()             //毫秒
	  };
	  if(/(y+)/.test(fmt))
	    fmt=fmt.replace(RegExp.$1, (date.getFullYear()+"").substr(4 - RegExp.$1.length));
	  for(var k in o)
	    if(new RegExp("("+ k +")").test(fmt))
	  fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
	  return fmt;
	}
</script>
</body>
</html>
