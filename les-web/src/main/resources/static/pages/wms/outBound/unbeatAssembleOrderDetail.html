<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>非工位制任务下达</title>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
</head>
<body>
<div id="bodyDiv">

</div>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js"></script>
<script type="text/html" id="bodyTpl">
<div class="layui-fluid">
		<div class="layui-row layui-form">
				 <div class="layui-col-md3">
				 	<label class="layui-form-label">物料编号:</label>
				 	 <div class="layui-input-block">
				      <input type="text" id="materialNum_search" class="layui-input">
				    </div>
				 </div>
				 <div class="layui-col-md3">
				 	<label class="layui-form-label">订单项目号:</label>
				 	 <div class="layui-input-block">
				      <input type="text" id="aufps_search" class="layui-input">
				    </div>
				 </div>
				 <div class="layui-col-md3">&nbsp;</div>

			</div>
			<div class="layui-row layui-form" style="margin-bottom: 0">
					<div class="layui-btn-container">
						{{# if(d.search==null || d.search=="true"){ }}
							<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
							<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
						{{# } }}
						{{# if(d.send==null || d.send=="true"){ }}
							<button class="layui-btn layui-btn-normal layui-btn-sm" id="autoSend" onclick="autoSend()" type="button">一键出库</button>
						{{# } }}
					</div>
			</div>
	</div>
<table class="layui-hide" id="unorderDetailTab" lay-filter="unorderDetailTabF"></table>
</script>
<script type="text/javascript">
	var table = layui.table;
	var assembleId = parent.assembleId;//集配单主键
	var deliveryCode=parent.deliveryCode;//出库单号
	var orderCode=parent.orderCode;//订单号
	var storageLocation=parent.storageLocation;//库存地点
	var contextPath = config.wmsConfig.contextPath;
	var active = {
			search:function(othis){
				var materialNum_search = $("#materialNum_search").val();
				var aufps_search = $("#aufps_search").val();
				table.reload('unorderDetailTabId',{
						where:{
							matnr:materialNum_search,
							aufnr:aufps_search,
							parentId:assembleId
						}
						,page:{"curr":1}
					})
				},
			reset:function(othis){
				$("#materialNum_search").val("");
				$("#aufps_search").val("");
			}
	};
	function loadding(){
		table.render({
			elem:"#unorderDetailTab",
			id:"unorderDetailTabId",
			url:contextPath+"assembleOrder/unbeatDetailPage",
			cols:[[
			     {type:'checkbox'},
			     {field:'mblnr',title:'物料凭证编号',width:150},
			     {field:'mjahr',title:'物料凭证年度',width:150},
			     {field:'zeile',title:'物料凭证中的项目',width:150},
			     {field:'bwart',title:'移动类型',width:100},
			     {field:'matnr',title:'物料编号',width:150},
			     {field:'werks',title:'工厂',width:100},
			     {field:'lgort',title:'存储位置',width:100},
			     {field:'charg',title:'批号',width:100},
			     {field:'insmk',title:'库存类型',width:100},
			     {field:'storage_bin_id',  width:120, title: '仓位号'},
			     {field:'sernr',  width:120, title: '车号'},
			     {field:'ablad',  width:120, title: '配送地址'},
			     {field:'zusch',title:'批量状态码',width:100},
			     {field:'zustd',title:'限制批量',width:100},
			     {field:'sobkz',title:'特殊库存标识',width:120},
			     {field:'bwtar',title:'评估类型',width:100},
			     {field:'menge',title:'数量',width:100},
			     {field:'meins',title:'基本计量单位',width:150},
			     {field:'erfmg',title:'录入项数量',width:150},
			     {field:'ebeln',title:'采购订单号',width:150},
			     {field:'ebelp',title:'采购凭证编号',width:150},
			     {field:'lfbja',title:'参考凭证会计年度',width:150},
			     {field:'lfbnr',title:'参考凭证的凭证号',width:150},
			     {field:'lfpos',title:'参考凭证项目',width:150},
			     {field:'sjahr',title:'物料凭证年度',width:150},
			     {field:'smbln',title:'物料凭证编号',width:150},
			     {field:'smblp',title:'物料凭证中的项目',width:150},
			     {field:'aufnr',title:'订单号',width:150},
			     {field:'anln1',title:'主资产号',width:150},
			     {field:'rsnum',title:'预留/相关需求的编号',width:200},
			     {field:'rspos',title:'预留 / 相关需求的项目编号',width:200},
			     {field:'psPspPnr',title:'工作分解结构元素 ',width:200},
			     {field:'aufpl',title:'订单中工序的工艺路线号',width:200},
			     {field:'aufps',title:'订单项目号',width:150},
			     ]],
			 page: {theme: '#008155'},
			 height: 'full-200',
			 even:true,
			 where:{
				 "assembleId":assembleId
			 }
		});
		$('.layui-btn-container button').on('click', function(){
		    var othis = $(this), method = othis.data('method');
		    active[method] ? active[method].call(this, othis) : '';
	  	});
	}



	function autoSend(){
		var list = table.checkStatus('unorderDetailTabId');
		oldData = list.data;
		$("#autoSend").attr("disabled","true");
		var length = oldData.length;
		if(length==0){
			layer.alert('请选择要发货的数据！',{icon: 2});
			$("#autoSend").removeAttr("disabled");
			return false;
		}
		if(length>1){
			layer.alert('只能选择一个!',{icon: 2});
			$("#autoSend").removeAttr("disabled");
			return false;
		}
		var detailId = oldData[0].id;
		var assembleId = oldData[0].assembleId;
		var option = {
			url:contextPath+'assembleOrderDetail/autoSend?detailId='+detailId+'&assembleId='+assembleId,
			type:'POST',
			success:function(res){
				if(res.code==0){
					layer.alert("发货成功!");
					$("#autoSend").removeAttr("disabled");
				}else{
					layer.alert(res.data);
					$("#autoSend").removeAttr("disabled");
				}
			}
		};
		$.ajax(option);
	}
</script>
</body>
</html>
