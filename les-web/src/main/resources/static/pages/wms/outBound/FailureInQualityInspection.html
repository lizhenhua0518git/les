<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="renderer" content="webkit|ie-comp|ie-stand">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta http-equiv="Content-Type" content="charset=UTF-8">
	<meta name="viewport"
		  content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	<meta http-equiv="Cache-Control" content="no-siteapp" />
	<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
	<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
	<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
	<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
	<style type="text/css">
		.layui-form-label2{float: left;display: block;padding: 5px 10px;width: 90px;font-weight: 400;line-height: 20px;text-align: right;}
		.layui-layer-content-new{background: linear-gradient(#001a47,#022558);}
	</style>
	<title>不合格物料管理</title>
</head>
<div id="bodyDiv">

</div>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>

<script type="text/html" id="bodyTpl">
	<input type="hidden" id="totalNum"/>
	<input type="hidden" id="receiveId"/>
	<input type="hidden" id="arrivalId"/>
	<input type="hidden" id="img">
	<div class="layui-fluid">
		<div class="layui-row layui-form">
			<div class="layui-col-md2">
                <label class="layui-form-label">采购订单号</label>
                <div class="layui-input-inline">
                    <input type="text" id="orderCode_search" class="layui-input" placeholder="请输入采购订单号">
                </div>
            </div>
			<div class="layui-col-md2">
				<label class="layui-form-label">仓库</label>
				<div class="layui-input-inline">
					<select  id="sourceEntrepot">
						<option value="">请选择</option>
					</select>
				</div>
			</div>
			<div class="layui-col-md2">
				<label class="layui-form-label">物料号</label>
				<div class="layui-input-inline">
					<input type="text" id="billCod" class="layui-input" placeholder="请输入物料号">
				</div>
			</div>
			<div class="layui-col-md2">
                <label class="layui-form-label">供应商</label>
                <div class="layui-input-inline">
                    <input type="text" id="supplierName_search" class="layui-input" placeholder="请输入供应商">
                </div>
            </div>
			<div class="layui-col-md2">
				<label class="layui-form-label">质检日期</label>
				<div class="layui-input-inline layui-form">
					<input type="text" class="layui-input"  id="createTime_search" placeholder="请选择质检日期">
				</div>
			</div>
			<div class="layui-btn-container nav-" style="text-align: right;">
				{{# if(d.search==null || d.search=="true"){ }}
				<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
				<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" id="reset" type="button"><i class="layui-icon  layui-icon-reset"></i>重置</button>
				{{# } }}
			</div>
		</div>
	</div>
	<div class="layui-fluid-table">
		<div class="layui-row layui-form">
			<div class="layui-btn-container">
				<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="distribute" type="button"><i class="layui-icon layui-icon-edit"></i>退货</button>
				<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="history" type="button"><i class="layui-icon layui-icon-order-check"></i>历史记录</button>
			</div>
		</div>
	</div>
	<table id="scheduleTab" lay-filter="scheduleTabF">

	</table>
</script>
<script type="text/html" id="indexTpl">
	{{d.LAY_TABLE_INDEX+1}}
</script>

<script type="text/javascript">
	var contextPath = config.basicInfoConfig.contextPath;
	var wmsContextPath = config.wmsConfig.contextPath;
	var layer = layui.layer;
	var table = layui.table;
	var form= layui.form;
	var laydate = layui.laydate;
	var $ = layui.$;
	var oldData;//用于查看详情时传递参数
	var active = {
		//退货
		distribute:function(othis){
			var checkStatus = table.checkStatus('scheduleTabId');
			oldData = checkStatus.data;
			if (oldData.length <= 0) {
				layer.alert('请选择要退的货！', {icon: 2});
				return;
			}
			var warehouseCode_T;
			var wareHouseName;
			var unMaterialList = new Array();
			for (let i = 0; i < oldData.length; i++) {
				if (warehouseCode_T == null){
					warehouseCode_T = oldData[i].wareHouseCode;
					wareHouseName = oldData[i].wareHouseName;
				}else {
					if (warehouseCode_T != null&&warehouseCode_T != oldData[i].wareHouseCode){
						layer.alert('请选择属于同一个仓库下的物料！', {icon: 2});
						return;
					}
				}
				var materialStorages = {
					id:oldData[i].id,
					materialCode:oldData[i].materialCode,
					pickNum:oldData[i].unEnableCount,
					supplierName:oldData[i].supplierName,
					enableCount:oldData[i].enableCount,
					preUseCount:oldData[i].preUseCount,
					wareHouseName:oldData[i].wareHouseName,
					positionCode:oldData[i].positionCode,
					materialDesc:oldData[i].materialDesc,
					materialUnit:oldData[i].materialUnit,
					storageId:oldData[i].storageId,
					storageLocation:oldData[i].storageLocation,
					positionCode:oldData[i].positionCode,
					batchNo:oldData[i].batchNo
				};
				unMaterialList.push(materialStorages);
			}
			var paraMap = {
				materialStorages : unMaterialList,
				busiType : 9,
				wareHouseCode:warehouseCode_T,
				wareHouseName:wareHouseName,
			}
			layer.confirm('确定要退的货', {icon: 3, title: '提示'}, function (index) {
				// do something
				var option = {
					url: wmsContextPath + 'costCenterOut/saveStationOrderInfo',
					type: 'POST',
					contentType: "application/json",
					dataType: 'json',
					data: JSON.stringify(paraMap),
					success: function (data) {
						if (data.code == 0) {
							layer.alert("退货成功");
							table.reload('scheduleTabId');
						}
					}, error: function (data) {
						layer.alert(data.msg);
					}
				}
				$.ajax(option);
				layer.close(index);
			});

		},
		history:function (othis){
			var type = othis.data('type');
			layer.open({
				type : 2,
				title : '历史记录',
				maxmin : false,
				area : [ '100%', '100%' ],
				offset : type,
				id : 'scheduleTabId' + type //防止重复弹出
				,
				content : 'FailureInQualityInspectionHistory.html',
				shade : 0 //不显示遮罩
				,
				yes : function() {
					layer.closeAll();
				}
			});
		},
		search:function(othis){
			//采购订单号
			var orderCode = $('#orderCode_search').val();
			//供应商名称
			var supplierName = $('#supplierName_search').val();
			//质检时间
			var createTimeBegin = $('#createTime_search').val().split(' - ')[0];
			var createTimeEnd = $('#createTime_search').val().split(' - ')[1];
			//仓库
			let sourceEntrepot = $('#sourceEntrepot').find("option:selected").val();
			//物料号
			let billCod = $('#billCod').val();
			//执行重载
			table.reload('scheduleTabId', {
				where:{
					purchaseCode:orderCode,
					wareHouseCode:sourceEntrepot,
					supplierName:supplierName,
					materialCode:billCod,
					inspectionBeginTime:createTimeBegin,
					inspectionEndTime:createTimeEnd
				},
				page : {
					"curr" : 1
				}
			});
		},
		reset:function(othis){
			$('#orderCode_search').val("");
			$('#supplierName_search').val("");
			$('#createTime_search').val('');
			$('#billCod').val("");
			$('#sourceEntrepot').val("");
			form.render("select");
		},
	};
	var oldData;
	function loadding() {
		table.render({
			elem:'#scheduleTab',
			id:'scheduleTabId',
			url:wmsContextPath+'qualityApi/findQualityMaterials',
			cols: [[
				{
					type : 'checkbox'
				},
				{title: '序号',templet: '#indexTpl',width: 60},
				//{type:'numbers',title:'序号',width: 60},
				{field:'purchaseCode',title: '采购订单号'},
				{field:'inspectionTime',title: '质检日期',templet(d){
						if(d.inspectionTime){
							return d.inspectionTime.substring(0,10);
						}else{
							return '-';
						}
					}},
				{field:'materialCode',title: '物料号'},
				{field:'wareHouseName',title: '仓库'},
				{field:'positionCode',title: '库位'},
				{field:'unEnableCount', title: '物料数量'},
				{field:'materialUnit', title: '单位'},
				{field:'supplierName', title: '供应商'},
				{field:'billCode', title: '号'},
				{field:'inspectionerName', title: '质检员'},
				{field:'upperName', title: '上架员'},
				{field:'upperTime', title: '上架时间'}
				// {fixed:'right',align:'center',title: '操作',toolbar:'#toolBar',width:300},

			]],
			page: {theme: '#008155'},
			height: 'full-110',
			even:true,
		});
		//initWarehouseMultiSelect("sourceEntrepot","sourceEntrepotSelect",1,null);
		initWarehouseSignSelect("sourceEntrepot","sourceEntrepotSelect",1);
		//监听工具条
		table.on('tool(scheduleTabF)', function(obj){
			var eventName = obj.event;			//事件名称

		});
		$('.layui-btn-container button').on('click', function(){
			var othis = $(this), method = othis.data('method');
			active[method] ? active[method].call(this, othis) : '';
		});
		//时间选择器
		laydate.render({
			elem: '#createTime_search',
			type: 'date',
			range: true
		});
		// initWarehouseMultiSelect("sourceEntrepot","sourceEntrepotSelect",1,'');
		initBillTypeMultiSelect2("billNameSelect",[],'0,2');
		form.render();
	}
	/**
	 *  功能描述：单/多选下拉仓库
	 *  permission  1-权限控制 0-不控制
	 * @param warehouseSelectId 下拉框ID
	 * @param xmselectId  多选的xmselect参数ID
	 * @param selectValues 多选中的值
	 * @param permission  1-权限控制 0-不控制
	 * @returns
	 */
	function initWarehouseMultiSelect(warehouseSelectId,xmselectId,permission,selectValues){
		var params={limit:0,sortColums:"org_code asc",permission:permission};
		var contextPath = config.basicInfoConfig.contextPath
		var option = {
			url:contextPath + 'orgnization/listWarehouse',
			type:"post",
			contentType: "application/json",
			dataType:'json',
			data:JSON.stringify(params),
			success:function(result){
				if(result.code==0){
					var WarehouseCodes=result.data;
					initWarehouseSignSelect(warehouseSelectId,permission,selectValues);
				}
			}
		}
		$.ajax(option);
	}
</script>
</html>
