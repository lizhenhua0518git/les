<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>集配单详情</title>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
</head>
<body>
<div id="bodyDiv">

</div>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js"></script>
<script type="text/html" id="bodyTpl">
<div class="layui-fluid">
	<div class="layui-row layui-form">
				<div class="layui-btn-container">
						<button class="layui-btn layui-btn-normal layui-btn-sm" id="autoSend" onclick="autoSend()" type="button">一键出库</button>
				</div>
	</div>
</div>
<table class="layui-hide" id="orderDetailTab" lay-filter="orderDetailTabF"></table>

</script>
<script type="text/javascript">
	var table = layui.table;
	var assembleId = parent.assembleId;//集配单主键
	var deliveryCode=parent.deliveryCode;//出库单号
	var orderCode=parent.orderCode;//订单号
	var storageLocation=parent.storageLocation;//库存地点
	var contextPath = config.wmsConfig.contextPath;
	var active = {
			search:function(othis){
				var materialNum_search = $("#materialNum_search").val();
				var materialDesc_search = $("#materialDesc_search").val();
				var reserveNum_search = $("#reserveNum_search").val();
				table.reload('orderDetailTabId',{
						where:{
							materialNum:materialNum_search,
							materialDesc:materialDesc_search,
							reserveNum_search:reserveNum_search,
							orderId:orderId
						}
						,page:{"curr":1}
					})
				},
			reset:function(othis){
				$("#materialNum_search").val("");
				$("#materialDesc_search").val("");
				$("#reserveNum_search").val("");
			}
	};
	function loadding(){
		table.render({
			elem:"#orderDetailTab",
			id:"orderDetailTabId",
			url:contextPath+"assembleOrderDetail/queryAssembleDetail",
			cols:[[
			     {type:'checkbox'},
			     {field:'reserveCode',title:'预留号',width:100},
			     {field:'reserveRow',title:'预留行',width:100},
			     {field:'materialCode',title:'SAP物料号',width:150},
			     {field:'materialDesc',title:'物料描述',width:100},
			     {field:'storageType',title:'存储类型',width:100},
			     {field:'materialUnity',title:'单位',width:100},
			     {field:'enableCount',title:'集配数量',width:100},
			     {field:'unsendCount',title:'未发料数量',width:100},
			     {field:'factory',title:'工厂',width:100},
			     {field:'orderCode',title:'订单号',width:100},
			     {field:'storageLocation',title:'库存地点',width:100},
			     {field:'deliverMode',title:'配送方式',width:100},
			     {field:'deliverPlatform',title:'配送台位',width:100},
			     {field:'planFillgoodTime',title:'计划补货完成时间',width:150},
			     {field:'planShippingTime',title:'计划配送完成时间',width:150}
			     ]],
			 page: {theme: '#008155'},
			 height: 'full-200',
			 even:true,
			 where:{
				 "assembleId":assembleId
			 },
			 done:function(res,page,count){//列表数据回调函数
				 $("[data-field='deliveryCode']").children().each(function(){
					 	if(deliveryCode!=null && 'null'!=deliveryCode && $(this).text().trim()!='出库单号')
							$(this).text(deliveryCode);
					});
				 $("[data-field='orderCode']").children().each(function(){
					 if(orderCode!=null && 'null'!=orderCode && $(this).text().trim()!='订单号')
						$(this).text(orderCode);
					});
				 $("[data-field='storageLocation']").children().each(function(){
					 if(storageLocation!=null && 'null'!=storageLocation && $(this).text().trim()!='库存地点')
						$(this).text(storageLocation);
					});
				 $("[data-field='storageType']").children().each(function(){
					 if($(this).text().trim()=='0'){
						 $(this).text("地堆");
					 }else  if ($(this).text().trim()=='1'){
						 $(this).text("货架");
					 }
				});

			 }
		});
		$('.layui-btn-container button').on('click', function(){
		    var othis = $(this), method = othis.data('method');
		    active[method] ? active[method].call(this, othis) : '';
	  	});
	}



	function autoSend(){
		var list = table.checkStatus('orderDetailTabId');
		oldData = list.data;
		$("#autoSend").attr("disabled","true");
		var length = oldData.length;
		if(length==0){
			layer.alert('请选择要发货的数据！',{icon: 2});
			$("#autoSend").attr("disabled","false");
			return false;
		}
		if(length>1){
			layer.alert('只能选择一个!',{icon: 2});
			$("#autoSend").attr("disabled","false");
			return false;
		}
		var detailId = oldData[0].id;
		var assembleId = oldData[0].assembleId;
		var option = {
			url:contextPath+'assembleOrderDetail/autoSend?detailId='+detailId+'&assembleId='+assembleId,
			type:'POST',
			success:function(res){
				if(res.code==0){
					layer.alert("发货成功!");
					$("#autoSend").attr("disabled","false");
				}else{
					layer.alert(res.data);
					$("#autoSend").attr("disabled","false");
				}
			}
		};
		$.ajax(option);
	}
</script>
</body>
</html>
