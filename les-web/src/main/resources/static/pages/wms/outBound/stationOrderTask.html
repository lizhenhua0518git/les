<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css" type="text/css"/>
    <link rel="stylesheet" href="/iles/pages/css/layui_extend.css" type="text/css"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css"/>
    <title>任务派发</title>
</head>
<body id="bodyDiv">
<script type="text/html" id="bodyTpl">
    <div class="layui-fluid">
        <div class="layui-row layui-form">
            <div class="layui-col-md2">
                <div class="layui-col-md2">
                    <label class="layui-form-label">生产日期</label>
                    <div class="layui-input-inline layui-form">
                        <input type="text" class="layui-input" id="requiredTime_search" placeholder="请选择生产日期">
                    </div>
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">仓库</label>
                <div class="layui-input-inline">
                    <select id="storageLocation_search" lay-filter="storageLocationFilter" xm-select="storageLocationSelect" xm-select-show-count="1">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">业务类型</label>
                <div class="layui-input-inline">
                    <select  id="busiType_search"  xm-select="busiTypeCode_search" xm-select-show-count="1">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="layui-row layui-form">
            <div class="layui-col-md2">
                <label class="layui-form-label">车间</label>
                <div class="layui-input-inline">
                    <select  id="workshopCode_search"  xm-select="workshopCode_search" xm-select-show-count="1">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">产线</label>
                <div class="layui-input-inline">
                    <select  id="lineCode_search"  xm-select="lineCode_search" xm-select-show-count="1">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">工位</label>
                <div class="layui-input-inline">
                    <select id="stationCode_search" xm-select="stationCode_search" xm-select-show-count="1">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="layui-row layui-form">
            <div class="layui-btn-container nav-" style="text-align: right;">
                {{# if(d.search==null || d.search=="true"){ }}
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="search" id="search" type="button">
                    <i class="layui-icon layui-icon-search"></i>查询
                </button>
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="reset" id="reset" type="button"><i
                        class="layui-icon  layui-icon-reset"></i>重置
                </button>
                {{# } }}
            </div>
        </div>
    </div>
    <div class="layui-fluid-table">
        <div class="layui-row layui-form">
            <div class="layui-btn-container">
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="distributing" type="button"><i
                        class="layui-icon layui-icon-edit"></i>任务派发
                </button>
            </div>
        </div>
        <table class="layui-hide" id="stationOrderTab" lay-filter="stationOrderTabF"></table>
    </div>
</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>

<script type="text/javascript">
    var element = layui.element;
    var layer = layui.layer;
    var table = layui.table;
    var form = layui.form;
    var laydate = layui.laydate;
    var oldData;
    var contextPath = config.omsConfig.contextPath;
    var active = {
        distributing : function(othis) {
            var checkStatus = table.checkStatus('stationOrderTabId');
            oldData = checkStatus.data;
            var idarrys = new Array();
            if(oldData.length <=0) {
                layer.alert('请选择需要派发的订单！', {
                    icon: 2
                });
                return;
            }
            for(var i=0;i<oldData.length;i++){
                idarrys.push(oldData[i].id);
            }
            var type = othis.data('type');
            layer.confirm('已选中'+oldData.length+'条数据，确认派发?', {icon: 3, title:'提示'}, function(index){
                var option ={
                    url:contextPath+'stationOrder/taskStationOrder',
                    type:'POST',
                    contentType: "application/json",
                    dataType:'json',
                    data:JSON.stringify(idarrys),
                    success:function(data){
                        if(data.code==0){
                            layer.alert("任务下发成功,可以拣料了");
                        }else{
                            layer.alert("任务已下发失败");
                        }
                        table.reload('stationOrderTabId');
                    },error:function(data){
                        layer.alert(data.msg);
                    }
                }
                $.ajax(option);
                layer.close(index);
            });
        },
        search : function(othis) {
            //仓库
            var storageLocation = layui.formSelects.value('storageLocationSelect', 'valueStr');
            //车间 单选
            var workshopCode = layui.formSelects.value('workshopCode_search', 'valueStr');
            //产线
            var lineCode = layui.formSelects.value('lineCode_search', 'valueStr');
            //工位
            var stationCode = layui.formSelects.value('stationCode_search', 'valueStr');
            //时间
            var requiredTime = $('#requiredTime_search').val();
            //业务类型
            var busiType = $('#busiType_search').val();
            var params = {};
            params.workshopCode = workshopCode;
            params.storageLocation = storageLocation;
            params.stationCode = stationCode;
            params.lineCode = lineCode;
            params.requiredTimeStr = requiredTime;
            params.busiTypeCodes =busiType;
            //状态等于待派发
            params.status = 0;
            //执行重载
            table.reload('stationOrderTabId', {
                where : params,
                url : contextPath + 'stationOrder/findAllOrders'
            });
        },
        reset : function(othis) {
            $('#requiredTime_search').val("");
            $('#workshopCode_search').val("");
            layui.formSelects.value('storageLocationSelect', []);
            $('#stationCode_search').val("");
            $('#lineCode_search').val("");
            $('#busiType_search').val("");
            form.render("select");
        }
    };
    function loadding() {
        table.render({
            elem : '#stationOrderTab',
            id : 'stationOrderTabId',
            data:[],
            cols : [ [ {
                type : 'checkbox'
            },{
                field : 'orderCode',
                title : '生产订单号'
            }, {
                field : 'requiredDate',
                title : '生产日期'
            }, {
                field : 'customDesc',
                title : '客户描述'
            }, {
                field : 'lineCode',
                title : '车号'
            }] ],
            even : true,
            done : function(res, page, count) {//列表数据回调函数
                //initWarehouseSignSelect("warehouse_search", 1);
                form.render(null, "storageLocationSearchForm");
            }
        });
        $('.layui-btn-container button').on('click', function() {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });
        //时间选择器
        laydate.render({
            elem : '#requiredTime_search',
            type : 'date',
            range : true
        });
        inintPlantMultiSelect("workshopCode_search", [], 2);
        initWarehouseMultiSelect("storageLocation_search","storageLocationSelect",0,'');
        //加载库存状态和库存类型
        var dictTypes = ["busi_type"]
        var selectItems = ["busiType_search"]
        var defaultValues = [""]
        dictItemValue = queryDictItems(dictTypes,selectItems,defaultValues);
    }
    // //监听启用操作
    // form.on('switch(statusValue)', function(obj) {
    //     var status = '0';
    //     if (obj.elem.checked) {
    //         status == '1';
    //     }
    //     updateStatus(this.value, status);
    // });
</script>