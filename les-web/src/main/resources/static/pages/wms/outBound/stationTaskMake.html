<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Content-Type" content="charset=UTF-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
<title>工位制任务下达</title>
</head>
<body>
<div id="bodyDiv">

</div>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js"></script>
<script src="/iles/pages/js/common/warehouseSelect.js"></script>
<script type="text/html" id="bodyTpl">
<div class="layui-fluid">
	<div class="layui-row layui-form">
			 <div class="layui-col-md3">
                 <label class="layui-form-label">仓库:</label>
                 <div class="layui-input-block">
					<select id="warehouseCode" xm-select="select1" xm-select-show-count="1">
						<option value="">请选择</option>
					</select>
                </div>
     		</div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label">订单号:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="orderNum_search" class="layui-input">
			    </div>
			 </div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label">产品线:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="productLine_search" class="layui-input">
			    </div>
			 </div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label">工序物料号:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="processNum_search" class="layui-input">
			    </div>
			 </div>


		</div>
		<div class="layui-row layui-form" style="margin-bottom: 0">

			<div class="layui-col-md3">
			 	<label class="layui-form-label">需求日期:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="requiredTime_search" class="layui-input" placeholder="yyyy-MM-dd">
			    </div>
			 </div>
			 <div class="layui-col-md2">
				<label class="layui-form-label">工序物料描述</label>
				 <div class="layui-input-block">
			      <input type="text" id="processDesc_search" class="layui-input">
			    </div>
			</div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label">物料编码:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="materialCode_search" class="layui-input">
			    </div>
			 </div>
		</div>
		<div class="layui-row layui-form">
				<div class="layui-btn-container">
					{{# if(d.search==null || d.search=="true"){ }}
						<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
						<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
					{{# } }}
					{{# if(d.pull==null || d.pull=="true"){ }}
						<button class="layui-btn layui-btn-normal layui-btn-sm" id="pullOrder" onclick="pullOrder()" type="button">拉取生产订单</button>
					{{# } }}
					{{# if(d.match==null || d.match=="true"){ }}
					<button class="layui-btn layui-btn-normal layui-btn-sm"  onclick="splitStroage(0);" type="button" id="matchButton">匹配订单</button>
					{{# } }}
					{{# if(d.active==null || d.active=="true"){ }}
						<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="toActive" type="button">派工</button>
					{{# } }}
				</div>
		</div>
</div>
<table class="layui-hide" id="activeTab" lay-filter="activeTabF"></table>
</script>
<script type="text/html" id="toolbar">
	<a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
</script>
<script type="text/javascript">
	var element = layui.element;
	var layer = layui.layer;
	var table = layui.table;
	var form = layui.form;
	var dictItems = null;//存储数据字典
	var contextPath = config.wmsConfig.contextPath;
	var assembleId="";
	var deliveryCode="";
	var orderCode="";
	var storageLocation="";
	var active={
			search:function(othis){
				var orderNum_search = $("#orderNum_search").val();
				var productLine_search = $("#productLine_search").val();
				var processNum_search = $("#processNum_search").val();
				var processDesc_search = $("#processDesc_search").val();
				var requiredTime_search = $("#requiredTime_search").val();
				var materialCode_search = $("#materialCode_search").val();
				var storageLocation = layui.formSelects.value('select1', 'storagelocationStr');
				var startTime="";
				var endTime="";
				if(requiredTime_search && requiredTime_search.length>0){
					startTime = requiredTime_search.substring(0,20);
					endTime = requiredTime_search.substring(22);
				}
				table.reload('activeTabId',{
					where:{
						orderCode:orderNum_search,
						productLine:productLine_search,
						processMaterialCode:processNum_search,
						processMaterialDesc:processDesc_search,
						startTime:startTime,
				        endTime:endTime,
				        requiredType:"0",
				        storageLocation:storageLocation,
				        materialCode:materialCode_search,
				        sortColums:'required_date,required_time,sub_factory,product_line,station_code desc'
					}
					,page:{"curr":1}
				}

				);
			},
			reset:function(othis){
				$("#orderNum_search").val("");
				$("#productLine_search").val("");
				$("#processNum_search").val("");
				$("#processDesc_search").val("");
				$("#requiredTime_search").val("");
				$("#materialCode_search").val("");
				layui.formSelects.value('select1', []);
			},
			toActive:function(othis){
				if(table.cache.activeTabId.length==0){
					layer.msg("处理失败！无集配订单");
					return false;
				}
				layer.open({
			        type: 2
			        ,title:'指定派工波次'
			        ,maxmin:false
			        ,area: ['100%', '100%']
			        ,id: 'appointActive' //防止重复弹出
			        ,content: 'apointActiveTotal.html'
			        ,shade: 0 //不显示遮罩
			        ,yes: function(){
			          layer.closeAll();
			        }
		     	 });
			}
	};
	function loadding(){
		layui.use('laydate', function(){
			var laydate = layui.laydate;
			//时间选择器
			  laydate.render({
			    elem: '#requiredTime_search'
			    ,type: 'datetime'
			    ,range: true
			  });
		});
		table.render({
			elem:"#activeTab",
			id:"activeTabId",
			url:contextPath+'assembleOrder/queryAssemble',
			cols:[[
				//{type:'checkbox'}
				 {width: 100, align:'center', toolbar: '#toolbar',title:'操作'}
				,{type:'numbers',title:'序号',width: 60}
				,{field:'warehouseCode', title: '仓库编码' , width:100}
				,{field:'warehouseName', title: '仓库名称' , width:100}
				,{field:'waveNum',  width:70, title: '波次', event: 'setSign', style:'cursor: pointer;'}
				,{field:'assembleOrderCode',   width:120,title: '集配订单号', event: 'setSign', style:'cursor: pointer;'}
				,{field:'enableRowsCount',   width:90,title: '可配送行', event: 'setSign', style:'cursor: pointer;'}
				,{field:'productLine',  width:100, title: '产品线', event: 'setSign', style:'cursor: pointer;'}
				,{field:'carType',  width:120, title: '车型车种', event: 'setSign', style:'cursor: pointer;'}
				,{field:'carCode',width:120,  title: '车号代码', event: 'setSign', style:'cursor: pointer;'}
				,{field:'wbsCode',width:120,  title: 'WBS元素号', event: 'setSign', style:'cursor: pointer;'}
				,{field:'processOrderCode',   width:120,title: '工序订单号', event: 'setSign', style:'cursor: pointer;'}
				,{field:'processMaterialCode',  width:120, title: '工序物料编号', event: 'setSign', style:'cursor: pointer;'}
				,{field:'processMaterialDesc',  width:120,title: '工序物料描述', event: 'setSign', style:'cursor: pointer;'}
				,{field:'subFactory', width:70, title: '分厂', event: 'setSign', style:'cursor: pointer;'}
				,{field:'pipeLineCode', width:70, title: '产线', event: 'setSign', style:'cursor: pointer;'}
				,{field:'stationCode',   width:70,title: '工位', event: 'setSign', style:'cursor: pointer;'}
				,{field:'requiredDate',  width:120, title: '需求日期', event: 'setSign', style:'cursor: pointer;'}
				,{field:'requiredTime',  width:100, title: '需求时间', event: 'setSign', style:'cursor: pointer;'}
				,{field:'stationOrderCode',  width:120, title: '工位订单号', event: 'setSign', style:'cursor: pointer;'}
				,{field:'stationMaterialCode',  width:120,title: '工位物料编号', event: 'setSign', style:'cursor: pointer;'}
				,{field:'stationMaterialDesc',  width:120, title: '工位物料描述', event: 'setSign', style:'cursor: pointer;'}
				,{field:'orderCode',   width:120,title: '订单号', event: 'setSign', style:'cursor: pointer;'}
				,{field:'orderMaterialCode',   width:120,title: '订单物料编号', event: 'setSign', style:'cursor: pointer;'}
				,{field:'orderMaterialDesc',  width:120, title: '订单物料描述', event: 'setSign', style:'cursor: pointer;'}
			     ]],
			    page: {theme: '#008155'},
			    where:{
			    	requiredType:"0",
			    	sortColums:'wave_num,assemble_order_code asc'
			    },
			   	height: 'full-150',
			   	even:true,
			   	done:function(res,page,count){//列表数据回调函数
	    		}
		});
		table.on('tool(activeTabF)', function(obj){
			var data = obj.data;//当前行数据
			deliveryCode = data.deliveryCode;
			orderCode = data.orderCode;
			storageLocation = data.storageLocation;
			assembleId = data.id;
			layer.open({
		        type: 2
		        ,title:'集配单详细列表'
		        ,maxmin:false
		        ,area: ['100%', '100%']
		        ,id: 'orderDetail' //防止重复弹出
		        ,content: 'assembleOrderDetail.html'
		        ,shade: 0 //不显示遮罩
		        ,yes: function(){
		          layer.closeAll();
		        }
	     	 });
		});
		$('.layui-btn-container button').on('click', function(){
		    var othis = $(this), method = othis.data('method');
		    active[method] ? active[method].call(this, othis) : '';
	  	});
		initWarehouseMultiSelect("warehouseCode","select1","0",null);
	}
	function defulatSelect(dictItems){
		if(dictItems && dictItems.length>0){
			if($("#orderStatus_search").find("option").length==1){
			  for(var i=0;i<dictItems.length;i++){
				   if(dictItems[i].dictTypeId=="order_status"){
					  $("#orderStatus_search").append("<option value="+dictItems[i].itemValue+">"+dictItems[i].itemName+"</option>");
				  }
			  }
			  form.render('select');
		  }
		}
	}
</script>
<script src="splitOrder.js"></script>
</body>
</html>
