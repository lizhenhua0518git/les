<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>指定派工统计</title>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
</head>
<body>
<div id="bodyDiv">

</div>
</body>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js"></script>
<script type="text/html" id="bodyTpl">
<div id="inputDiv">

</div>
<div id="content" style="display:none">
<div class="layui-fluid">
	
	<div class="layui-row layui-form">
			 <div class="layui-col-md2">
			 	<label class="layui-form-label" style="width:88px;">订单数量统计:</label>
			 	 <div class="layui-input-block">
			      <span id="orderCount" style="position:relative;top:10px;">0</span>
			    </div>
			 </div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label" style="width:88px;">物料笔数统计:</label>
			 	 <div class="layui-input-block">
			      <span id="materialCount" style="position:relative;top:10px;">0</span>
			    </div>
			 </div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label" style="width:130px;">正常区载具数量统计:</label>
			 	 <div class="layui-input-block">
			      <span id="carrierCountZ" style="position:relative;top:10px;">0</span>
			    </div>
			 </div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label" style="width:130px;">异常载具数量统计:</label>
			 	 <div class="layui-input-block">
			      <span id="carrierCountY" style="position:relative;top:10px;">0</span>
			    </div>
			 </div>
			 <div class="layui-col-md2">
				<label class="layui-form-label" style="width:102px;">节拍化空闲区域:</label>
			 	 <div class="layui-input-block">
			       <span id="areaCount" style="position:relative;top:10px;"></span>
			    </div>
			</div>
			 <div class="layui-col-md2">
				<label class="layui-form-label" style="width:102px;">非节拍空闲区域:</label>
			 	 <div class="layui-input-block">
			       <span id="unBeatAreaCount" style="position:relative;top:10px;"></span>
			    </div>
			</div>
		</div>
		<div class="layui-row layui-form">
			<div class="layui-col-md6">&nbsp;</div>
			<div class="layui-col-md6"><button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="toActive" type="button" id="activeAssemble" style="float:right">派工</button></div>
		</div>
</div>
<table class="layui-hide" id="activeTotal" lay-filter="activeTotalF"></table>
</div>
</script>
<script type="text/html" id="noStorageType">
		<h1>派工失败！请维护以下物料主数据的存储类型或是否大部件信息</h1>
		<table class="layui-table">
			<colgroup>
				<col width="20">
				<col width="100">
				<col width="100">
				<col width="80">
				<col width="80">
				<col width="80">
				<col width="80">
			</colgroup>
			<thead>
				<tr>
					<th>序号</th>
					<th>物料编码</th>
					<th>物料主数据</th>
					<th>存储类型</th>
					<th>是否大部件</th>
				</tr>
			</thead>
		<tbody>
		{{# layui.each(d,function(index,item){	}}
			<tr>
				<td>{{ index+1 }}</td>
				<td>{{ item.materialCode }}</td>
				<td>{{ item.id!=null?item.id:"" }}</td>
				<td>{{ item.storageType!=null?item.storageType:"" }}</td>
				<td>{{ item.isLarge!=null?item.isLarge:"" }}</td>
			</tr>
		{{# }); }}
		</tbody>
</script>
<script type="text/javascript">
	var table = layui.table;
	var areaCountAll;
	var laytpl = layui.laytpl;
	var tableFilter = layui.tableFilter;
	var contextPath = config.wmsConfig.contextPath;
	var chooseData = null;
	function loadding(){
		var option = {
				url:contextPath+'assembleOrderDetail/queryNoStorage',
				type:'GET',
				success:function(res){
					if(res.code==0){
						var data = res.data;
						if(data.length>0){
							var getTpl = noStorageType.innerHTML
							,view = document.getElementById('inputDiv');
							laytpl(getTpl).render(data, function(html){
								  view.innerHTML = html;
							});
							$("#content").hide();
						}else{
							initActiveBefore();
							$("#content").show();
						}
					}else{
						layer.alert("查询失败");
					}
				}
		};
		$.ajax(option);
		
		
		table.on('row(activeTotalF)', function(obj){
			chooseData=obj.data;
		});
		table.on('checkbox(activeTotalF)',function(res,index){
			var orderCount = parseInt($("#orderCount").text());
			var materialCount = parseInt($("#materialCount").text());
			var carrierCountZ = parseInt($("#carrierCountZ").text());
			var carrierCountY = parseInt($("#carrierCountY").text());
			var areaCount = parseInt($("#areaCount").text());
			var unBeatAreaCount = parseInt($("#unBeatAreaCount").text());
			if(res.type=="all" && res.checked==true){
				checkAll();
			}else if(res.type=="all" && res.checked==false){
				$("#orderCount").text(0);
				$("#materialCount").text(0);
				$("#carrierCountZ").text(0);
				$("#carrierCountY").text(0);
				$("#areaCount").text(areaCountAll.areaCount);
				$("#unBeatAreaCount").text(areaCountAll.unBeatAreaCount);
			}else if(res.type=="one" && res.checked==false){
				$("#orderCount").text(orderCount-chooseData.orderCount);
				$("#materialCount").text(materialCount-chooseData.materialCount);
				$("#carrierCountZ").text(carrierCountZ-chooseData.carrierCountZ);
				$("#carrierCountY").text(carrierCountY-chooseData.carrierCountY);
				if(unBeatAreaCount<areaCountAll.unBeatAreaCount){
					if(unBeatAreaCount+chooseData.carrierCountZ>areaCountAll.unBeatAreaCount){
						$("#unBeatAreaCount").text(areaCountAll.unBeatAreaCount);
						$("#areaCount").text(areaCount+(unBeatAreaCount+chooseData.carrierCountZ-areaCountAll.unBeatAreaCount));
					}else{
						$("#unBeatAreaCount").text(unBeatAreaCount+chooseData.carrierCountZ);
						
					}
					return;
				}
				if(areaCount+chooseData.carrierCountZ>areaCountAll.areaCount){
					$("#areaCount").text(areaCountAll.areaCount);
					$("#unBeatAreaCount").text(unBeatAreaCount+(areaCount+chooseData.carrierCountZ-areaCountAll.areaCount));
				}else{
					$("#areaCount").text(areaCount+chooseData.carrierCountZ);
				}
				
			}else if(res.type=="one" && res.checked==true){
				$("#orderCount").text(orderCount+chooseData.orderCount);
				$("#materialCount").text(materialCount+chooseData.materialCount);
				$("#carrierCountZ").text(carrierCountZ+chooseData.carrierCountZ);
				$("#carrierCountY").text(carrierCountY+chooseData.carrierCountY);
				if(areaCount-chooseData.carrierCountZ>=0){
					$("#areaCount").text(areaCount-chooseData.carrierCountZ);
				}else{
					$("#areaCount").text(0);
					$("#unBeatAreaCount").text(unBeatAreaCount-(chooseData.carrierCountZ-areaCount));
				}
				
			}
		});
		
		$("#activeAssemble").click(function(){
			$("#activeAssemble").attr("class","layui-btn layui-btn-normal layui-btn-sm layui-btn-disabled");
			$("#activeAssemble").attr("disabled","disabled");
			var checkStatus = table.checkStatus('activeTotalId');
			oldData = checkStatus.data;
			
			if(oldData.length<=0){
				layer.alert('请选择要派工的波次！',{icon: 2});
				return ;
			}
			if(tableFilter.cacheData.length>0 && tableFilter.cacheData.length<oldData.length){
				oldData = tableFilter.cacheData;
			}
			var waveIdArray = new Array();
			for(var i=0;i<oldData.length;i++){
				waveIdArray.push(oldData[i].waveId)
			}
			var option = {
					  url:contextPath+'assembleOrder/appointActive',
					  data:{"waveCodes":waveIdArray},
					  dataType:'json',
					  type:'POST',
					  success:function(res){
						  if(res.code==0){
							  parent.layer.closeAll();
							  parent.table.reload('activeTabId');
						  }
					  },error:function(res){
						  layer.alert("波次派工失败！");
					  }
			  };
			  $.ajax(option);
		});
	}
	
	
	function initActiveBefore(){
		table.render({
			elem:'#activeTotal',
			id:'activeTotalId',
			url:contextPath+'assembleOrder/beatActiveTotal',
			cols:[[
				{type:'checkbox'},
				{field:'waveNum',title:'波次号',width:80},
				{field:'requiredDate',title:'需求日期',width:120},
				{field:'requiredTime',title:'需求时间',width:120},
				{field:'productLine',title:'产品线',width:80},
				{field:'subFactory',title:'分厂',width:80},
				{field:'piepeLineCode',title:'产线',width:80},
				{field:'stationCode',title:'工位',width:80},
				{field:'orderCount',title:'集配订单数',width:120},
				{field:'materialCount',title:'物料笔数',width:100},
				{field:'carrierCountZ',title:'正常区载具数',width:120},
				{field:'carrierCountY',title:'异常区载具数',width:120},
				{field:'isAllFloor',title:'是否全地堆料'},
			]],
			even:true,
			page:false
			,request: {//修改了分页参数，避免自动分页
				 pageName: 'pageNumber' //页码的参数名称，默认：page
	    		,limitName: 'pageSize' //每页数据量的参数名，默认：limit
	    	}
		});
		var tableFilterIns = tableFilter.render({
		    'elem' : '#activeTotal',//table的选择器
		    'mode' : 'local',//过滤模式
		    'id':'activeTotalId',
		    'filters' : [{field:'waveNum',name:'波次号',type:'checkbox'},
		                 {field:'requiredDate',name:'需求日期',type:'checkbox'},
		    			 {field:'requiredTime',name:'需求时间',type:'checkbox'},	
		    			 {field:'productLine',name:'产品线',type:'checkbox'},
		    			 {field:'subFactory',name:'分厂',type:'checkbox'},
		    			 {field:'piepeLineCode',name:'产线',type:'checkbox'},
		    			 {field:'stationCode',name:'工位',type:'checkbox'},
		    			],//过滤项配置
		    'done': function(filters){
		        //结果回调
		    	var tableData = table.cache.activeTotalId;
		    	layui.each(tableData, function(e, l){
		    		l.LAY_CHECKED = false;
		    	});
		    	$("#orderCount").text(0);
				$("#materialCount").text(0);
				$("#carrierCountZ").text(0);
				$("#carrierCountY").text(0);
				$("#areaCount").text(areaCountAll.areaCount);
				$("#unBeatAreaCount").text(areaCountAll.unBeatAreaCount);
		    }
		})
		var option = {
				url:config.basicInfoConfig.contextPath+'area/queryArea',
				type:'GET',
				success:function(res){
					if(res.code==0){
						areaCountAll = res.data;
						$("#areaCount").text(res.data.areaCount);
						$("#unBeatAreaCount").text(res.data.unBeatAreaCount);
					}
				}
		};
		$.ajax(option);
	}
	

	
	function checkAll(){
		var tableData = table.cache.activeTotalId;
		if(tableFilter.cacheData.length>0){
			tableData = tableFilter.cacheData;
		}
		var orderCount=0;
		var materialCount=0;
		var carrierCountZ=0;
		var carrierCountY=0;
		var areaCount=areaCountAll.areaCount;
		var unBeatAreaCount=areaCountAll.unBeatAreaCount;
		for(var i=0;i<tableData.length;i++){
			orderCount = orderCount+tableData[i].orderCount;
			materialCount = materialCount+tableData[i].materialCount;
			carrierCountZ = carrierCountZ+tableData[i].carrierCountZ;
			carrierCountY = carrierCountY+tableData[i].carrierCountY;
		}
		$("#orderCount").text(orderCount);
		$("#materialCount").text(materialCount);
		$("#carrierCountZ").text(carrierCountZ);
		$("#carrierCountY").text(carrierCountY);
		if(areaCount-carrierCountZ>=0){
			$("#areaCount").text(areaCount-carrierCountZ);
		}else{
			$("#areaCount").text(0);
			$("#unBeatAreaCount").text(unBeatAreaCount-(carrierCountZ-areaCount));
			
		}
	}
	
</script>
</html>