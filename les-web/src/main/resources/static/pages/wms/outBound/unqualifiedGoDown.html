<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<title>不合格品出库任务下达</title>
</head>
<body>
	<div id="bodyDiv">

</div>
	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/loginInspect.js"></script>
	<script type="text/html" id="bodyTpl">
		<div style="background-color: #F2F2F2;">
		<div class="layui-row layui-form" >
			<div class="layui-col-md12">
				<div class="layui-btn-container" style="text-align: right;margin-top:15px;">
					<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="todo">下达</button>
				</div>
			</div>
		 </div>
  		<div class="layui-row layui-col-space15" style="width:100%;height:50%;margin-top:24px">
		    <div>
		      <div class="layui-card">
		        <div class="layui-card-header">采购不合格品物料信息</div>
		        <div class="layui-card-body">
		        	<div class="layui-collapse">
					  	<div class="layui-colla-item">
						    <h2 class="layui-colla-title">检索信息</h2>
						    <div class="layui-colla-content">
						      	<div class="layui-fluid">
									<div class="layui-row layui-form">
										 <div class="layui-col-md3">
										 	<label class="layui-form-label">物料号:</label>
										 	 <div class="layui-input-block">
										      <input type="text" id="materialCode_search" class="layui-input">
										    </div>
										 </div>
										 <div class="layui-col-md3">
										 	<label class="layui-form-label">仓位号:</label>
										 	 <div class="layui-input-block">
										      <input type="text" id="positionCode_search" class="layui-input">
										    </div>
										 </div>
										 <div class="layui-col-md6">
											<div class="layui-btn-container" style="text-align: right;">
											  {{# if(d.search==null || d.search=="true"){ }}
													<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
													<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
												{{# } }}
											</div>
										</div>
									</div>
								</div>
						    </div>
					  	</div>
					  </div>
				     <table class="layui-hide" id="positionTab" lay-filter="positionTabF"></table>
		        </div>
		      </div>
		    </div>
		 </div>
		 <div class="layui-row layui-form" >
				<div class="layui-col-md5">
					<div class="layui-btn-container" style="text-align: right;margin-top:15px;">
						<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="up"><!-- <i class="layui-icon">&#xe642;</i> -->上移</button>
						<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="down" data-type="auto"><!-- <i class="layui-icon">&#xe61f;</i> -->下移</button>
					</div>
				</div>
		 </div>
		 <div class="layui-row layui-col-space15" style="width:100%;height:45%;margin-top:24px">
		    <div>
		      <div class="layui-card">
		        <div class="layui-card-header">下达列表</div>
		        <div class="layui-card-body">

				    <table class="layui-hide" id="downPositionTab" lay-filter="downPositionTabF"></table>
		        </div>
		      </div>
		    </div>
		 </div>
	</div>
	</script>
	<script type="text/javascript">
	var element = layui.element;
	var layer = layui.layer;
	var table = layui.table;
	var roleId = parent.roleId;
	var oldData = parent.oldData;
	var unqualifiedDetailId = "";
	if(oldData && oldData.ID){
		unqualifiedDetailId = oldData.ID
	}
	var contextPath = config.wmsConfig.contextPath;
	var tableIns;


	var active = {
			up:function(othis){
				var checkStatus = table.checkStatus('downPositionTabId');
  				var downPositionData = checkStatus.data;
				if(downPositionData.length<=0){
					layer.alert('请选择要上移的行！',{icon: 2});
  					return ;
				}
				var currTabeData =  table.cache.downPositionTabId;
				var tempMID,tempCurMID;
				var deleteIds = new Array();
				for(var i=0;i<downPositionData.length;i++){
					tempMID = downPositionData[i].materialStorageBinId;
					for(var j=0;j<currTabeData.length;j++){
						tempCurMID = currTabeData[i].materialStorageBinId;
						if(tempMID==tempCurMID){
							//currTabeData.remove(j);
							if(currTabeData[i].id!=null && currTabeData[i].id.length>0){
								if(currTabeData[i].status==1){
									deleteIds.push(currTabeData[i]);
								}
							}
							currTabeData.splice(j,1);

						}
					}
				}
				if(deleteIds.length>0){
					$.ajax({
						url:contextPath+'unqualifiedRemoved/deleteUnqualifiedDetails',
						type:'POST',
						data: JSON.stringify(deleteIds),
   			        	contentType:'application/json',
						success:function(res){
							if(res.code!=0){
								layer.alert("删除失败!")
							}
						},error:function(res){
							layer.alert("删除失败!")
						}
					});
				}
				table.reload('downPositionTabId', {
					url:'',
					data:currTabeData,
					 page: {
				          curr: 1 //重新从第 1 页开始
				        }
			     });
			}
			,down:function(othis){
				var checkStatus = table.checkStatus('positionTabId');
				debugger;
  				var positionData = checkStatus.data;
				if(positionData.length<=0){
					layer.alert('请选择要下移的行！',{icon: 2});
  					return ;
				}
				var currTabeData =  table.cache.downPositionTabId;
				s:for(var i=0;i<positionData.length;i++){
					for(var j=0;j<currTabeData.length;j++){
						if(currTabeData[j].materialStorageBinId==positionData[i].materialStorageBinId){
							continue s;
						}
					}
					positionData[i].storageBin = positionData[i].positionCode;
					positionData[i].count = 0;
					currTabeData.push(positionData[i]);
				}
				table.reload('downPositionTabId', {
					url:'',
					data:currTabeData,
					 page: {
				          curr: 1 //重新从第 1 页开始
				        }
			     });
			},search:function(othis){
				var materialCode = $('#materialCode_search');
				var positionCode = $('#positionCode_search');
			      //执行重载
			      table.reload('positionTabId', {
			        where:{
			        	materialCode: materialCode.val()
			           ,positionCode:positionCode.val()
			        }
			        ,page:{"curr":1}
			      });
			},reset:function(othis){
				$('#materialCode_search').val("");
				$('#positionCode_search').val("");
			},searchN:function(othis){
				var materialCode = $('#materialCode_search_n');
				var positionCode = $('#positionCode_search_n');
				var currTabeData =  table.cache.downPositionTabId;
				table.reload('downPositionTabId', {
					url:'',
			        where:{
			        	materialCode: materialCode.val()
			           ,positionCode:positionCode.val()
			        }
			        ,page:{"curr":1}
			      });
			},resetN:function(othis){
				$('#materialCode_search_n').val("");
				$('#positionCode_search_n').val("");

			},todo:function(othis){
				var currTabeData =  table.cache.downPositionTabId;
				var tempData = new Array();
				if(currTabeData && currTabeData.length>0){

					for(var i=0;i<currTabeData.length;i++){
						if(unqualifiedDetailId.length>0){
							currTabeData[i].unqualifiedId = unqualifiedDetailId;
						}
						if(currTabeData[i].count==0){
							layer.alert("下达失败!出库数量不能为0");
							return ;
						}
						if(currTabeData[i].count>currTabeData[i].totalStockCount){
							layer.alert("下达失败!出库数量不能大于可用库存");
							return ;
						}
					}
				}else{
					layer.alert("下达失败!无数据");
				}
				var option = {
						url:contextPath+'unqualifiedRemoved/saveUnqualifiedDetails',
						type:'post',
						data: JSON.stringify(currTabeData),
			        	contentType:'application/json',
			        	success:function(res){
			        		if(res.code==0){
			        			layer.msg("保存成功!");
			        			parent.layer.closeAll();
			        			parent.$(".layui-laypage-btn")[0].click()
			        		}else{
			        			layer.msg("保存失败!");
			        		}
			        	}
				};
				$.ajax(option);
			}
	};
	function loadding(){
		//仓库库存中采购不合格数据
		table.render({
			elem:'#positionTab',
			id:'positionTabId',
			url:contextPath+'unqualifiedRemoved/queryUnqualifiedPosition',
			cols:[[
			{type:'checkbox'},
			{field:'positionCode',title:'仓位号'},
			{field:'materialCode', title: '物料号'},
			{field:'factory', title: '工厂'},
			{field:'specialType',title: '特殊库存标记'},
			{field:'specialCode', title: '特殊库存编码'},
			{field:'batchNo',title: '批次号'},
			{field:'totalStockCount', title: '可用库存'},
			{field:'pickCount',title: '拣配库存'},
			{field:'inStockCount',title: '质检库存'}
			]],
			page: {theme: '#008155'},
			even:true
		});
		//采购不合格出库下达任务列表
		tableIns  =  table.render({
			elem:'#downPositionTab',
			id:'downPositionTabId',
			url:contextPath+'unqualifiedRemoved/queryUnqualifiedDetail',
			cols:[[
			{type:'checkbox'},
			{field:'storageBin', title: '仓位号'},
			{field:'count', title: '出库数量',edit:'text'},
			{field:'materialCode',title:'物料号'},
			{field:'factory', title: '工厂'},
			{field:'specialType',title: '特殊库存标记'},
			{field:'specialCode', title: '特殊库存编码'},
			{field:'batchNo',title: '批次号'}
			]],
			page: {theme: '#008155'},
			where:{
				unqualifiedDetailId:unqualifiedDetailId
			},
	   		even:true
		});

		table.on('edit(downPositionTabF)', function(obj){
		    var value = obj.value //得到修改后的值
		    ,data = obj.data //得到所在行所有键值
		    ,field = obj.field; //得到字段
		    var matcher =/^[0-9]+(.[0-9]{1,3})?$/;
			if(!matcher.test(value)){
				data.count=0;
				obj.update(data);
			}
		});
		$('.layui-btn-container button').on('click', function(){
		    var othis = $(this), method = othis.data('method');
		    active[method] ? active[method].call(this, othis) : '';
	  	});
		element.init();
	}
	</script>
</body>
</html>
