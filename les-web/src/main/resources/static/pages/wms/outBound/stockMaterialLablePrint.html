<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">


<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
<title>地堆物料标签打印</title>
</head>
<body>
<div id="bodyDiv">

</div>
<!--打印-->
<script src="/iles/pages/lib/jquery-qrcode-0.14.0/jquery.min.js"></script>
<script src="/iles/pages/lib/jquery-qrcode-0.14.0/jquery-qrcode-0.14.0.min.js"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/lib/jquery-barcode/jquery-migrate-1.2.1.min.js"></script>
<script src="/iles/pages/lib/jquery-barcode/jquery.jqprint-0.3.js"></script>
<script src="/iles/pages/lib/jquery-barcode/jquery-barcode.js"></script>
<script type="text/javascript">var jquery$ = $;</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/lay/modules/layer.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js"></script>
<script type="text/html" id="bodyTpl">
<div class="layui-fluid" style="padding-top: 20px;">
<div class="layui-fluid">
	<div class="layui-row layui-form">
			 <div class="layui-col-md2">
			 	<label class="layui-form-label">派工日期</label>
			    <div class="layui-input-block">
			        	<input type="text" class="layui-input" id="dateTime" >
			    </div>
			 </div>
			 <div class="layui-col-md2">
			 	  <label class="layui-form-label">派工时间</label>
			      <div class="layui-input-block layui-form">
			        	<select id="activeTime" xm-select="select1">
			        		<option value="">请选择</option>
			        	</select>
			      </div>
			 </div>
			 <div class="layui-col-md2">
			 	<label class="layui-form-label">波次号:</label>
				<div class="layui-input-block">
			        	<input type="text" class="layui-input" id="waveCode">
			    </div>
			 </div>
			 <div class="layui-col-md2">
				<label class="layui-form-label">集配单号:</label>
				<div class="layui-input-block">
			        	<input type="text" class="layui-input" id="orders" >
			    </div>
			</div>
		</div>
		<div class="layui-row layui-form" style="margin-bottom: 0;padding-top: 7px;">
			<div class="layui-col-md2">
				<label class="layui-form-label">物料编码:</label>
				 <div class="layui-input-block">
				    <input type="text" class="layui-input" id="materialCode" name="materialCode" >
				</div>
			</div>
			<div class="layui-col-md2">
				<label class="layui-form-label">工位:</label>
				 <div class="layui-input-block">
				    <input type="text" class="layui-input" id="stationcode" name="stationcode" >
				</div>
			</div>
			<div class="layui-col-md2">
			 <label class="layui-form-label">打印状态</label>
			      <div class="layui-input-block layui-form">
			        	<select id="printStatus" >
			        		<option value="">选择打印状态</option>
			        		<option value="1">已打印</option>
			        		<option value="0">未打印</option>
			        	</select>
			      </div>
			</div>
			<div class="layui-col-md2">
			 <label class="layui-form-label">下架状态</label>
			     <div class="layui-input-block layui-form">
			        	<select id="lowerStatus" >
			        		<option value="">选择下架状态</option>
			        		<option value="1">已下架</option>
			        		<option value="0">未下架</option>
			        	</select>
			      </div>
			</div>
		</div>
		<div class="layui-row layui-form" style="margin-bottom: 0;padding-top: 7px;">
			<div class="layui-col-md2">
					<label class="layui-form-label">订单号:</label>
					 <div class="layui-input-block">
					    <input type="text" class="layui-input" id="orderCode" name="orderCode" >
					</div>
			</div>
		</div>
		<div class="layui-row layui-form" >
				<div class="layui-btn-container">
					{{# if(d.search==null || d.search=="true"){ }}
						<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
						<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
					{{# } }}
					{{# if(d.print==null || d.print=="true"){ }}
						<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="print" type="button"><i class="mine-icon icon-print"></i>打印</button> 
					{{# } }}
				</div>
		</div>
		</div>
	</div>
	<table class="layui-hide" id="labelPrintTab" lay-filter="labelPrintTabF" ></table>
<!--打印内容-->
<div id="printDiv">
</div>
</script>
<script type="text/html" id="printContent">
	{{#  layui.each(d, function(index, item){ }}
	<div STYLE="page-break-before:always">
	<div style="position:relative;float:right;width:100%;margin-top:20px;">
		<span style="float:left;">地堆物料集配标签</span></br><div id="barcode_{{index}}"  align="right"></div>
	</div>
	<div>
		<div>
		{{#  layui.each(item.materialList, function(index1, item1){ }}
			{{# if(index1>0 && index1%6==0){ }}
				<div STYLE="page-break-before:always">
			{{# } }}
			<div class="layui-row">
    		  <div class="layui-col-md3">
     		    <div class="layui-card">
        			<div class="layui-card-body">
						<img id="image_{{index}}_{{index1}}" width="120px" height="120px" align="right">
          				集配订单号:{{item1.assembleOrderCode!=null?item1.assembleOrderCode:""}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						物料号:{{item1.materialcode!=null?item1.materialcode:""}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						订单号:{{item1.aufnr!=null?item1.aufnr:""}}<br>
						数量/单位:{{item1.enableCount!=null?item1.enableCount:0}}/{{item1.materialUnit!=null?item1.materialUnit:""}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						仓位号:{{item1.positionname!=null?item1.positionname:""}}<br>
						工序描述:{{item1.processMaterialDesc!=null?item1.processMaterialDesc:""}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          				波次号:{{item1.waveOldNum!=null?item1.waveOldNum:""}}<br>
						物料描述:{{item1.materialdesc!=null?item1.materialdesc:""}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						派工次数:{{item1.activeNum!=null?item1.activeNum:""}}<br>
						批次号:{{item1.batchNum!=null?item1.batchNum:""}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						车号:{{item1.carCode!=null?item1.carCode:""}}&nbsp;{{item1.activeTime}}<br>
          				<canvas id="canvas_{{index}}_{{index1}}" height="120px" width="120px" style="display: none"></canvas>
						</div>
      			</div>
    		  </div>
			</div>
			{{# if(index1>0 && index1%6==0){ }}
				</div>
			{{# } }}
 		{{#  }); }}
	   </div>
	</div>
	</div>
	</div>
	{{#  }); }}
</script>
<script type="text/javascript">
//全局定义一次, 加载formSelects
layui.config({
    base: '/iles/pages/layui/lay/modules/' //此处路径请自行处理, 可以使用绝对路径
}).extend({
    formSelects: 'formSelects-v4'
});
var table = layui.table;
var form = layui.form;
var layer = layui.layer;
var laytpl = layui.laytpl;
var laydate = layui.laydate;
var formSelects;
var contextPath = config.wmsConfig.contextPath;
var tableFilter = layui.tableFilter;
var myDate = new Date();
var dateString = myDate.toLocaleDateString();
if(myDate.getMonth()+1<10){
	dateString = dateString.replace("/","-0");
}else{
	dateString = dateString.replace("/","-");
}
if(myDate.getDate()<10){
	dateString = dateString.replace("/","-0");
}else{
	dateString = dateString.replace("/","-");
}
var startTime=dateString+" 00:00:00";
var endTime=dateString+" 23:59:59";
var tableFilterIns;
layui.use(['formSelects'],function(){
	formSelects = layui.formSelects;
});

var active = {
		search:function(othis){
			 
			 var dateTime = $("#dateTime").val();
		      var activeDate = dateTime;
			  var activeTime = $("#activeTime").val();
		      var waveCode = $("#waveCode").val();
		      var orders = $("#orders").val();
		      var materialCode = $("#materialCode").val();
		      var printStatus = $("#printStatus").val();
		      var stationcode = $("#stationcode").val();
		      var activeTimeArray = layui.formSelects.value('select1', 'val');
		      var lowerStatus = $("#lowerStatus").val();
		      var orderCode = $("#orderCode").val();
		      for(var i=0;i<activeTimeArray.length;i++){
		    	  activeTime = activeTime+activeTimeArray[i]+";"
		      }
		      //执行重载
		      table.reload('labelPrintTabId', {
		        where:{
		        	activeDate:activeDate
		        	,activeTime: activeTime
		        	,waveCode:waveCode
		        	,assembleOrderCode: orders
		        	,materialCode:materialCode
		        	,printStatus:printStatus
		        	,storageType:0
		        	,stationcode:stationcode
		        	,lowerStatus:lowerStatus
		        	,orderCode:orderCode
		        }
		      });
		      tableFilterIns = tableFilter.render({
		    	    'elem' : '#labelPrintTab',//table的选择器
		    	    'mode' : 'local',//过滤模式
		    	    'id':'labelPrintTabId',
		    	    'filters' : [{field:'ASSEMBLEORDERCODE',name:'集配订单号',type:'checkbox'}
		    	    			],//过滤项配置
		    	    'done': function(filters){
		    	        //结果回调
		    	    	var tableData = table.cache.activeTotalId;
		    	    	layui.each(tableData, function(e, l){
		    	    		l.LAY_CHECKED = false;
		    	    	});
		    	    }
		    	})
		},reset:function(othis){
			$('#dateTime').val("");
			$('#orders').val("");
			$("#activeTime").val("");
			$("#waveCode").val("");
			$("#materialCode").val("");
			$("#printStatus").val("");
			$("#stationcode").val("");
			$("#lowerStatus").val("");
			layui.formSelects.value('select1', []); 
			form.render("select");
		},print:function(othis){
			var list = table.checkStatus('labelPrintTabId');
			oldData = list.data;
			var length = oldData.length;
			if(length==0){
				layer.alert('请选择要打印的数据！',{icon: 2});
				return false;
			}
			if(tableFilter.cacheData.length>0 && tableFilter.cacheData.length<oldData.length){
				oldData = tableFilter.cacheData;
			}
			var id_list = new Array();
			for(var i=0;i<oldData.length;i++){
				id_list.push(oldData[i].id);
			}
			$("#div1").show();
			$.ajax({
			        url: contextPath+"outBoundPlanManger/listmaterialStockLabelData",
			        dataType:'json',
					type:'POST',
			        async: false,
				    contentType:'application/json',
			        data: JSON.stringify(id_list),
			        success: function (result) {
			            if (result.code == 0) {
			            	var data = result.data;
			            	if(!data && data.length==0){
			            		layer.msg("打印失败，无数据",{icon: 5,time:1000});
			            		return false
			            	}
			            	$("#printDiv").show();
			            	var getTpl = printContent.innerHTML
			            	,view = document.getElementById('printDiv');
			            	laytpl(getTpl).render(data, function(html){
			            	  view.innerHTML = html;
			            	});
			            	var text="";
			            	var materialList=null;
			            	var img,canvas,label,tempVoucher;
			            	for(var i=0;i<data.length;i++){
			            		materialList = data[i].materialList;
			            		for(var j=0;j<materialList.length;j++){
			            			label = materialList[j];
			            			text =label.materialcode+"\n"+  
			            			    "订单:"+label.orderCode+"\n"+
									    "描述:"+label.materialdesc+"\n"+
										"数量:"+label.enableCount+label.materialUnit+"\n"+
										"供应商:"+"\n"+
										"制造商:"+"\n"+
										"载具:"+(label.carrierCode==null?'T':label.carrierCode)+" "+(label.putLevel==null?'':label.putLevel)+"\n"+
										"序列:"+"\n"+
										"批次:"+(label.batchNum==null?'':label.batchNum)+"\n"+
										"工位:"+(label.subLineStationCode==null?'':label.subLineStationCode)+"\n"+
									label.did;
			            			jquery$("#canvas_"+i+"_"+j).qrcode({
					            		render : 'canvas',    //设置渲染方式，有table和canvas，使用canvas方式渲染性能相对来说比较好
					            		text : text, //扫描二维码后显示的内容,\n换行
					            		size : 120  
					            	}); 
			            			var img = document.getElementById("image_"+i+"_"+j); // get image element
				            		var canvas  = document.getElementById("canvas_"+i+"_"+j);  // get canvas element
				            		img.src = canvas.toDataURL();//"image/png"
				            		
			            		}
			            		
			            		tempVoucher = data[i].carrierCode;
			            		if(tempVoucher!=null && tempVoucher.length>6){
			            			tempVoucher=tempVoucher.substring(0,tempVoucher.length-6);
				            		jquery$('#barcode_'+i).empty().barcode(tempVoucher, "code128",{//code128为条形码样式
				        				output:'css',
				        				color: '#000000', 
				        				barWidth: 2,        //单条条码宽度
				        		        barHeight: 80,     //单体条码高度
				        				addQuietZone: false
				        			}); 
			            		}
			            		
			            	}
			                // 打印
			                jquery$("#printDiv").jqprint();
			                $("#printDiv").hide();
			            }else {layer.msg(result.msg,{icon: 5,time:1000})}
			        }
			    });
		}
	};
function loadding(){
	//日期范围
	laydate.render({
	elem: '#dateTime'
	,range: false
	,type: 'date'
	,done: function(value, date, endDate){
		  $.ajax({
	      url:contextPath+'outBoundPlanManger/queryActiveTime?queryDate='+value,
	      type:'GET',
	      success:function(res){
	    	  var order = res.data;
	    	  if(order && order.length>0){
	   		     var optionItem;
	    		 var optoinArray = new Array();
	    		 for(var i=0;i<order.length;i++){
	    			 optionItem = {"name": ""+order[i].activeTime, "value": ""+order[i].activeTime };
	    			 optoinArray.push(optionItem);
	    		 }
	    		 layui.formSelects.data('select1', 'local', {
	    			 arr:optoinArray
	    	     });   
	    	  }
	      }
	      
	  })
	  return false;
	} 
	});
	table.render({
		elem:"#labelPrintTab",
		id:"labelPrintTabId",
		url:contextPath+"outBoundPlanManger/listMaterialPrintData",
		cols:[[
		     {type:'checkbox'},
		     {type:'numbers',title:'序号',width: 60},
		     {field:'tab',title:'工位',width:200},
		     {field:'wavenum',title:'波次序号',width:200},
		     {field:'assembleordercode',title:'集配订单号',width:200},
		     {field:'materialcode',title:'物料号',width:200},
		     {field:'materialdesc',title:'物料描述',width:200}
		     ]],
		 height: '500',
		 width : '100%',
		 even:true,
		 where:{storageType:0,
			 	activeDate:dateString
		 }
	});
	tableFilterIns = tableFilter.render({
	    'elem' : '#labelPrintTab',//table的选择器
	    'mode' : 'local',//过滤模式
	    'id':'labelPrintTabId', 
	    'filters' : [{field:'assembleordercode',name:'集配订单号',type:'checkbox'}
	    			],//过滤项配置
	    'done': function(filters){
	        //结果回调
	    	var tableData = table.cache.activeTotalId;
	    	layui.each(tableData, function(e, l){
	    		l.LAY_CHECKED = false;
	    	});
	    }
	});
	$('.layui-btn-container button').on('click', function(){
	    var othis = $(this), method = othis.data('method');
	    active[method] ? active[method].call(this, othis) : '';
	});
	form.render('select');
}

function initwaveCode(){
	 $.ajax({
        url:contextPath+'outBoundPlanManger/queryActiveWave?storageType=0',
        dataType:'JSON',
        success:function(res){
      	  var order = res.data;
      	/*   $('#orders').html("");
  		  $('#orders').append('<option value="">请选择</option>'); */
  		  if(res.code==0){
  			if(order){
  			  for(var i=0;i<order.waveCode.length;i++){
				  $("#waveCode").append("<option value="+order.waveCode[i]+">"+order.waveCode[i]+"</option>");
  			  }
  			for(var i=0;i<order.assembleOrderCode.length;i++){
				  $("#orders").append("<option value="+order.assembleOrderCode[i]+">"+order.assembleOrderCode[i]+"</option>");
			  }
  			  form.render('select');
    	   }
  		  }
        }
        
    });
}
</script>
</body>
</html>