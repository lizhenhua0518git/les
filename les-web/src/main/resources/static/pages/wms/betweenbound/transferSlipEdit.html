<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>创建/修改调拨任务</title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
</head>
<body id="bodyDiv">

<script type="text/html" id="bodyTpl">
    <div class="layui-container" style="padding-top: 20px;">
        <form class="layui-form" action=""  style="text-align: center;" lay-filter="transferSlipForm">
            <div class="layui-inline">
                <div class="layui-form-item">
                    <div class="layui-col-md2">
                        <label class="layui-form-label">源仓库</label>
                        <div class="layui-input-inline">
                            <select  id="sourceEntrepot">
                                <option value="">请选择</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-col-md2">
                        <label class="layui-form-label">目的仓库</label>
                        <div class="layui-input-inline">
                            <select  id="goalEntrepot">
                                <option value="">请选择</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-col-md2">
                        <label class="layui-form-label">用途</label>
                        <div class="layui-input-block">
                            <input type="text" name="useWay" id="useWay"   autocomplete="off" class="layui-input" >
                        </div>
                    </div>
                    <div class="layui-col-md2">
                        <label class="layui-form-label">备注:</label>
                        <div class="layui-input-block">
                            <input type="text" name="remark" id="remark"   autocomplete="off" class="layui-input" >
<!--                            <input type="text" name="supplierName" id="supplierName"   lay-verify="supplierName" autocomplete="off" placeholder="请输入备注" readonly="readonly"  class="layui-input" onclick="chooseSupplier()">-->
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-btn-container" style="text-align: center;">
                    <button class="layui-btn layui-btn-normal layui-btn-sm" lay-submit="" lay-filter="areaSubit" id="serve" >提交</button>
                    <button class="layui-btn layui-btn-normal layui-btn-sm"  lay-submit=""  lay-filter="cancel" id="cancel">取消</button>
                </div>
            </div>
        </form>
    </div>
</script>
<script src="/iles//pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
<script type="text/javascript">
    var layer = layui.layer;
    var table = layui.table;
    var form = layui.form
    var dictItems = parent.dictItems;
    var oldData = parent.oldData;
    var orgName,orgId;
    var warehouseData = parent.warehouseData;
    var contextPath = config.wmsConfig.contextPath;
    function loadding(){

        form.verify({
            goalEntrepot: function(value){
                if(value.length < 1){
                    return '目的仓库不能为空';
                }
            }
            ,sourceEntrepot:function(value){
                if(value.length < 1){
                    return '源仓库不能为空';
                }
            }

        });
        //监听提交
        form.on('submit(areaSubit)', function(data){
            editDict(data);
            return false;
        });
        //监听取消
        form.on('submit(cancel)', function(){
            cancel();
            return false;
        });
        initWarehouseSignSelect("sourceEntrepot","sourceEntrepotSelect",1);
        initWarehouseSignSelect("goalEntrepot","goalEntrepotSelect",1);
        // initWarehouseMultiSelect("sourceEntrepot","sourceEntrepotSelect",1,null);
        // initWarehouseMultiSelect("goalEntrepot","goalEntrepotSelect",1,null);
        //表单付默认值
        if(oldData.length>0){
            var formData =  eval('('+JSON.stringify(oldData[0])+')');
            form.val("transferSlipForm",formData);
            let aa= formData.goalEntrepot;
            let bb= formData.sourceEntrepot;
            setTimeout(function(){
                var goalList = $("#goalEntrepot").find("option");
                goalList.each(function (index,item) {
                    if(goalList.eq(index).text() === aa){
                        $("#goalEntrepot").find("option").eq(index).attr("selected", "selected");
                    }
                })

                var sourceList = $("#sourceEntrepot").find("option");
                sourceList.each(function (index,item) {
                    if(sourceList.eq(index).text() === bb){
                        $("#sourceEntrepot").find("option").eq(index).attr("selected", "selected");
                    }
                })


                renderForm();
            },1000)

            // $("#goalEntrepot").find("option[text= '总装立库']").attr("selected", "selected");
            // $("#goalEntrepot").sel.val(formData.goalEntrepot);
            // $("#sourceEntrepot").val(formData.sourceEntrepot);
            renderForm();//表单重新渲染，要不然添加完显示不出来新的
        }
        queryDictItem('area_type','areaType','');
    };

    //重新渲染表单函数
    function renderForm() {
        layui.use('form', function() {
            var form = layui.form; //高版本建议把括号去掉，有的低版本，需要加()
            form.render();
        });
    }

    function editDict(data){
        //源工厂
        // let sourceEntrepot = layui.formSelects.value('sourceEntrepot', 'name');
        let sourceEntrepot = $('#sourceEntrepot').find("option:selected").text();
        let sourceEntrepotId = $('#sourceEntrepot').find("option:selected").val();
        // let sourceEntrepot = $('#sourceEntrepot').text();
        //目的工厂
        let goalEntrepot = $('#goalEntrepot').find("option:selected").text();
        let goalEntrepotId = $('#goalEntrepot').find("option:selected").val();
        // let goalEntrepot = layui.formSelects.value('goalEntrepotSelect', 'name');
        var formData =  eval('('+JSON.stringify(oldData[0])+')');
        if (sourceEntrepot=="请选择"){
            sourceEntrepot=null;
            layer.alert('源仓库不能为空');
            return '源仓库不能为空';
        }
        if (goalEntrepot=="请选择"){
            goalEntrepot=null;
            layer.alert('目的仓库不能为空');
            return '目的仓库不能为空';
        }
        if (sourceEntrepot==goalEntrepot){
            sourceEntrepot=null;
            goalEntrepot=null;
            layer.alert('源仓库,目的仓库不能为同一仓库');
            return '源仓库,目的仓库不能为同一仓库';
        }
        data.field.id=formData.id;
        data.field.goalEntrepot=goalEntrepot;
        data.field.sourceEntrepot=sourceEntrepot;
        data.field.goalEntrepotId=goalEntrepotId;
        data.field.sourceEntrepotId=sourceEntrepotId;
        var option = {
            url:contextPath+'transferSlip/updateTransferSlip',
            data:JSON.stringify(data.field),
            type:'POST',
            contentType:'application/json',
            success:function(data){
                if(data.code==0){
                    var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                    parent.layer.close(index);  // 关闭layer
                    parent.parentId = "";
                    parent.table.reload('areaTabId');
                    //重新加载父页面
                    parent.location.reload();
                }else{
                    layer.alert(data.data);
                }
            },error:function(data){
                layer.alert(data.msg);
            }
        }
        $.ajax(option);
    }

    /**
     *  功能描述：多选下拉仓库
     *  permission  1-权限控制 0-不控制
     * @param warehouseSelectId 下拉框ID
     * @param xmselectId  多选的xmselect参数ID
     * @param selectValues 多选中的值
     * @param permission  1-权限控制 0-不控制
     * @returns
     */
    function initWarehouseMultiSelect(warehouseSelectId,xmselectId,permission,selectValues){
        var params={limit:0,sortColums:"org_code asc",permission:permission};
        var contextPath = config.basicInfoConfig.contextPath
        var option = {
            url:contextPath + 'orgnization/listWarehouse',
            type:"post",
            contentType: "application/json",
            dataType:'json',
            data:JSON.stringify(params),
            success:function(result){
                if(result.code==0){
                    var WarehouseCodes=result.data;
                    // warehouseMultiSelect(WarehouseCodes,warehouseSelectId,xmselectId,selectValues);
                    initWarehouseSignSelect(warehouseSelectId,permission,selectValues);
                }
            }
        }
        $.ajax(option);
    }

    //取消按钮
    function cancel() {
        var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
        parent.layer.close(index);  // 关闭layer
        parent.parentId = "";
        parent.table.reload('areaTabId');
    }
    // var active = {
    //     //取消按钮
    //     cancel: function (othis) {
    //         var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
    //         console.log(index)
    //         parent.layer.close(index);  // 关闭layer
    //         parent.parentId = "";
    //         parent.table.reload('areaTabId');
    //     }
    // }
</script>
</body>
</html>