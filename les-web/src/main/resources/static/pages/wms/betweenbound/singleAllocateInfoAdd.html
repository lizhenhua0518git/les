<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="charset=UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css"
          type="text/css"/>
    <link rel="stylesheet" href="/iles/pages/css/layui_extend.css"
          type="text/css"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css"/>
    <title>调拨单详情添加</title>
</head>
<body id="bodyDiv">
<script type="text/html" id="bodyTpl">
    <div class="layui-fluid">
        <div class="layui-row layui-form">
            <div class="layui-col-md2">
                <label class="layui-form-label">物料号</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="materialCode" placeholder="请填写物料号">
                </div>
            </div>
            <div class="layui-btn-container nav-" style="text-align: right;">
                {{# if(d.search==null || d.search=="true"){ }}
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="search" id="search" type="button">
                    <i class="layui-icon layui-icon-search"></i>查询
                </button>
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="reset" id="reset" type="button"><i
                        class="layui-icon  layui-icon-reset"></i>重置
                </button>
                {{# } }}
            </div>
        </div>
    </div>
    <div class="layui-fluid-table">
        <div class="layui-row layui-form">
            <div class="layui-btn-container">
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="distributing" type="button"><i
                        class="layui-icon layui-icon-edit"></i>提交
                </button>
            </div>
        </div>
        <table class="layui-hide" id="stationOrderTab" lay-filter="stationOrderTabF"></table>
    </div>
</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>

<script type="text/javascript">
    var element = layui.element;
    var layer = layui.layer;
    var table = layui.table;
    var form = layui.form;
    var laydate = layui.laydate;
    var beforeData = parent.oldData;
    var oldData = {};
    var enableFlag = true;
    var contextPath = config.wmsConfig.contextPath;
    var paraMap = {};
    var index_open_add =parent.index_open_add;
    function isEmptyStr(obj) {
        return (typeof obj === 'undefined' || obj === null || obj === "");
    };
    var active = {
        //任务提交
        distributing: function (othis) {
            var id = beforeData.id;

            var params = new Array();
            let checkStatus = table.checkStatus('costCenterOrderTableId');
            oldData = checkStatus.data;
            if (oldData.length <= 0) {
                layer.alert('请选择调拨详情！', {
                    icon: 2
                });
                return;
            }

            for (let i = 0; i < oldData.length; i++) {
                console.log("oldData",oldData)
                var storageBinId = oldData[i].id;
                oldData[i].storageBinId = storageBinId;
                var pickNum = oldData[i].materialNum;
                //只要下架数量大于零的
                if (pickNum > 0&&oldData[i].materialNum<=oldData[i].enableCount) {
                    params.push(oldData[i])
                }else {
                    layer.alert('请填写物料数量！', {
                        icon: 2
                    });
                    return;
                }
                //检测下架数量是否小于等于可用库存量
                check_off_num(oldData[i]);
            }

            paraMap.singleAllocateMaterial = params;
            paraMap.id=id;
            console.log("beforeData",beforeData);
            console.log("id",id);
            console.log("paraMap",JSON.stringify(paraMap));
            layer.confirm('已选中' + params.length + '条数据，确认?', {icon: 3, title: '提示'}, function (index) {
                var option = {
                    url: contextPath + 'singleAllocate/addSingleAllocateMaterial',
                    type: 'POST',
                    contentType: "application/json",
                    dataType: 'json',
                    data: JSON.stringify(paraMap),
                    success: function (data) {
                        if (data.code == 0) {
                            layer.confirm("调拨单详情已添加", {icon: 3, title: '提示'}, function (index) {
                                layer.close(index);
                                parent.layer.close(index_open_add);
                                parent.table.reload('singleAllocateInfoId');
                            });
                        } else {
                            layer.confirm("调拨单详情添加失败", {icon: 3, title: '提示'}, function (index) {
                            });
                        }
                    }, error: function (data) {
                        layer.alert(data.msg);
                    }
                }
                $.ajax(option);


            });
        },
        search: function (othis) {
            //物料编码 materialCode
            var materialCode = $('#materialCode').val();
            var params = {};
            params.materialCode = materialCode;
            params.wareHouseCode = beforeData.outWarehouseCode;
            params.id = beforeData.id;
            //执行重载
            table.reload('costCenterOrderTableId', {
                where: params,
                url: contextPath + 'singleAllocate/listMaterialInfo'
            });

        },
        reset: function (othis) {
            $('#materialCode').val("");
            form.render("select");
        }
    };

    function loadding() {
        table.render({
            elem: '#stationOrderTab',
            id: 'costCenterOrderTableId',
            data: [],
            cols: [[{
                type: 'checkbox'
            }, {
                field: 'materialCode',
                title: '物料号'
            }, {
                field: 'materialDesc',
                title: '物料描述'
            }, {
                field: 'storageLocation',
                title: '库存地点'
            }, {
                field: 'positionCode',
                title: '仓位'
            }, {
                field: 'stockCount',
                title: '仓位总量'
            },{
                field: 'preUseCount',
                title: '仓位预占数量'
            },{
                field: 'enableCount',
                title: '仓位可用数量'
            }, {
                field: 'materialUnit',
                title: '单位'
            }, {
                field: 'batchNo',
                title: '批次号'
            },{
                field: 'supplierCode',
                title: '供应商编码'
                , hide:true
            },{
                field: 'supplierName',
                title: '供应商名称'
                , hide:true
            },{
                field: 'id',
                title: '仓位库存表主键'
                , hide:true
            },{
                field: 'stockStatus',
                title: '库存状态0非限制 1冻结)'
                , hide:true
            }, {
                field: 'materialNum',
                title: '物料数量',
                edit: 'text'
            }
            ]],
            page: {theme: '#008155'},
            height: 'full-95',
            even: true,
            done: function (res, page, count) {//列表数据回调函数
            }
        });

        //添加文本框点击事件
        table.on('edit(stationOrderTabF)', function (obj) {
            var pickNumCount = obj.value;
            var enableCount = obj.data.enableCount;
            if (pickNumCount > enableCount) {
                enableFlag = false;
                layer.alert("下架数量错误：下架数量大于可用库存数量");
                return;
            }
            enableFlag = true;
            console.log(enableFlag)
        });


        $('.layui-btn-container button').on('click', function () {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });
        //时间选择器
        laydate.render({
            elem: '#requiredTime_search',
            type: 'date',
            trigger: 'click',
            range: true
        });
    }

    function check_off_num(oneRow) {
        if (oneRow.materialNum>oneRow.enableCount){
            layer.alert('物料数量不可以超过该仓位的可用库存数量！', {
                icon: 2
            });
            return;
        }

    }
</script>
