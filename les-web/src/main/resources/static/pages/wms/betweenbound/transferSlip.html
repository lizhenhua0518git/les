<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="charset=UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
    <link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
    <link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
    <link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
    <link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
    <title>调拨单</title>
</head>
<body >
<div id="bodyDiv">

</div>
<script type="text/html" id="bodyTpl">
  	<div class="layui-fluid">
		<div class="layui-row layui-form" >
            <div class="layui-col-md2">
                <label class="layui-form-label">创建时间</label>
                <div class="layui-input-block">
                    <input type="text" id="createTime" class="layui-input">
                </div>
            </div>

            <div class="layui-col-md2">
                <label class="layui-form-label">调拨任务编号</label>
                <div class="layui-input-inline">
                    <input type="text" id="tasksId" class="layui-input" placeholder="调拨任务编号">
                </div>
            </div>

            <div class="layui-col-md2">
                <label class="layui-form-label">源仓库</label>
                <div class="layui-input-inline">
                    <select  id="sourceEntrepot">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">目的仓库</label>
                <div class="layui-input-inline">
                    <select  id="goalEntrepot">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
           <div class="layui-col-md2">
                <div class="layui-btn-container " style="text-align: right;">
                    {{# if(d.search==null || d.search=="true"){ }}
                    <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
                    <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" id="reset" type="button"><i class="layui-icon  layui-icon-reset"></i>重置</button>
                    {{# } }}
                </div>
            </div>
        </div>
        <div class="layui-fluid-table">
            <div class="layui-row layui-form">
                <div class="layui-btn-container">
                    <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="distributing" type="button"><i class="layui-icon layui-icon-add-circle"></i>新增</button>
                    {{# if(d.del==null || d.del=="true"){ }}
                    <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="editdistribute" type="button"><i class="layui-icon layui-icon-edit"></i>编辑</button>
                    <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="del" type="button"><i class="layui-icon layui-icon-delete"></i>删除</button>
                    {{# } }}
                    <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="distribute" type="button"><i class="layui-icon layui-icon-edit"></i>调拨任务下发</button>
                </div>
            </div>
        </div>
    <table class="layui-hide" id="transferSlip" lay-filter="transferSlipF"></table>
   </div>
</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
<script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
</script>
<script type="text/javascript">
    var element = layui.element;
    var layer = layui.layer;
    var table = layui.table;
    var form = layui.form;
    var laydate = layui.laydate;
    var oldData;
    var contextPath = config.wmsConfig.contextPath;
    var active = {
        // 创建调拨单
        distributing : function(othis) {
            var type = othis.data('type');
            layer.open({
                type : 2,
                title : '创建调拨任务',
                maxmin : false,
                area : [ '100%', '100%' ],
                offset : type,
                id : 'transferSlipAdd' + type //防止重复弹出
                ,
                content : 'transferSlipAdd.html',
                shade : 0 //不显示遮罩
                ,
                yes : function() {
                    layer.closeAll();
                }
            });
        },
        //编辑调拨单
        editdistribute : function(othis) {
            var checkStatus = table.checkStatus('transferSlipId');
            oldData = checkStatus.data;
            let idarrys = new Array();
            for (var i = 0; i < oldData.length; i++) {
                idarrys.push(oldData[i].id);
                if (oldData[i].status!='0'){
                    layer.alert('只能编辑未下发任务！', {icon: 2});
                    return;
                }
            }
            if(oldData.length<=0){
                layer.alert('请选择要编辑的行！',{icon: 2});
                return ;
            }else if(oldData.length >1){
                layer.alert('编辑不能超过多行！',{icon: 2});
                return ;
            }
            var type = othis.data('type');
            layer.open({
                type : 2,
                title : '编辑调拨单',
                maxmin : false,
                area : [ '100%', '100%' ],
                offset : type,
                id : 'transferSlipEdit' + type //防止重复弹出
                ,
                content : 'transferSlipEdit.html',
                shade : 0 //不显示遮罩
                ,
                yes : function() {
                    layer.closeAll();
                }
            });
        },
        distribute:function(othis){
            var checkStatus = table.checkStatus('transferSlipId');
            oldData = checkStatus.data;
            if (oldData.length <= 0) {
                layer.alert('请选择要下发的任务！', {icon: 2});
                return;
            }
            let idarrys = new Array();

            for (var i = 0; i < oldData.length; i++) {
                idarrys.push(oldData[i].id);
                if (oldData[i].status!='0'){
                    layer.alert('请选择未下发任务！', {icon: 2});
                    return;
                }
            }
            layer.confirm('确定下发任务', {icon: 3, title: '提示'}, function (index) {
                // do something
                var option = {
                    url: contextPath + 'transferSlip/updateStatus',
                    type: 'POST',
                    contentType: "application/json",
                    dataType: 'json',
                    data: JSON.stringify(idarrys),
                    success: function (data) {
                        if (data.code == 0) {
                            layer.alert("下发成功");
                            table.reload('transferSlipId');
                        }else if(data.code == -1) {
                            layer.alert("下发失败,请添加详细信息");
                            table.reload('transferSlipId');
                        }
                    }, error: function (data) {
                        layer.alert(data.msg);
                    }
                }
                $.ajax(option);
                layer.close(index);
            });
        },
        search : function(othis) {
            //创建时间
            let createTime = $('#createTime').val();
            var createStartTime='';
            var createEndTime='';
            if(createTime.length>0){
                createStartTime = createTime.substring(0,10);
                createEndTime = createTime.substring(13);
            }
            //源工厂
            // let sourceEntrepot = layui.formSelects.value('sourceEntrepot', 'name');
            let sourceEntrepot = $('#sourceEntrepot').find("option:selected").text();
            // let sourceEntrepot = $('#sourceEntrepot').text();
            //目的工厂
            let goalEntrepot = $('#goalEntrepot').find("option:selected").text();
            // let goalEntrepot = layui.formSelects.value('goalEntrepotSelect', 'name');
            //物料号
            let tasksId = $('#tasksId').val();
            if (sourceEntrepot=="请选择"){
                sourceEntrepot=null;
            }
            if (goalEntrepot=="请选择"){
                goalEntrepot=null;
            }
            //仓库
            // let storageLocation = layui.formSelects.value('storageLocationSelect', 'valueStr');substring
            //执行重载
            table.reload('transferSlipId', {
                where :{
                    createStartTime:createStartTime,
                    createEndTime:createEndTime,
                    sourceEntrepot:sourceEntrepot,
                    goalEntrepot:goalEntrepot,
                    tasksId:tasksId
                }
                ,page:{"curr":1}
            });
        },
        reset : function(othis) {
            $('#createTime').val("");
            $('#sourceEntrepot').val("");
            $('#goalEntrepot').val("");
            $('#tasksId').val("");
            $('#materialCode_search').val("");
            form.render("select");
        }
        ,del:function(othis) {
            var checkStatus = table.checkStatus('transferSlipId');
            oldData = checkStatus.data;
            if (oldData.length <= 0) {
                layer.alert('请选择要删除的行！', {icon: 2});
                return;
            }
            var idarrys = new Array();
            for (var i = 0; i < oldData.length; i++) {
                if (oldData[i].status!='0'){
                    layer.alert('只能删除未下发的任务！', {icon: 2});
                    return;
                }
                idarrys.push(oldData[i].id);
            }
            layer.confirm('确定删除该条调拨单记录信息?', {icon: 3, title: '提示'}, function (index) {
                //do something
                var option = {
                    url: contextPath + 'transferSlip/delStationOrderInfo',
                    type: 'POST',
                    contentType: "application/json",
                    dataType: 'json',
                    data: JSON.stringify(idarrys),
                    success: function (data) {
                        if (data.code == 0) {
                            layer.alert("删除成功");
                            table.reload('transferSlipId');
                        }
                    }, error: function (data) {
                        layer.alert(data.msg);
                    }
                }
                $.ajax(option);
                layer.close(index);
            });
        }
    };

    function loadding() {
        table.render({
            elem : '#transferSlip',
            id : 'transferSlipId',
            url : contextPath + 'transferSlip/findTransferSlipList',
            cols : [ [ {
                type : 'checkbox'
            }, {
                type : 'numbers',
                title : '序号'
            },{
                field : 'id',
                title : '调拨任务编号'
                , hide:true
            },{
                field : 'tasksId',
                title : '调拨任务编号'
            }, {
                field : 'sourceEntrepot',
                title : '源仓库'
            }, {
                field : 'createName',
                title : '创建人'
            }, {
                field : 'createTime',
                title : '创建时间'
            }, {
                field : 'factory',
                title : '工厂'
            }, {
                field : 'goalEntrepot',
                title : '目的仓库'
            }, {
                field : 'status',
                title : '任务状态'
            }, {
                field : 'useWay',
                title : '用途'
            }, {
                field : 'remark',
                title : '备注'
            }, {
                align:'center',

                title : '详情',
                toolbar: '#toolbar'
            }

            ] ],
            page : {
                theme: '#008155'
            },
            even : true,
            done : function(res, page, count) {//列表数据回调函数
                $("[data-field='status']").children().each(function(){
                    if($(this).text()=='0'){
                        $(this).text("未下发")
                    }else if($(this).text()=='1'){
                        $(this).text("已下发")
                    }else if($(this).text()=='2'){
                        $(this).text("已完成")
                    }else if($(this).text()=='3'){
                        $(this).text("下架中")
                    }else if($(this).text()=='4'){
                        $(this).text("待交接")
                    }else if($(this).text()=='5'){
                        $(this).text("待上架")
                    }
                });
            }
        });
        $('.layui-btn-container button').on('click', function() {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });
        //时间选择器
        laydate.render({
            elem : '#createTime',
            type : 'date',
            trigger: 'click',
            range : true
        });
        initWarehouseSignSelect("sourceEntrepot","sourceEntrepotSelect",1);
        initWarehouseSignSelect("goalEntrepot","goalEntrepotSelect",1);
        //initWarehouseMultiSelect("sourceEntrepot","sourceEntrepotSelect",1,null);
        //initWarehouseMultiSelect("goalEntrepot","goalEntrepotSelect",1,null);

        //监听工具条
        table.on('tool(transferSlipF)', function(obj){
            userId = obj.data.id;
            var eventName = obj.event;
            var checkStatus = table.checkStatus('transferSlipId');
            oldData = obj.data;
            layer.open({
                type: 2
                ,title:'调拨单详情'
                ,maxmin:true
                ,area: ['100%', '100%']
                ,id: 'userRoleS' //防止重复弹出
                ,content: 'transferSlipInfo.html'
                ,shade: 0 //不显示遮罩
                ,yes: function(){
                    layer.closeAll();
                }
            });
        })
    }
    /**
     *  功能描述：单/多选下拉仓库
     *  permission  1-权限控制 0-不控制
     * @param warehouseSelectId 下拉框ID
     * @param xmselectId  多选的xmselect参数ID
     * @param selectValues 多选中的值
     * @param permission  1-权限控制 0-不控制
     * @returns
     */
    function initWarehouseMultiSelect(warehouseSelectId,xmselectId,permission,selectValues){
        var params={limit:0,sortColums:"org_code asc",permission:permission};
        var contextPath = config.basicInfoConfig.contextPath
        var option = {
            url:contextPath + 'orgnization/listWarehouse',
            type:"post",
            contentType: "application/json",
            dataType:'json',
            data:JSON.stringify(params),
            success:function(result){
                if(result.code==0){
                    var WarehouseCodes=result.data;
                    initWarehouseSignSelect(warehouseSelectId,permission,selectValues);
                }
            }
        }
        $.ajax(option);
    }

</script>
</body>
</html>
