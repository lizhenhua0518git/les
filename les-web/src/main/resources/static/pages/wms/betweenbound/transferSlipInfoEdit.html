<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="charset=UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css"
          type="text/css"/>
    <link rel="stylesheet" href="/iles/pages/css/layui_extend.css"
          type="text/css"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css"/>
    <title>调拨单详情编辑</title>
</head>
<body id="bodyDiv">
<script type="text/html" id="bodyTpl">
    <div class="layui-fluid">
    </div>
    <div class="layui-fluid-table">
        <div class="layui-row layui-form">
            <div class="layui-btn-container">
                <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="distributing" type="button"><i
                        class="layui-icon layui-icon-edit"></i>提交
                </button>
            </div>
        </div>
        <table class="layui-hide" id="stationOrderTab" lay-filter="stationOrderTabF"></table>
    </div>
</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>

<script type="text/javascript">
    var element = layui.element;
    var layer = layui.layer;
    var table = layui.table;
    var form = layui.form;
    var laydate = layui.laydate;
    var beforeData = parent.oldData;
    var oldData = {};
    var enableFlag = true;
    var contextPath = config.wmsConfig.contextPath;
    var paraMap = {};

    function isEmptyStr(obj) {
        return (typeof obj === 'undefined' || obj === null || obj === "");
    };
    var active = {
        //任务提交
        distributing: function (othis) {
            var taskId = beforeData;
            var params = new Array();
            let checkStatus = table.checkStatus('costCenterOrderTableId');
            oldData = checkStatus.data;
            if (oldData.length <= 0) {
                layer.alert('请选择调拨详情！', {
                    icon: 2
                });
                return;
            }

            for (let i = 0; i < oldData.length; i++) {
                var pickNum = oldData[i].outNumber;
                //只要下架数量大于零的
                if (pickNum > 0&&oldData[i].outNumber<oldData[i].enableCount) {
                    params.push(oldData[i])
                }else {
                    layer.alert('请填写下架数量！', {
                        icon: 2
                    });
                    return;
                }
            }
            paraMap.TransferSlipInfo = params;
            paraMap.taskId=taskId;
            paraMap.pid = beforeData[0].id;//调拨详情id(子表)
            paraMap.pickNum = beforeData[0].outNumber;
            console.log("JSON.stringify(paraMap):编辑页:",JSON.stringify(paraMap));
            layer.confirm('已选中' + params.length + '条数据，确认?', {icon: 3, title: '提示'}, function (index) {
                var option = {
                    url: contextPath + 'transferSlipInfo/updateTransferSlipInfo',
                    type: 'POST',
                    contentType: "application/json",
                    dataType: 'json',
                    data: JSON.stringify(paraMap),
                    success: function (data) {
                        if (data.code == 0) {
                            layer.confirm("调拨单详情已修改", {icon: 3, title: '提示'}, function (index) {
                                layer.close(index);
                            });
                        } else {
                            layer.confirm("调拨单详情修改失败", {icon: 3, title: '提示'}, function (index) {
                            });
                        }
                        table.reload('costCenterOrderTableId');
                        var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                        parent.layer.close(index);  // 关闭layer
                        parent.parentId = "";
                        parent.table.reload('costCenterOrderTableId');
                        //重新加载父页面
                        parent.location.reload();
                    }, error: function (data) {
                        layer.alert(data.msg);
                    }
                }
                $.ajax(option);
                layer.close(index);
            });
        },

        reset: function (othis) {
            $('#materialCode').val("");
            form.render("select");
        }
    };

    function loadding() {
        table.render({
            id:'costCenterOrderTableId',//可以在这里设置需要隐藏的列的字段名，如果是要隐藏多列的话这样写 id:'id,sex'
            elem: '#stationOrderTab',
            url : contextPath + 'costCenterOut/findMaterialStorageById',
            // data: [],
            cols: [[{
                type: 'checkbox'
            }, {
                field: 'materialCode',
                title: '物料号'
            }, {
                field: 'materialDesc',
                title: '物料描述'
            }, {
                field: 'storageLocation',
                title: '库存地点'
            }, {
                field: 'positionCode',
                title: '仓位'
            }, {
                field: 'stockCount',
                title: '仓位总量'
            },{
                field: 'preUseCount',
                title: '仓位预占数量'
            },{
                field: 'enableCount',
                title: '仓位可用数量'
            }, {
                field: 'materialUnit',
                title: '单位'
            }, {
                field: 'batchNo',
                title: '批次号'
            },{
                field: 'outNumber',
                title: '下架数量',templet(d){
                    return beforeData[0].outNumber;
                },
                edit: 'text'
            }
            ]],
            where : {
                id : beforeData[0].storageBinId,
            },
            page: {theme: '#008155'},
            height: 'full-95',
            even: true,
            done: function (res, page, count) {//列表数据回调函数
            }

        });
        // $('#outNumber').val(beforeData[0].outNumber);
        //添加文本框点击事件
        table.on('edit(stationOrderTabF)', function (obj) {
            var pickNumCount = obj.value;
            var enableCount = obj.data.enableCount;
            console.log("obj>>>",obj);
            if (pickNumCount > enableCount) {
                layer.alert("下架数量错误：下架数量大于可用库存数量");
                return;
            }
        });


        $('.layui-btn-container button').on('click', function () {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });
    }
</script>
