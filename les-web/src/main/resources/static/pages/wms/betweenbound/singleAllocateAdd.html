<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>创建调拨任务</title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
</head>
<body id="bodyDiv">

<script type="text/html" id="bodyTpl">
    <div class="layui-container" style="padding-top: 20px;">
        <form class="layui-form" action=""  style="text-align: center;" lay-filter="transferSlipForm">
            <div class="layui-inline">
                <div class="layui-form-item">
                    <div class="layui-col-md2">
                        <label class="layui-form-label">源仓库</label>
                        <div class="layui-input-inline">
                            <select  id="outWarehouseCode">
                                <option value="">请选择</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-col-md2">
                        <label class="layui-form-label">目的仓库</label>
                        <div class="layui-input-inline">
                            <select  id="inWarehouseCode">
                                <option value="">请选择</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="layui-col-md2">
                    <label class="layui-form-label">调拨类型</label>
                    <div class="layui-input-inline">
                        <select  id="allocationType">

                            <option value="0">非限制</option>

                        </select>
                    </div>
                </div>

                    <div class="layui-col-md2">
                        <label class="layui-form-label">备注</label>
                        <div class="layui-input-block">
                            <input type="text" name="remark" id="remark"   autocomplete="off" class="layui-input" >

                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-btn-container" style="text-align: center;">
                    <button class="layui-btn layui-btn-normal layui-btn-sm" lay-submit="" lay-filter="areaSubit" id="serve" >提交</button>
                    <button class="layui-btn layui-btn-normal layui-btn-sm"  lay-submit=""  lay-filter="cancel" id="cancel">取消</button>
                </div>
            </div>
        </form>
    </div>
</script>
<script src="/iles//pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
<script type="text/javascript">
    var layer = layui.layer;
    var table = layui.table;
    var form = layui.form
    var dictItems = parent.dictItems;
    var oldData = parent.oldData;
    var orgName,orgId;
    var warehouseData = parent.warehouseData;
    var contextPath = config.wmsConfig.contextPath;
    function loadding(){

        form.verify({
            inWarehouseCode: function(value){
                if(value.length < 1){
                    return '目的仓库不能为空';
                }
            }
            ,outWarehouseCode:function(value){
                if(value.length < 1){
                    return '源仓库不能为空';
                }
            }

        });
        //监听提交
        form.on('submit(areaSubit)', function(data){
            saveDict(data);
            return false;
        });
        //监听取消
        form.on('submit(cancel)', function(){
            cancel();
            return false;
        });

        initWarehouseSignSelect("outWarehouseCode","1",1);
        getWarehouseList();

    };

    function saveDict(data){
        //源工厂
        // let outWarehouseCode = layui.formSelects.value('outWarehouseCode', 'name');
        let outWarehouseName = $('#outWarehouseCode').find("option:selected").text();
        let outWarehouseCode = $('#outWarehouseCode').find("option:selected").val();
        // let outWarehouseCode = $('#outWarehouseCode').text();
        //目的工厂
        let inWarehouseName= $('#inWarehouseCode').find("option:selected").text();
        let inWarehouseCode = $('#inWarehouseCode').find("option:selected").val();
        // let inWarehouseCode = layui.formSelects.value('goalEntrepotSelect', 'name');
        if (outWarehouseCode=="请选择"){
            outWarehouseCode=null;
            return '源仓库不能为空';
        }
        if (inWarehouseCode=="请选择"){
            inWarehouseCode=null;
            return '目的仓库不能为空';
        }
        if (outWarehouseCode==inWarehouseCode){
            outWarehouseCode=null;
            inWarehouseCode=null;
            layer.alert('源仓库,目的仓库不能为同一仓库');
            return '源仓库,目的仓库不能为同一仓库';
        }

        let allocationType =$('#allocationType').find("option:selected").val();
        if(null ==allocationType || ""==allocationType){
            layer.alert('请选择调拨类型！');
            return false;

        }

        var remark =$('#remark').val();
        data.field.inWarehouseCode=inWarehouseCode;
        data.field.outWarehouseCode=outWarehouseCode;
        data.field.inWarehouseName=inWarehouseName;
        data.field.outWarehouseName=outWarehouseName;
        data.field.remark=remark;
        data.field.allocationType=allocationType;
        var option = {
            url:contextPath+'singleAllocate/addSingleAllocate',
            data:JSON.stringify(data.field),
            type:'POST',
            contentType:'application/json',
            success:function(data){
                if(data.code==0){
                    var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                    parent.layer.close(index);  // 关闭layer
                    parent.parentId = "";

                    //重新加载父页面
                    parent.location.reload();
                }else{
                    layer.alert(data.data);
                }
            },error:function(data){
                layer.alert(data.msg);
            }
        }
        $.ajax(option);
    }

    /**
     *  功能描述：多选下拉仓库
     *  permission  1-权限控制 0-不控制
     * @param warehouseSelectId 下拉框ID
     * @param xmselectId  多选的xmselect参数ID
     * @param selectValues 多选中的值
     * @param permission  1-权限控制 0-不控制
     * @returns
     */
    function initWarehouseMultiSelect(warehouseSelectId,xmselectId,permission,selectValues){
        var params={limit:0,sortColums:"org_code asc",permission:permission};
        var contextPath = config.basicInfoConfig.contextPath
        var option = {
            url:contextPath + 'orgnization/listWarehouse',
            type:"post",
            contentType: "application/json",
            dataType:'json',
            data:JSON.stringify(params),
            success:function(result){
                if(result.code==0){
                    var WarehouseCodes=result.data;
                    // warehouseMultiSelect(WarehouseCodes,warehouseSelectId,xmselectId,selectValues);
                    initWarehouseSignSelect(warehouseSelectId,permission,selectValues);
                }
            }
        }
        $.ajax(option);
    }

    //取消按钮
    function cancel() {
        var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
        parent.layer.close(index);  // 关闭layer
        parent.parentId = "";
        parent.table.reload('areaTabId');
    }
    function  getWarehouseList(){
        var option ={
            type: 'POST',
            async: false,
            url: config.basicInfoConfig.contextPath+"orgnization/listOrgnizaByType?orgType=2",
            dataType: "json",
            contentType : 'application/json',
            success: function(data){
                if(data.code==0){
                    var list =data.data;
                    var html = '<option value="">请选择</option>';

                    for(var i =0;i<list.length;i++){

                        html=html+ '<option value="'+list[i].orgCode+'">'+list[i].orgName+'</option>';

                    }
                    $("#inWarehouseCode").html(html)
                    form.render("select");
                }

            },error:function(data){
                layer.alert(data.msg);
            }
        }
        $.ajax(option);
    }
</script>
</body>
</html>