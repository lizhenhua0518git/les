<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="charset=UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
    <link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
    <link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />
    <link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
    <link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
    <title>调拨单</title>
</head>
<body >
<div id="bodyDiv">

</div>
<script type="text/html" id="bodyTpl">
  	<div class="layui-fluid">
		<div class="layui-row layui-form" >
            <div class="layui-col-md2">
                <label class="layui-form-label">创建时间</label>
                <div class="layui-input-block">
                    <input type="text" id="createTime" class="layui-input">
                </div>
            </div>

            <div class="layui-col-md2">
                <label class="layui-form-label">调拨单号</label>
                <div class="layui-input-inline">
                    <input type="text" id="allocationOrder" class="layui-input" placeholder="调拨单号">
                </div>
            </div>

            <div class="layui-col-md2">
                <label class="layui-form-label">源仓库</label>
                <div class="layui-input-inline">
                    <select  id="outWarehouseCode">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
            <div class="layui-col-md2">
                <label class="layui-form-label">目的仓库</label>
                <div class="layui-input-inline">
                    <select  id="inWarehouseCode">
                        <option value="">请选择</option>
                    </select>
                </div>
            </div>
           <div class="layui-col-md2">
                <div class="layui-btn-container " style="text-align: right;">
                    {{# if(d.search==null || d.search=="true"){ }}
                    <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
                    <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" id="reset" type="button"><i class="layui-icon  layui-icon-reset"></i>重置</button>
                    {{# } }}
                </div>
            </div>
        </div>
        <div class="layui-fluid-table">
            <div class="layui-row layui-form">
                <div class="layui-btn-container">
                    <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="distributing" type="button"><i class="layui-icon layui-icon-add-circle"></i>新增</button>
                    {{# if(d.del==null || d.del=="true"){ }}
                    <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="editdistribute" type="button"><i class="layui-icon layui-icon-edit"></i>编辑</button>
                    <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="del" type="button"><i class="layui-icon layui-icon-delete"></i>删除</button>
                    {{# } }}
                    <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="distribute" type="button"><i class="layui-icon layui-icon-edit"></i>调拨任务下发</button>
                </div>
            </div>
        </div>
    <table class="layui-hide" id="singleAllocate" lay-filter="transferSlipF"></table>
   </div>
</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
<script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
</script>
<script type="text/javascript">
    var element = layui.element;
    var layer = layui.layer;
    var table = layui.table;
    var form = layui.form;
    var laydate = layui.laydate;
    var oldData;
    var contextPath = config.wmsConfig.contextPath;
    var active = {
        // 创建调拨单
        distributing : function(othis) {
            var type = othis.data('type');
            layer.open({
                type : 2,
                title : '创建调拨任务',
                maxmin : false,
                area : [ '100%', '100%' ],
                offset : type,
                id : 'singleAllocateAdd' + type //防止重复弹出
                ,
                content : 'singleAllocateAdd.html',
                shade : 0 //不显示遮罩
                ,
                yes : function() {
                    layer.closeAll();
                }
            });
        },
        //编辑调拨单
        editdistribute : function(othis) {
            var checkStatus = table.checkStatus('singleAllocateId');
            oldData = checkStatus.data;
            let idarrys = new Array();
            for (var i = 0; i < oldData.length; i++) {
                idarrys.push(oldData[i].id);
                if (oldData[i].status!='0'){
                    layer.alert('只能编辑未下发任务！', {icon: 2});
                    return;
                }
            }
            if(oldData.length<=0){
                layer.alert('请选择要编辑的行！',{icon: 2});
                return ;
            }else if(oldData.length >1){
                layer.alert('编辑不能超过多行！',{icon: 2});
                return ;
            }
            var type = othis.data('type');
            layer.open({
                type : 2,
                title : '编辑调拨单',
                maxmin : false,
                area : [ '100%', '100%' ],
                offset : type,
                id : 'singleAllocateEdit' + type //防止重复弹出
                ,
                content : 'singleAllocateEdit.html',
                shade : 0 //不显示遮罩
                ,
                yes : function() {
                    layer.closeAll();
                }
            });
        },
        distribute:function(othis){
            var checkStatus = table.checkStatus('singleAllocateId');
            oldData = checkStatus.data;

            for (var i = 0; i < oldData.length; i++) {

                if (oldData[i].status!='0'){
                    layer.alert('只能派发未下发任务！', {icon: 2});
                    return;
                }
            }
            if(oldData.length<=0){
                layer.alert('请选择要派发的行！',{icon: 2});
                return ;
            }else if(oldData.length >1){
                layer.alert('派发不能超过多行！',{icon: 2});
                return ;
            }
            var paraMap = {};
            paraMap.id=oldData[0].id;
            layer.confirm('确定下发任务', {icon: 3, title: '提示'}, function (index) {
                // do something
                var option = {
                    url: contextPath + 'singleAllocate/sendTask',
                    type: 'POST',
                    data: paraMap,
                    success: function (data) {
                        if (data.code == 0) {
                            if(data.data==-2){
                                layer.alert("没有添加明细，不能下发任务");
                            }else{
                                layer.alert("下发成功");

                            }
                            table.reload('singleAllocateId');

                        }else if(data.code == -1) {
                            layer.alert("下发失败,请添加详细信息");
                            table.reload('singleAllocateId');
                        }
                    }, error: function (data) {
                        layer.alert(data.msg);
                    }
                }
                $.ajax(option);
                layer.close(index);
            });
        },
        search : function(othis) {
            //创建时间
            let createTime = $('#createTime').val();
            var createStartTime='';
            var createEndTime='';
            if(createTime.length>0){
                createStartTime = createTime.substring(0,10);
                createEndTime = createTime.substring(13);
            }
            var allocationOrder=$("#allocationOrder").val();
            //源仓库

            let outWarehouseCode = $('#outWarehouseCode').find("option:selected").text();

            //目的仓库
            let inWarehouseCode = $('#inWarehouseCode').find("option:selected").text();

            //调拨单号
            let sapAllocationOrder = $('#sapAllocationOrder').val();
            if (inWarehouseCode=="请选择"){
                inWarehouseCode=null;
            }
            if (outWarehouseCode=="请选择"){
                outWarehouseCode=null;
            }
            //仓库
            // let storageLocation = layui.formSelects.value('storageLocationSelect', 'valueStr');substring
            //执行重载
            table.reload('singleAllocateId', {
                where :{
                    createStartTime:createStartTime,
                    createEndTime:createEndTime,
                    inWarehouseCode:inWarehouseCode,
                    outWarehouseCode:outWarehouseCode,
                    allocationOrder:allocationOrder
                }
                ,page:{"curr":1}
            });
        },
        reset : function(othis) {
            $('#createTime').val("");
            $('#inWarehouseCode').val("");
            $('#outWarehouseCode').val("");

            $('#allocationOrder').val("");
            form.render("select");
        }
        ,del:function(othis) {
            var checkStatus = table.checkStatus('singleAllocateId');
            oldData = checkStatus.data;
            if (oldData.length <= 0) {
                layer.alert('请选择要删除的行！', {icon: 2});
                return;
            }
            var idarrys = new Array();
            for (var i = 0; i < oldData.length; i++) {
                if (oldData[i].status!='0'){
                    layer.alert('只能删除未下发的任务！', {icon: 2});
                    return;
                }
                idarrys.push(oldData[i].id);
            }
            layer.confirm('确定删除该条调拨单记录信息?', {icon: 3, title: '提示'}, function (index) {
                //do something
                var option = {
                    url: contextPath + 'singleAllocate/delStationOrderInfo',
                    type: 'POST',
                    contentType: "application/json",
                    dataType: 'json',
                    data: JSON.stringify(idarrys),
                    success: function (data) {
                        if (data.code == 0) {
                            layer.alert("删除成功");
                            table.reload('singleAllocateId');
                        }
                    }, error: function (data) {
                        layer.alert(data.msg);
                    }
                }
                $.ajax(option);
                layer.close(index);
            });
        }
    };

    function loadding() {
        table.render({
            elem : '#singleAllocate',
            id : 'singleAllocateId',
            url : contextPath + 'singleAllocate/singleAllocatePage',
            cols : [ [ {
                type : 'checkbox'
            }, {
                type : 'numbers',
                title : '序号'
            },{
                field : 'allocationOrder',
                title : '调拨单号'

            }, {
                field : 'allocationType',
                title : '调拨类型'
            } , {
                field : 'outWarehouseName',
                title : '源仓库'
            }, {
                field : 'inWarehouseName',
                title : '目的仓库'
            }, {
                field : 'createrName',
                title : '创建人'
            }, {
                field : 'createTime',
                title : '创建时间'
            }, {
                field : 'factory',
                title : '工厂'
            }, {
                field : 'status',
                title : '任务状态'
            } , {
                field : 'sourceSystem',
                title : '来源系统'
            }, {
                align:'center',

                title : '详情',
                toolbar: '#toolbar'
            }

            ] ],
            page : {
                theme: '#008155'
            },
            even : true,
            done : function(res, page, count) {//列表数据回调函数
                $("[data-field='status']").children().each(function(){
                    if($(this).text()=='0'){
                        $(this).text("未下发")
                    }else if($(this).text()=='5'){
                        $(this).text("已下发")
                    }else if($(this).text()=='8'){
                        $(this).text("下架中")
                    }else if($(this).text()=='10'){
                        $(this).text("已下架")
                    }else if($(this).text()=='15'){
                        $(this).text("已交接")
                    }
                });

                $("[data-field='allocationType']").children().each(function(){
                    if($(this).text()=='0'){
                        $(this).text("非限制")
                    }else if($(this).text()=='1'){
                        $(this).text("冻结")
                    }
                });
            }
        });
        $('.layui-btn-container button').on('click', function() {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });
        //时间选择器
        laydate.render({
            elem : '#createTime',
            type : 'date',
            trigger: 'click',
            range : true
        });
        //initWarehouseSignSelect("inWarehouseCode","inWarehouseCodeSelect",1);
        initWarehouseSignSelect("outWarehouseCode","outWarehouseCodeSelect",1);
         getWarehouseList();

        //监听工具条
        table.on('tool(transferSlipF)', function(obj){
            userId = obj.data.id;
            var eventName = obj.event;
            var checkStatus = table.checkStatus('singleAllocateId');
            oldData = obj.data;
            html = 'singleAllocateInfo.html';
            if(oldData.sourceSystem=='SAP' ||oldData.sourceSystem=='sap' ){
                html = 'singleAllocateSAPInfo.html';
            }
            layer.open({
                type: 2
                ,title:'调拨单详情'
                ,maxmin:true
                ,area: ['100%', '100%']
                ,id: 'userRoleS' //防止重复弹出
                ,content: html
                ,shade: 0 //不显示遮罩
                ,yes: function(){
                    layer.closeAll();
                }
            });
        })
    }
    /**
     *  功能描述：单/多选下拉仓库
     *  permission  1-权限控制 0-不控制
     * @param warehouseSelectId 下拉框ID
     * @param xmselectId  多选的xmselect参数ID
     * @param selectValues 多选中的值
     * @param permission  1-权限控制 0-不控制
     * @returns
     */
    function initWarehouseMultiSelect(warehouseSelectId,xmselectId,permission,selectValues){
        var params={limit:0,sortColums:"org_code asc",permission:permission};
        var contextPath = config.basicInfoConfig.contextPath
        var option = {
            url:contextPath + 'orgnization/listWarehouse',
            type:"post",
            contentType: "application/json",
            dataType:'json',
            data:JSON.stringify(params),
            success:function(result){
                if(result.code==0){
                    var WarehouseCodes=result.data;
                    initWarehouseSignSelect(warehouseSelectId,permission,selectValues);
                }
            }
        }
        $.ajax(option);
    }

    function  getWarehouseList(){
        var option ={
            type: 'POST',
            async: false,
            url: config.basicInfoConfig.contextPath+"orgnization/listOrgnizaByType?orgType=2",
            dataType: "json",
            contentType : 'application/json',
            success: function(data){
                if(data.code==0){
                    var list =data.data;
                    var html = '<option value="">请选择</option>';

                    for(var i =0;i<list.length;i++){

                        html=html+ '<option value="'+list[i].orgCode+'">'+list[i].orgName+'</option>';

                    }
                    $("#inWarehouseCode").html(html)
                    form.render("select");
                }

            },error:function(data){
                layer.alert(data.msg);
            }
        }
        $.ajax(option);
    }

</script>
</body>
</html>
