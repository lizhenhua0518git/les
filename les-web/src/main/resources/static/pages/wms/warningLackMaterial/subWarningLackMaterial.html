<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>工位齐套管理</title>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link href="/iles/pages/assets/css/bootstrap.css" rel="stylesheet" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">

</head>
<body>
 <div id="bodyDiv"></div>
	<div class="layui-fluid">
<div style="position:relative">
	<div id="title_div">
		<a href="/iles/pages/panelIndex.html" style="border:1px black solid; padding:5px 25px; color:black; line-height:60px">首页</a>
			<a href="#" onclick="toIndex('/iles/pages/mfc/panel/quehuo.html')"
			style="background: orange; border:1px black solid; padding: 5px 25px; color: #FFFFFF; line-height: 60px">工位看板</a>

	</div>
</div>

		<div class="layui-row layui-form" style="margin-bottom: 0">
			<div class="layui-col-md6">&nbsp;</div>
			<div class="layui-col-md6">
				<div class="layui-btn-container" style="text-align: right;">
				  <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="allCheck" type="button"><i class="mine-icon icon-check"></i>全部物料明细</button>
		<!-- 		  <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="check" type="button"><i class="mine-icon icon-check"></i>需求前到货明</button>
				  <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="lackCheck" type="button"><i class="mine-icon icon-check"></i>缺件明细</button>
	 -->			</div>
			</div>
		</div>
	</div>
	<table class="layui-hide" id="subWarningLackMaterialTab" lay-filter="subWarningLackMaterialTabF"></table>
   <script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
	<script src="/iles/pages/assets/js/jquery-1.10.2.js"></script>
	<script src="/iles/pages/js/loginInspect.js"></script>
	<script type="text/html" id="bodyTpl"></script>
     <script type="text/html" id="subfactoryTpl">
  {{#  if(d.branch ==='ZZ1' ){ }}
     {{ '预组装'}}
  {{#  } else { }}
   {{ '总组装'}}
  {{#  } }}
</script>


  <script type="text/html" id="processTpl">
   <label  class="btn btn-primary  "  onclick="showTabForArgs('{{d.requestTime}}','{{d.branch}}','{{d.station}}','{{d.carCode}}','{{d.process}}' );">
         {{d.process}}
   </label>

</script>



    <script type="text/javascript">
	var contextPath = config.wmsConfig.contextPath;
    var $ = layui.$;
    var element = layui.element;
    var layer = layui.layer;
    var table = layui.table;

    var form = layui.form;
    var requestTime =getQueryVariable("requestTime");
    var subfactory =getQueryVariable("subfactory");
    var station =getQueryVariable("station");
    var carCode =getQueryVariable("carCode");
    var process ='';


    var oldData;

    table.render({
        elem:'#subWarningLackMaterialTab',
        id:'subWarningLackMaterialTabId',
        url:contextPath+'warningLackMateria/listSubList',
        where:{'requestTime':requestTime,'subfactory':subfactory,'station':station,'carCode':carCode,'process':process},
        cols:[[
        {field:'id',type:'checkbox'},
        {field:'requestTime',width:'10%',title:'需求时间'},
        {field:'branch', width:'7%', title:'分厂'},
        {field:'station', width:'8%', title: '工位'},
        {field:'carCode', width:'10%', title: '车号'},
        {field:'process', width:'20%', title: '工序',templet: '#processTpl'},
        {field:'requireType', width:'12%', title: '需求'},
        {field:'lackType', width:'12%', title: '缺失'},
        {field:'project', width:'10%', title: '项目'},
        {field:'status',width:'8%',title:'状态显示',event: 'onclickStatus', style:'cursor: pointer;'}
        ]],
        height: 'full-95',
        page: {theme: '#008155'},
        limit:1000,
        limits:[1000],
        //page:false,
        done:function(res,page,count){//列表数据回调函数

        	merge(res);
        }
    });



    var active = {

            allCheck:function(othis){
              var checkStatus = table.checkStatus('subWarningLackMaterialTabId');
                  oldData = checkStatus.data;
              if(oldData.length<=0){
                  layer.alert('请选择要查看的行！',{icon: 2});
                      return ;
              }else if(oldData.length >1){
                      layer.alert('不能超过多行！',{icon: 2});
                      return ;
                  }

              var requestTime =oldData[0].requestTime;
              var endTime =oldData[0].requestTime;

              var url ="warningLackMaterialDetail.html?type=1&subfactory="+subfactory+"&station="+station+"&carCode="+"&process=&requestTime="+requestTime+"&endTime="+endTime;

              toIndex(url);
/*               showTab(1,url);
 */
            },
            check:function(othis){
                var checkStatus = table.checkStatus('subWarningLackMaterialTabId');
                    oldData = checkStatus.data;
                if(oldData.length<=0){
                    layer.alert('请选择要查看的行！',{icon: 2});
                        return ;
                }else if(oldData.length >1){
                        layer.alert('不能超过多行！',{icon: 2});
                        return ;
                    }

                var requestTime =oldData[0].requestTime;
                var station =oldData[0].station;
                var subfactory =oldData[0].branch;
                var carCode =oldData[0].carCode;
                var url ="warningLackMaterialDetail.html?type=2&subfactory="+subfactory+"&station="+station+"&carCode="+"&process=&requestTime="+requestTime;
                showTab(2,url);

              },
              lackCheck:function(othis){
                  var checkStatus = table.checkStatus('subWarningLackMaterialTabId');
                      oldData = checkStatus.data;
                  if(oldData.length<=0){
                      layer.alert('请选择要查看的行！',{icon: 2});
                          return ;
                  }else if(oldData.length >1){
                          layer.alert('不能超过多行！',{icon: 2});
                          return ;
                      }

                  var requestTime =oldData[0].requestTime;
                  var station =oldData[0].station;
                  var subfactory =oldData[0].branch;
                  var carCode =oldData[0].carCode;
                  var url ="warningLackMaterialDetail.html?type=3&subfactory="+subfactory+"&station="+station+"&carCode="+"&process=&requestTime="+requestTime;
                  showTab(3,url);

                }

    };
    $('.layui-btn-container button').on('click', function(){
        var othis = $(this), method = othis.data('method');
        active[method] ? active[method].call(this, othis) : '';
    });

    //获取父级页面的参数
	function getQueryVariable(variable)
	 {
	        var query = window.location.search.substring(1);
	        var vars = query.split("&");
	        for (var i=0;i<vars.length;i++) {
	                var pair = vars[i].split("=");
	                if(pair[0] == variable){
	                	return pair[1];
	                }
	        }
	        return(false);
	 }

	 function merge(res) {

		    var data = res.data;
		    var mergeIndex = 0;//定位需要添加合并属性的行数
		    var mark = 1; //这里涉及到简单的运算，mark是计算每次需要合并的格子数
		    var columsName = ['id','requestTime','subfactory','station','carCode'];//需要合并的列名称
		    var columsIndex = [0,1,2,3,4];//需要合并的列索引值

		    for (var k = 0; k < columsName.length; k++) { //这里循环所有要合并的列
		        var trArr = $(".layui-table-body>.layui-table").find("tr");//所有行
		            for (var i = 1; i < res.data.length; i++) { //这里循环表格当前的数据
		                var tdCurArr = trArr.eq(i).find("td").eq(columsIndex[k]);//获取当前行的当前列
		                var tdPreArr = trArr.eq(mergeIndex).find("td").eq(columsIndex[k]);//获取相同列的第一列
		               var t = k;
		                if(k==0){
		                	t=k+1;
		                }
		                if (data[i][columsName[t]] === data[i-1][columsName[t]]) { //后一行的值与前一行的值做比较，相同就需要合并
		                    mark += 1;
		                    tdPreArr.each(function () {//相同列的第一列增加rowspan属性
		                        $(this).attr("rowspan", mark);
		                    });
		                    tdCurArr.each(function () {//当前行隐藏
		                        $(this).css("display", "none");
		                    });
		                }else {
		                    mergeIndex = i;
		                    mark = 1;//一旦前后两行的值不一样了，那么需要合并的格子数mark就需要重新计算
		                }
		            }
		        mergeIndex = 0;
		        mark = 1;
	    }
	}

	 function showTab(type,url){
	   	 var title="";
	   	 var dataId="";

	   	if(type==1){

			 title ='全部物料明细';
			 dataId ="warningLackMaterialDetail_"+type;
		 }else if(type==2){
			 title ='需求前到货明细';
			 dataId ="warningLackMaterialDetail_"+type;
		 }else{
			 title ='缺件明细';
			 dataId ="warningLackMaterialDetail_"+type;
		 }

	   	 var isData = false;
	     var liObj =$("body", parent.document).find(".layui-tab-title li[lay-id]");
	     if(dataId && dataId.length>0){
	      $.each(liObj, function () {
	             if ($(this).attr("lay-id") == dataId) {
	                 isData = true;
	                 window.parent.active.tabDelete($(this).attr("lay-id"));

	             }
	         })
 	         window.parent.active.tabAdd(url,dataId,title);

	      window.parent.active.tabChange(dataId);
	     }
	    }


	 function showTabForArgs(requestTime,branch,station,carCode,process){
	   	 var title="";
	   	 var dataId="";
		 title ='全部物料明细';
		 dataId ="warningLackMaterialDetail_";



		 process=encodeURI(process);
         var url ="warningLackMaterialDetail.html?type=1&subfactory="+branch+"&station="+station+"&carCode="+carCode+"&process="+process+"&requestTime="+requestTime;

    	/*  window.open(url,title); */
    	 toIndex(url);

	    }





	 	function toIndex(url) {
			parent.location.href = url;
		}




	 function showTabForArgs_inner(requestTime,branch,station,carCode,process){
	   	 var title="";
	   	 var dataId="";
		 title ='全部物料明细';
		 dataId ="warningLackMaterialDetail_";



		 process=encodeURI(process);
         var url ="pages/mfc/warningLackMaterial/warningLackMaterialDetail.html?type=1&subfactory="+branch+"&station="+station+"&carCode="+carCode+"&process="+process+"&requestTime="+requestTime;

	   	 var isData = false;
	     var liObj =$("body", parent.document).find(".layui-tab-title li[lay-id]");
	     if(dataId && dataId.length>0){
	      $.each(liObj, function () {
	             if ($(this).attr("lay-id") == dataId) {
	                 isData = true;
	                 window.parent.active.tabDelete($(this).attr("lay-id"));

	             }
	         })
 	         window.parent.active.tabAdd(url,dataId,title);
 	      window.parent.active.tabChange(dataId);
	     }
	    }

</script>
 </body>
</html>
