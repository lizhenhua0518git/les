<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>工位物料预警总览</title>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
<link rel="stylesheet" href="/iles/pages/layui/css/modules/layer/default/layer.css"  type="text/css" />

</head>

<body>
  <div id="bodyDiv"></div>

	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
	<script src="/iles/pages/assets/js/jquery-1.10.2.js"></script>
	<script src="/iles/pages/js/loginInspect.js"></script>
	<script type="text/html" id="bodyTpl">
   <div class="layui-fluid">
		<div class="layui-row layui-form">
			<div class="layui-col-md3">
			 	<label class="layui-form-label">日期:</label>
                <div class="layui-input-block layui-form">
                    <input type="text" class="layui-input" name="startTime" id="startTime" placeholder="">

                </div>


			</div>

			<div class="layui-col-md3">
			 	<label class="layui-form-label">至</label>


                 <div class="layui-input-block layui-form">
                    <input type="text" class="layui-input" name="endTime" id="endTime" placeholder="">

                </div>
			</div>

			<div class="layui-col-md3">
			 	<label class="layui-form-label">分厂:</label>
			 	 <div class="layui-input-block">
			      <input type="text" id="subfactory" name="subfactory" class="layui-input">
			    </div>
			</div>
			<!--
			<div class="layui-col-md3">
                <label class="layui-form-label">产线:</label>
                 <div class="layui-input-block">
                 <select name="pipeLine" id="pipeLine"   class="layui-select">
                  </select>
                </div>
            </div>
			 -->
			<div class="layui-col-md3">
                <label class="layui-form-label">工位:</label>
                 <div class="layui-input-block">
                   <input type="text" id="station" name="station" class="layui-input">
                </div>
            </div>


		</div>
		<div class="layui-row layui-form" style="margin-bottom: 0">
			<div class="layui-col-md6">&nbsp;</div>
			<div class="layui-col-md6">
				<div class="layui-btn-container" style="text-align: right;">

	<div class="layui-btn-container" style="text-align: right;">
			{{# if(d.search==null || d.search=="true"){ }}
			   <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
		 	   <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
	         {{# } }}
             {{# if(d.check==null || d.check=="true"){ }}
              <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="check" type="button"><i class="mine-icon icon-check"></i>需求日期明细</button> <button class="layui-btn layui-btn-normal layui-btn-sm" data-method="check" type="button"><i class="mine-icon icon-check"></i>需求日期明细</button> 	         {{# } }}

  				</div>
			</div>
		</div>
	</div>
	<table class="layui-hide" id="subWarningLackMaterialTab" lay-filter="subWarningLackMaterialTabF"></table>
   </script>
   <script type="text/html" id="subfactoryTpl">
  {{#  if(d.subfactory ==='ZZ1' ){ }}
     {{ '预组装'}}
  {{#  } else { }}
   {{ '总组装'}}
  {{#  } }}
</script>
    <script type="text/javascript">
	var contextPath = config.wmsConfig.contextPath;
    var $ = layui.$;
    var element = layui.element;
    var layer = layui.layer;
    var table = layui.table;

    var form = layui.form;

    var oldData;

    table.render({
        elem:'#subWarningLackMaterialTab',
        id:'subWarningLackMaterialTabId',
        url:contextPath+'warningLackMateria/listMainList',
        cols:[[
        {field:'id',width:'5%' ,type:'checkbox'},
        {field:'requestTime',width:'15%',title:'需求日期'},
        {field:'subfactory', width:'15%', title:'分厂'},
       // {field:'pipeLine', width:'15%', title:'产线'},
        {field:'station', width:'20%', title: '工位'},
        {field:'planOrderNum', width:'10%', title: '计划工序'},
        {field:'normalOrderNum', width:'10%', title: '物料齐套工序'},
        {field:'lackOrderNum', width:'10%', title: '缺料工序'},
/*         {field:'materialMissingSpecies', width:'14%', title: '物料缺失种类'},
     */    {field:'positionOrderRate', width:'15%', title: '工位齐套率'}



        ]],
        page: {theme: '#008155'},

        height: 'full-95',

        done:function(res,page,count){//列表数据回调函数

        	  merge(res);
        }
    });
  //时间选择器
        layui.use('laydate', function(){
            var laydate = layui.laydate;
            //时间选择器
            laydate.render({
                elem: '#startTime',
                range: false
            });
            laydate.render({
                elem: '#endTime',
                range: false
            });
        });


    var active = {

            check:function(othis){
              var checkStatus = table.checkStatus('subWarningLackMaterialTabId');
                  oldData = checkStatus.data;
              if(oldData.length<=0){
                  layer.alert('请选择要查看的行！',{icon: 2});
                      return ;
              }else if(oldData.length >1){
                      layer.alert('不能超过多行！',{icon: 2});
                      return ;
                }

              var requestTime =oldData[0].requestTime;
              var url ="subWarningLackMaterial.html?subfactory=&station=&carCode=&requestTime="+requestTime;
               layer.open({
      	        type: 2
      	        ,title:'查看需求日期明细'
      	        ,maxmin:true
      	        ,area: ['100%', '100%']
      	        ,id: 'materialThreeId' //防止重复弹出
      	        ,content: url
      	        ,shade: 0 //不显示遮罩
      	        ,yes: function(){
      	          layer.closeAll();
      	        }
      	     });

            },
            search:function(othis){
                var startTime=$('#startTime').val();
                var endTime=$('#endTime').val();
                var subfactory=$('#subfactory').val();
                //var pipeLine=$('#pipeLine').val();
                var station=$('#station').val();

                var params={};
                params.startTime=startTime;
                params.endTime=endTime;
                params.subfactory=subfactory;
              //  params.pipeLine=pipeLine;
                params.station=station;

                  //执行重载
                  table.reload('subWarningLackMaterialTabId', {
                    where:params,
                    page:{"curr":1}
                  });
            },reset:function(othis){
                $('#startTime').val("");
                $('#endTime').val("");
                $('#subfactory').val("");
               // $('#pipeLine').val("");
                $('#station').val("");


            }

    };
    $('.layui-btn-container button').on('click', function(){
        var othis = $(this), method = othis.data('method');
        active[method] ? active[method].call(this, othis) : '';
    });

    function merge(res) {

	    var data = res.data;
	    var mergeIndex = 0;//定位需要添加合并属性的行数
	    var mark = 1; //这里涉及到简单的运算，mark是计算每次需要合并的格子数
	    var columsName = ['id','requestTime','subfactory'];//需要合并的列名称
	    var columsIndex = [0,1,2];//需要合并的列索引值

	    for (var k = 0; k < columsName.length; k++) { //这里循环所有要合并的列
	        var trArr = $(".layui-table-body>.layui-table").find("tr");//所有行
	            for (var i = 1; i < res.data.length; i++) { //这里循环表格当前的数据
	                var tdCurArr = trArr.eq(i).find("td").eq(columsIndex[k]);//获取当前行的当前列
	                var tdPreArr = trArr.eq(mergeIndex).find("td").eq(columsIndex[k]);//获取相同列的第一列
	               var t = k;
	                if(k==0){
	                	t=k+1;
	                }
	                if (data[i][columsName[t]] === data[i-1][columsName[t]]) { //后一行的值与前一行的值做比较，相同就需要合并
	                    mark += 1;
	                    tdPreArr.each(function () {//相同列的第一列增加rowspan属性
	                        $(this).attr("rowspan", mark);
	                    });
	                    tdCurArr.each(function () {//当前行隐藏
	                        $(this).css("display", "none");
	                    });
	                }else {
	                    mergeIndex = i;
	                    mark = 1;//一旦前后两行的值不一样了，那么需要合并的格子数mark就需要重新计算
	                }
	            }
	        mergeIndex = 0;
	        mark = 1;
    }
}

    function showTab(type,url){
   	 var title="";
   	 var dataId="";

   	if(type==1){

		 title ='查看需求日期明细';
		 dataId ="subWarningLackMaterial";
	 }
   	 var isData = false;
     var liObj =$("body", parent.document).find(".layui-tab-title li[lay-id]");
     if(dataId && dataId.length>0){
      $.each(liObj, function () {
             if ($(this).attr("lay-id") == dataId) {
                 isData = true;
                 window.parent.active.tabDelete($(this).attr("lay-id"));

             }
         })
          window.parent.active.tabAdd(url,dataId,title);

      window.parent.active.tabChange(dataId);
     }
    }

</script>
</body>
</html>
