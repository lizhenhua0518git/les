<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>移库管理</title>
	<meta name="renderer" content="webkit|ie-comp|ie-stand">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	<meta http-equiv="Cache-Control" content="no-siteapp" />
	<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
	<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
</head>
<body>
<div id="bodyDiv">

</div>
    <script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
    <script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
    <script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
    <script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
    <script type="text/html" id="bodyTpl">
	<div class="layui-fluid">
	 <input type="text"  id="transferBinId" hidden="true" />
		<div class="layui-row layui-form" lay-filter="moveForm">
            <div class="layui-col-md3">
                <label class="layui-form-label">仓库:</label>
                <div class="layui-input-block">
                    <select name="warehouse_search" id="warehouse_search" class="layui-select">
                     <option value="">请选择</option>
                    </select>
                 </div>
            </div>

			<div class="layui-col-md3">
				<label class="layui-form-label">移库日期:</label>
		           <div class="layui-input-block layui-form">
		               <input type="text" class="layui-input" name="" id="requiredDate" placeholder=" - ">
		           </div>
			</div>

             <div class="layui-col-md3">
                <label class="layui-form-label"> 移库单号:</label>
                <div class="layui-input-block">
                    <input type="text" name="transferBinCode" id="transferBinCode" class="layui-input" placeholder="">
                </div>
            </div>


			<div class="layui-col-md3">
                <label class="layui-form-label">状态:</label>
                 <div class="layui-input-block">
                   <select name="status" id="status" class="layui-select">
                        <option value="-1">请选择</option>
                    <option value="0">已创建</option>
                    <option value="1">已下达 </option>
                    <option value="2">已完成 </option>
                    </select>
                </div>
            </div>
		</div>
		<!-- 按钮区域 -->
		<div style="margin-top:8px"></div>
		<div class="layui-row layui-form" style="margin-bottom: 0">
			 <div class="layui-btn-container" style="text-align: left;">
			   {{# if(d.search==null || d.search=="true"){ }}
              <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
              <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
                 {{# } }}
                 {{# if(d.add==null || d.add=="true"){ }}
                <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="add" data-type="auto" type="button"><i class="layui-icon  layui-icon-add-circle"></i>新增</button>
                 {{# } }}
                 {{# if(d.del==null || d.del=="true"){ }}
                <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="del" type="button"><i class="layui-icon layui-icon-delete"></i>删除</button>
                 {{# } }}
              <button class="layui-btn layui-btn-normal layui-btn-sm" id="goDown" data-method="goDown" type="button"><i class="layui-icon">&#xe61a;</i>下达</button>
		   </div>
		</div>
	</div>
	<table id="storeTransfer" lay-filter="storeTransferTabF"></table>
</script>
	<script type="text/javascript">
		var $ = layui.$;
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form;
		var laydate = layui.laydate;
		var oldData;
		var contextPath = config.wmsConfig.contextPath;

		  function loadding(){
			  table.render({
		            elem:'#storeTransfer',
		            id:'storeTransferTabId',
		            url: contextPath +'storeTransfer/query',
		            where:{status:-1},
		            cols: [[
		                {type:'checkbox'},
		                {align:'center',title:'操作', toolbar:'#toolBar',width:'10%'},
		                {type:'numbers',title:'序号',width: 80},
		                {field:'warehouseCode',title: '仓库编码', width: '14%'},
		                {field:'warehouseName',title: '仓库名称', width: '14%'},
		                {field:'transferBinTime',title: '移库日期', width: 100,sort: true},
		                {field:'transferBinCode',title: '移库单号',width: '14%', sort: true},
		                {field:'status', title: '状态', width: '8%'},
		                {field:'createTime',title: '创建时间', width: '14%',sort: true},
		                {field:'transmitTime',title: '下达时间', width: '14%',sort: true}
		                //{field:'transferOutStatus', title: '移出状态', width: '8%'},
		                //{field:'transferInStatus', title: '移入状态', width: '8%'},
		                //{field:'transferLaneStatus', title: '状态', width: '8%'},

		                ]],
		            page: {theme: '#008155'},
		            height: 'full-80',
		            even:true,
		            done:function(res,page,count){//列表数据回调函数
		                initTableDate(res.data) ;
		                initWarehouseSignSelect("warehouse_search",1);
		                form.render(null,'moveForm');
		            }
		        });
			   //时间选择器
		        laydate.render({
		            elem: '#requiredDate',
		            range: true
		        });

		        $('.layui-btn-container button').on('click', function(){
		            var othis = $(this), method = othis.data('method');
		            active[method] ? active[method].call(this, othis) : '';
		        });
		  }


		var active = {
				search:function(othis){
					//执行重载
				var requiredTime=$('#requiredDate').val();
				var startTime="";
				var endTime="";
				if(requiredTime!=""){
					startTime=requiredTime.split(' - ')[0];
					endTime=requiredTime.split(' - ')[1];
				}
				table.reload('storeTransferTabId', {
					where:{
						startTime : startTime,
						endTime : endTime,
						transferBinCode:$('#transferBinCode').val(),
						status:$('#status').val()
				  	}
				,page:{"curr":1}
				});
			},
			reset:function(othis){
				 $('#requiredDate').val('');
                 $('#transferBinCode').val('');
                 $('#status').val('-1');
				form.render("select");
			},
			 add:function(othis){
                 var type = othis.data('type');
                 layer.open({
                     type: 2
                     ,title:'新增移库单信息'
                     ,offset:'auto'
                     ,maxmin:true
                     ,area: ['100%', '100%']
                     ,id: 'addStoreTransfer'+type //防止重复弹出
                     ,content: '/iles/pages/wms/store/addNew.html'
                     ,shade: 0 //不显示遮罩
                     ,yes: function(){
                           layer.closeAll();
                     }
                 });
             },
			/* edit:function(othis){
                var checkStatus = table.checkStatus('storeTransferTabId');
                oldData = checkStatus.data;
                if(oldData.length<=0){
                    layer.alert('请选择要编辑的行！',{icon: 2});
                    return ;
                }
                if(oldData.length >1){
                    layer.alert('不能选择多行编辑！',{icon: 2});
                    return ;
                }

                if(oldData[0].status !=0 ){
                    layer.alert('改状态下不能修改！',{icon: 2});
                    return ;
                }
                layer.confirm('确定编辑改记录信息？', {icon: 3, title:'提示'}, function(index){
                	  var stockTakeReportId =oldData[0].id;
                      $("#stockTakeReportId").val(stockTakeReportId);   //方便子页面取点收记录的Id
                      layer.open({
                          type: 2,
                          title:'编辑',
                          offset:'auto',
                          maxmin:true,
                          area: ['100%', '100%'],
                          id: 'edit', //防止重复弹出
                          content: '/iles/pages/wms/store/edit.html',
                          shade: 0, //不显示遮罩
                          yes: function(){
                            layer.closeAll();
                          }
                      });
                      layer.close(index);
                });
            },  */
            del:function(othis){
                var checkStatus = table.checkStatus('storeTransferTabId');
                oldData = checkStatus.data;
                if(oldData.length<=0){
                    layer.alert('请选择要删除的行！',{icon: 2});
                    return ;
                }
                var idarrys = new Array();
                for(var i=0;i<oldData.length;i++){
                    if(oldData[i].status==1 || oldData[i].status==2){
                        layer.alert('选中的记录包含了不能被删除的状态！',{icon: 2});
                        return ;
                    }

                    idarrys.push(oldData[i].id);
                }
                layer.confirm('确定删除移库单信息？', {icon: 3, title:'提示'}, function(index){
                    var option ={
                        url: contextPath +'storeTransfer/deleteStoreTransfer',
                        type:'POST',
                        contentType: "application/json",
                        dataType:'json',
                        data:JSON.stringify(idarrys),
                        success:function(data){
                            if(data.code==0){
                                layer.msg("删除成功");
                                table.reload('storeTransferTabId');//刷新列表
                            }
                        },error:function(data){
                            layer.alert(data.msg);
                        }
                    }
                    $.ajax(option);
                    layer.close(index);
                });
            }, goDown:function(othis){
                    var checkStatus = table.checkStatus('storeTransferTabId');
                    oldData = checkStatus.data;
                    if(oldData.length<=0){
                        layer.alert('请选择要下达的行！',{icon: 2});
                        return ;
                    }
                    var idarrys = new Array();
                    for(var i=0;i<oldData.length;i++){
                        idarrys.push(oldData[i].id);
                    }
                    layer.confirm('确定下达移库单信息？', {icon: 3, title:'提示'}, function(index){
                        var option ={
                            url:contextPath +'storeTransfer/goDown',
                            type:'POST',
                            contentType: "application/json",
                            dataType:'json',
                            data:JSON.stringify(idarrys),
                            success:function(data){
                                if(data.code==0){
                                    layer.msg("下达移库单成功");
                                    table.reload('storeTransferTabId');//刷新列表
                                }
                            },error:function(data){
                                layer.alert(data.msg);
                            }
                        }
                        $.ajax(option);
                        layer.close(index);
                    });
                }
		};

		  table.on('tool(storeTransferTabF)', function(obj){
              var eventName = obj.event;          //事件名称
              var clickObj = $(obj.tr[0]);        //当前对象tr

              if(eventName=="detail"){    //详情
            	  var transferBinId =obj.data.id;
            	  //方便子页面取值
                  $("#transferBinId").val(transferBinId);

                  layer.open({
                      type: 2,
                      title:'详情',
                      offset:'auto',
                      maxmin:true,
                      area: ['100%', '100%'],
                      id: 'storeTransferDetail', //防止重复弹出
                      content: '/iles/pages/wms/store/viewNew.html',
                      shade: 0, //不显示遮罩
                      yes: function(){
                        layer.closeAll();
                      }
                  });
              }
		  });

		//表格数据初始化
	    function initTableDate(data){
	        $("[data-field='status']").children().each(function(){
	            if($(this).text()=='0'){
	                $(this).text('已创建');
	            }else if($(this).text()=='1'){
	                $(this).text('已下达');
	            }else if($(this).text()=='2'){
                    $(this).text('已完成');
                }
	        });

/* 	        $("[data-field='transferOutStatus']").children().each(function(){
	            if($(this).text()=='0'){
	                $(this).text('待移出');
	            }else if($(this).text()=='1'){
	                $(this).text('部分移出');
	            }else if($(this).text()=='2'){
                    $(this).text('已完成');
                }
	        }); */
/* 	        $("[data-field='transferInStatus']").children().each(function(){
	            if($(this).text()=='0'){
	                $(this).text('待移入');
	            }else if($(this).text()=='1'){
	                $(this).text('部分移入');
	            }else if($(this).text()=='2'){
                    $(this).text('已完成');
                }
	        });
	        $("[data-field='transferLaneStatus']").children().each(function(){
	            if($(this).text()=='0'){
	                $(this).text('待移动');
	            }else if($(this).text()=='1'){
	                $(this).text('已移到巷道');
	            }else if($(this).text()=='2'){
                    $(this).text('已完成');
                }
	        }); */
	    }


	</script>

	<script type="text/html" id="toolBar">
        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">详情</a>
    </script>
</body>
</html>
