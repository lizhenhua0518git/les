<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
<link rel="stylesheet" href="/iles/pages/layui/css/tableFilter.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css" >
<title>新增盘点计划</title>
</head>
<body>
<div id="bodyDiv">

</div>

<script type="text/html" id="bodyTpl">
	<div class="layui-container layui-container-checkPlanAdd" style="padding-top: 20px;">
	<form class="layui-form"  action=""  lay-filter="stockTakePlanForm"  id="stockTakePlanForm" autocomplete="off" enctype="multipart/form-data">
		<div class="layui-form-item">
			<div class="layui-col-md2">
				 <label class="layui-form-label checkPlanAdd" >盘点类型</label>
				 <div class="layui-input-block">
					<select name="stockType" id="stockType" lay-verify="required" lay-filter="stockType">
						<option value="0">请选择</option>
						<option value="1">循环盘点</option>
						<option value="2">日常盘点</option>
						<option value="3">定向盘点</option>
						<option value="4">定期盘点</option>
					</select>
					</div>
			</div>
			<div class="layui-col-md2">
	                <label class="layui-form-label">盘点工厂</label>
	                <div class="layui-input-block">
		                <select name="factory" id="factory" lay-verify="required" xm-select="select1" xm-select-show-count="6" xm-select-search="">
		                    <option value=""></option>
		                </select>
	                </div>
            </div>
            <div class="layui-col-md2">
             <label class="layui-form-label">盘点仓库</label>
                <div class="layui-input-block">
                    <select name="warehouseCode" id="warehouseCode" lay-verify="required" xm-select="select2" xm-select-show-count="10" xm-select-search=""  >
                        <option value="">请选择</option>
                        <!-- <option value="1">中心仓库</option>
                        <option value="2">预组装仓库</option>
                        <option value="3">总组装仓库</option>
                        <option value="4">预组装管线材库</option>
                        <option value="4">总组装管线材库</option>
                        <option value="4">东区大部件仓库</option> -->
                    </select>
                </div>
            </div>
		</div>
		<div class="layui-form-item" id="xhzq" name="xhzq">
			<div class="layui-inline">
			    <label class="layui-form-label">循环周期</label>
				<input type="radio" name="repeatDay" id="repeatDay" lay-filter="repeatDayM" value="1" title="日别" checked="">
				<input type="radio" name="repeatDay" id="repeatDay" lay-filter="repeatDayM" value="7" title="周别" >
				<input type="radio" name="repeatDay" id="repeatDay" lay-filter="repeatDayM" value="31" title="月别" >
				<input type="radio" name="repeatDay" id="repeatDay" lay-filter="repeatDayM" value="92" title="季度" >
				<input type="radio" name="repeatDay" id="repeatDay" lay-filter="repeatDayM" value="-1" title="自定义" >
			</div>
			<div class="layui-inline">
				 <input type="number" class="layui-input" name="cycleNum" id="cycleNum" style="width:80px;" disabled="disabled"  maxlength="5" onKeyUp="this.value=this.value.replace(/[^\.\d]/g,'');this.value=this.value.replace('.','');"  placeholder="正整数" autocomplete="off" /> 
			</div>
			<div class="layui-inline " style="width:70px;">
				<select name="cycleUnit" id="cycleUnit"   xm-select-show-count="10" xm-select-search="">
					<option value="天">天</option>
					<option value="月">月</option>
					<option value="年">年</option>
				</select>
			</div>
	</div>
	<div class="layui-form-item" >
	       <div class="layui-col-md2" id="st">
			     <label class="layui-form-label">开始时间</label>
			     <div class="layui-inline" >
				      <input type="text" class="layui-input"  name="startTime" id="startTime"  lay-verify="required"  placeholder="yyyy-MM-dd hh:mm:ss" autocomplete="off">
			     </div>
	       </div>
	       <div class="layui-col-md2" id="pdjssj" name="pdjssj" >
	             <label class="layui-form-label">结束时间</label>
	             <div class="layui-inline">
	             <input type="text" class="layui-input" name="endTime" id="endTime" placeholder="yyyy-MM-dd hh:mm:ss" autocomplete="off">
	            </div>
	       </div>
	       <div class="layui-col-md2"  id="pdsc" name="pdsc">
            <label class="layui-form-label">盘点时长</label> 
              <div class="layui-inline" >
                     <input type="number" class="layui-input" name="cycleNum1" id="cycleNum1"   lay-verify="required" style="width: 80px;" maxlength="5"  onKeyUp="this.value=this.value.replace(/[^\.\d]/g,'');this.value=this.value.replace('.','');" placeholder="正整数" autocomplete="off" />
              </div>
              <div class="layui-inline" style="width: 70px;">
                <select name="cycleUnit1" id="cycleUnit1"  xm-select-show-count="10" xm-select-search="">
                    <option value="天">天</option>
                    <option value="月">月</option>
                    <option value="年">年</option>
                </select>
          </div>
       </div>
       <div class="layui-col-md2" id="xmh" name="xmh">
            <label class="layui-form-label">项目号</label>
            <div class="layui-inline" >
                      <input type="text" class="layui-input" name="projectCode" id="projectCode" >
              </div>
          </div>
          <div class="layui-col-md3" id="rws">
             <label class="layui-form-label">最低任务数</label>
              <div class="layui-inline">
                <input type="number" class="layui-input" name="taskNum" id="taskNum" lay-verify="required" style="width:80px;" maxlength="5" onKeyUp="this.value=this.value.replace(/[^\.\d]/g,'');this.value=this.value.replace('.','');"  > 
              </div>
              <div class="layui-inline"><span>笔</span></div>
          </div>
	</div>
		
	<div class="layui-form-item">
	      <label class="layui-form-label checkPlanAdd">盘点对象</label>
		  <div class="layui-inline">
			    <input type="text" class="layui-input" style="width:250px;height:40px" name="materialCode" id="materialCode" placeholder="请输入检索物料编号" oninput="loadMaterialCode()">
	       </div>
		<div name="transfer" id="transfer" class="demo-transfer"></div>
		<div class="layui-inline">
		      <button type="button" class="layui-btn  checkPlanAdd_inport" id="uploadExcel"><!--<img src="/iles/pages/img/add.png" style="width:16px;height: 16px;">-->导入物料</button> 
		      <a href="#"  onclick="tmplDownload()"  style="color:#000000; text-decoration:underline; padding-left: 30px;">模板下载</a>
		</div>
	</div>
		<div class="layui-form-item" style="text-align: center; margin-right: 500px;">
			<div class="layui-input-block">
				<button class="layui-btn layui-btn-normal layui-btn-sm checkPlanAdd_save"  lay-submit lay-filter="stockTakePlanSubit"><!--<i class="layui-icon layui-icon-set-sm"></i>-->保存</button>
				<button type="reset" class="layui-btn layui-btn-primary">重置</button>
			</div>
		</div>
	</form>
</div>
</script>
<script src="/iles/pages/layui/layui.all.js"></script>
<script src="/iles/pages/layui/lay/modules/layer.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>
<script type="text/javascript">
	 var warehouseName ="";
	 var materialCodeArr = "";
	
	  $("#pdjssj").hide();
	  $("#xmh").hide();
	  
	  var transfer; 
	  var layer = layui.layer;
	  var contextPath = config.wmsConfig.contextPath;
	  var form=layui.form;
	  var formSelects=layui.formSelects;
	  var laydate = layui.laydate;
	  var upload = layui.upload;
	  var result ="";
	  layui.use(['transfer','formSelects'],function(){
	     
		  transfer=layui.transfer;
		  formSelects=layui.formSelects;


	 });	
	function initFactorySelect(){
			 var param = {limit:0}
			 var contextPath2 = config.basicInfoConfig.contextPath
		        var option={
		                url:contextPath2+'factory/', 
		                type:'post',
		                data:param,
		                contentType:'application/json',
		                success:function(result){
		                      if(result.code==0){
		                          var factoryList = result.data;
		                          var optoinArray = new Array();
		                          if($("#factory").find("option").length==1){
		                              for(var i=0;i<factoryList.length;i++){
		                            	  var optionItem = {"name":""+factoryList[i].factoryName, "value":""+factoryList[i].factoryCode};
		                                  optoinArray.push(optionItem);
		                              }
		                              layui.formSelects.data("select1",'local',{
		                                  arr:optoinArray
		                              }); 
		                              form.render("select");
		                          }
		                      }
		                }
		        }
		         $.ajax(option); 
	 }
	 function saveDict(data){

		 var loading = layer.msg('正在处理', {icon: 16, shade: 0.3, time:0});
		 
		 var fd = new FormData();
         var formData = new FormData($( "#stockTakePlanForm" )[0]);
         
         var repeatDay = $('input[name="repeatDay"]:checked').val();
         if(repeatDay== -1){
        	 var cycleNum = $("#cycleNum").val();
             var cycleUnit = $("#cycleUnit").val();
             if(cycleUnit=="天"){
            	 cycleUnit=1;
             }else if(cycleUnit=="月"){
            	 cycleUnit=31;
             }else if(cycleUnit=="年"){
            	 cycleUnit=365;
             }else{
            	 cycleUnit=1;
             }
             repeatDay = cycleNum*cycleUnit;
         }
         
         var cycleNum1 = $("#cycleNum1").val();
         var cycleUnit1 = $("#cycleUnit1").val();
         if(cycleUnit1=="天"){
        	 cycleUnit1=1;
         }else if(cycleUnit1=="月"){
        	 cycleUnit1=31;
         }else if(cycleUnit1=="年"){
        	 cycleUnit1=365;
         }else{
        	 cycleUnit1=1;
         }
 
		 var inventoryTime = cycleNum1*cycleUnit1;

		 if(inventoryTime>repeatDay){
			 layer.alert("盘点时间大于循环周期，请调整！");
			 return;
         }
         warehouseName= layui.formSelects.value('select2', 'nameStr');
         var storageLocation = layui.formSelects.value('select2', 'storagelocation');
         var transferData = transfer.getData('transferKey');// 获取选择的物料
         formData.append("transferData",JSON.stringify(transferData));
         formData.append("warehouseName",warehouseName);
         formData.append("storageLocation",JSON.stringify(storageLocation));
         formData.append("inventoryTime",inventoryTime);
         formData.append("repeatDay",repeatDay);

         var url=contextPath+'stockTakePlan/regularPlan';
         var stockType =$("#stockType").val();
         
         if(stockType==1){
        	   url=contextPath+'stockTakePlan/cycleCountTask';
         }else if(stockType==2){
        	 url=contextPath+'stockTakePlan/dailyPlanBegin';
         }else if(stockType==3){
        	 url=contextPath+'stockTakePlan/directionalPlan';
         }else if(stockType==4){
        	 url=contextPath+'stockTakePlan/regularPlan';
         }
        
			var option = {
		    	url:url,
		    	data:formData,
		    	type:'POST',
		        processData: false, // 告诉jQuery不要去处理发送的数据
		        contentType: false, // 告诉jQuery不要去设置Content-Type请求头
		    	success:function(data){
		    		if(data.code==0){
		    			layer.msg("盘点计划创建成功！");
		    			var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
		    			parent.layer.close(index);  // 关闭layer
		    			parent.table.reload('stockTakePlanTabId');
		    			/* layer.close(loading);
		    			$("#stockTakePlanForm")[0].reset();
		    			layer.alert('盘点计划生成成功！',{icon: 6}); */
		    		}else{
		    			layer.alert(data.data,{icon: 2});
		    		}
		    	},error:function(data){
		    		layer.alert('盘点计划生成失败！',{icon: 2});
		    	}
		    }
		    $.ajax(option); 
		}
	 function tmplDownload(){
		  window.open("import_tpl.xlsx");
	  }
	  var selectData = new Array();//存放选择的物料
	  var defualtData = new Array();//存放初始值
	  function loadMaterialCode(){
		  var materialCode = $("#materialCode").val();
		   $.ajax({
		    	url:contextPath+'stockTakePlan/getPageMaterial',
		    	type:'POST',
		    	data: {materialCode:materialCode},
		    	 
		    	success:function(data){
		    		//显示搜索框
	    		    result =data.data;
	    		    if(selectData && selectData.length>0){//增加已经选择的内容
	    		    	  var index;
	    		    	  for(var i=0;i<selectData.length;i++){
	    		    		  index = result.findIndex(e => e.value === selectData[i].value);
	    		    		  if(index<0){//避免重复
	    		    			  result.push(selectData[i]);
	    		    		  }
	    		    		  defualtData.push(selectData[i].value);
			    		  }
	    		    }
	    		    transfer.render({
	    		    	  title: ['可选物料', '选中物料']
	    			      ,elem: '#transfer'
	    			      ,id:'transferKey'
	    			      ,data: result
	    			      ,value: defualtData
	    			      ,onchange: function(data, index){
	    			    	  if(index==0){//右移
	    			    		  for(var i=0;i<data.length;i++){
	    			    			  selectData.push(data[i]);
	    			    		  }
	    			    	  }else if(index==1){//左移
	    			    		  for(var i=0;i<data.length;i++){
	    			    			  selectData.splice(selectData.findIndex(e => e.value === data[i].value), 1) 
	    			    		  }
	    			    	  }
	    			      }
	    			}); 
		    	},error:function(data){
		    		layer.alert(data.msg)
		    	}
		    
	    }); 
	  }
	  function loadding(){
		  initWarehouseMultiSelect("warehouseCode","select2",1);
		  initFactorySelect();
		  form.render(null,"stockTakePlanForm");
		  transfer.render({
		      elem: '#transfer'
		      ,id:'transferKey'
		      ,data: []
		      ,width:400
		      ,height:200
		      ,title: ['可选物料', '选中物料']
		      //,showSearch: true
		    });
		//时间选择器
	  	laydate.render({
		    elem: '#startTime'
		    ,type: 'datetime'
		  });
	  	laydate.render({
		    elem: '#endTime'
		    ,type: 'datetime'
		  });
	  
	    //文件上传   已关闭
        upload.render({
            elem: '#uploadExcel'
            , url: contextPath+'stockTakePlan/regularPlan'
            , accept: 'file'
            , auto: false
            // , bindAction: '#upfile' //关闭的上传按钮   html中此id所在元素也被注释
            ,multiple: true
            , done: function (res) {
                alert("上传成功");
            }
        });
	
	form.on('radio(repeatDayM)', function(data){
        var level = data.value;//被点击的radio的value值
        if(level=="-1"){
        	$("#cycleNum").removeAttr("disabled");
        	$("#cycleNum").attr("lay-verify","required|number");
        }else{
        	$("#cycleNum").removeAttr("lay-verify");
        	$("#cycleNum").attr("disabled","disabled");
        }
   	});

	
	 form.on('select(stockType)', function(data){ 
           if(data.value == '1'){
        	   $("#st").show();
               $("#xhzq").show();
               $("#pdsc").show();
               $("#pdjssj").hide();
               $("#xmh").hide();
               $("#cycleNum1").attr("lay-verify","required|number");
               $("#startTime").attr("lay-verify","required");
               $("#endTime").removeAttr("lay-verify");
               $("#projectCode").removeAttr("lay-verify");
               
               
               
           }else if(data.value == '2'){
        	   $("#st").show();
        	   $("#xhzq").hide();
               $("#pdsc").hide();
               $("#pdjssj").show();
               $("#xmh").hide();
               $("#cycleNum").removeAttr("lay-verify");
               $("#cycleNum1").removeAttr("lay-verify");
               $("#startTime").attr("lay-verify","required");
               $("#endTime").attr("lay-verify","required");
               $("#projectCode").removeAttr("lay-verify");
           }else if(data.value == '3'){
        	   
        	   $("#st").hide();
        	   $("#xhzq").hide();
               $("#pdsc").hide();
               $("#pdjssj").show();
               $("#xmh").show(); 
               $("#cycleNum").removeAttr("lay-verify");
               $("#cycleNum1").removeAttr("lay-verify");
               $("#startTime").removeAttr("lay-verify");
               $("#endTime").attr("lay-verify","required");
               $("#projectCode").attr("lay-verify","required");
           }
           else{
        	   $("#st").show();
        	   $("#xhzq").hide();
               $("#pdsc").hide();
               $("#pdjssj").show();
        	   $("#xmh").hide(); 
        	   $("#cycleNum").removeAttr("lay-verify");
        	   $("#cycleNum1").removeAttr("lay-verify");
        	   $("#startTime").attr("lay-verify","required");
        	   $("#endTime").attr("lay-verify","required");
        	   $("#projectCode").removeAttr("lay-verify");
           }
       }); 
	    //监听提交
	   form.on('submit(stockTakePlanSubit)', function(data){
			saveDict(data);
			return false;
		});
			 
	   $("#queryMaterial").click(function(){
			var materialCode = $("#materialCode").val();
	    	 if(materialCode===''){
	    		 layer.alert("没有输入，不能查询");
	    		 return;
	    	 }
	    	$.ajax({
		    	url:contextPath+'stockTakePlan/getPageMaterial',
		    	type:'POST',
		    	data: {materialCode:materialCode},
		    	 
		    	success:function(data){
		    		  //显示搜索框
		    	    var data1 = [{"value": "1", "title": "物料1"}
		    	                 ,{"value": "2", "title": "物料2"}
		    	                 ,{"value": "3", "title": "物料3"}
		    	                 ,{"value": "4", "title": "物料4"}
		    	                 ,{"value": "5", "title": "物料5", "disabled": true}];
		    		    result =data.data;
		    		    transfer.reload('transferKey', {
					    	  title: ['可选物料', '选中物料']
		    		          ,value: ['1', '2', '5']
				    	      
					      })
		    		
		    	},error:function(data){
		    		layer.alert(data.msg)
		    	}
		    
	    	});
	    });	
		form.render();
	  };
	 
	</script>
</body>
</html>