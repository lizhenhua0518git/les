<!DOCTYPE html>
<html>
<head>

	<meta charset="UTF-8">
	<title>新增移库</title>
	<meta name="renderer" content="webkit|ie-comp|ie-stand">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	<meta http-equiv="Cache-Control" content="no-siteapp" />
	<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
	<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
</head>
<body>
<div id="bodyDiv">

</div>
    <script type="text/html" id="bodyTpl">
	<table class="layui-table" lay-filter="saveTable">
	  <thead>
	    <tr>
	      <th style="display: none;">ID</th>
          <th>序号</th>
	      <th >物料号</th>
	      <th >工厂</th>
	      <th >库存地点</th>
	      <th >物料描述</th>
	      <th >库存类型</th>
	      <th >可移动数量</th>
	      <th >单位</th>
	      <th >批次号</th>
	      <th >项目号</th>
	      <th >工位</th>
	      <th >移出仓位</th>
	      <th >移动数量</th>
	      <th >移入仓位</th>
	    </tr>
	  </thead>
	  <tbody id="saveTable">
	  	<tr>
	      <td class="id" style="display: none;"></td>
          <td class="materialCode"></td>
	      <td class="materialCode"></td>
	      <td class="factory"></td>
	      <td class="storageLocation"></td>
	      <td class="materialDesc"></td>
	      <td class="stockType"></td>
	      <td class="totalStockCount"></td>
	      <td class="materialUnit"></td>
	      <td class="batchNo"></td>
	      <td class="projectId"></td>
	      <td class="stationCode"></td>
	      <td class="positionCode"></td>
	      <td class="transNum"></td>
	      <td class="transferInBin"></td>
	    </tr>
	  </tbody>
</table>
	<div class="layui-fluid">
		<div class="layui-row layui-form">
			<input type="text"  id="materialCodeValue" name="materialCodeValue" hidden="true" />
			<input type="text"  id="factoryValue"   hidden="true"/>
			<input type="text"  id="positionCode" name="positionCode" hidden="true"/>
			<input type="text"  id="storageBinId" name="storageBinId" hidden="true"/>
			<input type="text"  id="transNum" hidden="true"/>
			<input type="text"  id="transferInBin"  hidden="true"/>
			<input type="text"  id="stationCode"  hidden="true"/>

		 	<div class="layui-col-md3">
			 	<label class="layui-form-label">物料编号:</label>
			 	<div class="layui-input-block">
			    	<input type="text" id="materialCode" class="layui-input" placeholder="请输入物料编号">
			    </div>
			</div>
			<div class="layui-col-md3">
			 	<label class="layui-form-label">库存地点:</label>
				<div class="layui-input-block layui-form">
					<input type="text" class="layui-input" id="storageLocation" placeholder="请输入库存地点">
				</div>
			</div>
            <div class="layui-col-md3">
			 	<label class="layui-form-label">仓位号:</label>
				<div class="layui-input-block layui-form">
					<input type="text" class="layui-input" id="positionCodes" placeholder="请输入仓位号">
				</div>
			</div>
		</div>

		<div class="layui-row layui-form" style="margin-bottom: 0">
            <div class="layui-col-md6">&nbsp;</div>
            <div class="layui-col-md6">
            <div class="layui-btn-container" style="text-align: right;">
              <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
               <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" type="button"><i class="layui-icon-reset"></i>重置</button>
              <!-- <button class="layui-btn layui-btn-normal layui-btn-sm" id="optUser" data-method="optUser" type="button"><i class="layui-icon layui-icon-add"></i>批量指派</button> -->
			  <button class="layui-btn layui-btn-normal layui-btn-sm" onclick="saveTransMainAndDetail()" type="button"><i class="mine-icon icon-add"></i>保存</button>

         </div>
            </div>
        </div>
		</div>
	<table id="addStoreTransferDetail" lay-filter="addStoreTransferDetailTabF"></table>
</script>
	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	 <script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
    <script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
	<script type="text/javascript">
		var $ = layui.$;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form;
		var laydate = layui.laydate;
		var oldData;
		var tableData=new Array(); // 用于存放表格数据
		var flag = 0; // 0 指派移出操作人 1 指派移入操作人
		var userId='';
		var userName='';
		var contextPath = config.wmsConfig.contextPath;
		// 获取移库单编号
		//getTransferBinCode();
		function loadding(){
			table.render({
	            elem:'#addStoreTransferDetail',
	            id:'addStoreTransferDetailTabId',
	            url:contextPath +'queryStoreBinStockList',
	            where:{userMode:2},
	            Width: 70,
	            cols: [[
	                //{type:'checkbox'},
	                {type:'numbers',title:'序号',width: 80},
	                {field:'materialCode',width:150,title: '物料号'},
	                {field:'factory',title: '工厂'},
	                {field:'storageLocation',title: '库存地点'},
	                {field:'materialDesc',title: '物料描述'},
	                {field:'stockType', title: '库存类别'},
	                {field:'totalStockCount',title: '可移数量'},
	                {field:'materialUnit',title: '单位'},
	                {field:'batchNo',title: '批次号'},
	                {field:'projectId', title: '项目号'},
	                {field:'stationCode', title: '工位'},
	                {field:'positionCode',title: '移出仓位',width:100},
	                {field:'transNum',title: '移动数量（输入）',edit:'text',style:'background-color: #009688; color: #fff;'},
	                {field:'transferInBin',title: '移入仓位',event: 'setTransferInBin', style:'cursor: pointer;'}
	                ]],
	            height: 'full-95',
	            even:true,
	            page: {theme: '#008155'},
	            done:function(res,page,count){//列表数据回调函数
	                initTableDate(res.data);
	            }
	        });
		     $('.layui-btn-container button').on('click', function(){
		            var othis = $(this), method = othis.data('method');
		            active[method] ? active[method].call(this, othis) : '';
		        });
		}


		var active = {
			search:function(othis){
				//执行重载
				table.reload('addStoreTransferDetailTabId', {
					where:{
						userMode:2,
				  		materialCode : $('#materialCode').val(),
				  		factory:$('#factory').val(),
				  		storageLocation:$('#storageLocation').val(),
				  		positionCode : $('#positionCodes').val()
				  	},
					page:{"curr" : 1}
				});
			}
		};

		layui.use('table', function(){
			  var table = layui.table;
			  //监听单元格事件
			  table.on('tool(addStoreTransferDetailTabF)', function(obj){
			    var data = obj.data;
			    if(obj.event === 'setTransferInBin'){
			    	var transNum=data.transNum; //得到修改后的值
				    var maxAcceptCount=data.totalStockCount;
				    var regu = /^[0-9]+\.?[0-9]*$/;
				    if(transNum!=''&&transNum!=null&&transNum!=undefined){
				    	if(!regu.test(transNum)){
				    		layer.alert('移转数量编辑有误！', {icon: 5});
				    		return;
				    	}else{
				    		if(parseFloat(transNum)>parseFloat(maxAcceptCount)){
				    			layer.alert('移转数量大于总数量！', {icon: 5});
				    			return;
				    		}
				    	}
				    }
			    	if(transNum== null ||transNum== undefined ||transNum==''){
			    		layer.alert('请先输入移转数量！', {icon: 5});
			    		return;
			    	}
			    	var $ = layui.$;
		            $("#stationCode").val(data.stationCode);
		            $("#positionCode").val(data.positionCode);
		            $("#storageBinId").val(data.id);
		            $("#transNum").val(transNum);
		            $("#materialCodeValue").val(data.materialCode);
			    	layer.open({
                        type: 2
                        ,title:'选择仓位'
                        ,maxmin:true
                        ,area: ['450px', '350px']
                        ,id: 'chooseStoreBin' //防止重复弹出
                        ,content: '/iles/pages/wms/store/chooseStoreBinNew.html'
                        //,btn: ['保存']
                        ,shade: 0 //不显示遮罩
                        ,yes: function(index, layero){
                        	/* var transferInBin =$("#transferInBin").val();
                        	  layer.close(index); //如果设定了yes回调，需进行手工关闭
                        	//同步更新表格和缓存对应的值
                            obj.update({

                            	transferInBin:transferInBin

                            }); */
                        }
                   });

			    }

			  });
			});

		function getTransferBinCode(){
            var option = {
                url:contextPath +'storeTransfer/getTransferBinCode',
                type:'POST',
                contentType:'application/json',
                success:function(data){
                    if(data.code==0){
                    $("#transferBinCode").val(data.data);
                    }else{
                        layer.alert(data.data);
                    }
                },error:function(data){
                    layer.alert(data.msg)
                }
            }
            $.ajax(option);
        }
		function initTableDate(){
			$("[data-field='stockType']").children().each(function() {
				if ($(this).text() == '0') {
					$(this).text('');
				} else if ($(this).text() == '1') {
					$(this).text('普通');
				} else if ($(this).text() == '2') {
					$(this).text('采购冻结');
				} else if ($(this).text() == '3') {
					$(this).text('厂内冻结');
				}
			});
		}

		function xianshi(){
			console.log(tableData);
			var option = {
	                url:contextPath +'queryStoreBinStockAddList',
	                type:'POST',
	                data:JSON.stringify(tableData),
	                contentType:'application/json',
	                success:function(data){
	                	console.log(data);
	                    if(data.code==0){
	                    	var datas= data.data
							var str = "";
	                    	for (var i = 0; i < datas.length; i++) {
	                    		var j = i+1;
	                    		str += "<tr>"+
		                  	      "<td class='id' style='display: none;'>"+datas[i].id+"</td>"+
		                  	      "<td class='materialCode'>"+i+1+"</td>"+
		                  	      "<td class='materialCode'>"+datas[i].materialCode+"</td>"+
		                  	      "<td class='factory'>"+datas[i].factory+"</td>"+
		                  	      "<td class='storageLocation'>"+datas[i].storageLocation+"</td>"+
		                  	      "<td class='materialDesc'>"+datas[i].materialDesc+"</td>"+
		                  	      "<td class='stockType'>"+datas[i].stockType+"</td>"+
		                  	      "<td class='totalStockCount'>"+datas[i].totalStockCount+"</td>"+
		                  	      "<td class='materialUnit'>"+datas[i].materialUnit+"</td>"+
		                  	      "<td class='batchNo'>"+datas[i].batchNo+"</td>"+
		                  	      "<td class='projectId'>"+datas[i].projectId+"</td>"+
		                  	      "<td class='stationCode'>"+datas[i].stationCode+"</td>"+
		                  	      "<td class='positionCodeOut'>"+datas[i].positionCodeOut+"</td>"+
		                  	      "<td class='transNum'>"+datas[i].transNum+"</td>"+
		                  	      "<td class='positionCodeIn'>"+datas[i].positionCodeIn+"</td>"+
		                  	    "</tr>"
							}
	                    	$("#saveTable").html(str);
	                    }else{
	                        layer.alert(data.data);
	                    }
	                },error:function(data){
	                    layer.alert(data.msg)
	                }
	            }
	            $.ajax(option);
		}

		function saveTransMainAndDetail (){
			var option = {
	                url:contextPath +'storeTransfer/saveTransMainAndDetail',
	                data:JSON.stringify(tableData),
	                type:'POST',
	                contentType:'application/json',
	                success:function(res){
	                    if(res.code==0){
	                    	//layer.alert('保存成功！',{icon: 2});
	                    	parent.layer.closeAll();
	    					parent.table.reload('storeTransferTabId');
	    					tableData="";
	                    }else{
	                    	layer.alert(res.data,{icon: 2});
	                    }
	                },error:function(res){
	                    layer.alert(res.msg);
	                }
	            }
	        $.ajax(option);
		}
	</script>

</body>
</html>
