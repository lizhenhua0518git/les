<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="renderer" content="webkit|ie-comp|ie-stand">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	<meta http-equiv="Cache-Control" content="no-siteapp" />
	<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
	<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  type="text/css" />
	<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
	<title>盘点计划</title>
</head>
<body>
<div id="bodyDiv">

</div>
<script type="text/html" id="bodyTpl">

	<div class="layui-fluid">
	<div class="layui-row layui-form">


			<div class="layui-col-md2">
                <label class="layui-form-label">计划编号:</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" name="stockTakePlanCode" id="stockTakePlanCode" placeholder="" autocomplete="off">
                </div>
            </div>
			<div class="layui-col-md2">
                <label class="layui-form-label">状态:</label>
                 <div class="layui-input-block">
                     <select name="status" id="status" xm-select="select3"
						xm-select-show-count="1" xm-select-search="" autocomplete="off">
                        <option value="">请选择</option>
	                    <!-- <option value="0">已关闭</option>  -->
	                    <option value="1">已删除 </option>
	                    <option value="2">未开始</option>
	                    <option value="3">等待盘点 </option>
	                    <!-- <option value="4">挂起 </option> -->
	                    <option value="5">盘点中</option>
	                    <option value="6">审核中</option>
	                    <option value="7">异常 </option>
	                    <option value="8">复盘 </option>
	                    <option value="9">审核超时 </option>
                    </select>
                </div>
            </div>
				<div class="layui-col-md2">
			 	<label class="layui-form-label">仓库</label>
			 	 <div class="layui-input-block" >
			       <select name="warehouse_search" id="warehouse_search" class="layui-select">
						<option value=""></option>
					</select>
			    </div>
			</div>

            <div class="layui-col-md2">
                <label class="layui-form-label">类型:</label>
                 <div class="layui-input-block">
                     <select name="status" id="status" xm-select="select3"
						xm-select-show-count="1" xm-select-search="" autocomplete="off">
                        <option value="">请选择</option>
	                    <!-- <option value="0">已关闭</option>  -->
	                    <option value="1">已删除 </option>
	                    <option value="2">未开始</option>
	                    <option value="3">等待盘点 </option>
	                    <!-- <option value="4">挂起 </option> -->
	                    <option value="5">盘点中</option>
	                    <option value="6">审核中</option>
	                    <option value="7">异常 </option>
	                    <option value="8">复盘 </option>
	                    <option value="9">审核超时 </option>
                    </select>
                </div>
            </div>


             <!--<div class="layui-col-md2">
                <label class="layui-form-label">类型:</label>
                <div class="layui-input-block">
                     <select name="stockTakeType" id="stockTakeType" class="layui-select">
	                     <option value="">请选择</option>
                    </select>
                </div>
            </div>
			-->
			 <div class="layui-col-md2">
                <label class="layui-form-label">项目号:</label>
                <div class="layui-input-block">
                    <input type="text" class="layui-input" name=procetCode id="procetCode" placeholder="">
                </div>
            </div>

			<!--<div class="layui-col-md2">&nbsp;</div>-->
			<div class="layui-btn-container nav-" style="text-align: right;">
					{{# if(d.search==null || d.search=="true"){ }}
             	 		<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
              			<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" id="reset" type="button"><i class="layui-icon  layui-icon-reset"></i>重置</button>
              		{{# } }}
			</div>


	       <div class="layui-row layui-form" style="margin-top:10px;">
           <div class="layui-col-md7">
            <div class="layui-col-md4">
                <label class="layui-form-label">计划时间:</label>
                <div class="layui-input-block">
                      <input type="text" class="layui-input" name="startTime" id="startTime" autocomplete="off">
                </div>
            </div>
			<div class="layui-col-md4 date">
                <label class="layui-form-label" style="width: 15%">至</label>
                <div class="layui-input-block layui-form" style="margin-left: 26%">
                     <input type="text" class="layui-input" name="endTime" id="endTime" autocomplete="off">
                </div>
            </div>
           </div>
	</div>
</div>


		<!-- 按钮区域 -->
		<div style="margin-top:8px"></div>
	<div class="layui-fluid-table">
	<div class="layui-row layui-form" >
			<div class="layui-col-md6">
				<div class="layui-btn-container" style="text-align: left;">
					{{# if(d.search==null || d.search=="true"){ }}
	      {{# } }}

         {{# if(d.add==null || d.add=="true"){ }}
	      <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="add" data-type="auto" type="button"><i class="layui-icon  layui-icon-add-circle"></i>增加</button>

          {{# } }}

         {{# if(d.edit==null || d.edit=="true"){ }}

	       <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="edit" type="button"><i class="layui-icon layui-icon-edit"></i>编辑</button>

          {{# } }}

        {{# if(d.del==null || d.del=="true"){ }}
	     <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="del" type="button"><i class="layui-icon layui-icon-delete"></i>删除</button>
        {{# } }}

         {{# if(d.import==null || d.import=="true"){ }}
		 <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="import" id="import" type="button"><i class="layui-icon layui-icon-import"></i>导入</button>
	     {{# } }}
          {{# if(d.export==null || d.export=="true"){ }}
		 <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="export" type="button"><i class="layui-icon layui-icon-export"></i>导出</button>
	     {{# } }}
				</div>
			</div>
		</div>
	<table id="areaTab" lay-filter="areaTabF"></table>
</div>
	<table id="stockTakePlan" lay-filter="stockTakePlanTabF"></table>
</script>
	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
    <script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
    <script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
    <script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
	<script src="/iles/pages/layui/lay/modules/tableFilter.js" charset="UTF-8"></script>

	<script type="text/javascript">
	layui.config({
	    base: '/iles/pages/layui/lay/modules/' //此处路径请自行处理, 可以使用绝对路径
	}).extend({
	    formSelects: 'formSelects-v4'
	});
	var $ = layui.$;
	var element = layui.element;
	var layer = layui.layer;
	var table = layui.table;
	var form = layui.form;
	var laydate = layui.laydate;
	var oldData;
	var flag = 0; // 0 盘点人 1 复盘人
	var contextPath = config.wmsConfig.contextPath;
	var userId='';
	var userName='';
function loadding(){
	layui.use(['form','table','layer','laydate','formSelects'],function(){
		    getWarehouse();
			table.render({
	            elem:'#stockTakePlan',
	            id:'stockTakePlanTabId',
	            url:contextPath +'stockTakePlan/query',
	            method:'post',
	            where:{status:-1},
	            cols: [[
	                {type:'checkbox'},
	                {type:'numbers',title:'序号',width: 60},
	                {field:'stockTakePlanCode',title: '盘点计划编号', width:'10%'},
	                {field:'planStartTime',title: '盘点计划开始时间', width:'12%'},
	                {field:'planEndTime',title: '盘点计划结束时间', width:'12%'},
	                {field:'warehouseName',title: '库存列表', width:'12%'},
	                {field:'stockTakeType', title: '盘点类型', width:'8%'},
	                {field:'procetCode', title: '项目号', width:'8%'},
	                {field:'status', title: '当前状态',width:'10%'},
	                {field:'userName', title: '创建人', width:'8%'},
	                {field:'repeatDay', title: '盘点周期', width:'8%'},
	                {fixed:'right',align:'center',title:'操作', width:'20%',toolbar:'#toolBar'}
	                ]],
	            page: {theme: '#008155'},
	            height: 'full-150',
	            even:true,
	            done:function(res,page,count){//列表数据回调函数
	                initTableDate(res.data) ;
	                getStockTakePlanTypeList();
	                form.render(null,"takePlanSearchFrom");
	            }
	        });

	     $('.layui-btn-container button').on('click', function(){
	            var othis = $(this), method = othis.data('method');
	            active[method] ? active[method].call(this, othis) : '';
	      });


		//时间选择器
	     laydate.render({
	         elem: '#startTime',
	         range: false
	     });
	     laydate.render({
	         elem: '#endTime',
	         range: false
	     });
		var active = {
			search:function(othis){

				var startTime =$('#startTime').val();
				var endTime =$('#endTime').val();

				if(startTime!=""&&endTime!=""){
					if(startTime >endTime){
						layer.alert('开始时间不能大于结束时间！',{icon: 2});
	                    return ;
					}
				}

				var warehouseName = "";
         		var warehouseNameArray = layui.formSelects.value('select4', 'val');
         		for(var i=0;i<warehouseNameArray.length;i++){
         			warehouseName +=warehouseNameArray[i]+"|"
         		}
         		if(warehouseName != ""){
         			warehouseName = warehouseName.substring(0,warehouseName.length-1);
         		}

				//执行重载
				table.reload('stockTakePlanTabId', {
					where:{
						startTime : $('#startTime').val(),
						endTime : $('#endTime').val(),
						stockTakePlanCode:$('#stockTakePlanCode').val(),
						stockTakeType:$('#stockTakeType').val(),
						procetCode:$('#procetCode').val(),
						warehouseName:warehouseName,
						status:$('#status').val()
				  	}
				});
			},
			reset:function(othis){
				 $('#startTime').val('');
                 $('#endTime').val('');
                 $('#stockTakePlanCode').val('');
                 $('#stockTakeType').val('');
                 $('#procetCode').val('');
                 layui.formSelects.value('select4', []);
                 $('#status').val('-1');
				form.render("select");
			},
			add:function(othis){
				var type = othis.data('type');
	  			layer.open({
			        type: 2
			        ,title:'新增盘点计划'
			        ,maxmin:false
			        ,area: ['100%', '100%']
			        ,id: 'dataServiceAdd'+type //防止重复弹出
			        ,content: '/iles/pages/wms/store/stockCheck/checkPlanAdd.html'
			        ,yes: function(){
				         layer.closeAll();
			        }
		      	});
			},


		};

		  table.on('tool(stockTakePlanTabF)', function(obj){
              var eventName = obj.event;          //事件名称
              var clickObj = $(obj.tr[0]);        //当前对象tr

              if(eventName=="detail"){    //详情
                  $("#pid").val(obj.data.id);
                  layer.open({
                      type: 2,
                      title:'详情',
                      offset:'auto',
                      maxmin:true,
                      area: ['100%', '100%'],
                      id: 'storeCheckPlanDetail', //防止重复弹出
                      content: '/iles/pages/wms/store/stockTakeDetailList.html',
                      yes: function(){
                        layer.closeAll();
                      }
                  });
              }

              if(eventName=="report"){
            	  $("#pid").val(obj.data.id);
            	  layer.open({
            	      type: 2,
            	      title: '',
            	      area: ['70%', '90%'],
            	      id: 'stockTakeRepor',
            	      shadeClose: true, //点击遮罩关闭
            	      content: '/iles/pages/wms/store/stockTakeReport.html'
            	    });
              }

		  });

		//表格数据初始化
	    function initTableDate(data){
	        $("[data-field='status']").children().each(function(){
	        	if($(this).text()=='0'){
	                $(this).text('未开始');
	            }else if($(this).text()=='1'){
	                $(this).text('盘点中');
	            }else if($(this).text()=='2'){
                    $(this).text('已结束未完成');
                }else if($(this).text()=='3'){
                    $(this).text('已结束已完成');
                }
	        });

	        $("[data-field='repeatDay']").children().each(function(){

        		if($(this).text()=='盘点周期'){
	                $(this).text('盘点周期');
	            }else if($(this).text()<'7'){
	                $(this).text($(this).text()+'天');
	            }else if($(this).text()%7==0){
	                $(this).text($(this).text()/7+'周');
	            }else if($(this).text()%31==0){
                    $(this).text($(this).text()/31+'月');
                }else if($(this).text()%93==0){
                    $(this).text($(this).text()/92+'季度');
                }else if($(this).text()%365==0){
                    $(this).text($(this).text()/365+'年');
                }else{
                	 $(this).text($(this).text()+'天');
                }
	        });
	    }

	    function getStockTakePlanTypeList(){
            var option = {
                url: contextPath +'storeCheck/queryDictItemsByType',
                type:'POST',
                contentType:'application/json',
                success:function(data){
                    if(data.code==0){
                      var typeList = data.data;
                      var html ='<option value="">请选择</option>';
                      for(var i =0;i<typeList.length;i++){
                          html +=' <option value="'+typeList[i].itemName+'">'+typeList[i].itemName+'</option>';
                      }
                      $("#stockTakeType").html(html);
                      form.render();//重新渲染
                    }else{
                        layer.alert(data.data);
                    }
                },error:function(data){
                    layer.alert(data.msg)
                }
            }
            $.ajax(option);
        }

	    function getWarehouse(){//仓库
	    	$.ajax({
	    		url: contextPath +"distributionTask/getUnStataionWarehouse",
	    		type:"post",
	    		success:function(result){
	    			$('#warehouseName').html("");
	    			$('#warehouseName').append('<option value="">请选择</option>');
	          	  	var order = result.data;
	    			if(order && order.length>0){
	    			var optionItem;
	    			var optoinArray = new Array();
	    				for(var i=0;i<order.length;i++){
	    				optionItem = {"name":""+order[i], "value":""+order[i]};
	    				optoinArray.push(optionItem);
	    				}
	    				layui.formSelects.data('select4','local',{
	    					arr:optoinArray
	    				});
	    			}
	    		}
	    	});
	    }

	});
}
	</script>

	<script type="text/html" id="toolBar">
        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看详情</a>
		{{# if(d.status>1){ }}
			<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="report">盘点报告</a>
		{{# } }}
    </script>
</body>
</html>
