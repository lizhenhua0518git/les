<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>异常管理</title>
	<meta name="renderer" content="webkit|ie-comp|ie-stand">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	<meta http-equiv="Cache-Control" content="no-siteapp" />
	<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
	<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  type="text/css" />
</head>
<body>
<div id="bodyDiv">

</div>
<script type="text/html" id="bodyTpl">
<div class="layui-fluid">
	<div class="layui-row" style="height:8px;">&nbsp;</div>
	 <input type="text"  id="transferBinId" hidden="true" />
	     <div class="layui-row layui-form">
			<div class="layui-col-md2">
                <label class="layui-form-label">异常类型:</label>
                 <div class="layui-input-block">
                   <select name="abnormalType" id="abnormalType" class="layui-select">
                        <option value="">请选择</option>
                        <option value="包括转储单消失/损坏">包括转储单消失/损坏</option>
                        <option value="仓位编码/物料扫描失败">仓位编码/物料扫描失败</option>
                          <option value="其他">其他</option>
                    </select>
                </div>
            </div>
            <div class="layui-col-md2">&nbsp;</div>
            <!--<div class="layui-col-md8">-->
				<div class="layui-btn-container nav-" style="text-align: right;">
					{{# if(d.search==null || d.search=="true"){ }}
             	 		<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
              			<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" id="reset" type="button"><i class="layui-icon  layui-icon-reset"></i>重置</button>
              		{{# } }}
				</div>
			<!--</div>-->
	</div>
</div>
<table id="stockAbnormal" lay-filter="stockAbnormalTabF"></table>
</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script type="text/javascript">
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form;
		var laydate = layui.laydate;
		var oldData;
		var contextPath = config.wmsConfig.contextPath;
		var active = {
				search:function(othis){

					//执行重载
				table.reload('stockAbnormalTabId', {
					where:{
						abnormalType :$('#abnormalType').val(),

					},

						page : {
							"curr" : 1
						}

				});
			},
			reset:function(othis){
				 $('#abnormalType').val('');

				form.render("select");
			}
		};
	    function loadding(){
	    	//时间选择器
		     laydate.render({
		         elem: '#startTime',
		         range: false
		     });
		     laydate.render({
		         elem: '#endTime',
		         range: false
		     });
	    	table.render({
				elem:'#stockAbnormal',
				id:'stockAbnormalTabId',
		    	url:contextPath+'stockAbnormal/queryStockAbnormal',
		    	where:{status:-1},
			    cols: [[
					/* {type:'checkbox'}, */
					 {type:'numbers',title:'序号',width: 60},
					 {field:'stockTakePlanCode',title:'盘点编号',width: '12%'},
					 {field:'positionCode',title:'仓位',width: '12%'},
				    {field:'materialCode',title: '物料号', width: '12%'},
				    {field:'materialDesc',title: '物料名称',width: '12%', sort: true},
				    {field:'abnormalType', title: '异常类型', width: '14%'},
				    {field:'abnormalDesc',title: '异常描述', width: '16%'},
				    {field:'status',title: '状态', width: '10%'},

				    {fixed:'right',align:'center',title:'操作', toolbar:'#toolBar',width:'8%'}

			    	]],


				page: {theme: '#008155'},
				height: 'full-95',
	    		even:true,
	    		done:function(res,page,count){//列表数据回调函数
	    			initTableDate(res.data) ;
	    		}
			});
	    	table.on('tool(stockAbnormalTabF)', function(obj){
	              var eventName = obj.event;          //事件名称
	              var clickObj = $(obj.tr[0]);        //当前对象tr
	              var id= obj.data.id;
	              var stockTakeDetailId= obj.data.stockTakeDetailId;
	              if(eventName=="deal"){    //处理
	            	  if(obj.data.status==1){
	            		  layer.msg("不能重复处理！");
	            		  return;
	            	  }
	            	  layer.confirm('确定处理该异常吗？', {icon: 3, title:'提示'}, function(index){
	            		  var option ={
	                              url:contextPath+'stockAbnormal/dealStockAbnormal',
	                              type:'POST',
	                              //contentType: "application/json",
	                               dataType:'json',
	                              data:{"stockTakeDetailId":stockTakeDetailId,"id":id},
	                              success:function(data){
	                                  if(data.code==0){
	                                      layer.msg("处理成功");
	                                      table.reload('stockAbnormalTabId');//刷新列表
	                                  }
	                              },error:function(data){
	                                  layer.alert(data.msg);
	                              }
	                          }
	                          $.ajax(option);
	  	  			});

	              }
			  });
			$('.layui-btn-container button').on('click', function(){
			    var othis = $(this), method = othis.data('method');
			    active[method] ? active[method].call(this, othis) : '';
		  	});
			form.render('select');
	    }
		//表格数据初始化
	    function initTableDate(data){


	    	$("[data-field='status']").children().each(function(){
	            if($(this).text()=='0'){
	                $(this).text('未处理');
	            }else {
                    $(this).text('处理');
                }
	        });

	    }
	</script>
<script type="text/html" id="toolBar">
        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="deal">处理</a>
</script>
</body>
</html>
