<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Content-Type" content="charset=UTF-8">
<meta name="viewport"
    content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<title>匹配库存</title>
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" type="text/css" href="/iles/pages/fonts/icomoon/style.css"/>
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
</head>
<body id="bodyDiv">
<script type="text/html" id="bodyTpl">
<div class="layui-fluid">
	<div class="layui-row layui-form">
		<div class="layui-col-md2">
			 	<label class="layui-form-label">生产日期:</label>
			 	 <div class="layui-input-block">
			      <input type="text" class="layui-input"  id="requiredTime_search" placeholder="请选择生产时间">
			    </div>
		</div>
		<div class="layui-col-md2">
			 	<label class="layui-form-label">车间:</label>
			 	  <div class="layui-input-block">
 					<select  id="workshopCode_search"  xm-select="workshopCode_search" xm-select-show-count="1" >
			        	<option value="">请选择</option>
			      	</select>
                </div>
		</div>
		<div class="layui-col-md2">
			<label class="layui-form-label">产线:</label>
			 	 <div class="layui-input-block">
			        <select  id="lineCode_search"  xm-select="lineCode_search" xm-select-show-count="1">
			        	<option value="">请选择</option>
			      	</select>
			    </div>
		</div>
		<div class="layui-col-md2">
			 	<label class="layui-form-label">工位:</label>
			 	 <div class="layui-input-block">
			        <select  id="stationCode_search" xm-select="stationCode_search" xm-select-show-count="1">
			        	<option value="">请选择</option>
			      	</select>
			    </div>
		</div>
		
		<div class="layui-col-md2">
			<div class="layui-col-md2">
			<label class="layui-form-label">仓库:</label>
			 	 <div class="layui-input-block">
			        <select  id="storageLocation_search" lay-filter="storageLocationFilter" xm-select="storageLocationSelect" xm-select-show-count="1">
			        	<option value="">请选择</option>
			      	</select>
			    </div>
			</div>
		</div>
		<div class="layui-btn-container" style="text-align: right;">
			{{# if(d.search==null || d.search=="true"){ }}
				<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
				<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset"  id="reset" type="button"><i class="layui-icon mine-icon icon-reset"></i>重置</button>
			{{# } }}
		</div>
	</div>
</div>
<div class="layui-fluid-table">
<div class="layui-row layui-form" style="margin-bottom: 0">
		<div class="layui-btn-container" style="text-align: left;">
             <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="match" type="button"><i class="layui-icon layui-icon-util"></i>开始匹配</button>
         </div>
	</div>
<table class="layui-hide" id="orderInfoTab" lay-filter="orderInfoTabF"></table> 
</div>
</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
<script type="text/javascript">
var table = layui.table;
var laydate = layui.laydate;
var contextPath = config.omsConfig.contextPath;
var active = {
		search:function(othis){
			var workshopCode = layui.formSelects.value('workshopCode_search', "valueStr");
			var lineCode = layui.formSelects.value('lineCode_search', "valueStr");
			var stationCode = layui.formSelects.value('stationCode_search', "valueStr");
			var storageLocation = layui.formSelects.value('storageLocationSelect', "valueStr");
			var requiredTime = $('#requiredTime_search').val();
			if(!workshopCode || workshopCode==''){
				layer.alert("请选择车间");
				return false;
			}
			if(!lineCode || lineCode==''){
				layer.alert("请选择产线");
				return false;
			}
			if(!storageLocation || storageLocation==''){
				
				layer.alert("请选择仓库");
				return false;
			}
			// if(!requiredTime || requiredTime==''){
			// 	layer.alert("请选择生产日期");
			// 	return false;
			// }
			table.reload("orderInfoTabId",{
				url:contextPath + 'processOrder/listAllProcessOrder',
				where:{
					workshopCode:workshopCode,
					lineCode:lineCode,
					stationCode:stationCode,
					storageLocation:storageLocation,
					requiredTimeStr:requiredTime,
				}
			});
			
		},
		reset:function(othis){
			layui.formSelects.value('workshopCode_search', []);
			layui.formSelects.value('lineCode_search', []);
			layui.formSelects.value('stationCode_search', []);
			$('#requiredTime_search').val("");
			layui.formSelects.value('storageLocationSelect', []);
		},
		match:function(othis){
			var checkStatus = table.checkStatus('orderInfoTabId');
			var oldData = checkStatus.data;
			if (oldData.length <= 0) {
				layer.alert('请选择要匹配的订单！', {
					icon : 2
				});
				return;
			}
			var ids = new Array();
			for(var i=0;i<oldData.length;i++){
				ids.push(oldData[i].id);
			}
			var param = {};
			param.ids = ids;
			var option = {
					url:contextPath+'processOrderDetail/matchStock',
					data:JSON.stringify(param),
					contentType:"application/json",
					type:"POST",
					dataType:"json",
					success:function(res){
						if(res.code==0){
							layer.alert("库存匹配成功");
							table.reload("orderInfoTabId");
						}else{
							layer.alert(res.data);	
						}
						
						
					},error:function(res){
						layer.alert("库存匹配失败")
					}
			};
			$.ajax(option);
		}
};
function loadding(){
	table.render({
		elem:'#orderInfoTab',
		id:'orderInfoTabId',
		url:contextPath + 'processOrder/listAllProcessOrder',
		where :{businessType:3},
		cols:[[
		{type:'checkbox'},
		{type:'numbers',title:'序号',width: 60},
		{field:'orderCode',title:'订单号'},

		{field:'vinCode',title:'vin号'},
		{field:'workShopName',title:'车间'},
		{field:'lineName',title:'产线'},
		{field:'stationName',title:'工位'},
		{field:'createTime',title:'创建时间'},
		{field:'requiredTime',title:'生产日期',templet(d){
			if(d.requiredTime!=null&&d.requiredTime!=''){
				return d.requiredTime.substring(0,10);
			}else{
				return '-';
			}
			}},

		{
				field : 'warehouseName',
				title : '仓库'
		}]],
		page: false,
   		even:true
	});

	//创建时间区间
 	laydate.render({
	    elem: '#requiredTime_search',
	    range: true
	});
 	inintPlantMultiSelect("workshopCode_search", [], 2);
	inintPlantMultiSelect("lineCode_search", [], 3);
	inintPlantMultiSelect("stationCode_search", [], 4);
	initWarehouseMultiSelect("storageLocation_search","storageLocationSelect",0,'');
	$('.layui-btn-container button').on('click', function() {
		var othis = $(this), method = othis.data('method');
		active[method] ? active[method].call(this, othis) : '';
	});
}
</script>
</body>

</html>