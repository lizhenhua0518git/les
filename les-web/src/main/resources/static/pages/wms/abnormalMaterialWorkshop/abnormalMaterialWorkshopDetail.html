<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Content-Type" content="charset=UTF-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"
	type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"
	type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
<title>补料详情</title>
</head>
<body id="bodyDiv">
	<script type="text/html" id="bodyTpl">

		<div class="layui-fluid-table">
			<div class="layui-row layui-form">
				<div class="layui-btn-container">
					<button class="layui-btn layui-btn-normal layui-btn-sm" data-method="distributing" type="button"><i
							class="layui-icon layui-icon-edit"></i>任务派发
					</button>
				</div>
			</div>
			<table class="layui-hide" id="stationOrderTab" lay-filter="stationOrderTabF"></table>
		</div>
	</script>
	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
	<script type="text/javascript">
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form;
		var laydate = layui.laydate;
		var oldData;
		//上个页面的补料订单详情数据
		var processOrderDetailData =parent.processOrderDetailData;
		var contextPath = config.omsConfig.contextPath;
		var active = {

			distributing : function(othis) {
				var checkStatus = table.checkStatus('stationOrderTabId');
				oldData = checkStatus.data;
				var idarrys = new Array();

				if(oldData.length <=0) {
					layer.alert('请选择需要派发的订单！', {
						icon: 2
					});
					return;
				}
				if(oldData[0].status !=0) {
					layer.alert('请选择未派发的订单！', {
						icon: 2
					});
					return;
				}
				for(var i=0;i<oldData.length;i++){
					idarrys.push(oldData[i].id);
				}
				var type = othis.data('type');
				layer.confirm('已选中'+oldData.length+'条数据，确认派发?', {icon: 3, title:'提示'}, function(index){
					var option ={
						url:contextPath+'stationOrder/taskStationOrder',
						type:'POST',
						contentType: "application/json",
						dataType:'json',
						data:JSON.stringify(idarrys),
						success:function(data){
							if(data.code==0){
								layer.alert('任务已下发,可以拣料了', {
									icon: 1
								});
								layer.close(index);
							}else{
								layer.alert('任务下发失败');
							}
							table.reload('stationOrderTabId');
						},error:function(data){
							layer.alert(data.msg);
						}
					}
					$.ajax(option);
					layer.close(index);
				});
			}

		};

		function loadding() {
			var params = {};

			params.busiTypeCodes ='3';
			//状态等于待派发
			// params.status = 0;
			params.processDetailId=processOrderDetailData.processDetailId;
			table.render({
				elem : '#stationOrderTab',
				id : 'stationOrderTabId',
                url : contextPath + 'stationOrder/listStationOrder',
               // where :{"orderCode":processOrderDetailData.orderCode,"materialCode":processOrderDetailData.materialCode,},
				cols : [ [ {
					type : 'checkbox'
				}, {
					field : 'taskcode',
					title : '补料任务号'
				}, {
					field : 'stationCode',
					title : '工位'
				}, {
					field : 'warehouseName',
					title : '仓库'
				},  {
					field : 'materialCode',
					title : '物料号'
				},{
					field : 'materialDesc',
					title : '物料描述'
				}, {
					field : 'positionCode',
					title : '库位'
				}, {
					field : 'pickNum',
					title : '下架数量'
				}, {
					field : 'statusStr',
					title : '派发状态'
				},{
					field : 'isOffShelf',
					title : '是否已下架'
				},{
					field : 'specialName',
					title : '特殊库存标识'
				} ] ],
				page : {
					theme: '#008155'
				},
				even : true,
				where : params,
				done : function(res, page, count) {//列表数据回调函数
					initWarehouseSignSelect("warehouse_search", 1);
					form.render(null, "storageLocationSearchForm");
				}
			});
			$('.layui-btn-container button').on('click', function() {
				var othis = $(this), method = othis.data('method');
				active[method] ? active[method].call(this, othis) : '';
			});
			//时间选择器
			laydate.render({
				elem : '#requiredTime_search',
				type : 'date',
				range : true
			});
			inintPlantMultiSelect("workshopCode_search", [], 2);
			inintPlantMultiSelect("lineCode_search", [], 3);
			initWarehouseMultiSelect("storageLocation_search","storageLocationSelect",0,'');
			inintPlantMultiSelect("stationCodeSelect", [], 4);//工位
		}
		//监听启用操作
		form.on('switch(statusValue)', function(obj) {
			var status = '0';
			if (obj.elem.checked) {
				status == '1';
			}
			updateStatus(this.value, status);
		});

		 function initStationCode(){//工位
		    	$.ajax({
		    		url:config.basicInfoConfig.contextPath+"stationManager/getAllStationCode",
		    		type:"GET",
		    		success:function(result){
		    			$('#stationCode_search').html("");
		    			$('#stationCode_search').append('<option value="">请选择</option>');
		          	  	var order = result.data;
		    			if(order && order.length>0){
		    			var optionItem;
		    			var optoinArray = new Array();
		    				for(var i=0;i<order.length;i++){
		    				optionItem = {"name":""+order[i].stationCode, "value":""+order[i].stationCode};
		    				optoinArray.push(optionItem);
		    				}
		    				layui.formSelects.data('stationCodeSelect','local',{
		    					arr:optoinArray
		    				});
		    			}
		    		}
		    	});
		    }
	</script>
</body>
</html>
