<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Content-Type" content="charset=UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css" type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css" type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
<title>生产退补料(不合格品)</title>
</head>
<script type="text/html" id="ckToolBar">
<!--   出库  -->
	{{# if(d.processId != '' &&  d.processStatus > 0 ){ }}
	<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="ckDetail">查看详情</a>
	{{# } }}
</script>
<script type="text/html" id="rkToolBar">
<!--    入库    -->
	{{# if(d.receiveNum != '' && d.receiveNum != null){ }}
	<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="rkDetail">查看详情</a>
	{{# } }}
</script>
<body id="bodyDiv">
	<script type="text/html" id="bodyTpl">
	<div class="layui-fluid" >
		<input id="materialCode" hidden>
		<input id="pid" hidden>
		<div class="layui-row layui-form">
			<div class="layui-col-md2">
				<label class="layui-form-label">任务号</label>
				<div class="layui-input-inline">
					<input type="text" id="taskCode_search" class="layui-input" placeholder="请输入退补料任务号">
				</div>
			</div>
			<div class="layui-col-md2">
				<label class="layui-form-label">订单号</label>
				<div class="layui-input-inline">
					<input type="text" id="orderCode_search" class="layui-input" placeholder="请输入生产订单号">
				</div>
			</div>
			<div class="layui-col-md2">
				<label class="layui-form-label">物料号</label>
				<div class="layui-input-inline">
					<input type="text" id="materialCode_search" class="layui-input" placeholder="请输入物料号">
				</div>
			</div>
			<div class="layui-col-md2" >
				<label class="layui-form-label" style="width: 100px;">点收任务是否派发</label>
				<div class="layui-input-inline">
					<select  id="taskDispatch" lay-filter="taskDispatch" xm-select="taskDispatch"  xm-select-radio>
						<option value="">请选择</option>
<!--						<option value="0">未派发</option>-->
<!--						<option value="1">已派发</option>-->
					</select>
				</div>
			</div>
		</div>
		<div class="layui-row layui-form">
			<div class="layui-col-md2">
				<label class="layui-form-label">条件搜索</label>
				<div class="layui-input-inline">
					<!--仓库不与车间产线工位关联-->
					<select  id="storageLocation_search" lay-filter="storageLocationFilter" xm-select="storageLocationSelect" xm-select-show-count="1">
						<option value="">请选择仓库</option>
					</select>
				</div>
				<div class="layui-input-inline">
					<select  id="workshopCode_search"  xm-select="workshopCode_search" xm-select-show-count="1" >
						<option value="">请选择车间</option>
					</select>
				</div>
				<div class="layui-input-inline">
					<select  id="lineCode_search"  xm-select="lineCode_search" xm-select-show-count="1">
						<option value="">请选择产线</option>
					</select>
				</div>
				<div class="layui-input-inline">
					<select  id="stationCode_search"  xm-select="stationCode_search" xm-select-show-count="1">
						<option value="">请选择工位</option>
					</select>
				</div>
			</div>

			<!--			<div class="layui-col-md2">-->
			<!--				<label class="layui-form-label">车间</label>-->
			<!--				<div class="layui-input-inline">-->
			<!--					<select  id="workshopCode_search"  xm-select="workshopCode_search" xm-select-show-count="1" >-->
			<!--						<option value="">请选择</option>-->
			<!--					</select>-->
			<!--				</div>-->
			<!--			</div>-->

			<!--			<div class="layui-col-md2">-->
			<!--				<label class="layui-form-label">产线</label>-->
			<!--				<div class="layui-input-inline">-->
			<!--					<select  id="lineCode_search"  xm-select="lineCode_search" xm-select-show-count="1">-->
			<!--						<option value="">请选择</option>-->
			<!--					</select>-->
			<!--				</div>-->
			<!--			</div>-->
			<!--			<div class="layui-col-md2">-->
			<!--				<label class="layui-form-label">工位</label>-->
			<!--				<div class="layui-input-inline">-->
			<!--					<select  id="stationCode_search"  xm-select="stationCodeSelect" xm-select-show-count="1">-->
			<!--						<option value="">请选择</option>-->
			<!--					</select>-->
			<!--				</div>-->
			<!--			</div>-->


			<div class="layui-btn-container nav-" style="text-align: right;">
				{{# if(d.search==null || d.search=="true"){ }}
				<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
				<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" id="reset" type="button"><i class="layui-icon  mine-icon layui-icon-syncronize"></i>重置</button>
				{{# } }}
			</div>
		</div>
	</div>
	<div class="layui-fluid-table">
		<div class="layui-row layui-form">
			<div class="layui-btn-container">
				{{# if(d.dispatchPointTask==null || d.dispatchPointTask=="true"){ }}
				<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="dispatchPointTask" type="button"><i class="layui-icon layui-icon-add-circle"></i>点收任务派发</button>
				{{# } }}
				{{# if(d.match==null || d.match=="true"){ }}
				<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="match" type="button"><i class="layui-icon layui-icon-add-circle"></i>匹配库存</button>
				{{# } }}
			</div>
		</div>
		<table class="layui-hide" id="abnormalMaterialWorkshopBLTab" lay-filter="abnormalMaterialWorkshopBLTabF"></table>
	</div>
</script>
	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
	<script type="text/javascript">
		// var formSelects;
		// //加载模块
		// layui.use(['jquery', 'formSelects'], function(){
		// 	formSelects = layui.formSelects;
		// });
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form;
		var laydate = layui.laydate;
		var oldData;
		// var formSelects = layui.formSelects;
		var wmsContextPath = config.wmsConfig.contextPath;
		var  omsContextPath = config.omsConfig.contextPath;
		var active = {
			search : function(othis) {
				var taskCode = $('#taskCode_search').val();
				var orderCode = $('#orderCode_search').val();
				var taskDispatch = layui.formSelects.value('taskDispatch', 'valueStr');
				var workshopCode = layui.formSelects.value('workshopCode_search', 'valueStr');
				var lineCode = layui.formSelects.value('lineCode_search', 'valueStr');
				var stationCode = layui.formSelects.value('stationCodeSelect', 'valueStr');
				var materialCode = $('#materialCode_search').val();
				var storageLocation = layui.formSelects.value('storageLocationSelect', 'valueStr');
				var status = layui.formSelects.value('statusSelect', 'valueStr');
				var params = {};
				params.taskDispatch = taskDispatch;
				params.orderCode = orderCode;
				params.taskCode = taskCode;
				params.workShopCode = workshopCode;
				params.lineCode = lineCode;
				params.stationCode = stationCode;
				params.materialCode = materialCode;
				params.warehouseCodes = storageLocation;
				params.status=status;
				//执行重载
				table.reload('abnormalMaterialWorkshopBLTabId', {
					where : params,
				});
			},
			reset : function(othis) {
				$('#orderCode_search').val("");
				$('#taskCode_search').val("");
				layui.formSelects.value('workshopCode_search', []);
				layui.formSelects.value('lineCode_search', []);
				layui.formSelects.value('stationCodeSelect', []);
				$('#materialCode_search').val("");
				layui.formSelects.value('taskDispatch', []);
				$('#serialNum_search').val("");
				layui.formSelects.value('storageLocationSelect', []);
				layui.formSelects.value('statusSelect', []);
				form.render("select");
			},
			match:function(othis){//匹配库存
				var tableData = table.checkStatus('abnormalMaterialWorkshopBLTabId').data;
				if(tableData==null || tableData.length==0){
					layer.alert('请选择要匹配的物料！', {icon: 2});
					return;
				}
				//验证物料是否属于同一个仓库
				var wareHouseName_T;
				var warehouseCode_T;
				var storageLocation_T;
				var taskCode;
				var ids = new Array();
				var storageLocations = new Array();
				for (let i = 0; i < tableData.length; i++) {
					if (warehouseCode_T == null){
						wareHouseName_T = tableData[i].wareHouseName;
						warehouseCode_T = tableData[i].warehouseCode;
						storageLocation_T = tableData[i].storageLocation;
						taskCode = tableData[i].taskCode;
					}else {
						if (warehouseCode_T != null&&warehouseCode_T != tableData[i].warehouseCode){
							layer.alert('请选择属于同一个仓库下的物料！', {icon: 2});
							return;
						}if (taskCode != null && taskCode != tableData[i].taskCode) {
							layer.alert('请选择属于同一个任务单号匹配库存！', {icon: 2});
							return;
						}
					}
					if (tableData[i].processId != null ) {
						ids.push(tableData[i].processId);
					}
					storageLocations.push(tableData[i].storageLocation)
				}
				if (ids.length <= 0) {
					layer.alert('请选中已点收的单号派发！', {icon: 2});
					return;
				}
				var unMaterParam = {
					processIds:ids
				};

				layer.confirm('确定匹配'+ids.length+'个任务？', {icon: 3, title: '提示'}, function (index) {
					//do something
					var option = {
						url: omsContextPath + 'processOrderDetail/matchStock',
						type: 'POST',
						contentType: "application/json",
						dataType: 'json',
						data: JSON.stringify(unMaterParam),
						success: function (data) {
							if (data.code == 0) {
								layer.alert("匹配成功");
								table.reload('abnormalMaterialWorkshopBLTabId');
							}else{
								layer.alert("匹配失败");
								table.reload('abnormalMaterialWorkshopBLTabId');
							}
						}, error: function (data) {
							layer.alert(data.msg);
						}
					};
					$.ajax(option);
					layer.close(index);
				});
			},
			dispatchPointTask:function(othis){
				//点收任务派发
				var task = table.checkStatus('abnormalMaterialWorkshopBLTabId').data;
				if(task==null || task.length==0){
					layer.alert('请选择要派发的任务！', {icon: 2});
					return;
				}
				//验证物料是否属于同一个仓库
				var wareHouseName_T;
				var warehouseCode_T;
				var storageLocation_T;
				//验证是否属于同一个生产订单号
				var orderCode;
				var taskCode;
				var unMaterialList = new Array();
                for (let i = 0; i < task.length; i++) {
                	if ( task[i].taskDispatch ==1){
						layer.alert('请选择任务未派发的物料！', {icon: 2});
						return;
					}
                    if (warehouseCode_T == null){
                        wareHouseName_T = task[i].wareHouseName;
                        warehouseCode_T = task[i].warehouseCode;
                        storageLocation_T = task[i].storageLocation;
						orderCode= task[i].orderCode;
                    }else {
                        if (warehouseCode_T != null&&warehouseCode_T != task[i].warehouseCode){
                            layer.alert('请选择属于同一个仓库下的物料！', {icon: 2});
                            return;
                        }
						if (taskCode != null && taskCode != tableData[i].taskCode) {
							layer.alert('请选择属于同一个任务单号匹配库存！', {icon: 2});
							return;
						}
						if (orderCode != null&&orderCode != task[i].orderCode){
							layer.alert('请选择属于同一个生产订单号的物料！', {icon: 2});
							return;
						}
                    }

                    var unMaterial = {
                        id:task[i].id,
                        orderCode:task[i].orderCode,
                        factory:task[i].factory,
                        supplierName:task[i].supplierName,
						taskcode:task[i].taskCode
                    };
                    unMaterialList.push(unMaterial);
                }
                var unMaterParam = {
                    storageLocation:storageLocation_T,
                    warehouseCode:warehouseCode_T,
                    wareHouseName:wareHouseName_T,
                    unMaterialList:unMaterialList,
					billType:"4",
                };
                layer.confirm('是否派发任务?', {icon: 3, title: '提示'}, function (index) {
                    //do something
                    var option = {
                        url: wmsContextPath + 'abnormalMaterialWorkshop/saveReceiveTaskInfo',
                        type: 'POST',
                        contentType: "application/json",
                        dataType: 'json',
                        data: JSON.stringify(unMaterParam),
                        success: function (data) {
                            if (data.code == 0) {
                                layer.alert("派发任务成功");
                                table.reload('abnormalMaterialWorkshopBLTabId');
                            }else {
								layer.alert(data.msg);
							}
                        }, error: function (data) {
                            layer.alert(data.msg);
                        }
                    };
                    $.ajax(option);
                    layer.close(index);
                });
            }
		};

		function loadding() {
			table.render({
				elem: '#abnormalMaterialWorkshopBLTab',
				id: 'abnormalMaterialWorkshopBLTabId',
				url: wmsContextPath + 'abnormalMaterialWorkshop/findAbnormalMaterialOfTBL',
				where: {
					//3-物料更换
					abnormalCode: "3"
				},
				cols: [[{
					type: 'checkbox'
				}, {
					field: 'taskDispatch',
					title: '派发状态',
					width: '100',
					templet: function (d) {
						//0 未派发(默认) 1已派发
						return d.taskDispatch == "0" ? "未派发" : d.taskDispatch == "1" ? "已派发" : "";
					}
				}, {
					field: 'taskCode',
					title: '退补料任务号',
					width: '175'
				}, {
					field: 'orderCode',
					title: '生产订单号',
					width: '100'
				}, {
					field: 'onlineTime',
					title: '生产日期',
					width: '100'
				}, {
					field: 'workShopName',
					title: '车间',
					width: '100'
				}, {
					field: 'lineName',
					title: '产线',
					width: '100'
				}, {
					field: 'stationName',
					title: '工位',
					width: '100'
				}, {
					field: 'wareHouseName',
					title: '仓库',
					width: '100'
				}, {
					field: 'materialCode',
					title: '物料号',
					width: '111'
				}, {
					field: 'materialNum',
					title: '退料入库数量',
					width: '100'
				}, {
					field: 'materialUnit',
					title: '单位'
				}, {
					field: 'receiveNum',
					title: '点收数量',
					width: '100'
				}, {
					field: 'pointerName',
					title: '点收人',
					width: '100'
				}, {
					field: 'pointerTime',
					title: '点收时间',
					width: '100'
				}, {
					field: 'upStatus',
					title: '上架状态',
					width: '100',
					templet: function (d) {
						return d.upStatus == "0" ? "未上架" : d.upStatus == "1" ? "已上架" : "";
					}
				}, {
					field: '',
					title: '入库详情',
					toolbar: '#rkToolBar',
					width: '100'
				}, {
					field: '',
					title: '出库详情',
					toolbar: '#ckToolBar',
					width: '100'
				},]],
				page: {
					theme: '#008155'
				},
				even: true,
				done: function (res, page, count) {//列表数据回调函数
					//initWarehouseSignSelect("warehouse_search", 1);
					form.render(null, "storageLocationSearchForm");
				}
			});
			$('.layui-btn-container button').on('click', function () {
				var othis = $(this), method = othis.data('method');
				active[method] ? active[method].call(this, othis) : '';
			});

			table.on('tool(abnormalMaterialWorkshopBLTabF)', function (obj) {
				var eventName = obj.event;          //事件名称
				var clickObj = $(obj.tr[0]);        //当前对象tr

				if (eventName == "ckDetail") {    //出库详情
					var data = {
						pid:obj.data.processId,
						materialCode:obj.data.materialCode,
					};
					console.log("出库详情",data);
					$("#pid").val(obj.data.processId);
					$("#materialCode").val(obj.data.materialCode);
					layer.open({
						type: 2,
						title: '出库详情',
						offset: 'auto',
						maxmin: true,
						area: ['100%', '100%'],
						id: 'abnormalMaterialDetail', //防止重复弹出
						content: '/iles/pages/wms/productionMaterial/feedBackOutBound.html',
						yes: function () {
							layer.closeAll();
						}
					});
				}

				if (eventName == "rkDetail") {    //入库详情
					// $("#id").val(obj.data.id);
					oldData = obj.data;
					layer.open({
						type: 2,
						title: '入库详情',
						offset: 'auto',
						maxmin: true,
						area: ['100%', '100%'],
						id: 'abnormalMaterialPutBoundDetail', //防止重复弹出
						content: '/iles/pages/wms/productionMaterial/feedBackPutBound.html',
						yes: function () {
							layer.closeAll();
						}
					});
				}
			});
			inintPlantMultiSelect("workshopCode_search", [], 2);
			initWarehouseMultiSelect("storageLocation_search", "storageLocationSelect", 1, '');
			initStatus();
		}

		//将数字改成文字
		function changeItemName(data){
			//table列 紧急状态 回显汉字
			$("[data-field='statusStr']").children().each(function(i,e){
				if(i>0){
					if($(e).text()==1){
						$(e).css("color","red");
					}
				}
				for(var i=0;i<data.length;i++){
					if(data[i].dictTypeId=="status_str" && data[i].itemValue==$(this).text().trim()){
						$(this).text(data[i].itemName);
					}
				}
			});
		}
		//初始化派发状态下拉框
		function initStatus(){

			var optoinArray=[{name:'未派发',value:'0'},{name:'已派发',value:'1'}];
			formSelects.data("taskDispatch",'local',{
				arr:optoinArray
			});
		}
	</script>
</body>
</html>
