<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="charset=UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/layui.css" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="/iles/pages/css/layui_extend.css"/>
    <link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css"/>
    <title>报废物料详情列表</title>
</head>
<div id="bodyDiv">

</div>

<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/commonUtil.js" charset="UTF-8"></script>
<script type="text/html" id="toolBar">
    <a class="layui-btn layui-btn-xs" lay-event="edit" title="修改报废清单详情">修改</a>
</script>
<script type="text/html" id="bodyTpl">

    <form class="layui-form" action="" lay-filter="detailForm" style="margin-top: 20px">

        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">物料描述</label>
                <div class="layui-input-block">
                    <input type="text" name="materialDesc" id="materialDesc" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <a class="layui-btn layui-btn-xs click" lay-event="search" title="搜索库存物料" data-method="search" style="margin-bottom: 3px;">
                    <i class="layui-icon layui-icon-search"></i>
                </a>
            </div>
        </div>


        <div class="layui-fluid-table">
            <div class="layui-row layui-form">
                <div class="layui-btn-container">
                    <button class="layui-btn layui-btn-normal layui-btn-sm main_status_0 click" data-method="add" id="add" type="button"
                            title="添加"><i class="layui-icon layui-icon-add-circle"></i>添加
                    </button>
                    <button class="layui-btn layui-btn-normal layui-btn-sm main_status_0 click" data-method="delete" id="delete" type="button"
                            title="删除"><i class="layui-icon layui-icon-delete"></i>删除
                    </button>
                </div>
            </div>

            <table id="scrapDetailTab" lay-filter="scrapDetailTabF"></table>

        </div>

    </form>

</script>

<script type="text/javascript">
    var layer = layui.layer;
    var table = layui.table;
    var form = layui.form
    var oldData = parent.oldData;
    var wmsContextPath = config.wmsConfig.contextPath;

    var active = {
        /** 搜索 */
        search: function (othis) {
            debugger

            let materialDesc = $('#materialDesc').val()

            //执行重载
            table.reload('scrapDetailTabId', {
                where: {
                    materialDesc: materialDesc,
                    id: oldData.id,
                },
                page: {"curr": 1}
            });
        },
        /** 添加 */
        add: function (othis) {
            var type = othis.data('type');
            layer.open({
                type: 2
                , title: '添加报废物料'
                , maxmin: false
                , area: ['850px', '600px']
                , offset: type
                , id: 'scrap_detail_new' + type //防止重复弹出
                , content: '/iles/pages/wms/inventory/scrapSheet/detail/stockSheet.html'
                , shade: [0.8, '#393D49'] //显示遮罩
                , yes: function () {
                    layer.closeAll();
                }
            });
        },
        /** 删除 */
        delete: function (othis) {
            let task = table.checkStatus('scrapDetailTabId').data;
            if (task == null || task.length === 0) {
                layer.alert('请选择要删除的报废任务信息！', {icon: 2});
                return;
            }
            var list = [];
            for (let i = 0; i < task.length; i++) {
                debugger
                if (oldData.applicationStatus == 5){
                    layer.alert('任务状态错误:该报废任务已提交报废申请,不可删除', {icon: 2});
                    return;
                }
                list.push({
                    "id":task[i].id,
                    "binId":task[i].binId,
                    "scrapNum":task[i].scrapNum,
                });
            }
            let data = {
                "mainId":oldData.id,
                "list":list,
            };
            console.log(">>>>>删除data:", data);
            layer.confirm('是否删除所选的记录?', {icon: 3, title: '提示'}, function (index) {
                var option = {
                    url: wmsContextPath + 'discardMainPC/reportWasteDel',
                    type: 'POST',
                    contentType: "application/json",
                    dataType: 'json',
                    data: JSON.stringify(data),
                    success: function (data) {
                        if (data.code == 0) {
                            layer.alert("执行成功");
                            table.reload('scrapDetailTabId');
                        } else {
                            console.log(">>>>data", data);
                            layer.alert("执行失败");
                        }
                    }, error: function (data) {
                        console.error("错误>>>",data);
                        layer.alert("执行失败");
                    }
                };
                $.ajax(option);
                layer.close(index);
            });
        },

    };


    function loadding() {

        $('.click').on('click', function () {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });


        table.render({
            elem: '#scrapDetailTab',
            id: 'scrapDetailTabId',
            url: wmsContextPath + 'discardMainPC/detailPageResult',
            where: {id: oldData.id},
            cols: [[
                {type: 'checkbox',fixed:'left'},
                {type:'numbers',title:'序号',fixed: 'left'},
                {field: 'positionCode',  title: '仓位code码'},
                {field: 'materialCode',  title: '物料号'},
                {field: 'materialUnit',  title: '单位'},
                {field: 'materialDesc',  title: '物料描述'},
                {field: 'batchNo',  title: '批次号'},
                {field: 'scrapNum',  title: '报废数量'},
                {field: 'unitPrice',  title: '单价（元）'},
                {field: 'scrapAmount',  title: '报废总金额'},
                {field: 'causeOfFormation',  title: '形成原因'},
                {field: 'reasonForScrap',  title: '报废原因'},
                {field: 'technicalConfirmation',  title: '技术确认'},
                {field: 'logisticsConfirmation',  title: '物流确认'},
                {field: 'remark',  title: '备注'},

                // {align:'center',title: '操作', field:'operating',toolbar:'#toolBar',width:185,fixed: 'right'},
            ]],
            page: {theme: '#008155'},
            even: false,
            done: function (res, page, count) {//列表数据回调函数
                if(oldData.applicationStatus == 5){

                    $("[data-field='operating']").css('display','none');

                }
            }
        });

        //监听工具条
        table.on('tool(scrapDetailTabF)', function (obj) {
            var eventName = obj.event;
            var clickObj = obj.data;
            console.log("clickObj", clickObj);

            /** 报废物料数据修改 */
            if (eventName == "edit") {//详情
                oldData = obj.data;
                let title_2 = '';
                layer.open({
                    type: 2
                    , title: '报废物料数据修改'+title_2
                    , maxmin: true
                    , area: ['50%', '60%']
                    , offset: 2
                    , id: 'scrapDetailTabEdit' + 2 //防止重复弹出
                    , content: 'editSheet.html'
                    , shade: [0.8, '#fff'] //显示遮罩
                    , yes: function () {
                        layer.closeAll();
                    }
                });
            }
        });

        if (oldData) {

            console.log(">>>>>的oldData数据", oldData);

            /** 检查申请状态(禁用控件) */
            if (oldData.applicationStatus == 5) {
                $('.main_status_0').addClass("layui-btn-disabled").attr("disabled", true);
            }
        }

        form.render();
    }
</script>



</html>
