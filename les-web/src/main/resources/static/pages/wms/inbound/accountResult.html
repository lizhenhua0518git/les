<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Content-Type" content="charset=UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
<title>过账记录</title>
</head>
<div id="bodyDiv">

</div>
<script type="text/html" id="bodyTpl">
    <div class="layui-fluid" >
		<input type="text" id="taskId" hidden="true" />
        <div class="layui-row layui-form">

<!--			<div class="layui-col-md2">-->
<!--                <label class="layui-form-label">采购订单号</label>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="text" id="orderCode_search" class="layui-input" placeholder="请输入采购订单号">-->
<!--                </div>-->
<!--            </div>-->
<!--			<div class="layui-col-md2">-->
<!--                <label class="layui-form-label">物料编号</label>-->
<!--                <div class="layui-input-inline">-->
<!--                    <input type="text" id="materialCode_search" class="layui-input" placeholder="请输入物料编号">-->
<!--                </div>-->
<!--            </div>-->
            <div class="layui-col-md2">
			 	<label class="layui-form-label">过账状态</label>
			 	 <div class="layui-input-inline">
			       <select name="status_search" id="status_search">
						<option value="">请选择</option>
						<option value="1">成功</option>
						<option value="0">失败</option>
					</select>
			    </div>
			</div>
<!--			<div class="layui-col-md2">-->
<!--				<label class="layui-form-label">接口类型</label>-->
<!--				<div class="layui-input-inline">-->
<!--					<select name="account_type" id="account_type">-->
<!--						<option value="">请选择</option>-->
<!--						<option value="3">点收过账</option>-->
<!--						<option value="4">质检过账</option>-->
<!--					</select>-->
<!--				</div>-->
<!--			</div>-->


           <div class="layui-btn-container nav-">
					{{# if(d.search==null || d.search=="true"){ }}
             	 		<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
              			<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" id="reset" type="button"><i class="layui-icon  layui-icon-reset"></i>重置</button>
              		{{# } }}
			</div>

        </div>

    </div>
    <div class="layui-fluid-table">
<!--        <div class="layui-row layui-form">-->
<!--            <div class="layui-btn-container">-->
<!--                <button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="instockAccount" type="button"><i class="layui-icon layui-icon-edit"></i>过账</button>-->
<!--			</div>-->
<!--        </div>-->
        <table class="layui-hide" id="accountResultTab" lay-filter="accountResultTabF"></table>
    </div>
</script>
	<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
	<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>

	<script type="text/javascript">
		var element = layui.element;
		var layer = layui.layer;
		var table = layui.table;
		var form = layui.form;
		var laydate = layui.laydate;
		var oldData;
		var contextPath = config.wmsoptConfig.contextPath;
		var active = {
			instockAccount : function(othis) {
				var checkStatus = table.checkStatus('accountResultTabId');
				oldData = checkStatus.data;
				console.log(oldData);
				if (oldData.length <= 0) {
					layer.alert('请选择要过账的行项目！', {
						icon : 2
					});
					return;
				} else if (oldData.length > 1) {
					layer.alert('请选择一个行项目！', {
						icon : 2
					});
					return;
				}
				if(oldData[0].status!='0'){
					layer.alert('请选择失败的行项目！', {
						icon : 2
					});
					return;
				}
				instockAccount(oldData[0].id,oldData[0].accountType,oldData[0].taskId);
			},
			search : function(othis) {
				var orderCode = $('#orderCode_search').val();
				var materialCode = $('#materialCode_search').val();
				var status = $('#status_search').val();
				var accountType = $('#account_type').val();
				var params = {};
				params.orderCode = orderCode;
				params.materialCode = materialCode;
				params.status = status;
				params.accountType = accountType;
				//执行重载
				table.reload('accountResultTabId', {
					where : params,
				});
			},
			reset : function(othis) {
				$('#orderCode_search').val("");
				$('#materialCode_search').val("");
				$('#status_search').val("");
				$('#account_type').val("");
				form.render("select");
			}

		};

		function loadding() {
			table.render({
				elem : '#accountResultTab',
				id : 'accountResultTabId',
				url : contextPath + 'accountResult/listAccountResult',
				cols : [ [
					{type : 'checkbox'},
					{type : 'numbers',width:100,title : '序号'},
					{field : 'status',width:100,
						title : '过账状态',templet(d){
							if(d.status=='0'){
								return '失败';
							}else{
								return '成功';
							}
						}
					},
					{field : 'failDesc',title : '失败原因'},
					{field : 'createTime',width:200,title : '创建时间'},
					{field : 'accountType',width:150,title : '接口类型',
						templet(d){
							if (d.accountType == '3') {
								return '点收过账';
							}else if (d.accountType == '4') {
								return '质检过账';
							}
						}
					}
					// {align:'center',title: '操作',toolbar:'#toolBar',width:150,fixed: 'right'}
				] ],
				page : {
					theme : '#008155'
				},
				even : true,
				done : function(res, page, count) {//列表数据回调函数
				}
			});
			$('.layui-btn-container button').on('click', function() {
				var othis = $(this), method = othis.data('method');
				active[method] ? active[method].call(this, othis) : '';
			});
			//初始化过账状态下拉框
			queryDictItem('account_status', 'status', '');
			form.render("select");

			//监听工具条
			table.on('tool(accountResultTabF)', function(obj){
				var eventName = obj.event;
				var clickObj =obj.data;
				if(eventName=="detail"){	//详情
					var taskId =clickObj.taskId;
					//方便子页面取值
					$("#taskId").val(taskId);
					layer.open({
						type: 2
						,title:'入库接口调用详情'
						,maxmin:true
						,area: ['1650px', '700px']
						,offset: 2
						,id: 'appUserInfo'+2 //防止重复弹出
						,content: 'apiReceiveTask.html'
						,shade: [0.8, '#fff'] //显示遮罩
						,yes: function(){
							layer.closeAll();
						}
					});
				}
			});
		}
		function instockAccount(id,accountType,taskId) {
			let object = {
				id: id,
				accountType:accountType,
				taskId:taskId
			}
			var option = {
				url: contextPath+'accountResult/instockAccount',
				type: 'POST',
				contentType: "application/json",
				dataType: 'json',
				data: JSON.stringify(object),
				success: function (data) {
					if (data.code == 0) {
						layer.alert("过账成功");
					}
				}, error: function (data) {
					layer.alert(data.msg);
				}
			}
			$.ajax(option);
		}
	</script>

</html>
