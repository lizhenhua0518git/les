<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="renderer" content="webkit|ie-comp|ie-stand">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta http-equiv="Content-Type" content="charset=UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	<meta http-equiv="Cache-Control" content="no-siteapp" />
	<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
	<link rel="stylesheet" type="text/css" href="/iles/pages/css/layui_extend.css"/>
	<link rel="stylesheet" href="/iles/pages/layui/css/formSelects-v4.css" />
</head>
 <div id="bodyDiv">

</div>
<script type="text/html" id="bodyTpl">
<div class="layui-fluid">
	<div class="layui-row layui-form">
        <input type="text" id="transferBinId" hidden="true" />
		<div class="layui-col-md2">
			<label class="layui-form-label">收货任务号:</label>
			<div class="layui-input-inline">
				<input type="text" id="arrivalCode" class="layui-input">
			</div>
		</div>
		<div class="layui-col-md2">
			<label class="layui-form-label">仓库名称</label>
			<div class="layui-input-inline">
				<select id="warehouseCode" xm-select="warehouseCodeSelect" xm-select-show-count="1">
					<option value="">请选择</option>
				</select>
			</div>
		</div>
		<div class="layui-col-md2">
			<label class="layui-form-label">客户名称</label>
			<div class="layui-input-inline">
				<select id="clientName" xm-select="clientManageSelect" xm-select-show-count="1">
					<option value="">请选择</option>
				</select>
			</div>
		</div>
		<div class="layui-btn-container nav-" style="text-align: right;">
			{{# if(d.search==null || d.search=="true"){ }}
				<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="search" id="search" type="button"><i class="layui-icon layui-icon-search"></i>查询</button>
				<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="reset" id="reset" type="button"><i class="layui-icon  layui-icon-reset"></i>重置</button>
			{{# } }}
		</div>
	</div>
</div>
<div class="layui-fluid">
	<div class="layui-row layui-form">
		<div class="layui-btn-container">
			{{# if(d.add==null || d.add=="true"){ }}
			<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="add" data-type="auto" type="button"><i class="layui-icon  layui-icon-add-circle"></i>增加</button>
			{{# } }}
			{{# if(d.del==null || d.del=="true"){ }}
			<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="del" type="button"><i class="layui-icon layui-icon-delete"></i>删除</button>
			{{# } }}
			{{# if(d.edit==null || d.edit=="true"){ }}
			<button class="layui-btn layui-btn-normal layui-btn-sm"  data-method="edit" type="button"><i class="layui-icon layui-icon-edit"></i>下发</button>
			{{# } }}
		</div>
	</div>
</div>
<table id="arriveManageTab" lay-filter="arriveManageTabF"></table>
</script>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/warehouseSelect.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/dictSelelct.js" charset="UTF-8"></script>
<script src="/iles/pages/js/common/clientManage.js" charset="UTF-8"></script>
<script type="text/html" id="indexTpl">
	{{d.LAY_TABLE_INDEX+1}}
</script>
<script type="text/javascript">
	var wmsContextPath = config.wmsConfig.contextPath;
	var layer = layui.layer;
	var table = layui.table;
	var form = layui.form;
	var oldData;//用于编辑时传递参数
	var active = {
		add:function(othis){
			var type = othis.data('type');
			layer.open({
				type: 2
				,title:'新增送货单'
				,maxmin:true
				,area: ['800px', '450px']
				,offset: type
				,id: 'arriveNoticeAdd'+type //防止重复弹出
				,content: 'arriveNoticeAdd.html'
				,shade: 0 //不显示遮罩
				,yes: function(){
					layer.closeAll();
				}
			});
		},
		edit:function(othis){
			var checkStatus = table.checkStatus('arriveManageTabId');
			oldData = checkStatus.data;
			if(oldData.length<=0){
				layer.alert('请选择要下发的行！',{icon: 2});
				return ;
			}else if(oldData.length >1){
				layer.alert('下发不能超过多行！',{icon: 2});
				return ;
			}
			var idarrys = new Array();
			for(var i=0;i<oldData.length;i++){
				idarrys.push(oldData[i].arrivalNoticeId);
			}
			layer.confirm('确定下发该条资源信息?', {icon: 3, title:'提示'}, function(index){
				//do something
				var option ={
					url:wmsContextPath+'arrivalPC/issueArriveNotice',
					type:'POST',
					contentType: "application/json",
					dataType:'json',
					data:JSON.stringify(idarrys),
					success:function(data){
						if(data.code==0){
							layer.alert("下发成功");
							table.reload('arriveManageTabId');
						}else if (data.code==-1) {
							layer.alert(data.data);
							table.reload('arriveManageTabId');
						}
					},error:function(data){
						layer.alert(data.msg);
					}
				}
				$.ajax(option);
				layer.close(index);
			});
		},
		del:function(othis){
			var checkStatus = table.checkStatus('arriveManageTabId');
			oldData = checkStatus.data;
			if(oldData.length<=0){
				layer.alert('请选择要删除的行！',{icon: 2});
				return ;
			}
			var idarrys = new Array();
			for(var i=0;i<oldData.length;i++){
				idarrys.push(oldData[i].arrivalNoticeId);
			}
			layer.confirm('确定删除该条资源信息?', {icon: 3, title:'提示'}, function(index){
				//do something
				var option ={
					url:wmsContextPath+'arrivalPC/deleteArriveNotice',
					type:'POST',
					contentType: "application/json",
					dataType:'json',
					data:JSON.stringify(idarrys),
					success:function(data){
						if(data.code==0){
							layer.alert("删除成功");
							table.reload('arriveManageTabId');
						}
					},error:function(data){
						layer.alert(data.msg);
					}
				}
				$.ajax(option);
				layer.close(index);
			});
		},
		search:function(othis){
			var  arrivalCode = $('#arrivalCode').val();//送货单号
			var clientName = layui.formSelects.value('clientManageSelect', 'valueStr');//客户名称
			var warehouseCode = layui.formSelects.value('warehouseCodeSelect', 'valueStr');//仓库编号
			//执行重载
			table.reload('arriveManageTabId', {
				where:{
					arrivalCode:arrivalCode,
					clientName:clientName,
					warehouseCode:warehouseCode
				}
			});
		},
		reset:function(othis){
			$('#arrivalCode').val("");
			layui.formSelects.value('warehouseCodeSelect', []);//仓库编号
			layui.formSelects.value('clientManageSelect', []);//客户名称
			form.render("select");
		}
	};
	function loadding(){
	    table.render({
			elem: '#arriveManageTab',
			id:'arriveManageTabId',
			url:wmsContextPath + 'arrivalPC/arrivalList',
			cols: [[
				{type: 'checkbox'},
				{field: 'arrivalCode', width: 200, title: '收货任务号',align:'center'},
				{field: 'warehouseCode', width: 150, title: '仓库编码',align:'center'},
				{field: 'warehouseName', width: 150, title: '仓库名称',align:'center'},
				{field: 'billName', width: 150, title: '单据类型名称',align:'center'},
				{field: 'clientName', width: 200, title: '客户名称',align:'center'},
				{field: 'responsible', width: 200, title: '经办人',align:'center'},
				{field: 'carCode', width: 200, title: '车牌号',align:'center'},
				{field: 'arrivalTime', width: 200, title: '到货时间',align:'center'},
				{field: 'createTime', width: 200, title: '创建时间',align:'center'},
				{align:'center',title: '操作',toolbar:'#toolBar',width:100,fixed: 'right'}
			]],
			page: {theme: '#008155'},
			where:{
				issueStatus:1
			},
			height: 'full-95',
			even: true,
			done: function (res, page, count) {//列表数据回调函数

			}
		});
		$('.layui-btn-container button').on('click', function () {
			var othis = $(this), method = othis.data('method');
			active[method] ? active[method].call(this, othis) : '';
		});
		initWarehouseMultiSelect("warehouseCode","warehouseCodeSelect","1",'');
		initClientManageList("clientManageSelect",[]);

		table.on('tool(arriveManageTabF)', function (obj) {
			var eventName = obj.event;
			var data = obj.data;
			var id = "arriveManageDetail";
			var url = "wms/inbound/arriveManageDetail.html?arrivalNoticeId=" + data.arrivalNoticeId;
			var currHeight = parent.$(document).height();
			if (eventName == "detail") {
				parent.element.tabDelete('indexTab', id);
				parent.element.tabAdd('indexTab', {
					title: "入库单明细",
					content: ' <iframe id="' + id + '" frameborder="0"  src="' + url + '" width="100%" height="' + currHeight + 'px"></iframe>',
					id: id //实际使用一般是规定好的id，这里以时间戳模拟下
				});
				parent.element.tabChange('indexTab', id); //切换到：用户管理
			}
		});
	}
</script>
 <script type="text/html" id="toolBar">
	 <a class="layui-btn layui-btn-xs" lay-event="detail">查看</a>
 </script>
</html>
