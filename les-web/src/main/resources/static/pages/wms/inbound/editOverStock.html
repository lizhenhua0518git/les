<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>处理超储订单</title>
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="stylesheet" href="/iles/pages/layui/css/layui.css"  type="text/css" />
<link rel="stylesheet" href="/iles/pages/css/layui_extend.css"  media="all">
</head>
<body>
<style type="text/css">
.layui-table-body{
	overflow-x:scroll;
}
</style>
<script type="text/html" id="switchTpl">
  <input type="checkbox" name="status" lay-skin="switch" lay-text="是|否" lay-filter="acceptStatus" {{ d.acceptNumber == 0 ? 'checked' : '' }}>
</script>
<table class="layui-hide" id="overStockDetailTab" lay-filter="overStockDetailTabF"></table>
<button class="layui-btn layui-btn-normal layui-btn-sm" id="uploadFile" type="button" style="margin-left:5%"><i class="layui-icon layui-icon-export"></i>上传附件</button>
<input id="location" style="border:none;width: 60%;" type="text" value="">
<button class="layui-btn layui-btn-normal layui-btn-sm" id="downloadFile" type="button" onclick="download();"><i class="layui-icon layui-icon-import"></i>下载查看</button>
<button class="layui-btn layui-btn-normal layui-btn-sm" id="handled" type="button" onclick="update();">完成</button>
<script src="/iles/pages/layui/layui.all.js" charset="UTF-8"></script>
<script src="/iles/pages/js/serverPathConfig.js" charset="UTF-8"></script>
<script src="/iles/pages/js/loginInspect.js" charset="UTF-8"></script>
<script type="text/javascript">
	var $ = layui.$;
	var element = layui.element;
	var layer = layui.layer;
	var table = layui.table;
	var form = layui.form;
	var upload = layui.upload;
	var oldData = parent.oldData;
    var wmsContextPath = config.wmsConfig.contextPath;
	$("#downloadFile").hide();
	table.render({
		elem:'#overStockDetailTab',
		id:'overStockDetailTabId',
		url:wmsContextPath+'overStockOrder/queryDetail',
		cols:[[
		{field:'arrivalItemNo', width:120, title:'行项目号'},
		{field:'arrivalCode',width:150,title:'到货单号'},
		{field:'materialCode', width:150,title:'物料编号'},
		{field:'materialDesc', width:200, title:'物料描述'},
		{field:'storageLocation', width:100, title:'库存地点'},
		{field:'factory', width:100, title:'工厂'},
		{field:'materialUnit', width:100, title:'物料单位'},
		{field:'stockCount', width:100, title:'现有库存'},
		{field:'inspectCount', width:100, title:'质检数量'},
		{field:'purchaseFrozenCount', width:120, title:'采购冻结数量'},
		{field:'warehouseFrozenCount', width:120, title:'库内冻结数量'},
		{field:'cacheCount', width:120, title:'入库缓存数量'},
		{field:'overCount', width:100, title:'超储数量'},
		{field:'boundCount', width:120, title: '超储时临界值'},
		{field:'maxAcceptCount', width:150, title:'本次应到货数量'},
		{field:'isUrgent', width:100, title: '紧急状态'},
		{field:'isHandled', width:100, title: '处理状态'},
		//{field:'status', width:100, title: '作废状态'},
		{field:'acceptCount',width:150,edit:'text',style:'background-color: #009688; color: #fff;', title: '可收数量(可编辑)'},
		//{field:'', width:100, title: '是否拒收',templet: '#switchTpl'},
		{field:'attachmentUrl', width:100, title: '附件地址'}
		]],
		//page: {theme: '#008155'},
   		height: 'full-95',
   		where:{arrivalCode:oldData[0].arrivalCode},
   		even:true,
   		done:function(res,page,count){//列表数据回调函数
   			$("[data-field='isUrgent']").children().each(function(){
   				if($(this).text()=='0'){
   					$(this).text('不紧急');
   				}else if($(this).text()=='1'){
   					$(this).text('紧急');
   				}
   			});
   			$("[data-field='isHandled']").children().each(function(){
   				if($(this).text()=='0'){
   					$(this).text('未处理');
   				}else if($(this).text()=='1'){
   					$(this).text('已处理');
   					var attachmentUrl=$("[data-field='attachmentUrl']").children()[1].innerText;
   					if(attachmentUrl!=""){
   						$("#location").val(attachmentUrl);
   	  				    $("#downloadFile").show();
   					}
   				}
   			});
   			$("[data-field='status']").children().each(function(){
   				if($(this).text()=='0'){
   					$(this).text('作废');
   				}else if($(this).text()=='1'){
   					$(this).text('正常');
   				}
   			});
   		}
	});
	//监听单元格编辑
	table.on('edit(overStockDetailTabF)', function(obj){
		var value = obj.value //得到修改后的值
		,data = obj.data; //得到所在行所有键值
		var arrivalDetailId=data.arrivalDetailId;
		var overStockId=data.id;
		var maxAcceptCount=data.maxAcceptCount;
		var regu = /^[0-9]+\.?[0-9]*$/;
		if(value!=''){
			if(!regu.test(value)){
				layer.alert('可收数量编辑有误！', {icon: 5});
			}else{
				if(value>maxAcceptCount){
					layer.alert('可收数量大于应到货数量！', {icon: 5});
				}else{
					updateAcceptNumber(arrivalDetailId,value,overStockId);
				}
			}
		}
	});
	//更新可收数量
	function updateAcceptNumber(id,acceptCount,overStockId){
		var option = {
			url:wmsContextPath+'overStockOrder/updateAcceptCount',
			data:{id:id,acceptCount:acceptCount,overStockId:overStockId},
			//type:'POST',
			success:function(data){

			},error:function(data){
				layer.alert(data.msg)
			}
		}
		$.ajax(option);
	}
	//上传初始化
	upload.render({
		  elem: '#uploadFile'
		  ,url: '/iles/fileUploadServlet?folder=overStockOrder' //必填项
		  ,method: 'post'
		  ,accept: 'file'
		  //,exts:'xls'
		  ,before: function(obj){
			layer.load(); //上传loading
		  }
		  ,done: function(res, index, upload){
			  if(res.code==0){
				  layer.closeAll('loading'); //关闭loading
				  layer.alert('文件上传成功！', {icon: 6});
				  $("#location").val(res.data);
				  $("#downloadFile").show();
			  }else{
				  layer.closeAll('loading'); //关闭loading
				  layer.alert('上传失败！', {icon: 5});
			  }
		  }
		  ,error: function(index, upload){
			  layer.alert('上传失败！', {icon: 5});
			  layer.closeAll('loading'); //关闭loading
		  }
		});
	//更新订单处理状态
	function update(){
		var arrivalCode=oldData[0].arrivalCode;
		var attachmentUrl=$("#location").val();
		$.ajax({
			url:wmsContextPath+"overStockOrder/update",
			//type:"post",
			data :{arrivalCode:arrivalCode,isHandled:1,attachmentUrl:attachmentUrl},
			success:function(res){
				if(res.code==0){
					var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
					parent.layer.close(index);  // 关闭layer
					parent.table.reload('overStockTabId');
				}else{
					layer.alert(res.data, {icon: 5});
				}
			}
		});
	}
	function download(){
		var path=$("#location").val();
		if(path!=""){
			window.open(wmsContextPath+"overStockOrder/download?path="+path);
		}
	}
</script>
</body>
</html>
